<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <title>AI-–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –û–±—É—á–µ–Ω–∏—è | Centras Insurance</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap');
        :root{--primary-color:#005A9C;--secondary-color:#00AEEF;--bg-color:#f4f7f6;--surface-color:#ffffff;--text-color:#333333;--text-light-color:#777777;--border-color:#e0e0e0;--success-color:#28a745;--error-color:#dc3545;--shadow:0 4px 15px rgba(0,0,0,0.08)}*{box-sizing:border-box}body,html{height:100%;margin:0;background-color:var(--bg-color);color:var(--text-color);font-family:'Lato',sans-serif;font-size:16px}.hidden{display:none !important}.container{width:100%;height:100%;padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center}.window{border:1px solid var(--border-color);padding:30px;box-shadow:var(--shadow);background:var(--surface-color);border-radius:12px;width:100%;max-width:1300px;position:relative}.window-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);padding-bottom:15px;margin-bottom:25px}.window-header h1,.window-header h2{margin:0;font-size:1.8em;color:var(--primary-color);font-weight:700}.logo{height:45px;width:auto}.content-area{height:60vh;overflow-y:auto;padding-right:15px}.content-area::-webkit-scrollbar{width:8px}.content-area::-webkit-scrollbar-track{background:#f1f1f1}.content-area::-webkit-scrollbar-thumb{background:var(--secondary-color);border-radius:4px}.content-area::-webkit-scrollbar-thumb:hover{background:var(--primary-color)}input[type="text"],input[type="email"],input[type="password"]{background-color:var(--bg-color);border:1px solid var(--border-color);color:var(--text-color);padding:12px 15px;margin-bottom:15px;width:100%;font-family:'Lato',sans-serif;border-radius:8px;transition:border-color .3s,box-shadow .3s}input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(0,90,166,0.2)}button,.btn{background:var(--primary-color);border:none;color:#fff;padding:12px 25px;cursor:pointer;transition:all .3s ease;box-shadow:0 2px 8px rgba(0,0,0,0.1);border-radius:10px;font-weight:700;font-family:'Lato',sans-serif;letter-spacing:.2px;margin-top:10px}button:hover,.btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,90,166,0.2);background:var(--secondary-color)}button:disabled{background:var(--text-light-color);cursor:not-allowed;transform:none;box-shadow:none}#auth-error{color:var(--error-color);margin-top:10px;text-align:center;font-weight:bold}#main-menu{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px}.menu-item{padding:20px;border:1px solid var(--border-color);border-radius:10px;cursor:pointer;transition:all .3s ease;background-color:var(--surface-color)}.menu-item:hover{transform:translateY(-5px);box-shadow:var(--shadow);border-color:var(--primary-color)}.menu-item h3{margin-top:0;color:var(--primary-color);display:flex;align-items:center}.menu-item-icon{font-size:1.5em;margin-right:15px;color:var(--secondary-color)}.menu-item.completed{border-left:5px solid var(--success-color)}.menu-item.completed h3{color:var(--success-color)}.menu-item.completed::after{content:'‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ';color:var(--success-color);font-size:.8em;font-weight:bold;display:block;margin-top:10px}#product-content h2,#product-content h3{color:var(--primary-color)}#product-content h3{border-bottom:2px solid var(--secondary-color);padding-bottom:5px;margin-top:25px}#product-content ul{list-style-type:'‚úì ';padding-left:20px}#product-content li{padding-left:10px;margin-bottom:10px}#test-view .question{margin-bottom:20px;font-size:1.3em;font-weight:bold;color:var(--primary-color)}#test-view .answers{display:flex;flex-direction:column;gap:10px}#test-view .answer{border:2px solid var(--border-color);padding:15px;cursor:pointer;border-radius:8px;transition:all .2s ease-in-out}#test-view .answer:hover{background-color:#e9f7fe;border-color:var(--secondary-color)}#test-results p{font-size:1.2em}#test-results .score{color:var(--primary-color);font-weight:bold;font-size:2em}.window-footer{margin-top:20px;border-top:1px solid var(--border-color);padding-top:20px;display:flex;justify-content:space-between;align-items:center}#back-to-menu-btn{background:var(--text-light-color)}#back-to-menu-btn:hover{background:#555;box-shadow:0 4px 10px rgba(0,0,0,0.2)}.loader{width:50px;height:50px;border:5px solid var(--bg-color);border-top-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin:50px auto}.message{text-align:center;padding:20px;font-size:1.1em;color:var(--text-light-color)}@keyframes spin{to{transform:rotate(360deg)}}#assistant-container{margin-top:30px;padding-top:20px;border-top:1px dashed var(--border-color)}#assistant-container h3{color:var(--primary-color);margin-top:0}#chat-box{height:150px;overflow-y:auto;border:1px solid var(--border-color);border-radius:8px;padding:10px;margin-bottom:10px;background-color:var(--bg-color)}.chat-message{margin-bottom:10px}.user-message{text-align:right}.assistant-message span{background-color:#e9f7fe;padding:5px 10px;border-radius:10px;display:inline-block}.thinking{color:var(--text-light-color);font-style:italic}#chat-form{display:flex;gap:10px}#chat-input{flex-grow:1;margin:0}#chat-form button{margin:0}#admin-controls{text-align:right;margin-bottom:15px}
    </style>
    <style>
        /* Card UI Overrides for .menu-item */
        .menu-item {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .menu-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .tab-btn:not(.active):hover {
            background-color: rgba(0,0,0,0.03);
            border-bottom-color: var(--border-color);
        }
        .skeleton-card { background-color: #e0e0e0; border-radius: 12px; height: 150px; position: relative; overflow: hidden; }
        .skeleton-card::after { content: ''; position: absolute; top: 0; left: -150%; width: 150%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { left: -150%; } 100% { left: 150%; } }
    </style>
    <style>
        .tab-btn{padding:10px 20px;border:none;background-color:transparent;cursor:pointer;font-size:1em;color:var(--text-light-color);border-bottom:3px solid transparent;margin-bottom:-2px}.tab-btn.active{color:var(--primary-color);border-bottom-color:var(--primary-color);font-weight:bold}
        #product-nav { padding: 10px; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); margin-bottom: 15px; }
        #product-nav a { margin-right: 15px; text-decoration: none; color: var(--text-light-color); font-weight: bold; }
        #product-nav a.active { color: var(--primary-color); }
        #product-nav a .lock-icon { display: inline-block; margin-left: 5px; }
        .presentation-view{height:100%;display:flex;flex-direction:column}
        .presentation-slider{width:100%;background:#e9ecef;border:1px solid #dee2e6;border-radius:12px;margin-top:20px;box-shadow:0 8px 30px rgba(0,0,0,0.05);flex:1 1 auto;overflow-y:auto}.presentation-slide{display:none;padding:40px 60px;animation:fadeIn .6s;word-wrap:break-word}.presentation-slide.active{display:block}.presentation-slide img{max-height:250px;width:100%;object-fit:cover;border-radius:8px;margin-bottom:20px;box-shadow:0 4px 10px rgba(0,0,0,0.1)}.slider-nav-container{display:flex;justify-content:space-between;align-items:center;padding:15px 40px;border-top:1px solid var(--border-color);background-color:#f8f9fa;flex-shrink:0}.slider-nav button{width:auto;padding:10px 22px;font-size:1em;border-radius:50px;background-color:var(--primary-color);color:white;border:none;cursor:pointer;transition:all .3s ease}.slider-nav button:hover{background-color:var(--secondary-color)}.slider-nav button:disabled{background-color:#ccc;cursor:not-allowed;opacity:0.6}.slide-counter{font-size:1em;color:var(--text-color);font-weight:bold}@keyframes fadeIn{from{opacity:0.2}to{opacity:1}}
    </style>
    <style>
        /* Floating Chat Button Styles */
        #floating-chat-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            border-radius: 50%;
            border: none;
            box-shadow: var(--shadow);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: all .3s ease;
        }
        #floating-chat-btn:hover {
            transform: scale(1.1);
            background-color: var(--secondary-color);
        }
        #floating-chat-btn svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        /* Override for Assistant Container to be a floating panel */
        #assistant-container {
            position: fixed;
            bottom: 90px;
            left: 20px;
            width: 370px;
            max-width: 90vw;
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            z-index: 999;
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-top: 0; /* Override */
            border-top: none; /* Override */
            animation: fadeIn .3s;
        }
        #assistant-container h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        #chat-box {
            height: 250px;
        }

        /* Compact Presentation Slide Styles */
        .presentation-slide {
            padding: 25px 50px !important; /* Reduce padding */
        }
        .presentation-slide img {
            max-height: 220px !important; /* Reduce image height */
            margin-bottom: 15px !important; /* Reduce space after image */
        }
        .presentation-slide h2 {
            margin-bottom: 15px !important;
        }
        .presentation-slide p, .presentation-slide li {
            font-size: 0.95rem !important;
            line-height: 1.45 !important;
        }

        /* Responsive Layout for Presentation View */
        .presentation-active {
            flex-wrap: nowrap !important; /* Prevent wrapping when presentation is active */
        }
        .presentation-active #leaderboard-container {
            flex: 0 0 320px !important; /* Fixed width sidebar */
        }
        .presentation-active #main-content-wrapper {
            flex: 1 1 auto !important; /* Grow to fill remaining space */
        }
        .presentation-active .presentation-slider {
            height: 68vh; /* Make the slider taller */
        }

        @media (max-width: 950px) {
            .presentation-active {
                flex-wrap: wrap !important;
            }
            .presentation-active #leaderboard-container,
            .presentation-active #main-content-wrapper {
                flex: 1 1 100% !important; /* Stack them on smaller screens */
            }
        }

        /* Floating Chat Button Tooltip Styles */
        #floating-chat-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }
        .chat-tooltip {
            position: absolute;
            bottom: 5px;
            left: 75px;
            padding: 10px 15px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            font-size: 0.9rem;
            max-width: 230px;
            white-space: normal;
            text-align: left;
            pointer-events: none;
        }
        .chat-tooltip::before {
            content: '';
            position: absolute;
            top: 50%;
            right: 100%;
            margin-top: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: transparent var(--border-color) transparent transparent;
        }
        .chat-tooltip::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 100%;
            margin-top: -5px;
            margin-right: -1px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent var(--surface-color) transparent transparent;
        }
        #floating-chat-container:hover .chat-tooltip {
            opacity: 1;
            visibility: visible;
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2?v=4"></script>
    
    <script>
        const SUPABASE_URL = 'https://wnsdlibhrlmgyszbyxat.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Induc2RsaWJocmxtZ3lzemJ5eGF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyODE0MjgsImV4cCI6MjA2OTg1NzQyOH0.Sgz-50dHj8M599sIjTRYs0kMP7b6kX2BJ-Gc-trMUQ4';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
</head>
<body>
    <div id="auth-view" class="container">
        <div class="window">
            <div class="window-header"><h1>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1></div>
            <form id="auth-form">
                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—ã–¥–∞–Ω–Ω—ã–µ –≤–∞–º –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.</p>
                <input type="email" id="user-email" placeholder="–†–∞–±–æ—á–∏–π Email" required>
                <input type="password" id="user-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
                <div id="auth-error" class="hidden"></div>
                <button type="submit" id="auth-button">–í–æ–π—Ç–∏</button>
            </form>
        </div>
    </div>

    <div id="app-view" class="container hidden">
        <div class="window">
             <div class="window-header">
                <h2 id="window-title">–ì–ª–∞–≤–Ω–æ–µ –ú–µ–Ω—é</h2>
                <div class="header-controls">
                    <div id="notifications-bell" style="position: relative; cursor: pointer;">
                        <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M21 19v1H3v-1l2-2v-6c0-3.1 2.03-5.83 5-6.71V4a2 2 0 0 1 2-2a2 2 0 0 1 2 2v.29c2.97.88 5 3.61 5 6.71v6l2 2m-7 2a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2"/></svg>
                        <span id="notifications-badge" class="hidden" style="position: absolute; top: -5px; right: -5px; background: var(--error-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; align-items: center; justify-content: center;"></span>
                    </div>
                    <div id="notifications-panel" class="hidden" style="position: absolute; top: 60px; right: 20px; width: 300px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow); z-index: 100;">
                        <div style="padding: 10px; border-bottom: 1px solid var(--border-color); font-weight: bold;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                        <div id="notifications-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
                 <img src="https://centras.kz/wp-content/uploads/2023/12/centras-insurance-col.png" alt="Logo" class="logo">
                 <button id="logout-btn" style="background: transparent; border: none; cursor: pointer; font-size: 1.5em; margin-left: 20px;" title="–í—ã–π—Ç–∏">üö™</button>
            </div>
            <div id="content-loader" class="hidden" style="display: flex; justify-content: center; align-items: center; height: 60vh;"><div class="loader"></div></div>
            <div class="content-area" id="content-area">
                <div id="main-flex-container" style="display: flex; flex-wrap: wrap; gap: 20px;">
                    <div id="leaderboard-container" style="flex: 1 1 300px; min-width: 280px; padding: 15px; background-color: #e9f7fe; border-radius: 8px; align-self: flex-start;">
                        <h3 style="margin-top: 0; color: var(--primary-color);">üèÜ –¢–æ–ø –£—á–µ–Ω–∏–∫–æ–≤ –ù–µ–¥–µ–ª–∏</h3>
                        <div id="leaderboard-content"></div>
                    </div>
                    <div id="main-content-wrapper" style="flex: 2 1 500px;">
                        <div id="main-menu-tabs" style="display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 15px;">
                            <button class="tab-btn active" data-filter="assigned">üì• –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ</button>
                            <button class="tab-btn" data-filter="completed">‚úÖ –ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ</button>
                            <button class="tab-btn" data-filter="future">üóìÔ∏è –ë—É–¥—É—â–∏–µ</button>
                            <button class="tab-btn" data-filter="catalog">üìö –ö–∞—Ç–∞–ª–æ–≥</button>
                        </div>
                        <div id="main-menu"></div>
                        <div id="extra-tools" style="padding-top: 20px; border-top: 1px solid #eee;">
                            <button id="launch-simulator-btn">–î–∏–∞–ª–æ–≥–æ–≤—ã–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä</button>
                        </div>
                        <div id="admin-controls" class="hidden"></div>
                        <div id="product-content" class="hidden"></div>
                        <div id="audio-player-container-user" style="margin-top: 15px;"></div>
                        <div id="assistant-container" class="hidden">
                            <h3>AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
                            <div id="chat-box"></div>
                            <form id="chat-form">
                                <input type="text" id="chat-input" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª—É..." autocomplete="off">
                                <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div id="test-view" class="hidden">
                    <p id="question-counter"></p>
                    <div id="question" class="question"></div>
                    <div id="answers" class="answers"></div>
                    <button id="next-question-btn" class="hidden">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
                </div>
                <div id="test-results" class="hidden">
                     <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
                    <p>–ü—Ä–æ–¥—É–∫—Ç: <span id="results-product-name"></span></p>
                    <p>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span id="results-score" class="score"></span></p>
                    <p id="results-feedback"></p>
                    <button id="back-to-menu-from-results">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</button>
                </div>
                <div id="simulator-view" class="hidden">
                    <div id="simulator-setup">
                        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–∞</h3>
                        <div style="margin-bottom: 20px;">
                            <label for="disposition-slider" style="display: block; margin-bottom: 10px; font-weight: bold;">1. –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:</label>
                            <input type="range" id="disposition-slider" min="0" max="2" value="1" style="width: 100%;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: var(--text-light-color);">
                                <span>–•–æ–ª–æ–¥–Ω—ã–π</span>
                                <span>–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π</span>
                                <span>–ì–æ—Ä—è—á–∏–π</span>
                            </div>
                        </div>
                        <button id="start-simulation-btn">–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥</button>
                    </div>
                    <div id="simulator-chat-area" class="hidden">
                        <div id="simulator-chat-box" style="height: 45vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; margin-bottom: 10px; background-color: var(--bg-color);"></div>
                        <form id="simulator-chat-form" style="display: flex; gap: 10px;">
                            <input type="text" id="simulator-chat-input" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..." autocomplete="off" style="flex-grow: 1; margin: 0;">
                            <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </form>
                        <button id="end-simulation-btn" style="margin-top: 10px; background-color: var(--error-color);">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
                    </div>
                    <div id="simulator-evaluation-area" class="hidden">
                        <h3>–û—Ü–µ–Ω–∫–∞ –¥–∏–∞–ª–æ–≥–∞</h3>
                        <div id="evaluation-results" style="white-space: pre-wrap; background-color: var(--bg-color); padding: 15px; border-radius: 8px;"></div>
                        <button id="restart-simulation-btn" style="margin-top: 10px;">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
                    </div>
                </div>
            </div>
            <div class="window-footer">
                <button id="back-to-menu-btn" class="hidden">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
            </div>
        </div>
    </div>

<script>
    const userData = { email: '', token: null };
    let courses = [];
    let currentCourse = null;
    let userProgress = {};
    let simulationHistory = [];
    
    const authView = document.getElementById('auth-view');
    const appView = document.getElementById('app-view');
    const authForm = document.getElementById('auth-form');
    const authError = document.getElementById('auth-error');
    const contentArea = document.getElementById('content-area');
    const mainMenu = document.getElementById('main-menu');
    const productContent = document.getElementById('product-content');
    const testView = document.getElementById('test-view');
    const testResultsView = document.getElementById('test-results');
    const windowTitle = document.getElementById('window-title');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');
    const backToMenuFromResultsBtn = document.getElementById('back-to-menu-from-results');
    const audioPlayerContainerUser = document.getElementById('audio-player-container-user');
    const assistantContainer = document.getElementById('assistant-container');
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const adminControls = document.getElementById('admin-controls');
    const notificationsBell = document.getElementById('notifications-bell');
    const notificationsBadge = document.getElementById('notifications-badge');
    const notificationsPanel = document.getElementById('notifications-panel');
    const notificationsList = document.getElementById('notifications-list');

    // --- Simulator UI Elements ---
    const simulatorView = document.getElementById('simulator-view');
    const launchSimulatorBtn = document.getElementById('launch-simulator-btn');
    const extraToolsDiv = document.getElementById('extra-tools');
    const simulatorSetup = document.getElementById('simulator-setup');
    const simulatorChatArea = document.getElementById('simulator-chat-area');
    const simulatorEvaluationArea = document.getElementById('simulator-evaluation-area');
    const personaSelector = document.getElementById('persona-selector');
    const scenarioSelector = document.getElementById('scenario-selector');
    const startSimulationBtn = document.getElementById('start-simulation-btn');
    const simulatorChatBox = document.getElementById('simulator-chat-box');
    const simulatorChatForm = document.getElementById('simulator-chat-form');
    const simulatorChatInput = document.getElementById('simulator-chat-input');
    const endSimulationBtn = document.getElementById('end-simulation-btn');
    const evaluationResults = document.getElementById('evaluation-results');
    const restartSimulationBtn = document.getElementById('restart-simulation-btn');

    const contentLoader = document.getElementById('content-loader');

    function showLoader() {
        contentArea.classList.add('hidden');
        contentLoader.classList.remove('hidden');
    }
    function hideLoader() {
        contentArea.classList.remove('hidden');
        contentLoader.classList.add('hidden');
    }
    function showMessage(message, details = '') {
        contentArea.innerHTML = `<div class="message">${message}<br><small style="color: #999;">${details}</small></div>`;
        hideLoader();
    }

    async function handleLogin(email, password) {
        const authButton = document.getElementById('auth-button');
        authButton.disabled = true;
        authButton.textContent = '–í—Ö–æ–¥...';
        authError.classList.add('hidden');

        try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) throw error;

            if (data && data.session) {
                await onLoginSuccess(data.session);
            } else {
                throw new Error("–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ—Å—Å–∏—é.");
            }
        } catch (error) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏:", error);
            authError.textContent = '–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å.';
            authError.classList.remove('hidden');
            authButton.disabled = false;
            authButton.textContent = '–í–æ–π—Ç–∏';
        }
    }

    async function onLoginSuccess(session) {
        userData.email = session.user.email;
        userData.token = session.access_token;

        authView.classList.add('hidden');
        appView.classList.remove('hidden');

        showLoader();
        await showMainMenu();
        // await loadNotifications(); // This is now handled by clicking the bell icon.
        hideLoader();
    }

    async function handleLogout() {
        await supabaseClient.auth.signOut();
        userData.token = null;
        userData.email = '';
        sessionStorage.clear();

        appView.classList.add('hidden');
        authView.classList.remove('hidden');
        document.getElementById('user-email').value = '';
        document.getElementById('user-password').value = '';
    }

    async function checkSession() {
        showLoader();
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            await onLoginSuccess(session);
        } else {
            authView.classList.remove('hidden');
            hideLoader();
        }
        // Attach listeners after session check
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('user-email').value.trim();
            const password = document.getElementById('user-password').value.trim();
            handleLogin(email, password);
        });
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
    }

    async function fetchAuthenticated(url, options = {}) {
        if (!userData.token) {
            console.error("Auth token is missing. Request cancelled.");
            throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.");
        }
        const defaultHeaders = { 'Authorization': `Bearer ${userData.token}` };
        const finalOptions = { ...options, headers: { ...defaultHeaders, ...options.headers } };
        
        const response = await fetch(url, finalOptions);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.statusText} (${response.status})` }));
            console.error(`Authenticated fetch failed for ${url}. Status: ${response.status}.`, errorData);
            throw new Error(errorData.error);
        }
        return response.json();
    }

    notificationsBell.addEventListener('click', async () => {
        const isHidden = notificationsPanel.classList.toggle('hidden');
        if (!isHidden) {
            const notifications = await fetchAuthenticated('/api/getNotifications');
            const unreadNotificationIds = notifications.filter(n => !n.is_read).map(n => n.id);

            if (unreadNotificationIds.length > 0) {
                try {
                    await fetchAuthenticated('/api/markNotificationsAsRead', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notification_ids: unreadNotificationIds })
                    });
                    notificationsBadge.classList.add('hidden');
                    notificationsList.querySelectorAll('div').forEach(div => div.style.fontWeight = 'normal');
                } catch (error) {
                    console.error('Failed to mark notifications as read:', error);
                }
            }
        }
    });

    async function loadLeaderboard() {
        const leaderboardContent = document.getElementById('leaderboard-content');
        leaderboardContent.innerHTML = '<div class="loader" style="height: 20px; width: 20px; margin: 0;"></div>';
        try {
            const leaderboardData = await fetchAuthenticated('/api/get-leaderboard', { method: 'POST' });
            if (!leaderboardData || leaderboardData.length === 0) {
                leaderboardContent.innerHTML = '<p>–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç –ª–∏–¥–µ—Ä–æ–≤. –°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>';
                return;
            }

            let html = '<ol style="margin: 0; padding-left: 20px;">';
            leaderboardData.forEach(user => {
                html += `<li style="margin-bottom: 5px;"><strong>${user.full_name || '–ê–Ω–æ–Ω–∏–º'}</strong>: –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∫—É—Ä—Å–æ–≤: ${user.courses_completed || 0}, –í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è: ${user.total_time_spent_minutes || 0} –º–∏–Ω.</li>`;
            });
            html += '</ol>';
            leaderboardContent.innerHTML = html;

        } catch (error) {
            console.error('Failed to load leaderboard:', error);
            leaderboardContent.innerHTML = '<p style="color: var(--error-color);">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∏–¥–µ—Ä–±–æ—Ä–¥.</p>';
        }
    }

    async function showMainMenu() {
        stopTimeTracking();
        windowTitle.textContent = '–ì–ª–∞–≤–Ω–æ–µ –ú–µ–Ω—é';

        document.getElementById('main-flex-container').classList.remove('presentation-active');
        document.getElementById('leaderboard-container').classList.remove('hidden');
        document.getElementById('main-content-wrapper').classList.remove('hidden');

        productContent.classList.add('hidden');
        productContent.classList.remove('presentation-view');
        testView.classList.add('hidden');
        testResultsView.classList.add('hidden');
        assistantContainer.classList.add('hidden');
        document.getElementById('floating-chat-container').classList.add('hidden');
        simulatorView.classList.add('hidden');
        
        mainMenu.classList.remove('hidden');
        document.getElementById('main-menu-tabs').classList.remove('hidden');
        extraToolsDiv.classList.remove('hidden');
        backToMenuBtn.classList.add('hidden');

        loadLeaderboard();
        mainMenu.innerHTML = ''; // Clear previous content
        for (let i = 0; i < 6; i++) {
            const skeleton = document.createElement('div');
            skeleton.className = 'skeleton-card';
            mainMenu.appendChild(skeleton);
        }

        try {
            const data = await fetchAuthenticated(`/api/getCourses`, { method: 'POST' });
            
            if (!data || !Array.isArray(data.courses)) {
                throw new Error("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Å—Å–∏–≤ –∫—É—Ä—Å–æ–≤.");
            }

            courses = data.courses;
            userProgress = data.userProgress;

            const tabsContainer = document.getElementById('main-menu-tabs');
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    tabsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    const filter = e.target.dataset.filter;
                    renderCourses(filter);
                }
            });

            renderCourses('assigned');

        } catch (error) {
            console.error('Failed to load courses:', error);
            showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤.', error.message);
        }
    }

    function renderCourses(filter) {
        mainMenu.innerHTML = '';
        let coursesToRender;
        const now = new Date();
        now.setHours(0, 0, 0, 0); // Set to start of today for date comparison

        switch (filter) {
            case 'assigned':
                coursesToRender = courses.filter(c => {
                    const progress = userProgress[c.id];
                    const isCompleted = progress && progress.completed;
                    const startDate = c.startDate ? new Date(c.startDate) : null;
                    const isFuture = startDate && startDate > now;
                    return c.isAssigned && !isCompleted && !isFuture;
                });
                if (coursesToRender.length === 0) {
                    mainMenu.innerHTML = '<p class="message">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤.</p>';
                }
                break;
            case 'completed':
                coursesToRender = courses.filter(c => c.isAssigned && userProgress[c.id]?.completed);
                if (coursesToRender.length === 0) {
                    mainMenu.innerHTML = '<p class="message">–í—ã –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫—É—Ä—Å–∞.</p>';
                }
                break;
            case 'future':
                coursesToRender = courses.filter(c => {
                    const startDate = c.startDate ? new Date(c.startDate) : null;
                    return c.isAssigned && startDate && startDate > now;
                });
                if (coursesToRender.length === 0) {
                    mainMenu.innerHTML = '<p class="message">–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±—É–¥—É—â–∏—Ö –∫—É—Ä—Å–æ–≤.</p>';
                }
                break;
            case 'catalog':
                coursesToRender = courses.filter(c => !c.isAssigned);
                 if (coursesToRender.length === 0) {
                    mainMenu.innerHTML = '<p class="message">–í –∫–∞—Ç–∞–ª–æ–≥–µ –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—Å–æ–≤.</p>';
                }
                break;
            default:
                coursesToRender = [];
        }

        if (coursesToRender.length > 0) {
            // Removed the grouping by product_line for the catalog view as the field is obsolete.
            mainMenu.className = 'main-menu';
            let type = 'assigned';
            if (filter === 'catalog') {
                type = 'catalog';
            } else if (filter === 'future') {
                type = 'view';
            }
            coursesToRender.forEach(course => mainMenu.appendChild(createCourseMenuItem(course, type)));
        }
    }

    function createCourseMenuItem(course, type) {
        const menuItem = document.createElement('div');
        menuItem.className = 'menu-item';
        menuItem.style.display = 'flex';
        menuItem.style.flexDirection = 'column';
        menuItem.style.justifyContent = 'space-between';

        const contentDiv = document.createElement('div');
        const progress = userProgress[course.id];
        if (progress && progress.completed) {
             menuItem.classList.add('completed');
        }
        contentDiv.dataset.courseId = course.id;
        contentDiv.innerHTML = `<h3><span class="menu-item-icon">üìñ</span>${course.title}</h3>`;

        if (course.startDate) {
            const startDate = new Date(course.startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (startDate >= today) {
                 contentDiv.innerHTML += `<p style="color: var(--primary-color); font-weight: bold;">–ù–∞—á–∞–ª–æ: ${startDate.toLocaleDateString('ru-RU')}</p>`;
            }
        }

        if (type === 'assigned') {
            contentDiv.innerHTML += `<p>–ü–µ—Ä–µ–π—Ç–∏ –∫ —É—á–µ–±–Ω–æ–º—É –º–æ–¥—É–ª—é...</p>`;
            if(progress && progress.percentage > 0 && !progress.completed) {
                contentDiv.innerHTML += `<div style="width: 100%; background: #eee; border-radius: 5px; margin-top: 10px;"><div style="width: ${progress.percentage}%; background: var(--success-color); height: 5px; border-radius: 5px;"></div></div>`;
            }
            contentDiv.style.cursor = 'pointer';
            contentDiv.addEventListener('click', () => showProduct(course.id));
        } else if (type === 'view') {
            // A view-only type for future courses that are not clickable to start
            contentDiv.style.cursor = 'default';
        }

        menuItem.appendChild(contentDiv);

        if (type === 'catalog') {
            const assignBtn = document.createElement('button');
            assignBtn.textContent = '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å';
            assignBtn.className = 'btn';
            assignBtn.style.marginTop = '15px';
            assignBtn.dataset.courseId = course.id;
            assignBtn.onclick = async (e) => {
                e.stopPropagation();
                const button = e.target;
                const courseId = button.dataset.courseId;
                button.disabled = true;
                button.textContent = '–ó–∞–ø–∏—Å—å...';
                try {
                    await fetchAuthenticated('/api/assign-course', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ course_id: courseId })
                    });
                    await showMainMenu();
                } catch (error) {
                    console.error('Failed to self-assign course:', error);
                    alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å: ${error.message}`);
                    button.disabled = false;
                    button.textContent = '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å';
                }
            };
            menuItem.appendChild(assignBtn);
        }
        return menuItem;
    }
    
    let timeTrackingInterval = null;
    let secondsSinceLastUpdate = 0;

    async function sendTimeUpdate(courseId, seconds) {
        if (!courseId || seconds <= 0) return;
        try {
            await fetchAuthenticated('/api/update-time-spent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ course_id: courseId, seconds_spent: seconds })
            });
            console.log(`Successfully sent ${seconds} seconds for course ${courseId}`);
        } catch (error) {
            console.error('Failed to send time update:', error);
        }
    }

    function stopTimeTracking() {
        if (timeTrackingInterval) {
            clearInterval(timeTrackingInterval);
            timeTrackingInterval = null;
            sendTimeUpdate(currentCourse.id, secondsSinceLastUpdate);
            secondsSinceLastUpdate = 0;
        }
    }

    function renderPresentation(summaryData) {
        productContent.innerHTML = '';

        if (!Array.isArray(summaryData) || summaryData.length === 0) {
            productContent.innerHTML = '<p>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∂–µ.</p>';
            return;
        }

        const slider = document.createElement('div');
        slider.className = 'presentation-slider';

        summaryData.forEach((slideData) => {
            const slideDiv = document.createElement('div');
            slideDiv.className = 'presentation-slide';
            let imageHtml = slideData.image_url ? `<img src="${slideData.image_url}" alt="${slideData.slide_title || 'Slide Image'}">` : '';
            slideDiv.innerHTML = `${imageHtml}<h2>${slideData.slide_title || ''}</h2>${slideData.html_content || ''}`;
            slider.appendChild(slideDiv);
        });

        const navContainer = document.createElement('div');
        navContainer.className = 'slider-nav-container';
        navContainer.innerHTML = `
            <span class="slide-counter"></span>
            <div class="slider-nav">
                <button class="slider-prev">‚Äπ –ù–∞–∑–∞–¥</button>
                <button class="slider-next">–í–ø–µ—Ä–µ–¥ ‚Ä∫</button>
            </div>
        `;

        productContent.appendChild(slider);
        productContent.appendChild(navContainer);

        const slides = slider.querySelectorAll('.presentation-slide');
        const prevBtn = navContainer.querySelector('.slider-prev');
        const nextBtn = navContainer.querySelector('.slider-next');
        const counter = navContainer.querySelector('.slide-counter');
        let currentIndex = 0;

        const updateSliderUI = () => {
            slides.forEach((slide, index) => {
                slide.classList.toggle('active', index === currentIndex);
            });
            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === slides.length - 1;
            counter.textContent = `${currentIndex + 1} / ${slides.length}`;
        };

        prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                updateSliderUI();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentIndex < slides.length - 1) {
                currentIndex++;
                updateSliderUI();
            }
        });

        updateSliderUI();
    }

    async function showProduct(courseId, forceRegenerate = false) {
        currentCourse = courses.find(c => c.id === courseId);
        if (!currentCourse) return;
        windowTitle.textContent = currentCourse.title;

        document.getElementById('main-flex-container').classList.add('presentation-active');
        document.getElementById('main-menu-tabs').classList.add('hidden');
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('extra-tools').classList.add('hidden');

        productContent.classList.remove('hidden');
        productContent.classList.add('presentation-view');
        assistantContainer.classList.add('hidden'); // The container itself is now hidden by default
        document.getElementById('floating-chat-container').classList.remove('hidden');
        backToMenuBtn.classList.remove('hidden');

        productContent.innerHTML = '<div class="loader"></div>';
        audioPlayerContainerUser.innerHTML = '';
        const savedChat = sessionStorage.getItem(`chatHistory_${currentCourse.id}`);
        chatBox.innerHTML = savedChat || '';

        try {
            const data = await fetchAuthenticated('/api/getCourseContent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ course_id: currentCourse.id, force_regenerate: forceRegenerate })
            });
            currentCourse.summary = data.summary;
            currentCourse.questions = data.questions;
            currentCourse.materials = data.materials;

            renderPresentation(currentCourse.summary);

            if (currentCourse.materials && currentCourse.materials.length > 0) {
                const materialsDiv = document.createElement('div');
                materialsDiv.innerHTML = '<h3>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</h3>';
                const materialsList = document.createElement('ul');
                currentCourse.materials.forEach(m => { materialsList.innerHTML += `<li><a href="${m.public_url}" target="_blank" download>${m.file_name}</a></li>`; });
                materialsDiv.appendChild(materialsList);
                productContent.appendChild(materialsDiv);
            }

            const listenBtn = document.createElement('button');
            listenBtn.textContent = '–û–∑–≤—É—á–∏—Ç—å —Å–∞–º–º–∞—Ä–∏';
            listenBtn.onclick = async () => {
                listenBtn.disabled = true;
                listenBtn.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ...';
                try {
                    let summaryText = '';
                    if (currentCourse && Array.isArray(currentCourse.summary)) {
                        const tempDiv = document.createElement('div');
                        summaryText = currentCourse.summary.map(slide => {
                            // –í—Å—Ç–∞–≤–ª—è–µ–º HTML –≤ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, —á—Ç–æ–±—ã –∏–∑–≤–ª–µ—á—å —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç
                            tempDiv.innerHTML = slide.html_content;
                            return tempDiv.textContent || tempDiv.innerText || '';
                        }).join('\\n\\n'); // –°–æ–µ–¥–∏–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Å–ª–∞–π–¥–æ–≤ —Å –ø–∞—É–∑–∞–º–∏
                    }

                    if (!summaryText) {
                        throw new Error('–¢–µ–∫—Å—Ç —Å–∞–º–º–∞—Ä–∏ –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω.');
                    }

                    const response = await fetchAuthenticated('/api/text-to-speech-user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            course_id: currentCourse.id,
                            text: summaryText
                        })
                    });

                    const audio = new Audio(response.audioUrl);
                    audio.controls = true;
                    audio.autoplay = true;
                    audioPlayerContainerUser.innerHTML = '';
                    audioPlayerContainerUser.appendChild(audio);
                    listenBtn.textContent = '–ê—É–¥–∏–æ –≥–æ—Ç–æ–≤–æ';
                } catch (error) {
                    console.error('Audio generation failed:', error);
                    alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞—É–¥–∏–æ: ${error.message}`);
                    listenBtn.textContent = '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
                } finally {
                    listenBtn.disabled = false;
                }
            };
            productContent.appendChild(listenBtn);

            const startTestBtn = document.createElement('button');
            startTestBtn.id = 'start-test-btn';
            startTestBtn.textContent = '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
            startTestBtn.onclick = () => {
                stopTimeTracking();
                startTest(currentCourse.id);
            };
            productContent.appendChild(startTestBtn);

            if (timeTrackingInterval) clearInterval(timeTrackingInterval);
            secondsSinceLastUpdate = 0;
            timeTrackingInterval = setInterval(() => {
                secondsSinceLastUpdate += 30;
                sendTimeUpdate(currentCourse.id, 30);
            }, 30000);
        } catch (error) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∫—É—Ä—Å–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫—É—Ä—Å–∞.', error.message);
        }
    }

    chatForm.addEventListener('submit', async (e) => { e.preventDefault(); const userQuestion = chatInput.value.trim(); if (!userQuestion || !currentCourse) return; appendMessage(userQuestion, 'user'); chatInput.value = ''; chatInput.disabled = true; appendMessage('...', 'assistant', true); try { const data = await fetchAuthenticated('/api/askAssistant', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ course_id: currentCourse.id, question: userQuestion }) }); updateLastAssistantMessage(data.answer); } catch (error) { console.error('–û—à–∏–±–∫–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞:', error); updateLastAssistantMessage(`–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}`); } finally { chatInput.disabled = false; chatInput.focus(); } });
    function appendMessage(text, sender, isThinking = false) { const messageDiv = document.createElement('div'); messageDiv.className = `chat-message ${sender}-message`; const textSpan = document.createElement('span'); textSpan.textContent = text; if (isThinking) { messageDiv.classList.add('thinking'); messageDiv.id = 'thinking-indicator'; } messageDiv.appendChild(textSpan); chatBox.appendChild(messageDiv); chatBox.scrollTop = chatBox.scrollHeight; if (currentCourse) { sessionStorage.setItem(`chatHistory_${currentCourse.id}`, chatBox.innerHTML); } }
    function updateLastAssistantMessage(text) { const thinkingIndicator = document.getElementById('thinking-indicator'); if (thinkingIndicator) { thinkingIndicator.querySelector('span').textContent = text; thinkingIndicator.classList.remove('thinking'); thinkingIndicator.id = ''; if (currentCourse) { sessionStorage.setItem(`chatHistory_${currentCourse.id}`, chatBox.innerHTML); } } }

    let currentQuestions = [], currentQuestionIndex = 0, score = 0, tabSwitchCount = 0;
    const MAX_ATTEMPTS = 3;
    const MAX_TAB_SWITCHES = 2;

    const handleVisibilityChange = () => {
        if (document.hidden) {
            tabSwitchCount++;
            if (tabSwitchCount === 1) {
                alert('–í–Ω–∏–º–∞–Ω–∏–µ! –í—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –¥—Ä—É–≥—É—é –≤–∫–ª–∞–¥–∫—É. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–µ—Å—Ç –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º 0.');
            } else if (tabSwitchCount >= MAX_TAB_SWITCHES) {
                alert('–í—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏–º–∏—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π. –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —Å –Ω—É–ª–µ–≤—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º.');
                score = 0;
                showTestResultsView();
            }
        }
    };

    function startTest(courseId) {
        currentCourse = courses.find(c => c.id === courseId);
        const progress = userProgress[courseId];
        const attempts = progress ? progress.attempts : 0;

        if (attempts >= MAX_ATTEMPTS) {
            alert(`–í—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Å–µ ${MAX_ATTEMPTS} –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è —Å–¥–∞—á–∏ —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞.`);
            document.getElementById('start-test-btn').disabled = true;
            return;
        }

        if (!currentCourse || !currentCourse.questions || currentCourse.questions.length === 0) {
            showMessage('–í–æ–ø—Ä–æ—Å—ã –¥–ª—è —ç—Ç–æ–≥–æ –∫—É—Ä—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.');
            backToMenuBtn.classList.remove('hidden');
            return;
        }

        currentQuestions = currentCourse.questions;
        currentQuestionIndex = 0;
        score = 0;
        tabSwitchCount = 0;
        document.addEventListener('visibilitychange', handleVisibilityChange);

        document.getElementById('main-content-wrapper').classList.add('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden');
        testView.classList.remove('hidden');

        displayQuestion();
    }

    function displayQuestion() { const nextBtn = document.getElementById('next-question-btn'); if (currentQuestionIndex < currentQuestions.length) { const q = currentQuestions[currentQuestionIndex]; document.getElementById('question-counter').textContent = `–í–æ–ø—Ä–æ—Å ${currentQuestionIndex + 1} –∏–∑ ${currentQuestions.length}`; document.getElementById('question').textContent = q.question; const answersDiv = document.getElementById('answers'); answersDiv.innerHTML = ''; q.options.forEach((option, index) => { const answerEl = document.createElement('div'); answerEl.className = 'answer'; answerEl.textContent = option; answerEl.dataset.index = index; answerEl.addEventListener('click', selectAnswer); answersDiv.appendChild(answerEl); }); nextBtn.classList.add('hidden'); } else { showTestResultsView(); } }
    function selectAnswer(e) { const selectedIndex = parseInt(e.target.dataset.index, 10); const correctIndex = currentQuestions[currentQuestionIndex].correct_option_index; document.querySelectorAll('.answer').forEach(el => { el.removeEventListener('click', selectAnswer); el.style.cursor = 'default'; }); if (selectedIndex === correctIndex) { score++; e.target.style.borderColor = 'var(--success-color)'; e.target.style.backgroundColor = '#eaf7ec'; } else { e.target.style.borderColor = 'var(--error-color)'; e.target.style.backgroundColor = '#fdeeee'; const correctAnswerEl = document.querySelector(`.answer[data-index='${correctIndex}']`); if(correctAnswerEl) correctAnswerEl.style.borderColor = 'var(--success-color)'; } const nextBtn = document.getElementById('next-question-btn'); nextBtn.classList.remove('hidden'); nextBtn.onclick = () => { currentQuestionIndex++; displayQuestion(); }; }
    async function showTestResultsView() {
        document.removeEventListener('visibilitychange', handleVisibilityChange);

        // Hide other views
        testView.classList.add('hidden');
        document.getElementById('main-content-wrapper').classList.add('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden');

        // Show the results view
        testResultsView.classList.remove('hidden');

        const percentage = Math.round((score / currentQuestions.length) * 100);
        document.getElementById('results-product-name').textContent = currentCourse.title;
        document.getElementById('results-score').textContent = `${percentage}% (${score} –∏–∑ ${currentQuestions.length})`;
        let feedback = '';
        if (percentage >= 80) {
            feedback = '–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–≤–æ–µ–Ω.';
        } else if (percentage >= 60) {
            feedback = '–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–∑–¥–µ–ª—ã.';
        } else {
            feedback = '–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è.';
        }
        document.getElementById('results-feedback').textContent = feedback;

        userProgress[currentCourse.id] = { completed: true, score, total: currentQuestions.length, percentage };

        try {
            await fetchAuthenticated('/api/saveTestResult', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    course_id: currentCourse.id,
                    score: score,
                    total_questions: currentQuestions.length,
                    percentage: percentage
                })
            });
        } catch(error) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', error);
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        // Hide app view initially
        appView.classList.add('hidden');
        authView.classList.add('hidden');

        // --- Create and set up the floating chat button ---
        const chatContainer = document.createElement('div');
        chatContainer.id = 'floating-chat-container';
        chatContainer.classList.add('hidden');

        const chatBtn = document.createElement('button');
        chatBtn.id = 'floating-chat-btn';
        chatBtn.title = "AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç";
        chatBtn.innerHTML = `<svg fill="currentColor" version="1.1" viewBox="0 0 190.535 190.535"><g><g><path d="M71.664,50.74c-1.068,0.959-1.972,2.338-2.98,3.925c-1.55,2.441-3.579,4.291-5.424,6.455 c-1.352,1.586-0.113,4.758,2.249,3.864c2.803-1.061,5.056-3.753,7.01-5.937c1.595-1.783,3.056-3.285,3.864-5.56 C77.393,50.645,73.614,48.989,71.664,50.74z"/><path d="M64.375,40.06c-3.034-0.694-5.417,2.101-7.539,3.936c-1.988,1.718-3.904,3.516-5.808,5.325 c-0.695,0.661-0.92,1.835-0.529,2.734c0.258,0.825,0.955,1.525,1.81,1.503c0.619,0.15,1.28,0.113,1.782-0.267 c1.949-1.474,3.92-2.916,5.898-4.35c2.219-1.607,5.289-2.871,6.313-5.488C66.833,42.093,65.729,40.369,64.375,40.06z"/><path d="M63.219,27.727c-1.707-2.668-4.98-3.228-7.826-4.33c-2.98-1.154-6.088-1.772-9.283-1.741c-2.975,0.03-2.893,4.327,0,4.558 c2.932,0.234,5.665,1.233,8.321,2.452c2.329,1.069,4.044,2.888,6.706,2.689C62.86,31.226,64.272,29.373,63.219,27.727z"/><path d="M71.991,7.511c-0.151-1.822-1.934-3.86-3.946-3.306c-1.993,0.548-2.543,3.199-1.732,4.844 c1.023,2.077,1.579,4.754,3.348,6.362c1.284,1.167,3.708,0.449,3.609-1.495C73.158,11.748,72.171,9.682,71.991,7.511z"/><path d="M95.005,0.407c-2.027-0.933-3.701-0.201-4.93,1.569c-1.343,1.933-0.333,6.063-0.108,8.184 c0.338,3.189,4.612,3.185,4.954,0c0.145-1.352,0.29-2.698,0.532-4.037c0.122-0.673,0.333-0.997,0.516-1.662 c0.038-0.286,0.077-0.571,0.115-0.857c0.048-0.273,0.05-0.388,0.03-0.428C96.375,2.109,96.158,0.938,95.005,0.407z"/><path d="M121.395,4.007c-4.459-1.926-8.225,3.95-10.666,6.906c-2.042,2.472,1.031,5.543,3.503,3.503 c2.522-2.081,5.279-3.921,7.725-6.052C123.202,7.279,122.991,4.697,121.395,4.007z"/><g><path d="M129.533,21.099c0.202-0.061,0.362-0.087,0.476-0.098c-0.059,0.001-0.073,0.007-0.185,0.001 c-0.812-0.049-1.514,0.329-2.161,0.755c-0.632,0.415-1.541,0.785-2.133,1.034c-1.011,0.426-2.068,0.743-3.067,1.193 c-0.459,0.207-0.867,0.39-1.237,0.76c-0.037,0.037-0.051,0.052-0.084,0.086c-0.052,0.037-0.109,0.05-0.159,0.093 c-0.061,0.051-0.066,0.135-0.12,0.192c-0.271,0.284-0.249,0.29-0.121,0.193c-0.408,0.554-0.591,1.246-0.429,1.923 c0.1,0.414,1.684,2.441,0.376,0.663c0.337,0.458,0.581,0.785,1.082,1.078c1.736,1.017,4.367,0.061,6.166-0.388 c2.247-0.56,4.451-1.071,5.351-3.458C134.229,22.622,131.775,20.597,129.533,21.099z"/><path d="M130.008,21C130.174,20.997,130.188,20.982,130.008,21L130.008,21z"/></g><g><path d="M129.933,52.573c0.005,0.009,0.006,0.019,0.01,0.029C130.178,53.159,130.184,53.173,129.933,52.573z"/><path d="M129.942,52.602c-0.044-0.105-0.082-0.194-0.143-0.34c-0.451-0.77-1.107-1.172-1.919-1.476 c-0.776-0.29-1.44-0.643-2.163-1.072c-1.528-0.908-2.962-1.959-4.398-3.001c-2.617-1.899-4.878,1.99-3.182,4.124 c1.714,2.155,4.742,4.714,7.269,5.818c0.978,0.427,2.288,0.733,3.241,0c0.287-0.221,0.6-0.413,0.845-0.681 C130.371,55.02,130.542,53.751,129.942,52.602z"/></g><path d="M61.688,119.781c-1.816-1.094-3.726-0.254-4.887,1.28c-0.552,0.731-1.104,1.461-1.657,2.192 c-2.523,2.255-4.172,5.434-2.675,8.753c1.449,3.211,5.629,4.288,8.825,4.229c3.448-0.062,7.533-1.526,8.514-5.213 C71.177,125.878,65.354,121.987,61.688,119.781z"/><path d="M168.147,136.706c-0.109-16.405,0.64-39.158-6.252-54.462c-0.263-0.583-0.639-0.961-1.052-1.253 c-0.142-0.926-0.594-1.828-1.513-2.474c-14.679-10.315-39.691-5.817-56.409-5.172c-2.228,0.086-4.467,0.113-6.712,0.117 c0.044-0.235,0.144-0.426,0.15-0.688c0.111-4.776-0.21-9.506-0.538-14.268c-0.141-2.053-0.142-4.128-0.306-6.164 c0.698-0.078,1.398-0.205,2.098-0.454c8.256-2.94,10.021-15.164,8.727-22.605c-0.709-4.078-3.489-6.544-6.968-7.293 c-1.066-0.725-2.107-1.297-2.96-1.633c-6.06-2.386-13.778-1.596-19.398,1.529c-14.531,8.078-3.244,33.379,10.176,31.211 c0.036,1.772,0.215,3.572,0.363,5.409c0.382,4.753,0.777,9.502,0.981,14.268c0.01,0.228,0.104,0.391,0.143,0.598 c-21.292-0.561-43.1-3.094-63.614,1.985c-3.505,0.868-3.338,4.639-1.226,6.435c-0.828,32.477,1.606,64.948,1.815,97.426 c0.016,2.421,1.899,3.995,4.182,4.182c23.992,1.967,47.835,5.209,71.891,6.443c16.38,0.84,40.995,2.734,54.987-7.801 c0.388-0.292,0.684-0.629,0.917-0.986c0.792,0.037,1.57-0.196,2.133-0.895C169.123,168.515,168.241,150.849,168.147,136.706z M155.235,84.606c-0.212,4.65-0.077,9.312,0.232,13.978c-3.677-2.77-7.655-5.229-11.331-7.955 c-4.077-3.022-8.118-6.085-12.197-9.1C139.688,81.845,147.425,82.68,155.235,84.606z M126.964,81.393 c9.165,7.697,18.39,17.309,28.943,22.779c0.2,2.12,0.427,4.241,0.668,6.363c-4.821-5.087-11.786-9.199-16.981-12.892 c-7.952-5.65-16.172-11.014-24.479-16.174C119.082,81.377,123.025,81.338,126.964,81.393z M110.003,81.596 c8.316,6.061,16.771,11.93,25.033,18.074c7.602,5.654,14.535,13.004,22.411,18.195c0.294,2.386,0.568,4.771,0.835,7.156 c-0.863-0.578-1.76-1.097-2.666-1.551c-2.212-10.229-10.98-17.581-22.027-19.519c-1.675-0.294-2.981,0.382-3.856,1.418 c0.058-0.568-0.109-1.145-0.671-1.591c-9.661-7.685-19.795-14.893-30.003-21.906C102.735,81.807,106.377,81.698,110.003,81.596z M159.305,135.593c-0.742-0.349-1.542-0.623-2.234-0.968c-0.494-0.247-0.977-0.534-1.468-0.798 c0.104-0.492,0.234-0.978,0.306-1.476c0.262-1.811,0.329-3.566,0.229-5.261c0.091,0.073,0.192,0.131,0.282,0.205 c0.869,0.711,1.604,1.538,2.335,2.366C158.948,131.639,159.154,133.617,159.305,135.593z M129.316,110.47 c0.476,0.59,1.125,1.076,2.13,1.252c9.35,1.639,16.519,7.05,16.703,17.092c0.148,8.048-5.326,15.262-13.05,17.205 C110.149,152.301,108.438,111.678,129.316,110.47z M112.455,112.851c-0.006-0.226-0.014-0.453-0.014-0.675 c0.003-5.091,0.006-10.181,0.009-15.272c3.941,3.266,7.991,6.373,12.246,9.184C119.855,106.604,115.626,109.086,112.455,112.851z M105.78,150.37c0.196,2.518,0.027,5.054-0.312,7.562c-7.153,0.022-14.306,0.056-21.458,0.162 c-0.51-1.883-1.016-3.732-0.48-5.778c0.201-0.77-0.037-1.458-0.465-2.006c0.425-0.48,0.9-0.869,1.302-1.39 c7.545-9.775,6.252-20.301,0.781-28.762c-0.668-6.644-1.197-13.269-1.415-19.932c7.088,0.028,14.178,0.052,21.266,0.058 c0.002,3.506,0.004,7.012,0.006,10.518c0.002,3.249-0.914,7.617,2.151,9.734c0.228,0.156,0.553,0.163,0.843,0.234 c-0.452,1.324-0.82,2.703-1.078,4.136c-1.109,6.143-0.186,11.667,2.237,16.237c-1.428-0.154-2.932,0.723-3.412,2.188 C104.947,145.764,105.584,147.849,105.78,150.37z M94.646,81.881c4.412,3.53,8.687,7.268,12.996,10.962 c-2.658,0.002-5.317,0.015-7.975,0.021c-2.401-2.578-6.042-4.283-8.908-6.337c-2.143-1.536-4.231-3.147-6.329-4.745 C87.842,81.863,91.246,81.884,94.646,81.881z M79.211,81.659c2.835,2.427,5.709,4.804,8.665,7.084 c1.655,1.276,3.422,2.809,5.286,4.138c-2.787,0.01-5.575,0.011-8.362,0.022c-2.565-2.275-6.32-3.916-9.04-5.718 c-2.836-1.878-5.576-3.895-8.322-5.901C71.362,81.404,75.288,81.538,79.211,81.659z M76.708,145.281c-6.716,8.568-18.204,5.918-25.35-0.419c-9.324-8.265-6.669-17.231-2.901-27.268 c0.502-1.337,0.138-2.486-0.632-3.306C64.05,102.692,91.122,126.89,76.708,145.281z M78.006,154.773 c-0.194,1.583-0.255,3.19-0.315,4.794c-1.118-0.894-2.197-1.848-3.255-2.833C75.661,156.185,76.857,155.546,78.006,154.773z M62.574,81.156c0.034,0.036,0.046,0.079,0.086,0.112c3.32,2.775,6.72,5.445,10.171,8.054 c1.566,1.183,3.348,2.767,5.225,4.197c-1.05,0.647-1.808,1.747-1.786,3.047c0.01,0.605,0.098,1.207,0.123,1.812 c-3.152-2.548-7.185-4.397-10.467-6.57c-4.776-3.162-9.061-6.831-13.161-10.778C56.031,81.018,59.302,81.08,62.574,81.156z M48.764,81.102c0.037,0.063,0.051,0.129,0.099,0.19c3.484,4.436,7.686,8.223,12.161,11.642 c4.607,3.52,10.036,8.553,15.691,10.163c0.301,3.002,0.703,5.996,1.236,8.972c-1.919-1.615-3.996-3.03-6.15-4.233 c0.631-0.998,0.599-2.429-0.706-3.287C59.75,97.079,47.51,91.436,38.074,81.563C41.629,81.293,45.193,81.171,48.764,81.102z M30.876,82.253c1.134-0.142,2.273-0.213,3.409-0.327c7.069,8.865,16.373,15.99,26.147,21.941 c-3.376-0.482-6.693-0.334-9.721,0.64c0.197-0.803-0.013-1.706-0.962-2.365c-4.896-3.398-9.245-7.833-13.645-11.833 c-1.693-1.54-3.375-3.089-5.09-4.603C30.966,84.553,30.924,83.403,30.876,82.253z M31.183,89.989c0.85,0.896,1.679,1.812,2.54,2.699 c4.322,4.456,8.797,8.718,13.305,12.98c0.135,0.128,0.276,0.17,0.415,0.259c-1.157,0.662-2.258,1.455-3.271,2.421 c-0.577-0.566-1.269-1.023-1.976-1.581c-1.821-1.435-3.572-2.961-5.315-4.489c-1.79-1.567-3.562-3.178-5.397-4.7 C31.383,95.048,31.281,92.519,31.183,89.989z M31.648,101.782c0.936,0.977,1.885,1.943,2.826,2.901 c1.619,1.649,3.265,3.273,4.959,4.845c0.689,0.64,1.381,1.338,2.164,1.836c-1.12,1.657-2.083,3.59-2.838,5.847 c-0.01,0.03,0.004,0.052-0.005,0.082c-0.546-1.699-3.022-2.523-4.396-3.444c-0.81-0.543-1.524-1.217-2.304-1.804 C31.921,108.623,31.781,105.203,31.648,101.782z M32.238,116.703c1.437,1.156,3.652,3.372,5.518,2.649 c0.337-0.13,0.569-0.362,0.766-0.612c-1.872,3.362-2.609,7.101-2.498,10.896c-1.181-0.724-2.305-1.519-3.37-2.411 C32.527,123.717,32.373,120.211,32.238,116.703z M36.47,133.858c0.668,3.483,1.97,6.909,3.779,10.023 c-2.385-1.476-4.767-2.958-7.148-4.439c-0.088-2.691-0.201-5.384-0.296-8.075C34.017,132.401,35.296,133.32,36.47,133.858z M39.775,175.909c-6.652-0.674-7.084-7.227-6.711-14.008c6.405,5.117,12.672,10.416,19.236,15.321 C48.125,176.778,43.953,176.332,39.775,175.909z M63.058,178.351c-1.781-0.182-3.561-0.373-5.341-0.56 c-0.036-0.481-0.243-0.957-0.722-1.31c-7.999-5.884-15.679-12.203-23.701-18.055c0.159-2.165,0.306-4.258,0.258-6.078 c-0.005-0.208-0.016-0.416-0.021-0.624c5.513,4.839,11.17,9.537,17.004,13.955c5.248,3.975,10.959,9.624,17.031,13.091 C66.06,178.627,64.578,178.507,63.058,178.351z M74.097,179.38c0.048-0.346-0.002-0.701-0.22-1.021 c-3.803-5.597-11.166-9.195-16.618-13.024c-8.093-5.686-16.202-11.313-23.864-17.564c-0.05-1.715-0.127-3.43-0.181-5.145 c17.246,12.86,35.352,24.533,52.466,37.576C81.848,179.974,77.996,179.708,74.097,179.38z M94.955,180.638 c-9.902-7.814-20.283-14.945-30.863-21.784c2.506,0.046,4.99-0.295,7.389-1.01c7.95,9.88,19.823,16.138,30.53,22.952 C99.664,180.768,97.312,180.717,94.955,180.638z M109.559,180.79c-0.113-0.232-0.275-0.452-0.51-0.646 c-7.166-5.881-15.46-9.99-23.24-14.854c4.041,0.052,8.084,0.062,12.126,0.091c3.62,3.092,7.329,6.065,11.104,8.967 c2.295,1.764,4.908,4.282,7.67,6.192C114.324,180.638,111.94,180.756,109.559,180.79z M123.018,180.211 c-2.387-2.894-6.306-4.691-9.368-6.756c-3.773-2.544-7.431-5.257-11.033-8.039c2.036,0.011,4.072,0.039,6.108,0.046 c1.614,0.005,3.282-1.148,3.642-2.773c0.028-0.126,0.056-0.291,0.083-0.421c7.424,5.751,14.992,11.399,22.648,16.815 C131.053,179.553,127.026,179.944,123.018,180.211z M140.431,178.408c-7.773-7.788-18.092-13.08-27.406-19.053 c0.47-2.664,0.792-5.677,0.696-8.561c5.188,6.33,11.747,11.466,18.27,16.339c3.529,2.636,9.788,8.314,15.201,10.233 C144.929,177.749,142.676,178.094,140.431,178.408z M154.96,176.031c-0.253,0.003-0.493-0.024-0.771,0.032 c-0.563,0.116-1.118,0.203-1.68,0.313c-0.029-0.109-0.022-0.212-0.081-0.324c-2.55-4.845-12.061-8.097-16.62-11.026 c-7.606-4.889-14.756-10.404-21.305-16.636c-0.352-0.334-0.711-0.331-1.034-0.219c-0.079-0.52-0.117-1.06-0.239-1.553 c4.316,4.309,10.399,7.082,17.439,7.722c0.433,0.039,0.855,0.031,1.283,0.043c5.006,3.158,9.609,6.897,14.238,10.588 c2.973,2.371,6.34,5.79,10.162,6.717C155.906,173.137,155.512,174.587,154.96,176.031z M157.393,168.25 c-2.916-2.792-7.2-4.909-10.346-7.224c-3.362-2.473-6.744-4.878-10.274-7.057c2.763-0.571,5.312-1.728,7.626-3.26 c1.767,1.364,3.507,2.759,5.289,4.101c2.389,1.798,5.989,5.744,9.128,5.822c0.02,0.001,0.03-0.012,0.048-0.012 C158.49,163.168,158.036,165.712,157.393,168.25z M159.278,157.288c-1.737-1.98-5.21-3.486-7.098-4.761 c-1.778-1.199-3.546-2.411-5.312-3.63c1.333-1.147,2.518-2.465,3.602-3.87c0.545,0.321,1.07,0.664,1.626,0.974 c2.443,1.355,4.975,2.918,7.637,3.89C159.665,152.358,159.539,154.826,159.278,157.288z M154.282,144.461 c-0.88-0.385-1.729-0.838-2.591-1.267c1.291-1.986,2.323-4.139,3.09-6.379c1.368,0.942,3.164,2.281,4.787,2.406 c0.14,2.532,0.226,5.063,0.225,7.592C158.015,145.911,156.072,145.245,154.282,144.461z"/><path d="M137.211,126.925c-0.398-1.737-1.835-2.834-3.541-3.573c-0.163-0.374-0.387-0.84-0.284-0.283 c-0.439-2.388-3.579-3.254-5.471-2.094c-0.51,0.312-0.979,0.689-1.428,1.089c-1.104,0.332-1.969,1.119-2.319,2.235 c-0.026,0.025-0.053,0.05-0.077,0.076c-1.615,0.452-2.661,2.242-2.546,3.976c-0.172,0.734-0.243,1.509-0.099,2.368 c0.58,3.428,5.269,5.486,8.343,5.368c3.416-0.131,5.257-2.344,5.706-5.07c0.024-0.019,0.05-0.043,0.074-0.062 C136.912,129.937,137.604,128.643,137.211,126.925z"/></g></g></svg>`;

        const tooltip = document.createElement('div');
        tooltip.className = 'chat-tooltip';
        tooltip.textContent = '–í–∞—à AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç Senti —Ç—É—Ç! –Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–µ.';

        chatContainer.appendChild(chatBtn);
        chatContainer.appendChild(tooltip);
        document.body.appendChild(chatContainer);

        chatBtn.addEventListener('click', () => {
            assistantContainer.classList.toggle('hidden');
        });
        // --- End of chat button setup ---

        checkSession();

        backToMenuBtn.addEventListener('click', showMainMenu);
        backToMenuFromResultsBtn.addEventListener('click', showMainMenu);
    });

    let currentScenario = ''; // To store the scenario for the current session

    function showSimulatorView() {
        windowTitle.textContent = '–î–∏–∞–ª–æ–≥–æ–≤—ã–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä';
        document.getElementById('main-content-wrapper').classList.add('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden');
        simulatorView.classList.remove('hidden');
        backToMenuBtn.classList.remove('hidden');

        simulatorSetup.classList.remove('hidden');
        simulatorChatArea.classList.add('hidden');
        simulatorEvaluationArea.classList.add('hidden');
        simulatorChatBox.innerHTML = '';
        simulationHistory = [];
        currentScenario = ''; // Reset scenario
    }

    launchSimulatorBtn.addEventListener('click', showSimulatorView);
    restartSimulationBtn.addEventListener('click', showSimulatorView);

    function appendSimulatorMessage(text, role, isThinking = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}-message`;
        const textSpan = document.createElement('span');
        textSpan.textContent = text;
        if (isThinking) {
            messageDiv.classList.add('thinking');
            messageDiv.id = 'simulator-thinking-indicator';
        }
        messageDiv.appendChild(textSpan);
        simulatorChatBox.appendChild(messageDiv);
        simulatorChatBox.scrollTop = simulatorChatBox.scrollHeight;
    }

    function updateLastSimulatorMessage(text) {
        const thinkingIndicator = document.getElementById('simulator-thinking-indicator');
        if (thinkingIndicator) {
            thinkingIndicator.querySelector('span').textContent = text;
            thinkingIndicator.classList.remove('thinking');
            thinkingIndicator.id = '';
        }
    }

    startSimulationBtn.addEventListener('click', async () => {
        simulatorSetup.classList.add('hidden');
        simulatorChatArea.classList.remove('hidden');
        appendSimulatorMessage('...', 'assistant', true);

        try {
            const disposition = document.getElementById('disposition-slider').value;
            const data = await fetchAuthenticated('/api/dialogueSimulator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'start', disposition })
            });

            if (!data.scenario || !data.first_message) {
                throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Å—Ü–µ–Ω–∞—Ä–∏–π –∏–ª–∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.");
            }

            currentScenario = data.scenario; // This is the critical assignment
            updateLastSimulatorMessage(data.first_message);
            simulationHistory.push({ role: 'assistant', text: data.first_message });

        } catch (error) {
            updateLastSimulatorMessage(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∏–º—É–ª—è—Ü–∏–∏: ${error.message}`);
        }
    });

    simulatorChatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userInput = simulatorChatInput.value.trim();
        if (!userInput) return;

        appendSimulatorMessage(userInput, 'user');
        simulationHistory.push({ role: 'user', text: userInput });
        simulatorChatInput.value = '';
        simulatorChatInput.disabled = true;
        appendSimulatorMessage('...', 'assistant', true);

        try {
            if (!currentScenario) { // Defensive check
                throw new Error("–°—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ –±—ã–ª –Ω–∞—á–∞—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—Ä–µ–Ω–∞–∂–µ—Ä.");
            }
            const disposition = document.getElementById('disposition-slider').value;
            const data = await fetchAuthenticated('/api/dialogueSimulator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    history: simulationHistory,
                    disposition: disposition,
                    scenario: currentScenario, // Ensure this is passed
                    action: 'chat'
                })
            });
            const aiResponse = data.answer ? data.answer.trim() : '';
            if (aiResponse) {
                updateLastSimulatorMessage(aiResponse);
                simulationHistory.push({ role: 'assistant', text: aiResponse });
            } else {
                updateLastSimulatorMessage("–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞—Ç—å.");
            }
        } catch (error) {
            updateLastSimulatorMessage(`–û—à–∏–±–∫–∞: ${error.message}`);
        } finally {
            simulatorChatInput.disabled = false;
            simulatorChatInput.focus();
        }
    });

    endSimulationBtn.addEventListener('click', async () => {
        if (simulationHistory.length === 0) {
            alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥.');
            return;
        }
        if (!currentScenario) { // Defensive check
            alert("–û—à–∏–±–∫–∞: —Å—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—Ä–µ–Ω–∞–∂–µ—Ä.");
            return;
        }
        simulatorChatArea.classList.add('hidden');
        simulatorEvaluationArea.classList.remove('hidden');
        evaluationResults.innerHTML = '<div class="loader"></div>';

        try {
             const disposition = document.getElementById('disposition-slider').value;
             const data = await fetchAuthenticated('/api/dialogueSimulator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    history: simulationHistory,
                    action: 'evaluate',
                    disposition: disposition,
                    scenario: currentScenario // Ensure this is passed
                })
            });

            evaluationResults.innerHTML = '';
            const evaluationData = data.answer;

            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ –∏ –æ—Ü–µ–Ω–∫—É';
            downloadBtn.style.marginTop = '10px';
            downloadBtn.style.marginBottom = '15px';

            downloadBtn.onclick = () => {
                const dialogueText = simulationHistory.map(h => `${h.role.toUpperCase()}: ${h.text}`).join('\n');
                const evaluationText = JSON.stringify(evaluationData, null, 2);
                const fullText = `–°–¶–ï–ù–ê–†–ò–ô: ${currentScenario}\n\n–î–ò–ê–õ–û–ì\n--------------------\n${dialogueText}\n\n–û–¶–ï–ù–ö–ê –ò–ò\n--------------------\n${evaluationText}`;
                const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dialogue-evaluation-${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            evaluationResults.appendChild(downloadBtn);

            const resultsTable = document.createElement('table');
            resultsTable.style.width = '100%';
            resultsTable.style.borderCollapse = 'collapse';
            resultsTable.innerHTML = `
                <tr style="background-color: var(--bg-color);">
                    <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left;">–ö—Ä–∏—Ç–µ—Ä–∏–π</th>
                    <th style="border: 1px solid var(--border-color); padding: 8px; text-align: center;">–û—Ü–µ–Ω–∫–∞</th>
                    <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                </tr>
            `;
            if(evaluationData.evaluation_criteria) {
                evaluationData.evaluation_criteria.forEach(item => {
                    resultsTable.innerHTML += `
                        <tr>
                            <td style="border: 1px solid var(--border-color); padding: 8px;">${item.criterion}</td>
                            <td style="border: 1px solid var(--border-color); padding: 8px; text-align: center; font-weight: bold;">${item.score}/10</td>
                            <td style="border: 1px solid var(--border-color); padding: 8px;">${item.comment}</td>
                        </tr>
                    `;
                });
            }
            evaluationResults.appendChild(resultsTable);

            const summary = document.createElement('div');
            summary.style.marginTop = '15px';
            if(evaluationData.average_score && evaluationData.general_comment) {
                summary.innerHTML = `
                    <h4 style="margin-bottom: 5px;">–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: <span style="color: var(--primary-color);">${evaluationData.average_score.toFixed(1)}</span></h4>
                    <p><strong>–û–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${evaluationData.general_comment}</p>
                `;
            }
            evaluationResults.appendChild(summary);

        } catch (error) {
            evaluationResults.textContent = `–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏: ${error.message}`;
        }
    });

</script>
</body>
</html>
