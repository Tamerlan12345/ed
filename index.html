<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –û–±—É—á–µ–Ω–∏—è | Centras Insurance</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap');
        :root{--primary-color:#005A9C;--secondary-color:#00AEEF;--bg-color:#f4f7f6;--surface-color:#ffffff;--text-color:#333333;--text-light-color:#777777;--border-color:#e0e0e0;--success-color:#28a745;--error-color:#dc3545;--shadow:0 4px 15px rgba(0,0,0,0.08)}*{box-sizing:border-box}body,html{height:100%;margin:0;background-color:var(--bg-color);color:var(--text-color);font-family:'Lato',sans-serif;font-size:16px}.hidden{display:none !important}.container{width:100%;height:100%;padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center}.window{border:1px solid var(--border-color);padding:30px;box-shadow:var(--shadow);background:var(--surface-color);border-radius:12px;width:100%;max-width:900px;position:relative}.window-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);padding-bottom:15px;margin-bottom:25px}.window-header h1,.window-header h2{margin:0;font-size:1.8em;color:var(--primary-color);font-weight:700}.logo{height:45px;width:auto}.content-area{height:60vh;overflow-y:auto;padding-right:15px}.content-area::-webkit-scrollbar{width:8px}.content-area::-webkit-scrollbar-track{background:#f1f1f1}.content-area::-webkit-scrollbar-thumb{background:var(--secondary-color);border-radius:4px}.content-area::-webkit-scrollbar-thumb:hover{background:var(--primary-color)}input[type="text"],input[type="email"],input[type="password"]{background-color:var(--bg-color);border:1px solid var(--border-color);color:var(--text-color);padding:12px 15px;margin-bottom:15px;width:100%;font-family:'Lato',sans-serif;border-radius:8px;transition:border-color .3s,box-shadow .3s}input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(0,90,166,0.2)}button,.btn{background:var(--primary-color);border:none;color:#fff;padding:12px 25px;cursor:pointer;transition:all .3s ease;box-shadow:0 2px 8px rgba(0,0,0,0.1);border-radius:10px;font-weight:700;font-family:'Lato',sans-serif;letter-spacing:.2px;margin-top:10px}button:hover,.btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,90,166,0.2);background:var(--secondary-color)}button:disabled{background:var(--text-light-color);cursor:not-allowed;transform:none;box-shadow:none}#auth-error{color:var(--error-color);margin-top:10px;text-align:center;font-weight:bold}#main-menu{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px}.menu-item{padding:20px;border:1px solid var(--border-color);border-radius:10px;cursor:pointer;transition:all .3s ease;background-color:var(--surface-color)}.menu-item:hover{transform:translateY(-5px);box-shadow:var(--shadow);border-color:var(--primary-color)}.menu-item h3{margin-top:0;color:var(--primary-color);display:flex;align-items:center}.menu-item-icon{font-size:1.5em;margin-right:15px;color:var(--secondary-color)}.menu-item.completed{border-left:5px solid var(--success-color)}.menu-item.completed h3{color:var(--success-color)}.menu-item.completed::after{content:'‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ';color:var(--success-color);font-size:.8em;font-weight:bold;display:block;margin-top:10px}#product-content h2,#product-content h3{color:var(--primary-color)}#product-content h3{border-bottom:2px solid var(--secondary-color);padding-bottom:5px;margin-top:25px}#product-content ul{list-style-type:'‚úì ';padding-left:20px}#product-content li{padding-left:10px;margin-bottom:10px}#test-view .question{margin-bottom:20px;font-size:1.3em;font-weight:bold;color:var(--primary-color)}#test-view .answers{display:flex;flex-direction:column;gap:10px}#test-view .answer{border:2px solid var(--border-color);padding:15px;cursor:pointer;border-radius:8px;transition:all .2s ease-in-out}#test-view .answer:hover{background-color:#e9f7fe;border-color:var(--secondary-color)}#test-results p{font-size:1.2em}#test-results .score{color:var(--primary-color);font-weight:bold;font-size:2em}.window-footer{margin-top:20px;border-top:1px solid var(--border-color);padding-top:20px;display:flex;justify-content:space-between;align-items:center}#back-to-menu-btn{background:var(--text-light-color)}#back-to-menu-btn:hover{background:#555;box-shadow:0 4px 10px rgba(0,0,0,0.2)}.loader{width:50px;height:50px;border:5px solid var(--bg-color);border-top-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin:50px auto}.message{text-align:center;padding:20px;font-size:1.1em;color:var(--text-light-color)}@keyframes spin{to{transform:rotate(360deg)}}#assistant-container{margin-top:30px;padding-top:20px;border-top:1px dashed var(--border-color)}#assistant-container h3{color:var(--primary-color);margin-top:0}#chat-box{height:150px;overflow-y:auto;border:1px solid var(--border-color);border-radius:8px;padding:10px;margin-bottom:10px;background-color:var(--bg-color)}.chat-message{margin-bottom:10px}.user-message{text-align:right}.assistant-message span{background-color:#e9f7fe;padding:5px 10px;border-radius:10px;display:inline-block}.thinking{color:var(--text-light-color);font-style:italic}#chat-form{display:flex;gap:10px}#chat-input{flex-grow:1;margin:0}#chat-form button{margin:0}#admin-controls{text-align:right;margin-bottom:15px}
    </style>
    <style>
        .tab-btn{padding:10px 20px;border:none;background-color:transparent;cursor:pointer;font-size:1em;color:var(--text-light-color);border-bottom:3px solid transparent;margin-bottom:-2px}.tab-btn.active{color:var(--primary-color);border-bottom-color:var(--primary-color);font-weight:bold}
        #product-nav { padding: 10px; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); margin-bottom: 15px; }
        #product-nav a { margin-right: 15px; text-decoration: none; color: var(--text-light-color); font-weight: bold; }
        #product-nav a.active { color: var(--primary-color); }
        #product-nav a .lock-icon { display: inline-block; margin-left: 5px; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2?v=4"></script>
    
    <script>
        const SUPABASE_URL = 'https://wnsdlibhrlmgyszbyxat.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Induc2RsaWJocmxtZ3lzemJ5eGF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyODE0MjgsImV4cCI6MjA2OTg1NzQyOH0.Sgz-50dHj8M599sIjTRYs0kMP7b6kX2BJ-Gc-trMUQ4';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
</head>
<body>
    <div id="auth-view" class="container">
        <div class="window">
            <div class="window-header"><h1>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1></div>
            <form id="auth-form">
                <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—ã–¥–∞–Ω–Ω—ã–µ –≤–∞–º –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.</p>
                <input type="email" id="user-email" placeholder="–†–∞–±–æ—á–∏–π Email" required>
                <input type="password" id="user-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
                <div id="auth-error" class="hidden"></div>
                <button type="submit" id="auth-button">–í–æ–π—Ç–∏</button>
            </form>
        </div>
    </div>

    <div id="app-view" class="container hidden">
        <div class="window">
             <div class="window-header">
                <h2 id="window-title">–ì–ª–∞–≤–Ω–æ–µ –ú–µ–Ω—é</h2>
                <div class="header-controls">
                    <div id="notifications-bell" style="position: relative; cursor: pointer;">
                        <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M21 19v1H3v-1l2-2v-6c0-3.1 2.03-5.83 5-6.71V4a2 2 0 0 1 2-2a2 2 0 0 1 2 2v.29c2.97.88 5 3.61 5 6.71v6l2 2m-7 2a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2"/></svg>
                        <span id="notifications-badge" class="hidden" style="position: absolute; top: -5px; right: -5px; background: var(--error-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; align-items: center; justify-content: center;"></span>
                    </div>
                    <div id="notifications-panel" class="hidden" style="position: absolute; top: 60px; right: 20px; width: 300px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow); z-index: 100;">
                        <div style="padding: 10px; border-bottom: 1px solid var(--border-color); font-weight: bold;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                        <div id="notifications-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
                 <img src="https://centras.kz/wp-content/uploads/2023/12/centras-insurance-col.png" alt="Logo" class="logo">
            </div>
            <div class="content-area" id="content-area">
                <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                    <div id="leaderboard-container" style="flex: 1 1 300px; min-width: 280px; padding: 15px; background-color: #e9f7fe; border-radius: 8px; align-self: flex-start;">
                        <h3 style="margin-top: 0; color: var(--primary-color);">üèÜ –¢–æ–ø –£—á–µ–Ω–∏–∫–æ–≤ –ù–µ–¥–µ–ª–∏</h3>
                        <div id="leaderboard-content"></div>
                    </div>
                    <div id="main-content-wrapper" style="flex: 2 1 500px;">
                        <div id="main-menu-tabs" style="display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 15px;">
                            <button class="tab-btn active" data-filter="assigned">–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ</button>
                            <button class="tab-btn" data-filter="completed">–ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ</button>
                            <button class="tab-btn" data-filter="future">–ë—É–¥—É—â–∏–µ</button>
                            <button class="tab-btn" data-filter="catalog">–ö–∞—Ç–∞–ª–æ–≥</button>
                        </div>
                        <div id="main-menu"></div>
                        <div id="extra-tools" style="padding-top: 20px; border-top: 1px solid #eee;">
                            <button id="launch-simulator-btn">–î–∏–∞–ª–æ–≥–æ–≤—ã–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä</button>
                        </div>
                        <div id="admin-controls" class="hidden"></div>
                        <div id="product-content" class="hidden"></div>
                        <div id="audio-player-container-user" style="margin-top: 15px;"></div>
                        <div id="assistant-container" class="hidden">
                            <h3>AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h3>
                            <div id="chat-box"></div>
                            <form id="chat-form">
                                <input type="text" id="chat-input" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª—É..." autocomplete="off">
                                <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div id="test-view" class="hidden">
                    <p id="question-counter"></p>
                    <div id="question" class="question"></div>
                    <div id="answers" class="answers"></div>
                    <button id="next-question-btn" class="hidden">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
                </div>
                <div id="test-results" class="hidden">
                     <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
                    <p>–ü—Ä–æ–¥—É–∫—Ç: <span id="results-product-name"></span></p>
                    <p>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span id="results-score" class="score"></span></p>
                    <p id="results-feedback"></p>
                    <button id="back-to-menu-from-results">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</button>
                </div>
                <div id="simulator-view" class="hidden">
                    <div id="simulator-setup">
                        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–∞</h3>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–ª–∏–µ–Ω—Ç–∞, —Å –∫–æ—Ç–æ—Ä—ã–º —Ö–æ—Ç–∏—Ç–µ –ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è.</p>
                        <select id="persona-selector">
                            <option value="cold">"–•–æ–ª–æ–¥–Ω—ã–π" –∫–ª–∏–µ–Ω—Ç</option>
                            <option value="interested">–ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç</option>
                            <option value="aggressive">–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –∫–ª–∏–µ–Ω—Ç</option>
                        </select>
                        <button id="start-simulation-btn">–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥</button>
                    </div>
                    <div id="simulator-chat-area" class="hidden">
                        <div id="simulator-chat-box" style="height: 45vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; margin-bottom: 10px; background-color: var(--bg-color);"></div>
                        <form id="simulator-chat-form" style="display: flex; gap: 10px;">
                            <input type="text" id="simulator-chat-input" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..." autocomplete="off" style="flex-grow: 1; margin: 0;">
                            <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </form>
                        <button id="end-simulation-btn" style="margin-top: 10px; background-color: var(--error-color);">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
                    </div>
                    <div id="simulator-evaluation-area" class="hidden">
                        <h3>–û—Ü–µ–Ω–∫–∞ –¥–∏–∞–ª–æ–≥–∞</h3>
                        <div id="evaluation-results" style="white-space: pre-wrap; background-color: var(--bg-color); padding: 15px; border-radius: 8px;"></div>
                        <button id="restart-simulation-btn" style="margin-top: 10px;">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
                    </div>
                </div>
            </div>
            <div class="window-footer">
                <button id="back-to-menu-btn" class="hidden">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
            </div>
        </div>
    </div>

<script>
    const userData = { email: '', token: null };
    let courses = [];
    let currentCourse = null;
    let userProgress = {}; 
    
    const authView = document.getElementById('auth-view');
    const appView = document.getElementById('app-view');
    const authForm = document.getElementById('auth-form');
    const authError = document.getElementById('auth-error');
    const contentArea = document.getElementById('content-area');
    const mainMenu = document.getElementById('main-menu');
    const productContent = document.getElementById('product-content');
    const testView = document.getElementById('test-view');
    const testResultsView = document.getElementById('test-results');
    const windowTitle = document.getElementById('window-title');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');
    const backToMenuFromResultsBtn = document.getElementById('back-to-menu-from-results');
    const audioPlayerContainerUser = document.getElementById('audio-player-container-user');
    const assistantContainer = document.getElementById('assistant-container');
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const adminControls = document.getElementById('admin-controls');
    const notificationsBell = document.getElementById('notifications-bell');
    const notificationsBadge = document.getElementById('notifications-badge');
    const notificationsPanel = document.getElementById('notifications-panel');
    const notificationsList = document.getElementById('notifications-list');

    // --- Simulator UI Elements ---
    const simulatorView = document.getElementById('simulator-view');
    const launchSimulatorBtn = document.getElementById('launch-simulator-btn');
    const extraToolsDiv = document.getElementById('extra-tools');
    const simulatorSetup = document.getElementById('simulator-setup');
    const simulatorChatArea = document.getElementById('simulator-chat-area');
    const simulatorEvaluationArea = document.getElementById('simulator-evaluation-area');
    const personaSelector = document.getElementById('persona-selector');
    const startSimulationBtn = document.getElementById('start-simulation-btn');
    const simulatorChatBox = document.getElementById('simulator-chat-box');
    const simulatorChatForm = document.getElementById('simulator-chat-form');
    const simulatorChatInput = document.getElementById('simulator-chat-input');
    const endSimulationBtn = document.getElementById('end-simulation-btn');
    const evaluationResults = document.getElementById('evaluation-results');
    const restartSimulationBtn = document.getElementById('restart-simulation-btn');

    function showLoader() { contentArea.innerHTML = '<div class="loader"></div>'; }
    function showMessage(message, details = '') { contentArea.innerHTML = `<div class="message">${message}<br><small style="color: #999;">${details}</small></div>`; }

    function initAuth() {
        console.log('[–®–ê–ì 1] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–∞.');
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('[–®–ê–ì 2] –ö–Ω–æ–ø–∫–∞ "–í–æ–π—Ç–∏" –Ω–∞–∂–∞—Ç–∞.');
            authError.classList.add('hidden');
            const email = document.getElementById('user-email').value.trim();
            const password = document.getElementById('user-password').value.trim();
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                console.log('[–®–ê–ì 3] –û—Ç–≤–µ—Ç –æ—Ç Supabase –ø–æ–ª—É—á–µ–Ω, –æ—à–∏–±–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –û—Ç–≤–µ—Ç:', data);
                
                if (data && data.session && data.session.access_token) {
                    userData.email = data.user.email;
                    userData.token = data.session.access_token;
                    console.log('[–®–ê–ì 4] –¢–æ–∫–µ–Ω –∏ email —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –¢–æ–∫–µ–Ω:', userData.token ? '–ü–û–õ–£–ß–ï–ù' : '–û–¢–°–£–¢–°–¢–í–£–ï–¢', '| Email:', userData.email);
                    
                    authView.classList.add('hidden');
                    appView.classList.remove('hidden');
                    showMainMenu();
                    loadNotifications();
                } else {
                    throw new Error("–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ—Å—Å–∏—é –∏–ª–∏ —Ç–æ–∫–µ–Ω.");
                }
            } catch (error) {
                console.error("[–û–®–ò–ë–ö–ê –ù–ê –®–ê–ì–ï 3] –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏:", error);
                authError.textContent = '–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å.';
                authError.classList.remove('hidden');
            }
        });
    }

    async function fetchAuthenticated(url, options = {}) {
        console.log(`[–ó–ê–ü–†–û–°] –í—ã–∑–æ–≤ fetchAuthenticated –¥–ª—è URL: ${url}`);
        if (!userData.token) {
            console.error("[–û–®–ò–ë–ö–ê –ó–ê–ü–†–û–°–ê] –¢–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –ó–∞–ø—Ä–æ—Å –æ—Ç–º–µ–Ω–µ–Ω.");
            throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.");
        }
        const defaultHeaders = { 'Authorization': `Bearer ${userData.token}` };
        const finalOptions = { ...options, headers: { ...defaultHeaders, ...options.headers } };
        
        console.log('[–ó–ê–ü–†–û–°] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å —Ç–æ–∫–µ–Ω–æ–º.');
        const response = await fetch(url, finalOptions);
        
        if (!response.ok) {
            console.error(`[–û–®–ò–ë–ö–ê –ó–ê–ü–†–û–°–ê] –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É ${response.status}`);
            const errorData = await response.json().catch(() => ({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.statusText} (${response.status})` }));
            throw new Error(errorData.error);
        }
        console.log(`[–ó–ê–ü–†–û–°] –ü–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è ${url}.`);
        return response.json();
    }

    async function loadNotifications() {
        try {
            const notifications = await fetchAuthenticated('/.netlify/functions/getNotifications');
            notificationsList.innerHTML = '';
            if (notifications.length === 0) {
                notificationsList.innerHTML = '<p style="padding: 15px; text-align: center; color: #888;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç.</p>';
            }

            let unreadCount = 0;
            notifications.forEach(n => {
                const notifDiv = document.createElement('div');
                notifDiv.style.padding = '10px 15px';
                notifDiv.style.borderBottom = '1px solid var(--border-color)';
                if (!n.is_read) {
                    notifDiv.style.fontWeight = 'bold';
                    unreadCount++;
                }
                notifDiv.textContent = n.message;
                notificationsList.appendChild(notifDiv);
            });

            if (unreadCount > 0) {
                notificationsBadge.textContent = unreadCount;
                notificationsBadge.classList.remove('hidden');
            } else {
                notificationsBadge.classList.add('hidden');
            }
        } catch (error) {
            console.error('Failed to load notifications:', error);
        }
    }

    notificationsBell.addEventListener('click', async () => {
        const isHidden = notificationsPanel.classList.toggle('hidden');
        if (!isHidden) {
            const notifications = await fetchAuthenticated('/.netlify/functions/getNotifications');
            const unreadNotificationIds = notifications.filter(n => !n.is_read).map(n => n.id);

            if (unreadNotificationIds.length > 0) {
                try {
                    await fetchAuthenticated('/.netlify/functions/markNotificationsAsRead', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notification_ids: unreadNotificationIds })
                    });
                    notificationsBadge.classList.add('hidden');
                    notificationsList.querySelectorAll('div').forEach(div => div.style.fontWeight = 'normal');
                } catch (error) {
                    console.error('Failed to mark notifications as read:', error);
                }
            }
        }
    });

    async function loadLeaderboard() {
        const leaderboardContent = document.getElementById('leaderboard-content');
        leaderboardContent.innerHTML = '<div class="loader" style="height: 20px; width: 20px; margin: 0;"></div>';
        try {
            const leaderboardData = await fetchAuthenticated('/.netlify/functions/get-leaderboard');
            if (!leaderboardData || leaderboardData.length === 0) {
                leaderboardContent.innerHTML = '<p>–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç –ª–∏–¥–µ—Ä–æ–≤. –°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>';
                return;
            }

            let html = '<ol style="margin: 0; padding-left: 20px;">';
            leaderboardData.forEach(user => {
                html += `<li style="margin-bottom: 5px;"><strong>${user.full_name || '–ê–Ω–æ–Ω–∏–º'}</strong>: –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∫—É—Ä—Å–æ–≤: ${user.courses_completed || 0}, –í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è: ${user.total_time_spent_minutes || 0} –º–∏–Ω.</li>`;
            });
            html += '</ol>';
            leaderboardContent.innerHTML = html;

        } catch (error) {
            console.error('Failed to load leaderboard:', error);
            leaderboardContent.innerHTML = '<p style="color: var(--error-color);">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∏–¥–µ—Ä–±–æ—Ä–¥.</p>';
        }
    }

    async function showMainMenu() {
        console.log('[–®–ê–ì 5] –ó–∞–ø—É—Å–∫ showMainMenu –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤.');
        stopTimeTracking();
        windowTitle.textContent = '–ì–ª–∞–≤–Ω–æ–µ –ú–µ–Ω—é';

        document.getElementById('leaderboard-container').classList.remove('hidden');
        document.getElementById('main-content-wrapper').classList.remove('hidden');

        productContent.classList.add('hidden');
        testView.classList.add('hidden');
        testResultsView.classList.add('hidden');
        assistantContainer.classList.add('hidden');
        simulatorView.classList.add('hidden');
        
        mainMenu.classList.remove('hidden');
        document.getElementById('main-menu-tabs').classList.remove('hidden');
        extraToolsDiv.classList.remove('hidden');
        backToMenuBtn.classList.add('hidden');

        loadLeaderboard();
        mainMenu.innerHTML = '<div class="loader"></div>';

        try {
            console.log('[–®–ê–ì 6] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /getCourses...');
            const data = await fetchAuthenticated(`/.netlify/functions/getCourses`);
            console.log('[–®–ê–ì 7] –û—Ç–≤–µ—Ç –æ—Ç /getCourses –ø–æ–ª—É—á–µ–Ω. –î–∞–Ω–Ω—ã–µ:', data);
            
            if (!data || !Array.isArray(data.courses)) {
                throw new Error("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Å—Å–∏–≤ –∫—É—Ä—Å–æ–≤.");
            }

            courses = data.courses;
            userProgress = data.userProgress;

            const tabsContainer = document.getElementById('main-menu-tabs');
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    tabsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    const filter = e.target.dataset.filter;
                    renderCourses(filter);
                }
            });

            renderCourses('assigned');
            console.log('[–®–ê–ì 8] –ú–µ–Ω—é –∫—É—Ä—Å–æ–≤ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–æ.');

        } catch (error) {
            console.error('[–û–®–ò–ë–ö–ê –ù–ê –®–ê–ì–ï 6/7] –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—É—Ä—Å—ã:', error);
            showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤.', error.message);
        }
    }

    function renderCourses(filter) {
        mainMenu.innerHTML = '';
        let coursesToRender;
        const now = new Date();
        now.setHours(0, 0, 0, 0); // Set to start of today for date comparison

        switch (filter) {
            case 'assigned':
                coursesToRender = courses.filter(c => {
                    const progress = userProgress[c.id];
                    const isCompleted = progress && progress.completed;
                    const startDate = c.startDate ? new Date(c.startDate) : null;
                    const isFuture = startDate && startDate > now;
                    return c.isAssigned && !isCompleted && !isFuture;
                });
                if (coursesToRender.length === 0) {
                    mainMenu.innerHTML = '<p class="message">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤.</p>';
                }
                break;
            case 'completed':
                coursesToRender = courses.filter(c => c.isAssigned && userProgress[c.id]?.completed);
                if (coursesToRender.length === 0) {
                    mainMenu.innerHTML = '<p class="message">–í—ã –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫—É—Ä—Å–∞.</p>';
                }
                break;
            case 'future':
                coursesToRender = courses.filter(c => {
                    const startDate = c.startDate ? new Date(c.startDate) : null;
                    return c.isAssigned && startDate && startDate > now;
                });
                if (coursesToRender.length === 0) {
                    mainMenu.innerHTML = '<p class="message">–£ –≤–∞—Å –Ω–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±—É–¥—É—â–∏—Ö –∫—É—Ä—Å–æ–≤.</p>';
                }
                break;
            case 'catalog':
                coursesToRender = courses.filter(c => !c.isAssigned);
                 if (coursesToRender.length === 0) {
                    mainMenu.innerHTML = '<p class="message">–í –∫–∞—Ç–∞–ª–æ–≥–µ –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—Å–æ–≤.</p>';
                }
                break;
            default:
                coursesToRender = [];
        }

        if (coursesToRender.length > 0) {
            if (filter === 'catalog') {
                const groupedCourses = coursesToRender.reduce((acc, course) => {
                    const key = course.product_line || '–†–∞–∑–Ω–æ–µ';
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(course);
                    return acc;
                }, {});

                for (const groupName in groupedCourses) {
                    const groupWrapper = document.createElement('div');
                    groupWrapper.innerHTML = `<h3 style="color: var(--primary-color); margin-top: 20px;">${groupName}</h3>`;
                    const courseGrid = document.createElement('div');
                    courseGrid.className = 'main-menu';
                    groupedCourses[groupName].forEach(course => courseGrid.appendChild(createCourseMenuItem(course, 'catalog')));
                    groupWrapper.appendChild(courseGrid);
                    mainMenu.appendChild(groupWrapper);
                }
            } else {
                mainMenu.className = 'main-menu';
                const type = (filter === 'future' || filter === 'completed') ? 'view' : 'assigned';
                coursesToRender.forEach(course => mainMenu.appendChild(createCourseMenuItem(course, type)));
            }
        }
    }

    function createCourseMenuItem(course, type) {
        const menuItem = document.createElement('div');
        menuItem.className = 'menu-item';
        menuItem.style.display = 'flex';
        menuItem.style.flexDirection = 'column';
        menuItem.style.justifyContent = 'space-between';

        const contentDiv = document.createElement('div');
        const progress = userProgress[course.id];
        if (progress && progress.completed) {
             menuItem.classList.add('completed');
        }
        contentDiv.dataset.courseId = course.id;
        contentDiv.innerHTML = `<h3><span class="menu-item-icon">üìñ</span>${course.title}</h3>`;

        if (course.startDate) {
            const startDate = new Date(course.startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (startDate >= today) {
                 contentDiv.innerHTML += `<p style="color: var(--primary-color); font-weight: bold;">–ù–∞—á–∞–ª–æ: ${startDate.toLocaleDateString('ru-RU')}</p>`;
            }
        }

        if (type === 'assigned') {
            contentDiv.innerHTML += `<p>–ü–µ—Ä–µ–π—Ç–∏ –∫ —É—á–µ–±–Ω–æ–º—É –º–æ–¥—É–ª—é...</p>`;
            if(progress && progress.percentage > 0 && !progress.completed) {
                contentDiv.innerHTML += `<div style="width: 100%; background: #eee; border-radius: 5px; margin-top: 10px;"><div style="width: ${progress.percentage}%; background: var(--success-color); height: 5px; border-radius: 5px;"></div></div>`;
            }
            contentDiv.style.cursor = 'pointer';
            contentDiv.addEventListener('click', () => showProduct(course.id));
        } else if (type === 'view') {
            // A view-only type for future/completed courses that are not clickable to start
            contentDiv.style.cursor = 'default';
        }

        menuItem.appendChild(contentDiv);

        if (type === 'catalog') {
            const assignBtn = document.createElement('button');
            assignBtn.textContent = '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å';
            assignBtn.className = 'btn';
            assignBtn.style.marginTop = '15px';
            assignBtn.dataset.courseId = course.id;
            assignBtn.onclick = async (e) => {
                e.stopPropagation();
                const button = e.target;
                const courseId = button.dataset.courseId;
                button.disabled = true;
                button.textContent = '–ó–∞–ø–∏—Å—å...';
                try {
                    await fetchAuthenticated('/.netlify/functions/assign-course', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ course_id: courseId })
                    });
                    await showMainMenu();
                } catch (error) {
                    console.error('Failed to self-assign course:', error);
                    alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å: ${error.message}`);
                    button.disabled = false;
                    button.textContent = '–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å';
                }
            };
            menuItem.appendChild(assignBtn);
        }
        return menuItem;
    }
    
    let timeTrackingInterval = null;
    let secondsSinceLastUpdate = 0;

    async function sendTimeUpdate(courseId, seconds) {
        if (!courseId || seconds <= 0) return;
        try {
            await fetchAuthenticated('/.netlify/functions/update-time-spent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ course_id: courseId, seconds_spent: seconds })
            });
            console.log(`Successfully sent ${seconds} seconds for course ${courseId}`);
        } catch (error) {
            console.error('Failed to send time update:', error);
        }
    }

    function stopTimeTracking() {
        if (timeTrackingInterval) {
            clearInterval(timeTrackingInterval);
            timeTrackingInterval = null;
            sendTimeUpdate(currentCourse.id, secondsSinceLastUpdate);
            secondsSinceLastUpdate = 0;
        }
    }

    async function showProduct(courseId, forceRegenerate = false) { currentCourse = courses.find(c => c.id === courseId); if (!currentCourse) return; windowTitle.textContent = currentCourse.title; document.getElementById('main-content-wrapper').classList.add('hidden'); document.getElementById('leaderboard-container').classList.add('hidden'); productContent.classList.remove('hidden'); assistantContainer.classList.remove('hidden'); backToMenuBtn.classList.remove('hidden'); productContent.innerHTML = '<div class="loader"></div>'; audioPlayerContainerUser.innerHTML = ''; const savedChat = sessionStorage.getItem(`chatHistory_${currentCourse.id}`); if (savedChat) { chatBox.innerHTML = savedChat; } else { chatBox.innerHTML = ''; } try { const url = `/.netlify/functions/getCourseContent?course_id=${currentCourse.id}&force_regenerate=${forceRegenerate}`; const data = await fetchAuthenticated(url); currentCourse.summary = data.summary; currentCourse.questions = data.questions; currentCourse.materials = data.materials; let highestUnlockedSlide = 0; if (Array.isArray(currentCourse.summary)) { const nav = document.createElement('div'); nav.id = 'product-nav'; const slidesContainer = document.createElement('div'); productContent.innerHTML = ''; productContent.appendChild(nav); productContent.appendChild(slidesContainer); const updateNavLocks = () => { nav.querySelectorAll('a').forEach((a, i) => { const lockSpan = a.querySelector('.lock-icon'); if (i <= highestUnlockedSlide) { lockSpan.textContent = '‚úÖ'; } else { lockSpan.textContent = 'üîí'; } }); }; currentCourse.summary.forEach((slide, index) => { const slideId = `slide-${index}`; const slideAnchor = document.createElement('a'); slideAnchor.href = `#${slideId}`; slideAnchor.innerHTML = `${index + 1} <span class="lock-icon"></span>`; slideAnchor.addEventListener('click', (e) => { if (index > highestUnlockedSlide) { e.preventDefault(); alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É—Ä–æ–∫–∏, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç.'); } }); nav.appendChild(slideAnchor); const slideDiv = document.createElement('div'); slideDiv.id = slideId; slideDiv.innerHTML = `<h3>${slide.title}</h3>${slide.html_content}<hr style="margin: 20px 0;">`; slidesContainer.appendChild(slideDiv); }); updateNavLocks(); contentArea.onscroll = () => { const scrollBottom = contentArea.scrollTop + contentArea.clientHeight; currentCourse.summary.forEach((slide, index) => { if (index > highestUnlockedSlide) return; const slideDiv = document.getElementById(`slide-${index}`); if (!slideDiv) return; const slideBottom = slideDiv.offsetTop + slideDiv.offsetHeight; if (scrollBottom >= slideBottom - 50) { if (highestUnlockedSlide < currentCourse.summary.length - 1) { highestUnlockedSlide = Math.max(highestUnlockedSlide, index + 1); updateNavLocks(); } } }); }; } else { productContent.innerHTML = currentCourse.summary; } if (currentCourse.materials && currentCourse.materials.length > 0) { const materialsDiv = document.createElement('div'); materialsDiv.innerHTML = '<h3>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</h3>'; const materialsList = document.createElement('ul'); currentCourse.materials.forEach(m => { materialsList.innerHTML += `<li><a href="${m.public_url}" target="_blank" download>${m.file_name}</a></li>`; }); materialsDiv.appendChild(materialsList); productContent.appendChild(materialsDiv); } const listenBtn = document.createElement('button'); listenBtn.textContent = '–û–∑–≤—É—á–∏—Ç—å —Å–∞–º–º–∞—Ä–∏'; listenBtn.onclick = async () => { listenBtn.disabled = true; listenBtn.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ...'; try { const response = await fetchAuthenticated(`/.netlify/functions/text-to-speech-user?course_id=${currentCourse.id}`); const audio = new Audio(response.audioUrl); audio.controls = true; audio.autoplay = true; audioPlayerContainerUser.innerHTML = ''; audioPlayerContainerUser.appendChild(audio); listenBtn.textContent = '–ê—É–¥–∏–æ –≥–æ—Ç–æ–≤–æ'; } catch (error) { console.error('Audio generation failed:', error); listenBtn.textContent = '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏'; } }; productContent.appendChild(listenBtn); const startTestBtn = document.createElement('button'); startTestBtn.id = 'start-test-btn'; startTestBtn.textContent = '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'; startTestBtn.onclick = () => { stopTimeTracking(); startTest(currentCourse.id); }; productContent.appendChild(startTestBtn); if (timeTrackingInterval) clearInterval(timeTrackingInterval); secondsSinceLastUpdate = 0; timeTrackingInterval = setInterval(() => { secondsSinceLastUpdate += 30; sendTimeUpdate(currentCourse.id, 30); }, 30000); } catch (error) { console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∫—É—Ä—Å–∞:', error); showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫—É—Ä—Å–∞.', error.message); } }

    chatForm.addEventListener('submit', async (e) => { e.preventDefault(); const userQuestion = chatInput.value.trim(); if (!userQuestion || !currentCourse) return; appendMessage(userQuestion, 'user'); chatInput.value = ''; chatInput.disabled = true; appendMessage('...', 'assistant', true); try { const url = `/.netlify/functions/askAssistant?course_id=${currentCourse.id}&question=${encodeURIComponent(userQuestion)}`; const data = await fetchAuthenticated(url); updateLastAssistantMessage(data.answer); } catch (error) { console.error('–û—à–∏–±–∫–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞:', error); updateLastAssistantMessage(`–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}`); } finally { chatInput.disabled = false; chatInput.focus(); } });
    function appendMessage(text, sender, isThinking = false) { const messageDiv = document.createElement('div'); messageDiv.className = `chat-message ${sender-message}`; const textSpan = document.createElement('span'); textSpan.textContent = text; if (isThinking) { messageDiv.classList.add('thinking'); messageDiv.id = 'thinking-indicator'; } messageDiv.appendChild(textSpan); chatBox.appendChild(messageDiv); chatBox.scrollTop = chatBox.scrollHeight; if (currentCourse) { sessionStorage.setItem(`chatHistory_${currentCourse.id}`, chatBox.innerHTML); } }
    function updateLastAssistantMessage(text) { const thinkingIndicator = document.getElementById('thinking-indicator'); if (thinkingIndicator) { thinkingIndicator.querySelector('span').textContent = text; thinkingIndicator.classList.remove('thinking'); thinkingIndicator.id = ''; if (currentCourse) { sessionStorage.setItem(`chatHistory_${currentCourse.id}`, chatBox.innerHTML); } } }

    let currentQuestions = [], currentQuestionIndex = 0, score = 0, tabSwitchCount = 0;
    const MAX_ATTEMPTS = 3;
    const MAX_TAB_SWITCHES = 2;

    const handleVisibilityChange = () => {
        if (document.hidden) {
            tabSwitchCount++;
            if (tabSwitchCount === 1) {
                alert('–í–Ω–∏–º–∞–Ω–∏–µ! –í—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –¥—Ä—É–≥—É—é –≤–∫–ª–∞–¥–∫—É. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–µ—Å—Ç –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º 0.');
            } else if (tabSwitchCount >= MAX_TAB_SWITCHES) {
                alert('–í—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏–º–∏—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π. –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —Å –Ω—É–ª–µ–≤—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º.');
                score = 0;
                showTestResultsView();
            }
        }
    };

    function startTest(courseId) {
        currentCourse = courses.find(c => c.id === courseId);
        const progress = userProgress[courseId];
        const attempts = progress ? progress.attempts : 0;

        if (attempts >= MAX_ATTEMPTS) {
            alert(`–í—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Å–µ ${MAX_ATTEMPTS} –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è —Å–¥–∞—á–∏ —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞.`);
            document.getElementById('start-test-btn').disabled = true;
            return;
        }

        if (!currentCourse || !currentCourse.questions || currentCourse.questions.length === 0) {
            showMessage('–í–æ–ø—Ä–æ—Å—ã –¥–ª—è —ç—Ç–æ–≥–æ –∫—É—Ä—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.');
            backToMenuBtn.classList.remove('hidden');
            return;
        }

        currentQuestions = currentCourse.questions;
        currentQuestionIndex = 0;
        score = 0;
        tabSwitchCount = 0;
        document.addEventListener('visibilitychange', handleVisibilityChange);

        document.getElementById('main-content-wrapper').classList.add('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden');
        testView.classList.remove('hidden');

        displayQuestion();
    }

    function displayQuestion() { const nextBtn = document.getElementById('next-question-btn'); if (currentQuestionIndex < currentQuestions.length) { const q = currentQuestions[currentQuestionIndex]; document.getElementById('question-counter').textContent = `–í–æ–ø—Ä–æ—Å ${currentQuestionIndex + 1} –∏–∑ ${currentQuestions.length}`; document.getElementById('question').textContent = q.question; const answersDiv = document.getElementById('answers'); answersDiv.innerHTML = ''; q.options.forEach((option, index) => { const answerEl = document.createElement('div'); answerEl.className = 'answer'; answerEl.textContent = option; answerEl.dataset.index = index; answerEl.addEventListener('click', selectAnswer); answersDiv.appendChild(answerEl); }); nextBtn.classList.add('hidden'); } else { showTestResultsView(); } }
    function selectAnswer(e) { const selectedIndex = parseInt(e.target.dataset.index, 10); const correctIndex = currentQuestions[currentQuestionIndex].correct_option_index; document.querySelectorAll('.answer').forEach(el => { el.removeEventListener('click', selectAnswer); el.style.cursor = 'default'; }); if (selectedIndex === correctIndex) { score++; e.target.style.borderColor = 'var(--success-color)'; e.target.style.backgroundColor = '#eaf7ec'; } else { e.target.style.borderColor = 'var(--error-color)'; e.target.style.backgroundColor = '#fdeeee'; const correctAnswerEl = document.querySelector(`.answer[data-index='${correctIndex}']`); if(correctAnswerEl) correctAnswerEl.style.borderColor = 'var(--success-color)'; } const nextBtn = document.getElementById('next-question-btn'); nextBtn.classList.remove('hidden'); nextBtn.onclick = () => { currentQuestionIndex++; displayQuestion(); }; }
    async function showTestResultsView() { document.removeEventListener('visibilitychange', handleVisibilityChange); testView.classList.add('hidden'); testResultsView.classList.remove('hidden'); contentArea.innerHTML = ''; contentArea.appendChild(testResultsView); const percentage = Math.round((score / currentQuestions.length) * 100); document.getElementById('results-product-name').textContent = currentCourse.title; document.getElementById('results-score').textContent = `${percentage}% (${score} –∏–∑ ${currentQuestions.length})`; let feedback = ''; if (percentage >= 80) feedback = '–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–≤–æ–µ–Ω.'; else if (percentage >= 60) feedback = '–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–∑–¥–µ–ª—ã.'; else feedback = '–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è.'; document.getElementById('results-feedback').textContent = feedback; userProgress[currentCourse.id] = { completed: true, score, total: currentQuestions.length, percentage }; try { await fetchAuthenticated('/.netlify/functions/saveTestResult', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ course_id: currentCourse.id, score: score, total_questions: currentQuestions.length, percentage: percentage }) }); } catch(error) { console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', error); } }
    document.addEventListener('DOMContentLoaded', () => { initAuth(); backToMenuBtn.addEventListener('click', showMainMenu); backToMenuFromResultsBtn.addEventListener('click', showMainMenu); });

    function showSimulatorView() {
        windowTitle.textContent = '–î–∏–∞–ª–æ–≥–æ–≤—ã–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä';
        document.getElementById('main-content-wrapper').classList.add('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden');
        simulatorView.classList.remove('hidden');
        backToMenuBtn.classList.remove('hidden');

        simulatorSetup.classList.remove('hidden');
        simulatorChatArea.classList.add('hidden');
        simulatorEvaluationArea.classList.add('hidden');
        simulatorChatBox.innerHTML = '';
        simulationHistory = [];
    }

    launchSimulatorBtn.addEventListener('click', showSimulatorView);
    restartSimulationBtn.addEventListener('click', showSimulatorView);

    startSimulationBtn.addEventListener('click', () => {
        simulatorSetup.classList.add('hidden');
        simulatorChatArea.classList.remove('hidden');
    });

    simulatorChatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userInput = simulatorChatInput.value.trim();
        if (!userInput) return;

        appendSimulatorMessage(userInput, 'user');
        simulationHistory.push({ role: 'user', text: userInput });
        simulatorChatInput.value = '';
        simulatorChatInput.disabled = true;

        try {
            const data = await fetchAuthenticated('/.netlify/functions/dialogueSimulator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    history: simulationHistory,
                    persona: personaSelector.value,
                    action: 'chat'
                })
            });
            appendSimulatorMessage(data.answer, 'assistant');
            simulationHistory.push({ role: 'assistant', text: data.answer });
        } catch (error) {
            appendSimulatorMessage(`–û—à–∏–±–∫–∞: ${error.message}`, 'assistant');
        } finally {
            simulatorChatInput.disabled = false;
            simulatorChatInput.focus();
        }
    });

    endSimulationBtn.addEventListener('click', async () => {
        if (simulationHistory.length === 0) {
            alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥.');
            return;
        }
        simulatorChatArea.classList.add('hidden');
        simulatorEvaluationArea.classList.remove('hidden');
        evaluationResults.innerHTML = '<div class="loader"></div>';

        try {
             const data = await fetchAuthenticated('/.netlify/functions/dialogueSimulator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    history: simulationHistory,
                    action: 'evaluate',
                    persona: personaSelector.value
                })
            });

            evaluationResults.innerHTML = ''; // Clear loader

            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥';
            downloadBtn.style.marginTop = '10px';
            downloadBtn.style.marginBottom = '15px';

            downloadBtn.onclick = () => {
                const dialogueText = simulationHistory.map(h => `${h.role.toUpperCase()}: ${h.text}`).join('\n');
                const fullText = `–î–ò–ê–õ–û–ì\n--------------------\n${dialogueText}\n\n–û–¶–ï–ù–ö–ê –ò–ò\n--------------------\n${data.answer}`;
                const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dialogue-${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            evaluationResults.appendChild(downloadBtn);

            const evaluationText = document.createElement('div');
            evaluationText.style.whiteSpace = 'pre-wrap';
            evaluationText.textContent = data.answer;
            evaluationResults.appendChild(evaluationText);

        } catch (error) {
            evaluationResults.textContent = `–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏: ${error.message}`;
        }
    });

    function appendSimulatorMessage(text, role) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role-message}`;
        const textSpan = document.createElement('span');
        textSpan.textContent = text;
        messageDiv.appendChild(textSpan);
        simulatorChatBox.appendChild(messageDiv);
        simulatorChatBox.scrollTop = simulatorChatBox.scrollHeight;
    }

</script>
</body>
</html>
