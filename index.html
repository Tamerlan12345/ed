<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <title>AI-–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –û–±—É—á–µ–Ω–∏—è | Centras Insurance</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap');
        :root{--primary-color:#005A9C;--secondary-color:#00AEEF;--bg-color:#f4f7f6;--surface-color:#ffffff;--text-color:#333333;--text-light-color:#777777;--border-color:#e0e0e0;--success-color:#28a745;--error-color:#dc3545;--shadow:0 4px 15px rgba(0,0,0,0.08)}*{box-sizing:border-box}body,html{height:100%;margin:0;background-color:var(--bg-color);color:var(--text-color);font-family:'Lato',sans-serif;font-size:16px}.hidden{display:none !important}.container{width:100%;height:100%;padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center}.window{border:1px solid var(--border-color);padding:30px;box-shadow:var(--shadow);background:var(--surface-color);border-radius:12px;width:100%;max-width:1300px;position:relative}.window-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);padding-bottom:15px;margin-bottom:25px}.window-header h1,.window-header h2{margin:0;font-size:1.8em;color:var(--primary-color);font-weight:700}.logo{height:45px;width:auto}.content-area{height:60vh;overflow-y:auto;padding-right:15px}.content-area::-webkit-scrollbar{width:8px}.content-area::-webkit-scrollbar-track{background:#f1f1f1}.content-area::-webkit-scrollbar-thumb{background:var(--secondary-color);border-radius:4px}.content-area::-webkit-scrollbar-thumb:hover{background:var(--primary-color)}input[type="text"],input[type="email"],input[type="password"]{background-color:var(--bg-color);border:1px solid var(--border-color);color:var(--text-color);padding:12px 15px;margin-bottom:15px;width:100%;font-family:'Lato',sans-serif;border-radius:12px;transition:border-color .3s,box-shadow .3s}input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(0,90,166,0.2)}button,.btn{background:var(--primary-color);border:none;color:#fff;padding:12px 25px;cursor:pointer;transition:all .3s ease;box-shadow:0 2px 8px rgba(0,0,0,0.1);border-radius:12px;font-weight:700;font-family:'Lato',sans-serif;letter-spacing:.2px;margin-top:10px}button:hover,.btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,90,166,0.2);background:var(--secondary-color)}button:disabled{background:var(--text-light-color);cursor:not-allowed;transform:none;box-shadow:none}#auth-error{color:var(--error-color);margin-top:10px;text-align:center;font-weight:bold}#main-menu{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px}.menu-item{padding:16px;border:1px solid var(--border-color);border-radius:12px;cursor:pointer;transition:all .3s ease;background-color:var(--surface-color)}.menu-item:hover{transform:translateY(-5px);box-shadow:var(--shadow);border-color:var(--primary-color)}.menu-item h3{margin-top:0;color:var(--primary-color);display:flex;align-items:center}.menu-item-icon{font-size:1.5em;margin-right:15px;color:var(--secondary-color)}.menu-item.completed{border-left:5px solid var(--success-color)}.menu-item.completed h3{color:var(--success-color)}.menu-item.completed::after{content:'‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ';color:var(--success-color);font-size:.8em;font-weight:bold;display:block;margin-top:10px}#product-content h2,#product-content h3{color:var(--primary-color)}#product-content h3{border-bottom:2px solid var(--secondary-color);padding-bottom:5px;margin-top:25px}#product-content ul{list-style-type:'‚úì ';padding-left:20px}#product-content li{padding-left:10px;margin-bottom:10px}#test-view .question{margin-bottom:20px;font-size:1.3em;font-weight:bold;color:var(--primary-color)}#test-view .answers{display:flex;flex-direction:column;gap:10px}#test-view .answer{border:2px solid var(--border-color);padding:15px;cursor:pointer;border-radius:12px;transition:all .2s ease-in-out}#test-view .answer:hover{background-color:#e9f7fe;border-color:var(--secondary-color)}#test-results p{font-size:1.2em}#test-results .score{color:var(--primary-color);font-weight:bold;font-size:2em}.window-footer{margin-top:20px;border-top:1px solid var(--border-color);padding-top:20px;display:flex;justify-content:space-between;align-items:center}#back-to-menu-btn{background:var(--text-light-color)}#back-to-menu-btn:hover{background:#555;box-shadow:0 4px 10px rgba(0,0,0,0.2)}.loader{width:50px;height:50px;border:5px solid var(--bg-color);border-top-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin:50px auto}.message{text-align:center;padding:20px;font-size:1.1em;color:var(--text-light-color)}@keyframes spin{to{transform:rotate(360deg)}}#assistant-container{margin-top:30px;padding-top:20px;border-top:1px dashed var(--border-color)}#assistant-container h3{color:var(--primary-color);margin-top:0}#chat-box{height:150px;overflow-y:auto;border:1px solid var(--border-color);border-radius:12px;padding:10px;margin-bottom:10px;background-color:var(--bg-color)}.chat-message{margin-bottom:10px}.user-message{text-align:right}.assistant-message span{background-color:#e9f7fe;padding:5px 10px;border-radius:10px;display:inline-block}.thinking{color:var(--text-light-color);font-style:italic}#chat-form{display:flex;gap:10px}#chat-input{flex-grow:1;margin:0}#chat-form button{margin:0}#admin-controls{text-align:right;margin-bottom:15px}
        /* Styles for Timer and Test Header */
        #timer-container {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
            text-align: right;
        }
        .timer-warning {
            color: var(--error-color) !important;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .test-header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        /* PPTX Slide Styles */
        .slide-container {
            position: relative;
            width: 100%;
            background-color: #fff;
            overflow: hidden;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .slide-image {
             width: 100%;
             height: auto;
             display: block;
             object-fit: contain;
        }
        .ppt-text-box {
            /* absolute positioning is set inline */
            box-sizing: border-box;
        }
        .ppt-text-box p {
            margin: 0;
        }
        /* Ensure content scales on mobile */
        .slide-container {
            transform-origin: top left; /* Scale from top-left corner */
            transition: transform 0.2s ease; /* Smooth scaling */
        }
    </style>
    <style id="character-styles">
/* --- Animated Character Widget (–û–ë–ù–û–í–õ–ï–ù–û) --- */
.character-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 10001; /* –ü–æ–≤–µ—Ä—Ö –æ–≤–µ—Ä–ª–µ—è */
    pointer-events: none;
    transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.character-container {
    position: relative;
    width: 208px;
    height: 312px;
    transform-origin: bottom right;
    transform: scale(0.7); /* –ß—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ, —á–µ–º –±—ã–ª–æ (0.6) */
}

.character-sprite {
    width: 208px;
    height: 312px;
    background-image: url('by.png');
    background-repeat: no-repeat;
    background-position: -208px -624px;
    pointer-events: auto;
}

/* –û–±–ª–∞—á–∫–æ –¥–∏–∞–ª–æ–≥–∞ - –£–õ–£–ß–®–ï–ù–û */
.character-bubble {
    position: absolute;
    bottom: 260px;
    right: 160px; /* –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –≥–æ–ª–æ–≤–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
    background: white;
    border: 2px solid var(--primary-color);
    border-radius: 15px;
    padding: 20px; /* –ë–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø—ã */
    width: max-content; /* –®–∏—Ä–∏–Ω–∞ –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É */
    max-width: 300px; /* –ù–µ —à–∏—Ä–µ 300px */
    min-width: 220px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    font-size: 1.1rem; /* –®—Ä–∏—Ñ—Ç –∫—Ä—É–ø–Ω–µ–µ (–±—ã–ª 0.9em) */
    line-height: 1.5;
    color: var(--text-color);
    opacity: 0;
    transform: translateY(10px) scale(0.9);
    transform-origin: bottom right;
    transition: all 0.3s ease;
    pointer-events: auto;
    z-index: 10002;
}

/* –•–≤–æ—Å—Ç–∏–∫ –æ–±–ª–∞—á–∫–∞ */
.character-bubble::after {
    content: '';
    position: absolute;
    bottom: 20px;
    right: -12px; /* –•–≤–æ—Å—Ç–∏–∫ —Å–ø—Ä–∞–≤–∞, —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ */
    border-width: 12px 0 12px 12px;
    border-style: solid;
    border-color: transparent transparent transparent var(--primary-color);
    display: block;
    width: 0;
}
/* –ë–µ–ª–∞—è –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—à–∫–∞ –¥–ª—è —Ö–≤–æ—Å—Ç–∏–∫–∞ (—á—Ç–æ–±—ã –±—ã–ª –∫–æ–Ω—Ç—É—Ä) */
.character-bubble::before {
    content: '';
    position: absolute;
    bottom: 20px;
    right: -9px;
    border-width: 10px 0 10px 10px;
    border-style: solid;
    border-color: transparent transparent transparent white;
    display: block;
    width: 0;
    z-index: 1;
}

.character-bubble.visible {
    opacity: 1;
    transform: translateY(0) scale(1);
}

/* –ö–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –æ–±–ª–∞—á–∫–∞ */
.bubble-actions {
    margin-top: 15px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.bubble-btn {
    background: var(--primary-color);
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background 0.2s;
}
.bubble-btn:hover { background: var(--secondary-color); }
.bubble-btn.secondary { background: #e0e0e0; color: #333; }
.bubble-btn.secondary:hover { background: #d0d0d0; }

/* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ */
#onboarding-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6); /* –¢–µ–º–Ω–µ–µ –¥–ª—è —Ñ–æ–∫—É—Å–∞ */
    z-index: 10000;
    display: none;
    opacity: 0;
    transition: opacity 0.3s;
}
#onboarding-overlay.visible {
    opacity: 1;
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
.highlight-element {
    position: relative;
    z-index: 10005 !important;
    background-color: white;
    box-shadow: 0 0 0 4px var(--primary-color), 0 0 50px rgba(255,255,255,0.5);
    border-radius: 8px;
    pointer-events: auto !important; /* –†–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫ */
    transition: all 0.3s ease;
}

/* Animations (–æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ) */
@keyframes sprite-walk-h { from { background-position-x: 0px; } to { background-position-x: -832px; } }
.pose-walk { animation: sprite-walk-h 0.8s steps(4) infinite; background-position-y: 0px !important; }
.pose-idle { background-position: -208px -624px !important; animation: sway 3s ease-in-out infinite; }
.pose-back { background-position: -416px -624px !important; }
.pose-peek { background-position: 0px 0px !important; }
.pose-serious { background-position: -624px -624px !important; }
@keyframes sway { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.02); } }
    </style>
    <style>
        /* Card UI Overrides for .menu-item */
        .menu-item {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .menu-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .course-group-container {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }
        .course-group-container h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
        }
        .skeleton-card { background-color: #e0e0e0; border-radius: 12px; height: 150px; position: relative; overflow: hidden; }
        .skeleton-card::after { content: ''; position: absolute; top: 0; left: -150%; width: 150%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { left: -150%; } 100% { left: 150%; } }
    </style>
    <style>
        #main-menu-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: none !important;
        }
        .tab-btn {
            padding: 8px 20px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 1em;
            color: var(--text-light-color);
            border-radius: 20px; /* pill shape */
            transition: all 0.2s ease-in-out;
            font-weight: 600;
            margin: 0;
        }
        .tab-btn.active {
            color: white;
            background-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 90, 166, 0.2);
        }
        .tab-btn:not(.active):hover {
           background-color: #e9ecef;
           color: var(--primary-color);
        }
    </style>
    <style id="presentation-styles">
        #app-view.presentation-mode-active #main-menu-tabs,
        #app-view.presentation-mode-active #main-menu,
        #app-view.presentation-mode-active #extra-tools,
        #app-view.presentation-mode-active #leaderboard-container,
        #app-view.presentation-mode-active #back-to-menu-btn,
        #app-view.presentation-mode-active .window-footer {
            display: none;
        }
        #app-view.presentation-mode-active #product-content {
            display: block;
            height: 100%;
        }
        #app-view.presentation-mode-active #main-flex-container {
            display: block;
        }
        #app-view.presentation-mode-active #main-content-wrapper {
             flex: 1 1 100%;
        }
        #app-view.presentation-mode-active .content-area {
            padding: 0;
        }
        .presentation-view-container {
            display: flex;
            gap: 20px;
            background-color: var(--bg-color);
            height: 100%;
            padding: 20px;
            opacity: 0;
            animation: fadeIn .4s ease-in-out forwards;
        }
        .presentation-view-left-sidebar {
            flex: 0 0 clamp(220px, 22vw, 280px);
            display: flex;
            flex-direction: column;
            gap: 15px; /* Reduced gap */
        }
        .presentation-view-right-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px 25px; /* Reduced padding */
            overflow: hidden;
        }
        .sidebar-panel {
            padding: 15px; /* Reduced padding */
        }
        #chat-box-sidebar {
            font-size: 0.85em; /* Smaller font in chat */
        }
        .presentation-slide h2 {
            font-size: clamp(1em, 2.2vw, 1.3em);
        }
        .presentation-slide {
            font-size: clamp(0.75em, 1.8vw, 0.85em);
        }
        .sidebar-panel {
            background: var(--surface-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        .sidebar-panel h3 {
            margin-top: 0;
            font-size: 1.0em;
            font-weight: bold;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .instruments-panel button {
            width: 100%;
            background-color: var(--primary-color);
            font-size: 0.95em;
        }
        .chatbot-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        #chat-box-sidebar {
            height: 40vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            background-color: var(--bg-color);
            font-size: 0.9em;
        }
        #chat-form-sidebar { display: flex; gap: 5px; }
        #chat-input-sidebar { flex-grow: 1; margin: 0; font-size: 0.9em; }
        #chat-form-sidebar button { margin: 0; padding: 8px 12px; background-color: var(--primary-color); }
        #back-to-course-btn-sidebar {
            width: 100%;
            background: transparent;
            border: 1px solid var(--text-light-color);
            color: var(--text-light-color);
            margin-top: auto;
        }
        #back-to-course-btn-sidebar:hover { background: var(--text-light-color); color: white; }
        .presentation-slider-container {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 15px;
        }
        .slider-nav-buttons {
            padding-top: 15px;
            margin-top: auto;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-shrink: 0;
        }
        .slider-nav-buttons button {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: bold;
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .slider-nav-buttons button:hover {
            background: var(--primary-color);
            color: white;
        }
        .slider-nav-buttons button:disabled {
            border-color: #ccc;
            color: #ccc;
            background: transparent;
            cursor: not-allowed;
        }
        .presentation-slide { display: none; }
        .presentation-slide.active {
            display: flex;
            flex-direction: column;
            height: 100%;
            animation: fadeInSlide .5s;
        }
        .presentation-slide img {
            max-width: 100%;
            max-height: 85vh; /* Increased max-height for better visibility */
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
            margin: 0 auto;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        /* Allow image to take full width if height permits */
        .presentation-slide img.full-slide-image {
             width: 100%;
             height: 100%;
             max-height: 85vh;
             object-fit: contain;
        }
        /* –°–∫—Ä—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ –Ω–µ—Ç */
        .presentation-slide-content:empty {
            display: none;
        }
        .presentation-slide-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        @keyframes fadeInSlide {
            from { opacity: 0.3; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @media (max-width: 992px) {
            .presentation-view-container {
                flex-direction: column;
                padding: 10px;
                height: auto;
            }
            .presentation-view-left-sidebar {
                flex: 1 1 auto;
                width: 100%;
            }
            .presentation-view-right-content {
                padding: 15px;
            }
        }
        @media (max-height: 750px) {
            .presentation-view-right-content {
                padding: 15px 20px;
            }
            .presentation-slide h2 {
                font-size: clamp(0.9em, 2vw, 1.2em);
            }
            .presentation-slide {
                font-size: clamp(0.7em, 1.6vw, 0.8em);
            }
            .presentation-slide img {
                max-height: 30vh;
                margin-bottom: 0.5rem;
            }
            .slider-nav-buttons {
                padding-top: 10px;
            }
        }
        @media (max-height: 650px) {
            .presentation-view-right-content {
                padding: 10px 15px;
            }
            .presentation-slide h2 {
                font-size: clamp(0.8em, 1.8vw, 1em);
            }
            .presentation-slide {
                font-size: clamp(0.65em, 1.4vw, 0.75em);
            }
            .presentation-slide img {
                max-height: 25vh;
                margin-bottom: 0.25rem;
            }
            .slider-nav-buttons {
                padding-top: 5px;
                gap: 5px;
            }
             .slider-nav-buttons button {
                padding: 4px 12px;
                font-size: 0.8em;
            }
        }
    </style>
    <style>
        /* Toast Notifications */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; }
        .toast { padding: 15px 20px; margin-bottom: 10px; border-radius: 8px; color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); opacity: 0; width: 300px; transform: translateX(100%); transition: all 0.4s ease-in-out; }
        .toast.show { opacity: 0.9; transform: translateX(0); }
        .toast-error { background-color: #dc3545; }
        .toast-success { background-color: #28a745; }
        .toast-info { background-color: #00AEEF; }
    </style>
    <style id="jules-layout-fixes">
        .main-menu-columns {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            align-items: flex-start;
        }
        .courses-column > h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .individual-courses-column {
             background-color: var(--surface-color);
             border-radius: 12px;
             padding: 20px;
             box-shadow: var(--shadow);
        }
        .individual-courses-column > h3 {
            margin-top: 0;
        }
    </style>
    <style id="jules-layout-fixes-2">
        body, html {
            overflow: hidden !important;
        }
        .window {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .window-header {
            flex-shrink: 0;
            margin-bottom: 20px;
        }
        .content-area {
            flex-grow: 1;
            min-height: 0;
            height: auto !important; /* Override 60vh */
            overflow-y: auto !important;
        }
        .window-footer {
            flex-shrink: 0;
        }
        #grouped-courses-container {
            display: block; /* Make groups stack vertically */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2?v=4"></script>
    <script>
        // Function to scale slides for mobile responsiveness
        function scaleSlides() {
            const slides = document.querySelectorAll('.slide-container');
            const containerWidth = document.getElementById('product-content')?.offsetWidth || window.innerWidth;

            slides.forEach(slide => {
                // Assume base design width is roughly 960px (standard PPT width in pixels for web)
                // If the container is smaller than 960px, we scale down.
                const baseWidth = 960;

                // We only scale if the container is smaller than the base width
                if (containerWidth < baseWidth) {
                    const scale = containerWidth / baseWidth;
                    slide.style.transform = `scale(${scale})`;
                    slide.style.width = `${100 / scale}%`; // Compensate width to fit container
                    slide.style.marginBottom = `-${(1 - scale) * 56.25}%`; // Adjust margin to remove gap caused by scaling
                } else {
                    slide.style.transform = 'none';
                    slide.style.width = '100%';
                    slide.style.marginBottom = '20px';
                }
            });
        }

        // Debounce resize event
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(scaleSlides, 100);
        });

        const SUPABASE_URL = 'https://wnsdlibhrlmgyszbyxat.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Induc2RsaWJocmxtZ3lzemJ5eGF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyODE0MjgsImV4cCI6MjA2OTg1NzQyOH0.Sgz-50dHj8M599sIjTRYs0kMP7b6kX2BJ-Gc-trMUQ4';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Observe DOM changes to trigger scaling when slides are loaded
        // Initialize observer after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const observer = new MutationObserver((mutations) => {
                scaleSlides();
            });
            if (document.body) {
                observer.observe(document.body, { childList: true, subtree: true });
            }
        });
    </script>
    <style id="layout-override">
        /* --- Jules's Card & Layout Styles --- */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        .search-container .fa-search {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            color: var(--text-light-color);
        }
        #course-search-input {
            padding-left: 40px;
            width: 100%;
        }
        #main-menu, .main-menu {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        .menu-item {
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .menu-item h3 {
            font-size: 1.05em;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }
        .menu-item-icon {
            font-size: 1.2em;
            margin-right: 12px;
            width: 1.2em;
            text-align: center;
            flex-shrink: 0;
        }
        .menu-item-description {
            font-size: 0.85em;
            color: var(--text-light-color);
            margin: 5px 0 10px 0;
            line-height: 1.4;
        }
        /* --- End of Jules's Fixes --- */

        .window-header {
            position: sticky;
            top: 0;
            background: var(--surface-color);
            z-index: 10;
        }
    </style>
    <style id="course-materials-style">
        .course-materials-container h3 {
            font-size: 1.1em;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .course-materials-list {
            list-style-type: none;
            padding-left: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        .material-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .material-link:hover {
            border-color: var(--primary-color);
            background-color: #e9f7fe;
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
    </style>
    <style id="leaderboard-header-styles">
        .window-header {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .window-header .logo {
            order: -2; /* Comes first */
        }
        .window-header #window-title {
            order: -1; /* Comes second */
            margin-right: auto; /* Pushes everything else to the right */
        }
        #leaderboard-container {
            flex-shrink: 0;
            min-width: 250px; /* Prevent it from getting too small */
            max-width: 350px;
            background-color: transparent;
            padding: 0;
            border: none;
            align-self: center;
        }
        #leaderboard-container h3 {
            font-size: 0.9em;
            margin-bottom: 5px;
            white-space: nowrap;
        }
        #leaderboard-content {
            font-size: 0.8em;
            max-height: 50px; /* Adjust as needed */
            overflow-y: auto;
        }
        #leaderboard-content ol {
            padding-left: 20px;
            margin: 0;
        }
        #leaderboard-content li {
            margin-bottom: 2px;
        }
        .header-controls {
            margin-left: auto; /* Push to the far right */
            order: 2;
        }
        #profile-btn {
            order: 2;
        }
        #logout-btn {
            order: 3;
        }
    </style>
    <style id="header-buttons-styles">
        .header-icon-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: var(--text-light-color);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            padding: 6px 12px;
            border-radius: 10px;
            margin-left: 0;
            min-width: 70px;
            box-shadow: none;
            margin-top: 0;
            font-family: 'Lato', sans-serif;
        }
        .header-icon-btn i {
            font-size: 1.4em;
            margin-bottom: 2px;
            transition: transform 0.3s ease;
        }
        .header-icon-btn span {
            font-size: 0.75em;
            font-weight: 700;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }
        .header-icon-btn:hover {
            background-color: rgba(0, 90, 166, 0.08);
            color: var(--primary-color);
            transform: translateY(-2px);
        }
        .header-icon-btn:hover i {
            transform: scale(1.1);
        }
        .header-icon-btn:active {
            transform: translateY(0);
        }
    </style>
    <style id="profile-styles">
        /* Profile Dashboard Styles */
        .profile-header-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
        }
        .profile-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .avatar-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .stat-card i {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-color);
            margin: 5px 0;
        }
        .stat-label {
            color: var(--text-light-color);
            font-size: 0.9em;
        }
        .profile-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .p-tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1em;
            color: var(--text-light-color);
            border-radius: 8px;
            font-weight: 600;
        }
        .p-tab-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        .styled-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .styled-table thead tr {
            background-color: var(--primary-color);
            color: white;
            text-align: left;
        }
        .styled-table th, .styled-table td {
            padding: 12px 15px;
        }
        .styled-table tbody tr {
            border-bottom: 1px solid #dddddd;
        }
        .styled-table tbody tr:nth-of-type(even) {
            background-color: #f3f3f3;
        }
        .styled-table tbody tr:last-of-type {
            border-bottom: 2px solid var(--primary-color);
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }
        .status-assigned { background-color: #e3f2fd; color: #1976d2; }
        .status-completed { background-color: #e8f5e9; color: #388e3c; }
        .status-overdue { background-color: #ffebee; color: #d32f2f; }

        .sim-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .sim-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .sim-feedback {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            font-style: italic;
            font-size: 0.9em;
            color: #555;
            margin-top: 10px;
            display: none; /* Hidden by default */
        }
        .sim-card.expanded .sim-feedback {
            display: block;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: relative;
            animation: fadeIn 0.3s;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: black;
            text-decoration: none;
        }
        .result-details-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .result-details-row:last-child {
            border-bottom: none;
        }
        .dialogue-history-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            margin-top: 15px;
            font-size: 0.9em;
        }
        .dialogue-msg {
            margin-bottom: 8px;
        }
        .dialogue-msg strong {
            display: block;
            font-size: 0.85em;
            color: #777;
        }
    </style>
</head>
<body>
    <div id="onboarding-overlay"></div>
    <div id="toast-container"></div>
    <div id="character-widget" class="character-widget hidden">
        <div class="character-container">
            <div id="character-bubble" class="character-bubble">–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ –æ—Å–≤–æ–∏—Ç—å—Å—è.</div>
            <div id="character-sprite" class="character-sprite pose-idle"></div>
        </div>
    </div>
    <div id="generic-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>
    <div id="auth-view" class="container">
        <div class="window">
            <div class="window-header" style="display: flex; flex-direction: column; align-items: center; border-bottom: none; padding-bottom: 0;">
                <img src="https://centras.kz/wp-content/uploads/2023/12/centras-insurance-col.png" alt="Centras Insurance" style="height: 60px; margin-bottom: 15px;">
                <h1 style="font-size: 2.2em; margin: 0; color: var(--primary-color); font-weight: 800; letter-spacing: 1px;">CIC Learn</h1>
                <p style="font-size: 1.1em; color: var(--text-light-color); margin-top: 5px; font-weight: 500;">–û–±—É—á–∞—é—â–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</p>
            </div>
            <form id="auth-form" style="max-width: 400px; margin: 0 auto;">
                <p style="text-align: center;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—ã–¥–∞–Ω–Ω—ã–µ –≤–∞–º –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å.</p>
                <input type="email" id="user-email" placeholder="–†–∞–±–æ—á–∏–π Email" required>
                <input type="password" id="user-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
                <div id="auth-error" class="hidden"></div>
                <button type="submit" id="auth-button">–í–æ–π—Ç–∏</button>
            </form>
        </div>
    </div>
    <div id="app-view" class="container hidden">
        <div class="window">
             <div class="window-header">
                <h2 id="window-title">–ì–ª–∞–≤–Ω–æ–µ –ú–µ–Ω—é</h2>
                <div class="header-controls">
                    <div id="notifications-bell" style="position: relative; cursor: pointer;">
                        <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M21 19v1H3v-1l2-2v-6c0-3.1 2.03-5.83 5-6.71V4a2 2 0 0 1 2-2a2 2 0 0 1 2 2v.29c2.97.88 5 3.61 5 6.71v6l2 2m-7 2a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2"/></svg>
                        <span id="notifications-badge" class="hidden" style="position: absolute; top: -5px; right: -5px; background: var(--error-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; align-items: center; justify-content: center;"></span>
                    </div>
                    <div id="notifications-panel" class="hidden" style="position: absolute; top: 60px; right: 20px; width: 300px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow); z-index: 100;">
                        <div style="padding: 10px; border-bottom: 1px solid var(--border-color); font-weight: bold;">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                        <div id="notifications-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
                 <img src="https://centras.kz/wp-content/uploads/2023/12/centras-insurance-col.png" alt="Logo" class="logo">
                <div id="leaderboard-container">
                    <h3><i class="fa-solid fa-trophy"></i> –¢–æ–ø –£—á–µ–Ω–∏–∫–æ–≤ –ù–µ–¥–µ–ª–∏</h3>
                    <div id="leaderboard-content"></div>
                </div>
                 <button id="profile-btn" class="header-icon-btn" title="–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å">
                    <i class="fa-solid fa-user-circle"></i>
                    <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
                 </button>
                 <button id="logout-btn" class="header-icon-btn" title="–í—ã–π—Ç–∏">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span>–í—ã–π—Ç–∏</span>
                 </button>
            </div>
            <div id="content-loader" class="hidden" style="display: flex; justify-content: center; align-items: center; height: 60vh;"><div class="loader"></div></div>
            <div class="content-area" id="content-area">
                <div id="profile-view" class="hidden">
                    <div class="profile-header-card">
                        <div class="profile-info">
                            <div class="avatar-circle" id="profile-avatar"></div>
                            <div>
                                <h2 id="profile-name">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                                <p id="profile-dept" style="color: #777; margin: 5px 0;">...</p>
                                <p id="profile-email" style="color: #999; font-size: 0.9em; margin: 0;">...</p>
                            </div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fa-solid fa-book-open" style="color: var(--primary-color);"></i>
                            <div class="stat-value" id="stat-active">0</div>
                            <div class="stat-label">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</div>
                        </div>
                        <div class="stat-card">
                            <i class="fa-solid fa-check-circle" style="color: var(--success-color);"></i>
                            <div class="stat-value" id="stat-completed">0</div>
                            <div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                        </div>
                        <div class="stat-card">
                            <i class="fa-solid fa-star" style="color: orange;"></i>
                            <div class="stat-value" id="stat-score">0%</div>
                            <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
                        </div>
                         <div class="stat-card">
                            <i class="fa-solid fa-clock" style="color: purple;"></i>
                            <div class="stat-value" id="stat-time">0—á</div>
                            <div class="stat-label">–í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è</div>
                        </div>
                    </div>

                    <div class="profile-tabs">
                        <button class="p-tab-btn active" onclick="switchProfileTab('history')">–ò—Å—Ç–æ—Ä–∏—è –ö—É—Ä—Å–æ–≤</button>
                        <button class="p-tab-btn" onclick="switchProfileTab('simulations')">–°–∏–º—É–ª—è—Ü–∏–∏</button>
                    </div>

                    <div id="profile-tab-history" class="profile-tab-content">
                        <table class="styled-table" id="profile-courses-table">
                            <thead>
                                <tr>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                                    <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                    <th>–î–µ–¥–ª–∞–π–Ω/–ó–∞–≤–µ—Ä—à–µ–Ω</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="profile-tab-simulations" class="profile-tab-content hidden">
                        <div id="profile-simulations-list"></div>
                    </div>
                </div>
                <div id="main-flex-container" style="display: flex;">
                    <div id="main-content-wrapper" style="flex: 1;">
                        <div class="search-container">
                            <i class="fa-solid fa-search"></i>
                            <input type="text" id="course-search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é...">
                        </div>
                        <div id="main-menu-tabs">
                            <button class="tab-btn active" data-filter="assigned">üì• –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ</button>
                            <button class="tab-btn" data-filter="completed">‚úÖ –ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ</button>
                            <button class="tab-btn" data-filter="catalog">üìö –ö–∞—Ç–∞–ª–æ–≥</button>
                        </div>
                        <div id="main-menu"></div>
                        <div id="extra-tools" style="padding-top: 20px; border-top: 1px solid #eee;">
                            <button id="launch-simulator-btn">–î–∏–∞–ª–æ–≥–æ–≤—ã–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä</button>
                            <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                                <label for="toggle-character-checkbox" style="font-size: 0.9em; cursor: pointer;">
                                    <input type="checkbox" id="toggle-character-checkbox" onchange="toggleCharacter(this.checked)" checked>
                                    –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫
                                </label>
                            </div>
                        </div>
                        <div id="admin-controls" class="hidden"></div>
                        <div id="product-content" class="hidden"></div>
                        <div id="audio-player-container-user" style="margin-top: 15px;"></div>
                    </div>
                </div>
                <div id="test-view" class="hidden">
                    <div class="test-header-controls">
                        <h3 id="test-course-title" style="margin:0; color: var(--primary-color);">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
                        <button id="back-to-presentation-from-test" style="background-color: #6c757d; font-size: 0.9em; padding: 5px 10px; margin: 0;">
                            <i class="fa-solid fa-arrow-left"></i> –í—ã–π—Ç–∏ –≤ –º–µ–Ω—é
                        </button>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <p id="question-counter" style="margin: 0; font-weight: bold;"></p>
                        <div id="timer-container"><i class="fa-solid fa-stopwatch"></i> <span id="question-timer">60</span> —Å–µ–∫.</div>
                    </div>

                    <hr style="margin: 10px 0 20px 0; border: 0; border-top: 1px solid #eee;">

                    <div id="question" class="question"></div>
                    <div id="answers" class="answers"></div>
                    <button id="next-question-btn" class="hidden">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
                </div>
                <div id="test-results" class="hidden" style="text-align: center;">
                    <div style="font-size: 4em; color: var(--success-color);"><i class="fa-solid fa-trophy"></i></div>
                    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
                    <p>–ö—É—Ä—Å: <b id="results-product-name"></b></p>
                    <p>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <span id="results-score" class="score"></span></p>
                    <div style="display: flex; justify-content: center; gap: 30px; margin: 20px 0;">
                        <div>
                            <p style="margin: 0; color: var(--text-light-color);">–ü–æ–ø—ã—Ç–æ–∫</p>
                            <p style="margin: 0; font-size: 1.5em; font-weight: bold;" id="results-attempts"></p>
                        </div>
                        <div>
                            <p style="margin: 0; color: var(--text-light-color);">–ó–∞—Ç—Ä–∞—á–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–∏</p>
                            <p style="margin: 0; font-size: 1.5em; font-weight: bold;" id="results-time-spent"></p>
                        </div>
                    </div>
                    <p id="results-feedback" style="font-style: italic;"></p>
                    <div id="results-buttons" style="margin-top: 25px; display: flex; justify-content: center; gap: 15px;">
                        <button id="back-to-menu-from-results" class="btn">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</button>
                        <button id="retry-test-btn" class="btn hidden" style="background-color: transparent; border: 1px solid var(--primary-color); color: var(--primary-color);">–ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ</button>
                    </div>
                </div>
                <div id="simulator-view" class="hidden">
                    <button id="simulator-back-btn" class="btn" style="margin-bottom: 20px; background-color: var(--text-light-color); display: flex; align-items: center; gap: 8px;"><i class="fa-solid fa-arrow-left"></i> –ù–∞–∑–∞–¥</button>
                    <div id="simulator-setup">
                        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–µ–Ω–∞–∂–µ—Ä–∞</h3>
                        <div style="margin-bottom: 20px;">
                            <label for="disposition-slider" style="display: block; margin-bottom: 10px; font-weight: bold;">1. –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:</label>
                            <input type="range" id="disposition-slider" min="0" max="2" value="1" style="width: 100%;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: var(--text-light-color);">
                                <span>–•–æ–ª–æ–¥–Ω—ã–π</span>
                                <span>–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π</span>
                                <span>–ì–æ—Ä—è—á–∏–π</span>
                            </div>
                        </div>
                        <button id="start-simulation-btn">–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥</button>
                    </div>
                    <div id="simulator-chat-area" class="hidden">
                        <div id="simulator-chat-box" style="height: 45vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; margin-bottom: 10px; background-color: var(--bg-color);"></div>
                        <form id="simulator-chat-form" style="display: flex; gap: 10px;">
                            <input type="text" id="simulator-chat-input" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..." autocomplete="off" style="flex-grow: 1; margin: 0;">
                            <button type="submit" id="simulator-submit-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </form>
                        <button id="end-simulation-btn" style="margin-top: 10px; background-color: var(--error-color);">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>
                    </div>
                    <div id="simulator-evaluation-area" class="hidden">
                        <h3>–û—Ü–µ–Ω–∫–∞ –¥–∏–∞–ª–æ–≥–∞</h3>
                        <div id="evaluation-results" style="white-space: pre-wrap; background-color: var(--bg-color); padding: 15px; border-radius: 8px;"></div>
                        <button id="restart-simulation-btn" style="margin-top: 10px;">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
                    </div>
                </div>
            </div>
            <div class="window-footer">
                <button id="back-to-menu-btn" class="hidden">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
            </div>
        </div>
    </div>
<script>
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => { toast.classList.add('show'); }, 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 5000);
    }
    const userData = { email: '', token: null };
    let courses = [];
    let currentCourse = null;
    let userProgress = {};
    let simulationHistory = [];
    let backButtonAction = null;
    let timeTrackingInterval = null;
    let secondsSinceLastUpdate = 0;

    function stopTimeTracking() {
        if (timeTrackingInterval) {
            clearInterval(timeTrackingInterval);
            timeTrackingInterval = null;
        }
    }

    async function sendTimeUpdate(courseId, seconds) {
        try {
            await fetchAuthenticated('/api/update-time-spent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ course_id: courseId, time_spent_seconds: seconds })
            });
        } catch (error) {
            console.error('Failed to update time spent:', error);
        }
    }

    async function sendSlideUpdate(courseId, slideIndex) {
        try {
            await fetchAuthenticated('/api/update-time-spent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ course_id: courseId, last_slide_index: slideIndex })
            });
        } catch (error) {
            console.error('Failed to update slide index:', error);
        }
    }

    const authView = document.getElementById('auth-view');
    const appView = document.getElementById('app-view');
    const authForm = document.getElementById('auth-form');
    const authError = document.getElementById('auth-error');
    const contentArea = document.getElementById('content-area');
    const mainMenu = document.getElementById('main-menu');
    const productContent = document.getElementById('product-content');
    const testView = document.getElementById('test-view');
    const testResultsView = document.getElementById('test-results');
    const windowTitle = document.getElementById('window-title');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');
    const backToMenuFromResultsBtn = document.getElementById('back-to-menu-from-results');
    const audioPlayerContainerUser = document.getElementById('audio-player-container-user');
    const notificationsBell = document.getElementById('notifications-bell');
    const notificationsBadge = document.getElementById('notifications-badge');
    const notificationsPanel = document.getElementById('notifications-panel');
    const notificationsList = document.getElementById('notifications-list');
    const simulatorView = document.getElementById('simulator-view');
    const launchSimulatorBtn = document.getElementById('launch-simulator-btn');
    const extraToolsDiv = document.getElementById('extra-tools');
    const simulatorSetup = document.getElementById('simulator-setup');
    const simulatorChatArea = document.getElementById('simulator-chat-area');
    const simulatorEvaluationArea = document.getElementById('simulator-evaluation-area');
    const startSimulationBtn = document.getElementById('start-simulation-btn');
    const simulatorChatBox = document.getElementById('simulator-chat-box');
    const simulatorChatForm = document.getElementById('simulator-chat-form');
    const simulatorChatInput = document.getElementById('simulator-chat-input');
    const endSimulationBtn = document.getElementById('end-simulation-btn');
    const evaluationResults = document.getElementById('evaluation-results');
    const restartSimulationBtn = document.getElementById('restart-simulation-btn');
    const contentLoader = document.getElementById('content-loader');
    const profileView = document.getElementById('profile-view');
    const profileBtn = document.getElementById('profile-btn');
    const genericModal = document.getElementById('generic-modal');
    const modalCloseBtn = document.querySelector('.modal-close');
    const modalBody = document.getElementById('modal-body');

    /* --- Character Logic --- */
    const charWidget = document.getElementById('character-widget');
    const charSprite = document.getElementById('character-sprite');
    const charBubble = document.getElementById('character-bubble');
    let charIdleTimer = null;
    let charActionTimer = null;

/* --- New Interactive Onboarding Logic --- */
const onboardingOverlay = document.getElementById('onboarding-overlay');
let currentStepIndex = 0;
let tourActive = false;

// –î–∞–Ω–Ω—ã–µ —Ç—É—Ä–∞: –∫–∞–∂–¥—ã–π —à–∞–≥ –º–æ–∂–µ—Ç –∂–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏—è 'waitClick'
const tourSteps = [
    {
        // –®–∞–≥ 0: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        text: "–ü—Ä–∏–≤–µ—Ç! üëã –Ø —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫. –î–∞–≤–∞–π —è –±—ã—Å—Ç—Ä–æ –ø–æ–∫–∞–∂—É, –∫–∞–∫ —Ç—É—Ç –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç, —á—Ç–æ–±—ã —Ç—ã –Ω–µ –∑–∞–ø—É—Ç–∞–ª—Å—è.",
        targetId: null,
        pose: "pose-walk",
        type: "info" // –ü—Ä–æ—Å—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å –∫–Ω–æ–ø–∫–æ–π "–î–∞–ª–µ–µ"
    },
    {
        // –®–∞–≥ 1: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        text: "–ù–∞—á–Ω–µ–º —Å –≤–∞–∂–Ω–æ–≥–æ. <b>–ù–∞–∂–º–∏ –Ω–∞ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫</b> üîî, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.",
        targetId: "notifications-bell",
        pose: "pose-peek",
        type: "interaction", // –ñ–¥–µ–º –∫–ª–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        waitForEvent: "click"
    },
    {
        // –®–∞–≥ 1.5: –†–µ–∞–∫—Ü–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        text: "–û—Ç–ª–∏—á–Ω–æ! –ó–¥–µ—Å—å –±—É–¥—É—Ç –Ω–æ–≤–æ—Å—Ç–∏ –æ –∫—É—Ä—Å–∞—Ö –∏ –¥–µ–¥–ª–∞–π–Ω–∞—Ö. –ù–∞–∂–º–∏ –Ω–∞ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ –µ—â–µ —Ä–∞–∑, —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å –∏—Ö, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∏–º.",
        targetId: "notifications-panel",
        pose: "pose-idle",
        type: "info"
    },
    {
        // –®–∞–≥ 2: –ü—Ä–æ—Ñ–∏–ª—å
        text: "–¢–µ–ø–µ—Ä—å –∑–∞–≥–ª—è–Ω–µ–º –≤ —Ç–≤–æ–π –∫–∞–±–∏–Ω–µ—Ç. <b>–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É '–ü—Ä–æ—Ñ–∏–ª—å'</b> üë§.",
        targetId: "profile-btn",
        pose: "pose-back",
        type: "interaction",
        waitForEvent: "click"
    },
    {
        // –®–∞–≥ 2.5: –†–µ–∞–∫—Ü–∏—è –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å (–∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–ª—Å—è)
        text: "–°—É–ø–µ—Ä! –ó–¥–µ—Å—å —Ç–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –∏—Å—Ç–æ—Ä–∏—è –∫—É—Ä—Å–æ–≤ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤. –í—Å—ë –ø–æ–¥ —Ä—É–∫–æ–π.",
        targetId: "profile-view", // –ü–æ–¥—Å–≤–µ—Ç–∏–º –≤—Å—é –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–æ—Ñ–∏–ª—è
        pose: "pose-walk",
        type: "info",
        delay: 500 // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã UI —É—Å–ø–µ–ª –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å—Å—è
    },
    {
        // –®–∞–≥ 3: –í—ã—Ö–æ–¥ –Ω–∞–∑–∞–¥
        text: "–ß—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫—É—Ä—Å–∞–º, –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É <b>'–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é'</b>.",
        targetId: "back-to-menu-btn",
        pose: "pose-peek",
        type: "interaction",
        waitForEvent: "click"
    },
    {
        // –®–∞–≥ 4: –§–∏–Ω–∞–ª
        text: "–¢—ã –≥–æ—Ç–æ–≤! üöÄ –í—ã–±–∏—Ä–∞–π –∫—É—Ä—Å –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –Ω–∞—á–∏–Ω–∞–π –æ–±—É—á–µ–Ω–∏–µ. –ï—Å–ª–∏ —á—Ç–æ, —è –±—É–¥—É –≤ —É–≥–ª—É. –£–¥–∞—á–∏!",
        targetId: "main-menu",
        pose: "pose-walk",
        type: "final"
    }
];

function startInteractiveTour() {
    if (localStorage.getItem('onboardingCompleted') === 'true') return;

    tourActive = true;
    currentStepIndex = 0;

    // Ensure character is visible in app-view
    moveCharacterTo('app-view');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏ –æ–≤–µ—Ä–ª–µ–π
    charWidget.classList.remove('hidden');
    onboardingOverlay.style.display = 'block';
    setTimeout(() => onboardingOverlay.classList.add('visible'), 10);

    // –ï—Å–ª–∏ –º—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ –≤—Ö–æ–¥–∞, —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–ø—É—Å—Ç–∏–º (–ª–æ–≥–∏–∫–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ onLoginSuccess)
    renderStep();
}

function renderStep() {
    if (currentStepIndex >= tourSteps.length) {
        finishTour();
        return;
    }

    const step = tourSteps[currentStepIndex];
    setCharPose(step.pose);

    // –°–Ω–∏–º–∞–µ–º —Å—Ç–∞—Ä—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É
    document.querySelectorAll('.highlight-element').forEach(el => {
        el.classList.remove('highlight-element');
    });

    // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —à–∞–≥–æ–º (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞)
    setTimeout(() => {
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        if (step.targetId) {
            const target = document.getElementById(step.targetId);
            if (target) {
                target.classList.add('highlight-element');
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –ø—É–∑—ã—Ä—è
        let buttonsHtml = '';

        if (step.type === 'info') {
            buttonsHtml = `
                <button class="bubble-btn secondary" onclick="finishTour()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
                <button class="bubble-btn" onclick="nextStep()">–î–∞–ª–µ–µ ‚ûî</button>
            `;
        } else if (step.type === 'interaction') {
            // –ù–µ—Ç –∫–Ω–æ–ø–∫–∏ "–î–∞–ª–µ–µ", —Ç–∞–∫ –∫–∞–∫ –∂–¥–µ–º –∫–ª–∏–∫–∞ –æ—Ç —é–∑–µ—Ä–∞
            // –ù–æ –æ—Å—Ç–∞–≤–∏–º "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
            buttonsHtml = `
                <button class="bubble-btn secondary" onclick="finishTour()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
                <span style="font-size:0.8em; color:#666; align-self:center; margin-left:10px;">(–ñ–¥—É –¥–µ–π—Å—Ç–≤–∏—è...)</span>
            `;
            setupInteraction(step);
        } else if (step.type === 'final') {
            buttonsHtml = `
                <button class="bubble-btn" onclick="finishTour()">–ü–æ–≥–Ω–∞–ª–∏! üöÄ</button>
            `;
        }

        charBubble.innerHTML = `
            <div style="margin-bottom:10px;">${step.text}</div>
            <div class="bubble-actions">${buttonsHtml}</div>
        `;
        charBubble.classList.add('visible');

    }, step.delay || 0);
}

function setupInteraction(step) {
    const target = document.getElementById(step.targetId);
    if (!target) {
        // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç (–±–∞–≥), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —à–∞–≥
        console.warn(`Target ${step.targetId} not found, skipping step.`);
        nextStep();
        return;
    }

    const handler = (e) => {
        // –£–±–∏—Ä–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å, —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –¥–≤–∞–∂–¥—ã
        target.removeEventListener(step.waitForEvent, handler);

        // –ï—Å–ª–∏ —Ç—É—Ä —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–∂–∞–ª–∏ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å"), –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        if (!tourActive) return;

        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(() => {
            if (tourActive) nextStep();
        }, 300);
    };

    // –í–µ—à–∞–µ–º –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π —Å–ª—É—à–∞—Ç–µ–ª—å
    target.addEventListener(step.waitForEvent, handler, { once: true });
}

window.nextStep = function() {
    currentStepIndex++;
    renderStep();
};

window.finishTour = function() {
    tourActive = false;
    localStorage.setItem('onboardingCompleted', 'true');

    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—ë
    charBubble.classList.remove('visible');
    onboardingOverlay.classList.remove('visible');
    setTimeout(() => {
        onboardingOverlay.style.display = 'none';
        // –ü–µ—Ä—Å–æ–Ω–∞–∂ —Ç–æ–∂–µ –ø—Ä–æ–ø–∞–¥–∞–µ—Ç, –∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∏
        charWidget.classList.add('hidden');
    }, 300);

    document.querySelectorAll('.highlight-element').forEach(el => {
        el.classList.remove('highlight-element');
    });

    // –°–±—Ä–æ—Å –ø–æ–∑—ã
    setCharPose('pose-idle');
    resetIdleTimer(); // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—ã—á–Ω—ã–π —Ç–∞–π–º–µ—Ä –±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è (–µ—Å–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂ –≤–µ—Ä–Ω–µ—Ç—Å—è)
};

    const charPhrases = {
        welcome: ["–ü—Ä–∏–≤–µ—Ç! üëã", "–†–∞–¥ –≤–∏–¥–µ—Ç—å!", "–î–∞–≤–∞–π —É—á–∏—Ç—å—Å—è!", "–í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å üëá"],
        worry: ["–¢—ã —Ç—É—Ç? üëÄ", "–Ø –∑–∞—Å–∫—É—á–∞–ª...", "–ê—É-—É...", "–ù–µ —Å–ø–∏! üí§"],
        password: ["–ù–µ –ø–æ–¥–≥–ª—è–¥—ã–≤–∞—é üôà", "–°–µ–∫—Ä–µ—Ç–∏–∫–∏...", "–¢—Å—Å... ü§´", "–Ø –æ—Ç–≤–µ—Ä–Ω—É–ª—Å—è"],
        peek: ["–í—Å—ë –≤–≤—ë–ª? üëÄ", "–ú–æ–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å?", "–î–æ–ª–≥–æ –µ—â—ë?"],
        success: ["–£—Ä–∞! –ü–æ–≥–Ω–∞–ª–∏! üöÄ", "–û—Ç–ª–∏—á–Ω–æ!", "–ó–∞—Ö–æ–¥–∏–º..."],
        test_start: ["–°–æ–±–µ—Ä–∏—Å—å! üòê", "–¢—ã —Å–º–æ–∂–µ—à—å! üí™", "–í—Ä–µ–º—è –ø–æ—à–ª–æ ‚è±Ô∏è"],
        test_good: ["–ú–æ–ª–æ–¥–µ—Ü! üèÜ", "–¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å! ‚≠ê", "–ì–æ—Ä–∂—É—Å—å! üòé"],
        test_bad: ["–≠—Ö... üòî", "–ù–∞–¥–æ –ø–æ–¥—É—á–∏—Ç—å üìö", "–ù–µ —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è"]
    };

    function setCharPose(poseClass) {
        charSprite.className = `character-sprite ${poseClass}`;
    }

    function showBubble(text, duration = 3000) {
        charBubble.textContent = text;
        charBubble.classList.add('visible');
        setTimeout(() => charBubble.classList.remove('visible'), duration);
    }

    function getRandomPhrase(key) {
        const phrases = charPhrases[key];
        return phrases[Math.floor(Math.random() * phrases.length)];
    }

    let characterEnabled = localStorage.getItem('characterEnabled') !== 'false';

    function toggleCharacter(enable) {
        characterEnabled = enable;
        localStorage.setItem('characterEnabled', enable);
        if (enable) {
             moveCharacterTo(authView.classList.contains('hidden') ? 'app-view' : 'auth-view');
             // If we are in app view, keep it hidden until test? Or show in menu?
             // Logic says: hidden in app view generally.
             if (!authView.classList.contains('hidden')) handleAuthViewCharacter();
        } else {
             charWidget.classList.add('hidden');
        }
    }

    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    function initCharacter() {
        if (!characterEnabled) return;

        // Debounced event listener
        const debouncedReset = debounce(resetIdleTimer, 1000);

        // Global event listeners for inactivity
        ['mousemove', 'keydown', 'scroll', 'click'].forEach(evt => {
            window.addEventListener(evt, debouncedReset);
        });
        resetIdleTimer();
    }

    function resetIdleTimer() {
        if (!characterEnabled) return;
        clearTimeout(charIdleTimer);

        // Don't reset if hidden
        if (charWidget.classList.contains('hidden')) return;

        if (!testView.classList.contains('hidden')) {
             // In test mode, don't go into "worry" mode easily, keep serious
             return;
        }

        // Return to idle pose if not in special state
        if (charSprite.classList.contains('pose-back') || charSprite.classList.contains('pose-peek')) {
             // Keep these states if interacting with password
        } else {
             setCharPose('pose-idle');
        }

        charIdleTimer = setTimeout(() => {
            if (charWidget.classList.contains('hidden') || !characterEnabled) return;
            // Trigger "Worry" state
            setCharPose('pose-peek'); // Use peek/side view for worry
            showBubble(getRandomPhrase('worry'));
        }, 20000); // 20 sec inactivity
    }

    function handleAuthViewCharacter() {
        if (!characterEnabled) return;
        charWidget.classList.remove('hidden');
        // Animation to enter
        setTimeout(() => {
            charWidget.classList.add('entered');
            setCharPose('pose-walk');
            // Stop walking after 1 sec (css transition time)
            setTimeout(() => {
                setCharPose('pose-idle');
                showBubble(getRandomPhrase('welcome'));
            }, 1000);
        }, 500);

        // Password interactions
        const pwdInput = document.getElementById('user-password');
        pwdInput.addEventListener('focus', () => {
            setCharPose('pose-back');
            showBubble(getRandomPhrase('password'));

            // Random peek logic
            clearInterval(charActionTimer);
            charActionTimer = setInterval(() => {
                if(Math.random() > 0.7) {
                    setCharPose('pose-peek');
                    showBubble(getRandomPhrase('peek'), 1500);
                    setTimeout(() => setCharPose('pose-back'), 1500);
                }
            }, 3000);
        });

        pwdInput.addEventListener('blur', () => {
            clearInterval(charActionTimer);
            setCharPose('pose-idle');
        });

        // Login button reaction
        document.getElementById('auth-form').addEventListener('submit', () => {
            setCharPose('pose-walk'); // Excited?
            showBubble(getRandomPhrase('success'));
        });
    }

    function handleTestCharacter(start = true) {
        if (!characterEnabled) return;
        charWidget.classList.remove('hidden');

        if (start) {
             setCharPose('pose-serious');
             showBubble(getRandomPhrase('test_start'));
        }
    }

    function moveCharacterTo(containerId) {
        const container = document.getElementById(containerId);
        if (container) {
            container.appendChild(charWidget);
            charWidget.classList.remove('hidden');
            // Trigger reflow/class updates
            if (containerId === 'auth-view') {
                 handleAuthViewCharacter();
            } else {
                 charWidget.classList.remove('entered'); // Reset specific auth anims
                 setCharPose('pose-idle');
            }
        }
    }

    if (modalCloseBtn) {
        modalCloseBtn.onclick = function() {
            genericModal.style.display = "none";
        }
    }
    window.onclick = function(event) {
        if (event.target == genericModal) {
            genericModal.style.display = "none";
        }
    }

    function openModal(contentHtml) {
        modalBody.innerHTML = contentHtml;
        genericModal.style.display = "flex";
    }

    function showCourseResultModal(course) {
        const percentage = course.percentage || course.score || 0;

        const html = `
            <h2 style="color: var(--primary-color); text-align: center; margin-top: 0;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫—É—Ä—Å–∞</h2>
            <h3 style="text-align: center; margin-bottom: 25px;">${course.title}</h3>

            <div style="text-align: center; margin-bottom: 30px;">
                 <div style="font-size: 4em; color: var(--success-color); margin-bottom: 10px;"><i class="fa-solid fa-trophy"></i></div>
                 <div style="font-size: 2.5em; font-weight: bold; color: var(--primary-color);">${percentage}%</div>
                 <div style="color: #777;">–ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
            </div>

            <div class="result-details-row">
                <span>–°—Ç–∞—Ç—É—Å</span>
                <span style="font-weight: bold; color: var(--success-color);">–ó–∞–≤–µ—Ä—à–µ–Ω</span>
            </div>
            <div class="result-details-row">
                <span>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</span>
                <span style="font-weight: bold;">${new Date(course.completed_at).toLocaleDateString('ru-RU')}</span>
            </div>
             <div class="result-details-row">
                <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫</span>
                <span style="font-weight: bold;">${course.attempts || '-'}</span>
            </div>

            <div style="text-align: center; margin-top: 25px;">
                 <button class="btn" onclick="document.getElementById('generic-modal').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        `;
        openModal(html);
    }

    function escapeHTML(str) {
        if (!str) return '';
        return str.replace(/'/g, '&apos;').replace(/"/g, '&quot;');
    }
    function truncateText(text, maxLength = 120) {
        if (!text || text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }
    function showLoader() {
        contentArea.classList.add('hidden');
        contentLoader.classList.remove('hidden');
    }
    function hideLoader() {
        contentArea.classList.remove('hidden');
        contentLoader.classList.add('hidden');
    }
    function showMessage(message, details = '') {
        contentArea.innerHTML = `<div class="message">${message}<br><small style="color: #999;">${details}</small></div>`;
        hideLoader();
    }
    async function handleLogin(email, password) {
        const authButton = document.getElementById('auth-button');
        authButton.disabled = true;
        authButton.textContent = '–í—Ö–æ–¥...';
        authError.classList.add('hidden');
        try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) throw error;
            if (data && data.session) await onLoginSuccess(data.session);
            else throw new Error("–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ—Å—Å–∏—é.");
        } catch (error) {
            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏:", error);
            let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏.';
            if (error.message.includes('Invalid login credentials')) errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å.';
            showToast(errorMessage, 'error');
        } finally {
            authButton.disabled = false;
            authButton.textContent = '–í–æ–π—Ç–∏';
        }
    }
    // –û–±–Ω–æ–≤–ª—è–µ–º onLoginSuccess
    async function onLoginSuccess(session) {
        userData.email = session.user.email;
        userData.token = session.access_token;
        authView.classList.add('hidden');

        // –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –º–µ—à–∞–ª —Ç—É—Ä—É
        charWidget.classList.add('hidden');

        appView.classList.remove('hidden');
        showLoader();
        await showMainMenu();
        hideLoader();

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç—É—Ä
        setTimeout(() => {
             startInteractiveTour();
        }, 1000);
    }
    async function handleLogout() {
        await supabaseClient.auth.signOut();
        userData.token = null;
        userData.email = '';
        sessionStorage.clear();
        appView.classList.add('hidden');
        authView.classList.remove('hidden');
        document.getElementById('user-email').value = '';
        document.getElementById('user-password').value = '';

        moveCharacterTo('auth-view');
    }
    async function checkSession() {
        showLoader();
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) await onLoginSuccess(session);
        else {
            authView.classList.remove('hidden');
            hideLoader();
        }
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleLogin(document.getElementById('user-email').value.trim(), document.getElementById('user-password').value.trim());
        });
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
    }
    async function fetchAuthenticated(url, options = {}) {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session || !session.access_token) throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω. –¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.");

        const finalOptions = { ...options, headers: { 'Authorization': `Bearer ${session.access_token}`, ...options.headers } };
        const response = await fetch(url, finalOptions);
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.statusText} (${response.status})` }));
            throw new Error(errorData.error);
        }
        return response.json();
    }
    notificationsBell.addEventListener('click', async () => {
        const isHidden = notificationsPanel.classList.toggle('hidden');
        if (!isHidden) {
            const notifications = await fetchAuthenticated('/api/getNotifications');
            const unreadNotificationIds = notifications.filter(n => !n.is_read).map(n => n.id);
            if (unreadNotificationIds.length > 0) {
                try {
                    await fetchAuthenticated('/api/markNotificationsAsRead', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notification_ids: unreadNotificationIds })
                    });
                    notificationsBadge.classList.add('hidden');
                    notificationsList.querySelectorAll('div').forEach(div => div.style.fontWeight = 'normal');
                } catch (error) { console.error('Failed to mark notifications as read:', error); }
            }
        }
    });
    async function loadLeaderboard(containerId = 'leaderboard-content') {
        const leaderboardContent = document.getElementById(containerId);
        if (!leaderboardContent) return;
        leaderboardContent.innerHTML = '<div class="loader" style="height: 20px; width: 20px; margin: 0;"></div>';
        try {
            const leaderboardData = await fetchAuthenticated('/api/get-leaderboard', { method: 'POST' });
            if (!leaderboardData || leaderboardData.length === 0) {
                leaderboardContent.innerHTML = '<p>–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç –ª–∏–¥–µ—Ä–æ–≤. –°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>';
                return;
            }
            let html = '<ol>';
            leaderboardData.forEach(user => {
                html += `<li><strong>${user.full_name || '–ê–Ω–æ–Ω–∏–º'}</strong>: –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∫—É—Ä—Å–æ–≤: ${user.courses_completed || 0}, –í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è: ${user.total_time_spent_minutes || 0} –º–∏–Ω.</li>`;
            });
            html += '</ol>';
            leaderboardContent.innerHTML = html;
        } catch (error) {
            console.error('Failed to load leaderboard:', error);
            leaderboardContent.innerHTML = '<p style="color: var(--error-color);">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–∏–¥–µ—Ä–±–æ—Ä–¥.</p>';
        }
    }
    async function loadCourses() {
        await showMainMenu();
    }

    async function showMainMenu() {
        appView.classList.remove('presentation-mode-active');
        stopTimeTracking();
        windowTitle.textContent = '–ì–ª–∞–≤–Ω–æ–µ –ú–µ–Ω—é';
        backButtonAction = null;

        const windowEl = appView.querySelector('.window');
        const tabsEl = document.getElementById('main-menu-tabs');
        const contentAreaEl = document.getElementById('content-area');
        if (windowEl && tabsEl && contentAreaEl && tabsEl.parentElement !== windowEl) {
            windowEl.insertBefore(tabsEl, contentAreaEl);
        }

        if (productContent) productContent.classList.add('hidden');
        if (testView) testView.classList.add('hidden');
        if (testResultsView) testResultsView.classList.add('hidden');
        if (simulatorView) simulatorView.classList.add('hidden');
        if (profileView) profileView.classList.add('hidden'); // Hide profile view
        if (backToMenuBtn) backToMenuBtn.classList.add('hidden');

        const leaderboardContainer = document.getElementById('leaderboard-container');
        if (leaderboardContainer) leaderboardContainer.classList.remove('hidden');

        const mainContentWrapper = document.getElementById('main-content-wrapper');
        if (mainContentWrapper) mainContentWrapper.classList.remove('hidden');

        if (mainMenu) mainMenu.classList.remove('hidden');

        const mainMenuTabs = document.getElementById('main-menu-tabs');
        if (mainMenuTabs) mainMenuTabs.classList.remove('hidden');

        if (extraToolsDiv) extraToolsDiv.classList.remove('hidden');
        loadLeaderboard();
        mainMenu.innerHTML = Array.from({length: 3}, () => '<div class="skeleton-card"></div>').join('');
        try {
            const courseGroups = await fetchAuthenticated(`/api/getCourses`, { method: 'POST' });
            if (!Array.isArray(courseGroups)) throw new Error("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º –≥—Ä—É–ø–ø –∫—É—Ä—Å–æ–≤.");
            courses = courseGroups;
            const searchInput = document.getElementById('course-search-input');

            const handleFilterAndSearch = () => {
                const activeTab = document.querySelector('.tab-btn.active');
                if (!activeTab) return;
                const filter = activeTab.dataset.filter;
                const searchTerm = searchInput.value;

                if (filter === 'catalog') {
                    renderCatalog(searchTerm);
                } else {
                    renderCourseGroups(filter, searchTerm);
                }
            };

            searchInput.addEventListener('input', handleFilterAndSearch);

            document.getElementById('main-menu-tabs').onclick = (e) => {
                if (e.target.matches('.tab-btn')) {
                    document.querySelector('.tab-btn.active').classList.remove('active');
                    e.target.classList.add('active');
                    handleFilterAndSearch();
                }
            };
            renderCourseGroups('assigned', searchInput.value);
        } catch (error) {
            console.error('Failed to load courses:', error);
            showMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤.', error.message);
        }
    }
    function renderCourseGroups(filter = 'assigned', searchTerm = '') {
        mainMenu.innerHTML = '';
        mainMenu.style.display = 'block';

        const sourceGroups = courses;

        const term = searchTerm.toLowerCase();
        const searchedGroups = !term ? sourceGroups : sourceGroups.map(group => ({
            ...group,
            courses: group.courses.filter(course =>
                (course.title && course.title.toLowerCase().includes(term)) ||
                (course.description && course.description.toLowerCase().includes(term))
            )
        })).filter(group => group.courses.length > 0);

        const filteredGroups = searchedGroups.map(group => ({
            ...group,
            courses: group.courses.filter(course => {
                const isCompleted = course.progress?.completed_at;
                return filter === 'completed' ? isCompleted : !isCompleted;
            })
        })).filter(group => group.courses.length > 0);
        if (filteredGroups.length === 0) {
            let message = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.';
            if (filter === 'assigned') message = '–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤. –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!';
            if (filter === 'completed') message = '–í—ã –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫—É—Ä—Å–∞.';
            mainMenu.innerHTML = `<p class="message">${message}</p>`;
            return;
        }
        mainMenu.innerHTML = `
            <div class="main-menu-columns">
                <div class="courses-column grouped-courses-column"><h3>–ì—Ä—É–ø–ø—ã –∫—É—Ä—Å–æ–≤</h3><div id="grouped-courses-container"></div></div>
                <div class="courses-column individual-courses-column"><h3>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã</h3><div id="individual-courses-container"></div></div>
            </div>
        `;
        const groupedContainer = document.getElementById('grouped-courses-container');
        const individualContainer = document.getElementById('individual-courses-container');
        const individualCoursesGroup = filteredGroups.find(g => g.id === 'individual');
        const actualGroups = filteredGroups.filter(g => g.id !== 'individual');
        if (actualGroups.length > 0) {
            actualGroups.forEach(group => {
                const groupContainer = document.createElement('div');
                groupContainer.className = 'course-group-container';
                const groupHeader = document.createElement('h3');
                groupHeader.textContent = group.group_name;
                groupContainer.appendChild(groupHeader);
                const coursesGrid = document.createElement('div');
                coursesGrid.className = 'main-menu';
                group.courses.forEach(course => {
                    coursesGrid.appendChild(createCourseMenuItem(course));
                });
                groupContainer.appendChild(coursesGrid);
                groupedContainer.appendChild(groupContainer);
            });
        } else {
            groupedContainer.innerHTML = '<p class="message" style="font-size: 0.9em;">–ù–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –≤ –≥—Ä—É–ø–ø–∞—Ö.</p>';
        }
        if (individualCoursesGroup && individualCoursesGroup.courses.length > 0) {
            const coursesGrid = document.createElement('div');
            coursesGrid.className = 'main-menu';
            individualCoursesGroup.courses.forEach(course => {
                coursesGrid.appendChild(createCourseMenuItem(course));
            });
            individualContainer.appendChild(coursesGrid);
        } else {
            individualContainer.innerHTML = '<p class="message" style="font-size: 0.9em;">–ù–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –∫—É—Ä—Å–æ–≤.</p>';
        }
    }
    function createCourseMenuItem(course) {
        const menuItem = document.createElement('div');
        menuItem.className = 'menu-item';
        if (course.is_locked) {
            menuItem.style.opacity = '0.6';
            menuItem.style.cursor = 'not-allowed';
            menuItem.title = '–≠—Ç–æ—Ç –∫—É—Ä—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ';
        } else {
            menuItem.style.cursor = 'pointer';
            menuItem.addEventListener('click', (e) => {
                // –ù–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ "–ü–µ—Ä–µ–ø—Ä–æ–π—Ç–∏"
                if (e.target.classList.contains('retake-btn') || e.target.closest('.retake-btn')) return;
                showPresentationView(course.id);
            });
        }
        if (course.progress?.completed_at) menuItem.classList.add('completed');
        let deadlineHtml = '';
        if (course.progress?.deadline_date && !course.progress?.completed_at) {
            const deadline = new Date(course.progress.deadline_date);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—ã, –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏
            const isOverdue = deadline < today;
            const iconHtml = isOverdue ? '<i class="fa-solid fa-fire"></i>' : '<i class="fa-solid fa-clock"></i>';
            deadlineHtml = `<p style="font-size: 0.85em; color: ${isOverdue ? 'var(--error-color)' : 'var(--text-light-color)'}; margin-top: 10px; font-weight: bold;">
                <span class="menu-item-icon" style="font-size: 1em;">${iconHtml}</span>
                –°—Ä–æ–∫ —Å–¥–∞—á–∏: ${deadline.toLocaleDateString('ru-RU')} ${isOverdue ? '(–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ)' : ''}
            </p>`;
        }
        let progressBarHtml = '';
        if(course.progress?.percentage > 0 && !course.progress?.completed_at) {
            progressBarHtml = `<div style="width: 100%; background: #eee; border-radius: 5px; margin-top: 10px;"><div style="width: ${course.progress.percentage}%; background: var(--success-color); height: 5px; border-radius: 5px;"></div></div>`;
        }
        const courseIcon = course.is_locked ? '<i class="fa-solid fa-lock"></i>' : '<i class="fa-solid fa-book-open"></i>';

        // –ö–ù–û–ü–ö–ê –ü–ï–†–ï–ü–†–û–ô–¢–ò
        let retakeBtnHtml = '';
        if (course.progress?.completed_at) {
            retakeBtnHtml = `
                <button class="btn retake-btn"
                        style="width: 100%; margin-top: 10px; background-color: white; color: var(--primary-color); border: 1px solid var(--primary-color);"
                        onclick="retakeCourse('${course.id}', this)">
                    <i class="fa-solid fa-rotate-right"></i> –ü–µ—Ä–µ–ø—Ä–æ–π—Ç–∏
                </button>
            `;
        }

        menuItem.innerHTML = `
            <div>
                <h3><span class="menu-item-icon">${courseIcon}</span>${course.title}</h3>
            </div>
            <div>
                ${progressBarHtml}
                ${deadlineHtml}
                ${retakeBtnHtml}
            </div>`;

        menuItem.style.display = 'flex';
        menuItem.style.flexDirection = 'column';
        menuItem.style.justifyContent = 'space-between';
        return menuItem;
    }

    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–ë–†–û–°–ê –ö–£–†–°–ê
    async function retakeCourse(courseId, btnElement) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–π—Ç–∏ –∫—É—Ä—Å –∑–∞–Ω–æ–≤–æ? –¢–µ–∫—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω.')) return;

        btnElement.disabled = true;
        btnElement.innerHTML = '<div class="loader" style="width: 15px; height: 15px; border-width: 2px;"></div>';

        try {
            await fetchAuthenticated('/api/assign-course', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ course_id: courseId, force_reset: true })
            });
            showToast('–ö—É—Ä—Å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω!', 'success');
            await loadCourses(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        } catch (error) {
            console.error(error);
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –∫—É—Ä—Å–∞', 'error');
            btnElement.disabled = false;
            btnElement.textContent = '–û—à–∏–±–∫–∞';
        }
    }
    function createCatalogMenuItem(course) {
        const menuItem = document.createElement('div');
        menuItem.className = 'menu-item';
        let buttonHtml = '';
        switch (course.user_status) {
            case 'not_assigned':
                buttonHtml = `<button class="btn assign-course-btn" data-course-id="${course.id}">–ù–∞—á–∞—Ç—å –∏–∑—É—á–µ–Ω–∏–µ</button>`;
                break;
            case 'assigned':
                buttonHtml = `<button class="btn" disabled style="background-color: var(--text-light-color); cursor: not-allowed;">–ö—É—Ä—Å —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</button>`;
                break;
            case 'completed':
                menuItem.classList.add('completed');
                buttonHtml = `<p style="font-weight: bold; color: var(--success-color); margin-top: 10px; text-align: right;">‚úì –ö—É—Ä—Å –ø—Ä–æ–π–¥–µ–Ω</p>`;
                break;
        }
        const iconHtml = course.user_status === 'completed' ? '<i class="fa-solid fa-trophy"></i>' : '<i class="fa-solid fa-book"></i>';
        menuItem.innerHTML = `
            <div>
                <h3><span class="menu-item-icon">${iconHtml}</span>${course.title}</h3>
            </div>
            <div style="margin-top: 10px;">${buttonHtml}</div>`;
        return menuItem;
    }
    async function renderCatalog(searchTerm = '') {
        mainMenu.innerHTML = '';
        mainMenu.style.display = 'block';
        mainMenu.innerHTML = '<div class="loader"></div>';
        try {
            let catalogGroups = await fetchAuthenticated('/api/getCourseCatalog', { method: 'POST' });

            const term = searchTerm.toLowerCase();
            if (term) {
                catalogGroups = catalogGroups.map(group => ({
                    ...group,
                    courses: group.courses.filter(course =>
                        (course.title && course.title.toLowerCase().includes(term)) ||
                        (course.description && course.description.toLowerCase().includes(term))
                    )
                })).filter(group => group.courses.length > 0);
            }
            mainMenu.innerHTML = '';
            if (!catalogGroups || catalogGroups.length === 0) {
                mainMenu.innerHTML = '<p class="message">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.</p>';
                return;
            }

            const filteredGroups = catalogGroups.filter(group => group.courses && group.courses.length > 0);

            if (filteredGroups.length === 0) {
                mainMenu.innerHTML = '<p class="message">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—Å–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.</p>';
                return;
            }

            mainMenu.innerHTML = `
                <div class="main-menu-columns">
                    <div class="courses-column grouped-courses-column"><h3>–ì—Ä—É–ø–ø—ã –∫—É—Ä—Å–æ–≤</h3><div id="grouped-courses-container-catalog"></div></div>
                    <div class="courses-column individual-courses-column"><h3>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã</h3><div id="individual-courses-container-catalog"></div></div>
                </div>
            `;

            const groupedContainer = document.getElementById('grouped-courses-container-catalog');
            const individualContainer = document.getElementById('individual-courses-container-catalog');

            const individualCoursesGroup = filteredGroups.find(g => g.id === 'individual');
            const actualGroups = filteredGroups.filter(g => g.id !== 'individual');

            if (actualGroups.length > 0) {
                actualGroups.forEach(group => {
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'course-group-container';
                    const groupHeader = document.createElement('h3');
                    groupHeader.textContent = group.group_name;
                    groupContainer.appendChild(groupHeader);

                    const coursesGrid = document.createElement('div');
                    coursesGrid.className = 'main-menu';
                    group.courses.forEach(course => {
                        coursesGrid.appendChild(createCatalogMenuItem(course));
                    });
                    groupContainer.appendChild(coursesGrid);
                    groupedContainer.appendChild(groupContainer);
                });
            } else {
                groupedContainer.innerHTML = '<p class="message" style="font-size: 0.9em;">–ù–µ—Ç –∫—É—Ä—Å–æ–≤, —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.</p>';
            }

            if (individualCoursesGroup && individualCoursesGroup.courses.length > 0) {
                const coursesGrid = document.createElement('div');
                coursesGrid.className = 'main-menu';
                individualCoursesGroup.courses.forEach(course => {
                    coursesGrid.appendChild(createCatalogMenuItem(course));
                });
                individualContainer.appendChild(coursesGrid);
            } else {
                individualContainer.innerHTML = '<p class="message" style="font-size: 0.9em;">–ù–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –∫—É—Ä—Å–æ–≤.</p>';
            }

        } catch (error) {
            console.error('Failed to load course catalog:', error);
            mainMenu.innerHTML = `<p class="message" style="color: var(--error-color);">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –∫—É—Ä—Å–æ–≤.</p>`;
        }
    }
    async function showPresentationView(courseId, forceRegenerate = false) {
        stopTimeTracking(); // Stop any previous timer
        currentCourse = courses.flatMap(group => group.courses).find(c => c.id === courseId);
        if (!currentCourse) {
             // Try to find it from any source if not in current filtered list?
             // Actually, 'courses' should contain all fetched groups.
             // If invoked from profile, 'courses' might need to be refreshed or checked differently.
             // For now assume courseId is valid or available.
             // If we are coming from profile, we might need to fetch the course content directly if not in 'courses' list.
             // But let's stick to existing logic first.

             // Fallback: try to fetch just this course info if not found (implied requirement if coming from history)
             // We can't do that easily without a new endpoint or logic update.
             // Let's assume the user has access to the course via the catalog or it's in 'courses'.
        }

        // Re-fetch courses if empty (e.g. page reload on profile view then click)
        if (!courses || courses.length === 0) {
             try {
                courses = await fetchAuthenticated(`/api/getCourses`, { method: 'POST' });
             } catch(e) {}
        }

        currentCourse = courses.flatMap(group => group.courses).find(c => c.id === courseId);

        if (!currentCourse) {
            // Try searching in catalog logic or just fetch content directly
            // Let's try to fetch content directly and build a dummy course object if we can
             currentCourse = { id: courseId, title: '–ó–∞–≥—Ä—É–∑–∫–∞...', is_locked: false }; // Temporary placeholder
        }

        if (!currentCourse) {
            contentArea.innerHTML = `
                <div class="message">–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫—É—Ä—Å.</div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="showMainMenu()">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</button>
                </div>
            `;
            hideLoader();
            return;
        }
        windowTitle.textContent = currentCourse.title;
        productContent.innerHTML = '<div class="loader"></div>';
        productContent.classList.remove('hidden');
        mainMenu.classList.add('hidden');
        profileView.classList.add('hidden'); // Hide profile view
        if (testView) testView.classList.add('hidden');
        if (testResultsView) testResultsView.classList.add('hidden');
        document.getElementById('main-menu-tabs').classList.add('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden');
        document.getElementById('extra-tools').classList.add('hidden');
        backToMenuBtn.classList.remove('hidden');
        backButtonAction = showMainMenu;
        try {
            if (!currentCourse.summary || (Array.isArray(currentCourse.summary) && currentCourse.summary.length === 0) || forceRegenerate) {
                const data = await fetchAuthenticated('/api/getCourseContent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ course_id: currentCourse.id, force_regenerate: forceRegenerate })
                });
                currentCourse.summary = data.summary;
                currentCourse.questions = data.questions;
                currentCourse.materials = data.materials;
            }
            appView.classList.add('presentation-mode-active');
            productContent.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'presentation-view-container';
            const leftSidebar = document.createElement('div');
            leftSidebar.className = 'presentation-view-left-sidebar';
            const instrumentsPanel = document.createElement('div');
            instrumentsPanel.className = 'sidebar-panel instruments-panel';
            instrumentsPanel.innerHTML = '<h3>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>';
            const testBtn = document.createElement('button');
            testBtn.innerHTML = '<i class="fa-solid fa-bullseye"></i> –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
            testBtn.className = 'action-btn primary';
            testBtn.onclick = () => {
                stopTimeTracking();
                startTest(currentCourse.id);
            };
            const simBtn = document.createElement('button');
            simBtn.innerHTML = '<i class="fa-solid fa-comments"></i> –î–∏–∞–ª–æ–≥–æ–≤—ã–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä';
            simBtn.className = 'action-btn';
            simBtn.style.marginTop = '10px';

            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –∫—É—Ä—Å–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ
            simBtn.onclick = () => showSimulatorView(currentCourse.id);

            // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∞–≤–µ—Ä—Ö
            const backBtnSidebar = document.createElement('button');
            backBtnSidebar.id = 'back-to-course-btn-sidebar';
            backBtnSidebar.textContent = '‚Äπ –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é';
            backBtnSidebar.style.marginBottom = '15px';
            backBtnSidebar.style.marginTop = '0'; // –°–±—Ä–æ—Å –∞–≤—Ç–æ-–æ—Ç—Å—Ç—É–ø–∞
            backBtnSidebar.onclick = showMainMenu;
            leftSidebar.appendChild(backBtnSidebar);

            instrumentsPanel.appendChild(testBtn);
            instrumentsPanel.appendChild(simBtn);
            leftSidebar.appendChild(instrumentsPanel);
            const chatbotPanel = document.createElement('div');
            chatbotPanel.className = 'sidebar-panel chatbot-panel';
            chatbotPanel.innerHTML = `
                <h3>–ß–ê–¢-–ë–û–¢ –ê–°–°–ò–°–¢–ï–ù–¢</h3>
                <div id="chat-box-sidebar" class="chat-box"></div>
                <form id="chat-form-sidebar" data-chatbox="chat-box-sidebar">
                    <input type="text" id="chat-input-sidebar" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å..." autocomplete="off">
                    <button type="submit" id="sidebar-submit-btn">‚û¢</button>
                </form>
            `;
            leftSidebar.appendChild(chatbotPanel);
            const rightContent = document.createElement('div');
            rightContent.className = 'presentation-view-right-content';

            const progressContainerHtml = `
                <div class="presentation-progress-container" style="padding-bottom: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span style="font-size: 0.9em; color: var(--text-light-color);">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                        <span id="slide-counter" style="font-size: 0.9em; font-weight: bold;"></span>
                    </div>
                    <div class="progress-bar-background" style="background-color: var(--border-color); border-radius: 5px; height: 8px;">
                        <div id="slide-progress-bar" style="width: 0%; height: 100%; background-color: var(--success-color); border-radius: 5px; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            `;
            rightContent.innerHTML += progressContainerHtml;

            const sliderContainer = document.createElement('div');
            sliderContainer.className = 'presentation-slider-container';
            const navButtonsContainer = document.createElement('div');
            navButtonsContainer.className = 'slider-nav-buttons';
            const renderPresentationForView = (summaryData) => {
                if (!summaryData || !Array.isArray(summaryData) || summaryData.length === 0) {
                    const messageDiv = document.createElement('div');
                    messageDiv.innerHTML = '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫—É—Ä—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.';
                    return { slider: messageDiv, prevBtn: null, nextBtn: null };
                }
                const slider = document.createElement('div');
                summaryData.forEach((slideData, slideIndex) => {
                    const slideDiv = document.createElement('div');
                    slideDiv.className = 'presentation-slide';
                    let imageHtml = '';
                    if (slideData.image_url) {
                         // If it's an image-only slide (like from PPTX conversion), render it as a full-width image
                         if (!slideData.html_content || slideData.html_content.trim() === '') {
                             imageHtml = `<img src="${slideData.image_url}" class="full-slide-image" alt="Slide">`;
                         } else {
                             // If there is content alongside the image (mixed mode)
                             imageHtml = `<img src="${slideData.image_url}" alt="Slide Image">`;
                         }
                    }
                    let questionHtml = '';

                    if (slideData.slide_question) {
                        const question = slideData.slide_question;
                        questionHtml = `
                            <div class="micro-question-view" style="margin-top: 20px; padding: 15px; border: 2px solid var(--secondary-color); border-radius: 8px;">
                                <h4>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ–±—è:</h4>
                                <p style="font-weight: bold;">${question.question_text}</p>
                                <div class="micro-answers">
                                    ${question.options.map((option, index) => `
                                        <div class="answer micro-answer" data-correct="${index === question.correct_index}" style="padding: 10px; border: 1px solid var(--border-color); margin-bottom: 5px; cursor: pointer; border-radius: 5px;">
                                            ${option}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }

                    slideDiv.innerHTML = `${imageHtml}<div class="presentation-slide-content"><h2>${slideData.slide_title || ''}</h2>${slideData.html_content || ''}</div>${questionHtml}`;
                    slider.appendChild(slideDiv);
                });

                // Add event listener for all micro-questions
                slider.addEventListener('click', (e) => {
                    if (e.target.classList.contains('micro-answer')) {
                        const parent = e.target.parentElement;
                        if (parent.dataset.answered) return; // Already answered
                        parent.dataset.answered = 'true';

                        const slide = e.target.closest('.presentation-slide');
                        slide.dataset.answered = 'true'; // Mark slide as answered

                        const isCorrect = e.target.dataset.correct === 'true';
                        e.target.style.backgroundColor = isCorrect ? 'hsl(145, 63%, 90%)' : 'hsl(354, 70%, 90%)';
                        e.target.style.borderColor = isCorrect ? 'var(--success-color)' : 'var(--error-color)';
                        e.target.style.fontWeight = 'bold';

                        // Disable other options
                        parent.querySelectorAll('.micro-answer').forEach(ans => {
                            if (ans !== e.target) ans.style.opacity = '0.6';
                            ans.style.cursor = 'default';
                        });

                        updateSliderUI(); // Re-evaluate button states
                    }
                });
                const slides = slider.querySelectorAll('.presentation-slide');
                const prevBtn = document.createElement('button');
                prevBtn.textContent = '–ù–∞–∑–∞–¥';
                const nextBtn = document.createElement('button');
                nextBtn.textContent = '–í–ø–µ—Ä–µ–¥';

                // Restore saved progress or default to 0
                let currentIndex = 0;
                if (currentCourse.progress && typeof currentCourse.progress.last_slide_index === 'number') {
                    // Ensure the saved index is within bounds
                    if (currentCourse.progress.last_slide_index >= 0 && currentCourse.progress.last_slide_index < slides.length) {
                        currentIndex = currentCourse.progress.last_slide_index;
                    }
                }

                const updateSliderUI = () => {
                    slides.forEach((slide, index) => slide.classList.toggle('active', index === currentIndex));
                    prevBtn.disabled = currentIndex === 0;

                    const currentSlideData = summaryData[currentIndex];
                    const hasMicroQuestion = currentSlideData && currentSlideData.slide_question;

                    // Disable next button if there's an unanswered micro-question
                    nextBtn.disabled = (currentIndex === slides.length - 1) || (hasMicroQuestion && !slides[currentIndex].dataset.answered);

                    // Update progress bar
                    const progressBar = document.getElementById('slide-progress-bar');
                    const slideCounter = document.getElementById('slide-counter');
                    if(progressBar && slideCounter) {
                        const progress = slides.length > 1 ? ((currentIndex) / (slides.length - 1)) * 100 : (slides.length === 1 ? 100 : 0);
                        progressBar.style.width = progress + '%';
                        slideCounter.textContent = `–°–ª–∞–π–¥ ${currentIndex + 1} –∏–∑ ${slides.length}`;
                    }
                };

                prevBtn.addEventListener('click', () => {
                    if (currentIndex > 0) {
                        currentIndex--;
                        updateSliderUI();
                        sendSlideUpdate(currentCourse.id, currentIndex);
                    }
                });

                nextBtn.addEventListener('click', () => {
                    if (currentIndex < slides.length - 1) {
                        currentIndex++;
                        updateSliderUI();
                        sendSlideUpdate(currentCourse.id, currentIndex);
                    }
                });

                updateSliderUI();
                return { slider, prevBtn, nextBtn };
            };
            // NEW: Check if the course is from a Google Slides presentation
            if (currentCourse.presentation_url) {
                sliderContainer.innerHTML = '<div class="loader"></div>'; // Show loader
                navButtonsContainer.style.display = 'none'; // Hide our custom nav

                const iframe = document.createElement('iframe');
                // Rebuild the URL for embedding. Removed 'rm=minimal' to ensure controls are visible.
                const embedUrl = currentCourse.presentation_url.split('/pub')[0] + '/embed?start=false&loop=false&delayms=3000';

                iframe.src = embedUrl;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.display = 'none'; // Hide iframe until loaded
                iframe.allow = "fullscreen";

                iframe.onload = () => {
                    // Remove loader and show the iframe
                    const loader = sliderContainer.querySelector('.loader');
                    if (loader) loader.remove();
                    iframe.style.display = 'block';
                };

                sliderContainer.appendChild(iframe);
            } else {
                // Original logic for generated slides
                navButtonsContainer.style.display = 'flex'; // Ensure nav is visible
                const { slider, prevBtn, nextBtn } = renderPresentationForView(currentCourse.summary);
                sliderContainer.innerHTML = ''; // Clear before appending
                sliderContainer.appendChild(slider);

                navButtonsContainer.innerHTML = ''; // Clear before appending
                if (prevBtn && nextBtn) {
                    navButtonsContainer.appendChild(prevBtn);
                    navButtonsContainer.appendChild(nextBtn);
                }
            }

            rightContent.appendChild(sliderContainer);
            rightContent.appendChild(navButtonsContainer);
            container.appendChild(leftSidebar);
            container.appendChild(rightContent);
            productContent.appendChild(container);

            if (rightContent && currentCourse.materials && currentCourse.materials.length > 0) {
                const materialsContainer = document.createElement('div');
                materialsContainer.className = 'course-materials-container';

                let materialsHtml = '<h3>–§–∞–π–ª—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è</h3><ul class="course-materials-list">';
                currentCourse.materials.forEach(material => {
                    materialsHtml += `
                        <li>
                            <a href="${escapeHTML(material.file_url)}" target="_blank" rel="noopener noreferrer" class="material-link">
                                <span>üìÑ</span>
                                <span>${escapeHTML(material.file_name)}</span>
                            </a>
                        </li>
                    `;
                });
                materialsHtml += '</ul>';
                materialsContainer.innerHTML = materialsHtml;

                // Insert the materials container before the navigation buttons
                const sliderNav = rightContent.querySelector('.slider-nav-buttons');
                if (sliderNav) {
                    rightContent.insertBefore(materialsContainer, sliderNav);
                } else {
                    rightContent.appendChild(materialsContainer);
                }
            }

            document.getElementById('chat-form-sidebar').addEventListener('submit', handleChatSubmit);
            const chatBoxSidebar = document.getElementById('chat-box-sidebar');
            const savedChat = sessionStorage.getItem(`chatHistory_${currentCourse.id}`);
            if(savedChat) chatBoxSidebar.innerHTML = savedChat;
            else {
                 const welcomeMessage = `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –≤–∞—à –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∫—É—Ä—Å—É "${currentCourse.title}". –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`;
                 appendMessage(welcomeMessage, 'assistant', 'chat-box-sidebar');
            }
            if (timeTrackingInterval) clearInterval(timeTrackingInterval);
            secondsSinceLastUpdate = 0;
            timeTrackingInterval = setInterval(() => {
                secondsSinceLastUpdate += 30;
                sendTimeUpdate(currentCourse.id, 30);
            }, 30000);

            container.style.opacity = '1';
        } catch (error) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–ª–∏ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∫—É—Ä—Å–∞:', error);
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫—É—Ä—Å–∞.', 'error');
            showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫—É—Ä—Å–∞.', error.message);
        }
    }
    async function handleChatSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const input = form.querySelector('input[type="text"]');
        const chatBoxId = form.dataset.chatbox;
        const userQuestion = input.value.trim();
        if (!userQuestion || !currentCourse) return;
        const submitBtn = form.querySelector('button[type="submit"]');
        appendMessage(userQuestion, 'user', chatBoxId);
        const thinkingMessage = appendMessage('...', 'assistant', chatBoxId, true);
        input.value = '';
        input.disabled = true;
        if(submitBtn) submitBtn.disabled = true;
        try {
            const data = await fetchAuthenticated('/api/askAssistant', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ course_id: currentCourse.id, question: userQuestion })
            });
            thinkingMessage.querySelector('span').textContent = data.answer;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞:', error);
            thinkingMessage.querySelector('span').textContent = `–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.`;
        } finally {
            thinkingMessage.id = '';
            if (currentCourse) sessionStorage.setItem(`chatHistory_${currentCourse.id}`, document.getElementById(chatBoxId).innerHTML);
            input.disabled = false;
            if(submitBtn) submitBtn.disabled = false;
            input.focus();
        }
    }
    function appendMessage(text, sender, chatBoxId, isThinking = false) {
        const chatBoxEl = document.getElementById(chatBoxId);
        if (!chatBoxEl) return null;
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${sender}-message`;
        const textSpan = document.createElement('span');
        textSpan.textContent = text;
        if (isThinking) messageDiv.id = `thinking-indicator-${chatBoxId}`;
        messageDiv.appendChild(textSpan);
        chatBoxEl.appendChild(messageDiv);
        chatBoxEl.scrollTop = chatBoxEl.scrollHeight;
        if (currentCourse && !isThinking) sessionStorage.setItem(`chatHistory_${currentCourse.id}`, chatBoxEl.innerHTML);
        return messageDiv;
    }

    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∞ ---
    let currentQuestions = [], currentQuestionIndex = 0, score = 0, tabSwitchCount = 0;
    let questionTimerInterval = null;
    let timeLeft = 60;
    const MAX_ATTEMPTS = 3;
    const MAX_TAB_SWITCHES = 2;

    const handleVisibilityChange = () => {
        if (document.hidden) {
            tabSwitchCount++;
            if (tabSwitchCount === 1) {
                showToast('–í–Ω–∏–º–∞–Ω–∏–µ! –í—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –¥—Ä—É–≥—É—é –≤–∫–ª–∞–¥–∫—É. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–µ—Å—Ç –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º 0.', 'info');
            } else if (tabSwitchCount >= MAX_TAB_SWITCHES) {
                showToast('–í—ã –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏–º–∏—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π. –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —Å –Ω—É–ª–µ–≤—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º.', 'error');
                score = 0;
                if (questionTimerInterval) clearInterval(questionTimerInterval);
                showTestResultsView();
            }
        }
    };

    async function startTest(courseId) {
        stopTimeTracking();

        // 1. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –ü—Ä–∞–≤–∏–ª–∞
        const confirmStart = confirm(
            "–í–´ –ì–û–¢–û–í–´ –ù–ê–ß–ê–¢–¨ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï?\n\n" +
            "–ü—Ä–∞–≤–∏–ª–∞:\n" +
            "1. –ù–∞ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –¥–∞–µ—Ç—Å—è —Ä–æ–≤–Ω–æ 60 —Å–µ–∫—É–Ω–¥.\n" +
            "2. –ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã–π–¥–µ—Ç, –≤–æ–ø—Ä–æ—Å –±—É–¥–µ—Ç –∑–∞—Å—á–∏—Ç–∞–Ω –∫–∞–∫ –Ω–µ–≤–µ—Ä–Ω—ã–π.\n" +
            "3. –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏ –Ω–µ–ª—å–∑—è (–ª–∏–º–∏—Ç: 2 —Ä–∞–∑–∞).\n" +
            "4. –£ –≤–∞—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫.\n\n" +
            "–ù–∞–∂–º–∏—Ç–µ '–û–ö', —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å."
        );

        if (!confirmStart) return;

        const courseGroup = courses.find(group => group.courses.some(c => c.id === courseId));
        if (courseGroup) currentCourse = courseGroup.courses.find(c => c.id === courseId);

        if (currentCourse && currentCourse.progress && currentCourse.progress.deadline_date) {
            const deadline = new Date(currentCourse.progress.deadline_date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (today > deadline) {
                showToast('–°—Ä–æ–∫ —Å–¥–∞—á–∏ —Ç–µ—Å—Ç–∞ –∏—Å—Ç–µ–∫. –†–µ–∑—É–ª—å—Ç–∞—Ç 0% –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.', 'error');
                try {
                    await fetchAuthenticated('/api/saveTestResult', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            course_id: currentCourse.id,
                            score: 0,
                            total_questions: currentCourse.questions ? currentCourse.questions.length : 0,
                            percentage: 0,
                            time_spent_seconds: 0
                        })
                    });
                     // Update local progress to reflect the failure
                     if (!currentCourse.progress) currentCourse.progress = {};
                     currentCourse.progress.completed_at = new Date().toISOString();
                     currentCourse.progress.score = 0;
                     currentCourse.progress.percentage = 0;
                } catch (e) {
                    console.error('Failed to submit 0 result for expired deadline:', e);
                }
                return;
            }
        }

        const progress = userProgress[courseId];
        const attempts = progress ? progress.attempts : 0;
        if (attempts >= MAX_ATTEMPTS) {
            showToast(`–í—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Å–µ ${MAX_ATTEMPTS} –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è —Å–¥–∞—á–∏ —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞.`, 'error');
            return;
        }
        if (!currentCourse || !currentCourse.questions || currentCourse.questions.length === 0) {
            contentArea.innerHTML = `
                <div class="message">–í–æ–ø—Ä–æ—Å—ã –¥–ª—è —ç—Ç–æ–≥–æ –∫—É—Ä—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="showMainMenu()">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</button>
                </div>
            `;
            hideLoader();
            return;
        }
        currentQuestions = currentCourse.questions;
        currentQuestionIndex = 0;
        score = 0;
        tabSwitchCount = 0;

        document.addEventListener('visibilitychange', handleVisibilityChange);
        document.getElementById('main-content-wrapper').classList.add('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden');
        productContent.classList.add('hidden');
        testView.classList.remove('hidden');

        moveCharacterTo('test-view');
        handleTestCharacter(true);

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –∫—É—Ä—Å–∞ –≤ —à–∞–ø–∫—É —Ç–µ—Å—Ç–∞
        document.getElementById('test-course-title').textContent = currentCourse.title;

        displayQuestion();
    }

    function displayQuestion() {
        // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ç–∞–π–º–µ—Ä–∞
        if (questionTimerInterval) clearInterval(questionTimerInterval);

        const nextBtn = document.getElementById('next-question-btn');
        const timerDisplay = document.getElementById('question-timer');
        const timerContainer = document.getElementById('timer-container');

        // –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π —Ç–∞–π–º–µ—Ä–∞
        timerContainer.classList.remove('timer-warning');
        timeLeft = 60;
        timerDisplay.textContent = timeLeft;

        if (currentQuestionIndex < currentQuestions.length) {
            const q = currentQuestions[currentQuestionIndex];
            document.getElementById('question-counter').textContent = `–í–æ–ø—Ä–æ—Å ${currentQuestionIndex + 1} –∏–∑ ${currentQuestions.length}`;
            document.getElementById('question').textContent = q.question;
            const answersDiv = document.getElementById('answers');
            answersDiv.innerHTML = '';
            q.options.forEach((option, index) => {
                const answerEl = document.createElement('div');
                answerEl.className = 'answer';
                answerEl.textContent = option;
                answerEl.dataset.index = index;
                answerEl.addEventListener('click', selectAnswer);
                answersDiv.appendChild(answerEl);
            });
            nextBtn.classList.add('hidden');

            // –ó–ê–ü–£–°–ö –¢–ê–ô–ú–ï–†–ê
            questionTimerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;

                if (timeLeft <= 10) {
                    timerContainer.classList.add('timer-warning');
                }

                if (timeLeft <= 0) {
                    clearInterval(questionTimerInterval);
                    handleTimeout(); // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
                }
            }, 1000);

        } else {
            showTestResultsView();
        }
    }

    function handleTimeout() {
        showToast('–í—Ä–µ–º—è –≤—ã—à–ª–æ!', 'error');

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç—ã
        document.querySelectorAll('.answer').forEach(el => {
            el.style.pointerEvents = 'none';
            el.style.opacity = '0.6';
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        const correctIndex = currentQuestions[currentQuestionIndex].correct_option_index;
        const correctEl = document.querySelector(`.answer[data-index='${correctIndex}']`);
        if (correctEl) correctEl.style.borderColor = 'var(--primary-color)';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–î–∞–ª—å—à–µ"
        const nextBtn = document.getElementById('next-question-btn');
        nextBtn.classList.remove('hidden');
        // –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —Ç–µ–ø–µ—Ä—å –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤—ã–±–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞
        nextBtn.onclick = () => { currentQuestionIndex++; displayQuestion(); };
    }

    function selectAnswer(e) {
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ
        clearInterval(questionTimerInterval);

        const selectedIndex = parseInt(e.target.dataset.index, 10);
        const correctIndex = currentQuestions[currentQuestionIndex].correct_option_index;
        document.querySelectorAll('.answer').forEach(el => {
            el.style.pointerEvents = 'none'; // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–±–æ—Ä
        });
        if (selectedIndex === correctIndex) {
            score++;
            e.target.style.borderColor = 'var(--success-color)';
            e.target.style.backgroundColor = '#eaf7ec';
        } else {
            e.target.style.borderColor = 'var(--error-color)';
            e.target.style.backgroundColor = '#fdeeee';
            const correctAnswerEl = document.querySelector(`.answer[data-index='${correctIndex}']`);
            if(correctAnswerEl) correctAnswerEl.style.borderColor = 'var(--success-color)';
        }
        const nextBtn = document.getElementById('next-question-btn');
        nextBtn.classList.remove('hidden');
        nextBtn.onclick = () => { currentQuestionIndex++; displayQuestion(); };
    }
    async function showTestResultsView() {
        document.removeEventListener('visibilitychange', handleVisibilityChange);
        testView.classList.add('hidden');

        const resultsView = document.getElementById('test-results');
        if(resultsView) {
            resultsView.appendChild(charWidget);
            charWidget.classList.remove('hidden');
        }

        testResultsView.classList.remove('hidden');
        const percentage = Math.round((score / currentQuestions.length) * 100);

        if (percentage >= 80) {
            setCharPose('pose-walk'); // Joy
            showBubble(getRandomPhrase('test_good'));
        } else {
            setCharPose('pose-serious'); // Disappointed/Neutral
            showBubble(getRandomPhrase('test_bad'));
        }
        document.getElementById('results-product-name').textContent = currentCourse.title;
        document.getElementById('results-score').textContent = `${percentage}% (${score} –∏–∑ ${currentQuestions.length})`;

        let feedback = '';
        if (percentage >= 80) {
            feedback = '–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–≤–æ–µ–Ω.';
            document.querySelector('#test-results .fa-trophy').style.color = 'var(--success-color)';
        } else if (percentage >= 60) {
            feedback = '–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–∑–¥–µ–ª—ã.';
            document.querySelector('#test-results .fa-trophy').style.color = 'var(--primary-color)';
        } else {
            feedback = '–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è.';
            document.querySelector('#test-results .fa-trophy').style.color = 'var(--text-light-color)';
        }
        document.getElementById('results-feedback').textContent = feedback;

        try {
            const resultData = await fetchAuthenticated('/api/saveTestResult', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    course_id: currentCourse.id,
                    score: score,
                    total_questions: currentQuestions.length,
                    percentage: percentage,
                    time_spent_seconds: secondsSinceLastUpdate // Send the tracked time
                })
            });

            const attempts = resultData.updated_progress?.attempts || 1;
            const timeSpent = resultData.updated_progress?.time_spent_seconds || secondsSinceLastUpdate;

            document.getElementById('results-attempts').textContent = `${attempts} / ${MAX_ATTEMPTS}`;
            document.getElementById('results-time-spent').textContent = `${Math.round(timeSpent / 60)} –º–∏–Ω`;

            const retryBtn = document.getElementById('retry-test-btn');
            if (attempts < MAX_ATTEMPTS) {
                retryBtn.classList.remove('hidden');
                retryBtn.onclick = () => startTest(currentCourse.id);
            } else {
                retryBtn.classList.add('hidden');
            }

        } catch(error) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', error);
            document.getElementById('results-feedback').textContent += " (–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞)";
        }
        secondsSinceLastUpdate = 0; // Reset time tracker
    }
    document.addEventListener('DOMContentLoaded', () => {
        mainMenu.addEventListener('click', async (e) => {
            if (e.target.classList.contains('assign-course-btn')) {
                const courseId = e.target.dataset.courseId;
                if (!courseId) return;
                const button = e.target;
                const originalText = button.textContent;

                button.disabled = true;
                button.innerHTML = '<div class="loader" style="width: 20px; height: 20px; border-width: 3px; display: inline-block; vertical-align: middle;"></div>';

                try {
                    await fetchAuthenticated('/api/assign-course', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ course_id: courseId })
                    });

                    showToast('–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫—É—Ä—Å!', 'success');

                    // 1. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∫–ª–∞–¥–∫—É UI –Ω–∞ "–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ"
                    const assignedTabBtn = document.querySelector('.tab-btn[data-filter="assigned"]');
                    if (assignedTabBtn) {
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        assignedTabBtn.classList.add('active');
                    }

                    // 2. –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞
                    // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ courses —Å–æ–¥–µ—Ä–∂–∏—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ (—Å—Ç–∞—Ç—É—Å "not_assigned")
                    await loadCourses();

                } catch (error) {
                    console.error('Failed to assign course:', error);
                    showToast(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å: ${error.message}`, 'error');
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        });
        appView.classList.add('hidden');
        authView.classList.add('hidden');

        initCharacter(); // Init character logic

        checkSession();

        // Initial check
        if (!userData.token) {
             moveCharacterTo('auth-view');
        }

        backToMenuBtn.addEventListener('click', () => {
            if (typeof backButtonAction === 'function') backButtonAction();
        });
        backToMenuFromResultsBtn.addEventListener('click', showMainMenu);

        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤–Ω—É—Ç—Ä–∏ —Ç–µ—Å—Ç–∞
        document.getElementById('back-to-presentation-from-test').addEventListener('click', async () => {
            if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–µ—Ä–≤–∞—Ç—å —Ç–µ—Å—Ç? –¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.")) {
                stopTimeTracking(); // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä—ã –µ—Å–ª–∏ –µ—Å—Ç—å
                if (questionTimerInterval) clearInterval(questionTimerInterval);
                document.removeEventListener('visibilitychange', handleVisibilityChange);

                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—á–∏—Å—Ç–∫–∞ UI
                testView.classList.add('hidden');

                showMainMenu();
            }
        });

        // Profile Button Event Listener
        if (profileBtn) {
            profileBtn.addEventListener('click', loadUserProfile);
        }

        // Sync checkbox state
        const charToggle = document.getElementById('toggle-character-checkbox');
        if (charToggle) {
            charToggle.checked = characterEnabled;
        }
    });

    // Profile Functions
    async function loadUserProfile() {
        stopTimeTracking();
        appView.classList.remove('presentation-mode-active');
        windowTitle.textContent = '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç';
        backButtonAction = showMainMenu;

        // Hide other views
        const windowEl = appView.querySelector('.window');
        const tabsEl = document.getElementById('main-menu-tabs');
        const contentAreaEl = document.getElementById('content-area');

        if (windowEl && tabsEl && contentAreaEl && tabsEl.parentElement !== windowEl) {
             // Restore tabs position if needed (though main menu does this too)
             windowEl.insertBefore(tabsEl, contentAreaEl);
        }

        if (mainMenu) mainMenu.classList.add('hidden');
        if (productContent) productContent.classList.add('hidden');
        if (testView) testView.classList.add('hidden');
        if (testResultsView) testResultsView.classList.add('hidden');
        if (simulatorView) simulatorView.classList.add('hidden');
        if (extraToolsDiv) extraToolsDiv.classList.add('hidden');
        if (document.getElementById('main-content-wrapper')) document.getElementById('main-content-wrapper').classList.add('hidden');
        document.getElementById('main-menu-tabs').classList.add('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden');

        // Show Profile View
        profileView.classList.remove('hidden');
        backToMenuBtn.classList.remove('hidden');

        // Reset Profile View State (Skeleton/Loading)
        document.getElementById('profile-name').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        document.getElementById('profile-dept').textContent = '...';
        document.getElementById('stat-active').textContent = '...';
        document.getElementById('stat-completed').textContent = '...';
        document.getElementById('stat-score').textContent = '...';
        document.getElementById('stat-time').textContent = '...';
        document.querySelector('#profile-courses-table tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
        document.getElementById('profile-simulations-list').innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

        try {
            const data = await fetchAuthenticated('/api/getUserProfileData', { method: 'POST' });

            // Update Profile Header
            const fullName = data.user.full_name || data.user.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            document.getElementById('profile-avatar').textContent = initials;
            document.getElementById('profile-name').textContent = fullName;
            document.getElementById('profile-dept').textContent = data.user.department || '–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –Ω–µ —É–∫–∞–∑–∞–Ω';
            document.getElementById('profile-email').textContent = data.user.email || '';

            // Update Stats
            document.getElementById('stat-active').textContent = data.stats.courses_assigned - data.stats.courses_completed;
            document.getElementById('stat-completed').textContent = data.stats.courses_completed;
            document.getElementById('stat-score').textContent = `${data.stats.average_score}%`;
            const hours = Math.floor(data.stats.total_time_minutes / 60);
            const minutes = data.stats.total_time_minutes % 60;
            document.getElementById('stat-time').textContent = `${hours}—á ${minutes}–º`;

            // Render Courses
            const tbody = document.querySelector('#profile-courses-table tbody');
            tbody.innerHTML = '';
            if (data.courses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 20px;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫—É—Ä—Å–æ–≤.</td></tr>';
            } else {
                window.profileCoursesMap = {};
                data.courses.forEach(course => {
                    window.profileCoursesMap[course.id] = course;
                    const tr = document.createElement('tr');
                    let statusClass = 'status-assigned';
                    let statusText = '–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
                    let actionBtn = `<button class="btn" style="padding: 5px 10px; font-size: 0.8em;" onclick="showPresentationView('${course.id}')">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>`;

                    if (course.status === 'completed') {
                        statusClass = 'status-completed';
                        statusText = '–ó–∞–≤–µ—Ä—à–µ–Ω';
                        if (course.is_late) {
                            statusText += ' (–° –æ–ø–æ–∑–¥–∞–Ω–∏–µ–º)';
                            statusClass = 'status-overdue'; // Use overdue color for late completion warning
                        }
                        actionBtn = `<button class="btn view-results-btn" style="padding: 5px 10px; font-size: 0.8em; background-color: var(--success-color);" data-course-id="${course.id}">–†–µ–∑—É–ª—å—Ç–∞—Ç</button>`;
                    } else if (course.status === 'overdue') {
                        statusClass = 'status-overdue';
                        statusText = '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω';
                    }

                    // Format dates including time
                    const formatDate = (dateString) => {
                        if (!dateString) return '-';
                        const date = new Date(dateString);
                        return date.toLocaleDateString('ru-RU', {
                            year: 'numeric',
                            month: 'numeric',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    };

                    let deadlineHtml = '-';
                    if (course.completed_at) {
                        deadlineHtml = `
                            <div style="font-size: 0.9em;">
                                <div style="color: var(--success-color);">–ó–∞–≤–µ—Ä—à–µ–Ω:</div>
                                <div>${formatDate(course.completed_at)}</div>
                                ${course.is_late ? '<div style="color: var(--error-color); font-weight: bold; font-size: 0.8em;">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>' : ''}
                            </div>
                        `;
                    } else if (course.deadline_date) {
                        deadlineHtml = `
                            <div style="font-size: 0.9em;">
                                <div style="color: var(--text-light-color);">–î–µ–¥–ª–∞–π–Ω:</div>
                                <div>${formatDate(course.deadline_date)}</div>
                            </div>
                        `;
                    }

                    // Calculate display progress
                    let progressDisplay = '0%';
                    if (course.status === 'completed') {
                        progressDisplay = '100%';
                    } else if (course.last_slide_index > 0) {
                        progressDisplay = `–°–ª–∞–π–¥ ${course.last_slide_index + 1}`;
                    } else if (course.progress > 0) {
                        progressDisplay = `${course.progress}%`;
                    }

                    tr.innerHTML = `
                        <td>${course.title}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${progressDisplay}</td>
                        <td>${course.score !== null ? course.score + '%' : '-'}</td>
                        <td>${deadlineHtml}</td>
                        <td>${actionBtn}</td>
                    `;
                    tbody.appendChild(tr);
                });

                tbody.querySelectorAll('.view-results-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const courseId = e.target.dataset.courseId;
                        const course = window.profileCoursesMap[courseId];
                        if (course) showCourseResultModal(course);
                    });
                });
            }

            // Render Simulations
            const simList = document.getElementById('profile-simulations-list');
            simList.innerHTML = '';
            if (data.simulations.length === 0) {
                simList.innerHTML = '<p class="message">–í—ã –µ—â–µ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Å–∏–º—É–ª—è—Ü–∏–∏.</p>';
            } else {
                data.simulations.forEach(sim => {
                    const simDiv = document.createElement('div');
                    simDiv.className = 'sim-card';

                    let historyHtml = '';
                    if (sim.evaluation_details && sim.evaluation_details.dialogue_history) {
                        historyHtml = `<div class="dialogue-history-container"><h4>–ü–æ–ª–Ω—ã–π –¥–∏–∞–ª–æ–≥:</h4>`;
                        sim.evaluation_details.dialogue_history.forEach(msg => {
                            const roleLabel = msg.role === 'user' ? '–í—ã' : '–ö–ª–∏–µ–Ω—Ç (–ò–ò)';
                            historyHtml += `<div class="dialogue-msg"><strong>${roleLabel}:</strong> ${escapeHTML(msg.text)}</div>`;
                        });
                        historyHtml += `</div>`;
                    }

                    let criteriaHtml = '';
                    if (sim.evaluation_details && sim.evaluation_details.evaluation_criteria) {
                         criteriaHtml = `<div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;"><h4>–î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞:</h4>`;
                         criteriaHtml += `<ul style="list-style: none; padding-left: 0;">`;
                         sim.evaluation_details.evaluation_criteria.forEach(c => {
                             criteriaHtml += `<li style="margin-bottom: 8px;"><strong>${c.criterion}:</strong> <span style="color: var(--primary-color); font-weight: bold;">${c.score}/10</span><br><span style="font-size: 0.9em; color: #666;">${c.comment}</span></li>`;
                         });
                         criteriaHtml += `</ul></div>`;
                    }

                    simDiv.innerHTML = `
                        <div class="sim-header">
                            <div style="font-weight: bold;">${sim.scenario}</div>
                            <div style="font-size: 0.9em; color: #777;">${new Date(sim.created_at).toLocaleDateString('ru-RU')}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>–û—Ü–µ–Ω–∫–∞ –ò–ò: <span style="font-weight: bold; color: var(--primary-color);">${sim.average_score}/10</span></div>
                            <button class="btn" style="padding: 5px 10px; font-size: 0.8em; background: #eee; color: #333;" onclick="this.closest('.sim-card').classList.toggle('expanded')">–î–µ—Ç–∞–ª–∏</button>
                        </div>
                        <div class="sim-feedback">
                            <strong>–û–±—â–∏–π –æ—Ç–∑—ã–≤:</strong> ${sim.feedback_summary}
                            ${criteriaHtml}
                            ${historyHtml}
                        </div>
                    `;
                    simList.appendChild(simDiv);
                });
            }

        } catch (error) {
            console.error('Error loading profile:', error);
            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.', 'error');
        }
    }

    function switchProfileTab(tabName) {
        const buttons = document.querySelectorAll('.p-tab-btn');
        buttons.forEach(btn => btn.classList.remove('active'));

        const contents = document.querySelectorAll('.profile-tab-content');
        contents.forEach(c => c.classList.add('hidden'));

        if (tabName === 'history') {
            buttons[0].classList.add('active');
            document.getElementById('profile-tab-history').classList.remove('hidden');
        } else if (tabName === 'simulations') {
            buttons[1].classList.add('active');
            document.getElementById('profile-tab-simulations').classList.remove('hidden');
        }
    }

    let currentScenario = '';
    // –ó–∞–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é showSimulatorView –Ω–∞ —ç—Ç—É:
    function showSimulatorView(fromCourseId = null) {
        stopTimeTracking();
        windowTitle.textContent = '–î–∏–∞–ª–æ–≥–æ–≤—ã–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä';

        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ª–∏—à–Ω–µ–µ
        document.getElementById('main-content-wrapper').classList.add('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden');
        productContent.classList.add('hidden');
        if (profileView) profileView.classList.add('hidden');
        if (testView) testView.classList.add('hidden'); // –í–∞–∂–Ω–æ —Å–∫—Ä—ã—Ç—å —Ç–µ—Å—Ç, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –æ—Ç–∫—Ä—ã—Ç

        simulatorView.classList.remove('hidden');

        // –ó–ê–î–ê–ß–ê 2: –°–∫—Ä—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
        if (backToMenuBtn) backToMenuBtn.classList.add('hidden');

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
        const simBackBtn = document.getElementById('simulator-back-btn');
        if (simBackBtn) {
            simBackBtn.onclick = () => {
                // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –∏–∑ –∫—É—Ä—Å–∞ (–ø–µ—Ä–µ–¥–∞–Ω ID) - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫—É—Ä—Å
                if (fromCourseId && typeof fromCourseId === 'string') {
                     // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º currentCourse –µ—Å–ª–∏ –æ–Ω –ø–æ—Ç–µ—Ä—è–ª—Å—è
                    if (!currentCourse || currentCourse.id !== fromCourseId) {
                        const group = courses.find(g => g.courses.some(c => c.id === fromCourseId));
                        if (group) currentCourse = group.courses.find(c => c.id === fromCourseId);
                    }
                    showPresentationView(fromCourseId);
                } else {
                    // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
                    showMainMenu();
                }
            };
        }

        simulatorSetup.classList.remove('hidden');
        simulatorChatArea.classList.add('hidden');
        simulatorEvaluationArea.classList.add('hidden');
        simulatorChatBox.innerHTML = '';
        simulationHistory = [];
        currentScenario = '';
    }
    launchSimulatorBtn.addEventListener('click', showSimulatorView);
    restartSimulationBtn.addEventListener('click', showSimulatorView);
    function appendSimulatorMessage(text, role, isThinking = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}-message`;
        const textSpan = document.createElement('span');
        textSpan.textContent = text;
        if (isThinking) {
            messageDiv.classList.add('thinking');
            messageDiv.id = 'simulator-thinking-indicator';
        }
        messageDiv.appendChild(textSpan);
        simulatorChatBox.appendChild(messageDiv);
        simulatorChatBox.scrollTop = simulatorChatBox.scrollHeight;
    }
    function updateLastSimulatorMessage(text) {
        const thinkingIndicator = document.getElementById('simulator-thinking-indicator');
        if (thinkingIndicator) {
            thinkingIndicator.querySelector('span').textContent = text;
            thinkingIndicator.classList.remove('thinking');
            thinkingIndicator.id = '';
        }
    }
    startSimulationBtn.addEventListener('click', async () => {
        simulatorSetup.classList.add('hidden');
        simulatorChatArea.classList.remove('hidden');

        // –û—á–∏—â–∞–µ–º —á–∞—Ç –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º
        simulatorChatBox.innerHTML = '';

        appendSimulatorMessage('–ü–æ–¥–±–∏—Ä–∞—é —Å—Ü–µ–Ω–∞—Ä–∏–π –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç–≤–µ—Ç...', 'assistant', true);

        try {
            const disposition = document.getElementById('disposition-slider').value;
            const data = await fetchAuthenticated('/api/dialogueSimulator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'start', disposition })
            });

            if (!data.scenario || !data.first_message) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è.");

            currentScenario = data.scenario;

            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –Ø–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ —á–∞—Ç–µ
            const scenarioDiv = document.createElement('div');
            scenarioDiv.style.backgroundColor = '#fff3cd';
            scenarioDiv.style.border = '1px solid #ffeeba';
            scenarioDiv.style.color = '#856404';
            scenarioDiv.style.padding = '10px';
            scenarioDiv.style.marginBottom = '15px';
            scenarioDiv.style.borderRadius = '5px';
            scenarioDiv.style.fontSize = '0.9em';
            scenarioDiv.innerHTML = `<strong>–í–∞—à–∞ –ª–µ–≥–µ–Ω–¥–∞ (–°—Ü–µ–Ω–∞—Ä–∏–π):</strong><br>${data.scenario}`;
            simulatorChatBox.prepend(scenarioDiv);

            updateLastSimulatorMessage(data.first_message);
            simulationHistory.push({ role: 'assistant', text: data.first_message });
        } catch (error) {
            updateLastSimulatorMessage(`–û—à–∏–±–∫–∞: ${error.message}`);
        }
    });
    simulatorChatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userInput = simulatorChatInput.value.trim();
        if (!userInput) return;
        const submitBtn = document.getElementById('simulator-submit-btn');
        appendSimulatorMessage(userInput, 'user');
        simulationHistory.push({ role: 'user', text: userInput });
        simulatorChatInput.value = '';
        simulatorChatInput.disabled = true;
        if(submitBtn) submitBtn.disabled = true;
        appendSimulatorMessage('...', 'assistant', true);
        try {
            if (!currentScenario) throw new Error("–°—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ –±—ã–ª –Ω–∞—á–∞—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—Ä–µ–Ω–∞–∂–µ—Ä.");
            const disposition = document.getElementById('disposition-slider').value;
            const data = await fetchAuthenticated('/api/dialogueSimulator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    history: simulationHistory,
                    disposition: disposition,
                    scenario: currentScenario,
                    action: 'chat'
                })
            });
            const aiResponse = data.answer ? data.answer.trim() : '';
            if (aiResponse) {
                updateLastSimulatorMessage(aiResponse);
                simulationHistory.push({ role: 'assistant', text: aiResponse });
            } else {
                updateLastSimulatorMessage("–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞—Ç—å.");
            }
        } catch (error) {
            updateLastSimulatorMessage(`–û—à–∏–±–∫–∞: ${error.message}`);
        } finally {
            simulatorChatInput.disabled = false;
            if(submitBtn) submitBtn.disabled = false;
            simulatorChatInput.focus();
        }
    });
    endSimulationBtn.addEventListener('click', async () => {
        if (simulationHistory.length === 0) {
            showToast('–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥.', 'info');
            return;
        }
        if (!currentScenario) {
            showToast("–û—à–∏–±–∫–∞: —Å—Ü–µ–Ω–∞—Ä–∏–π –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—Ä–µ–Ω–∞–∂–µ—Ä.", 'error');
            return;
        }
        simulatorChatArea.classList.add('hidden');
        simulatorEvaluationArea.classList.remove('hidden');
        evaluationResults.innerHTML = '<div class="loader"></div>';
        try {
             const disposition = document.getElementById('disposition-slider').value;
             const data = await fetchAuthenticated('/api/dialogueSimulator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    history: simulationHistory,
                    action: 'evaluate',
                    disposition: disposition,
                    scenario: currentScenario
                })
            });
            evaluationResults.innerHTML = '';
            const evaluationData = data.answer;
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ –∏ –æ—Ü–µ–Ω–∫—É';
            downloadBtn.style.marginTop = '10px';
            downloadBtn.style.marginBottom = '15px';
            downloadBtn.onclick = () => {
                const dialogueText = simulationHistory.map(h => `${h.role.toUpperCase()}: ${h.text}`).join('\n');
                const evaluationText = JSON.stringify(evaluationData, null, 2);
                const fullText = `–°–¶–ï–ù–ê–†–ò–ô: ${currentScenario}\n\n–î–ò–ê–õ–û–ì\n--------------------\n${dialogueText}\n\n–û–¶–ï–ù–ö–ê –ò–ò\n--------------------\n${evaluationText}`;
                const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dialogue-evaluation-${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            evaluationResults.appendChild(downloadBtn);
            const resultsTable = document.createElement('table');
            resultsTable.style.width = '100%';
            resultsTable.style.borderCollapse = 'collapse';
            resultsTable.innerHTML = `
                <tr style="background-color: var(--bg-color);">
                    <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left;">–ö—Ä–∏—Ç–µ—Ä–∏–π</th>
                    <th style="border: 1px solid var(--border-color); padding: 8px; text-align: center;">–û—Ü–µ–Ω–∫–∞</th>
                    <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                </tr>
            `;
            if(evaluationData.evaluation_criteria) {
                evaluationData.evaluation_criteria.forEach(item => {
                    resultsTable.innerHTML += `
                        <tr>
                            <td style="border: 1px solid var(--border-color); padding: 8px;">${item.criterion}</td>
                            <td style="border: 1px solid var(--border-color); padding: 8px; text-align: center; font-weight: bold;">${item.score}/10</td>
                            <td style="border: 1px solid var(--border-color); padding: 8px;">${item.comment}</td>
                        </tr>
                    `;
                });
            }
            evaluationResults.appendChild(resultsTable);
            const summary = document.createElement('div');
            summary.style.marginTop = '15px';
            if(evaluationData.average_score && evaluationData.general_comment) {
                summary.innerHTML = `
                    <h4 style="margin-bottom: 5px;">–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: <span style="color: var(--primary-color);">${evaluationData.average_score.toFixed(1)}</span></h4>
                    <p><strong>–û–±—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${evaluationData.general_comment}</p>
                `;
            }
            evaluationResults.appendChild(summary);
        } catch (error) {
            evaluationResults.textContent = `–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ü–µ–Ω–∫–∏: ${error.message}`;
        }
    });
</script>
</body>
</html>
