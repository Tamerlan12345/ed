<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <title>AI-Платформа Обучения | Centras Insurance</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap');
        :root{--primary-color:#005A9C;--secondary-color:#00AEEF;--bg-color:#f4f7f6;--surface-color:#ffffff;--text-color:#333333;--text-light-color:#777777;--border-color:#e0e0e0;--success-color:#28a745;--error-color:#dc3545;--shadow:0 4px 15px rgba(0,0,0,0.08)}*{box-sizing:border-box}body,html{height:100%;margin:0;background-color:var(--bg-color);color:var(--text-color);font-family:'Lato',sans-serif;font-size:16px}.hidden{display:none !important}.container{width:100%;height:100%;padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center}.window{border:1px solid var(--border-color);padding:30px;box-shadow:var(--shadow);background:var(--surface-color);border-radius:12px;width:100%;max-width:1300px;position:relative}.window-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);padding-bottom:15px;margin-bottom:25px}.window-header h1,.window-header h2{margin:0;font-size:1.8em;color:var(--primary-color);font-weight:700}.logo{height:45px;width:auto}.content-area{height:60vh;overflow-y:auto;padding-right:15px}.content-area::-webkit-scrollbar{width:8px}.content-area::-webkit-scrollbar-track{background:#f1f1f1}.content-area::-webkit-scrollbar-thumb{background:var(--secondary-color);border-radius:4px}.content-area::-webkit-scrollbar-thumb:hover{background:var(--primary-color)}input[type="text"],input[type="email"],input[type="password"]{background-color:var(--bg-color);border:1px solid var(--border-color);color:var(--text-color);padding:12px 15px;margin-bottom:15px;width:100%;font-family:'Lato',sans-serif;border-radius:8px;transition:border-color .3s,box-shadow .3s}input:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(0,90,166,0.2)}button,.btn{background:var(--primary-color);border:none;color:#fff;padding:12px 25px;cursor:pointer;transition:all .3s ease;box-shadow:0 2px 8px rgba(0,0,0,0.1);border-radius:10px;font-weight:700;font-family:'Lato',sans-serif;letter-spacing:.2px;margin-top:10px}button:hover,.btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,90,166,0.2);background:var(--secondary-color)}button:disabled{background:var(--text-light-color);cursor:not-allowed;transform:none;box-shadow:none}#auth-error{color:var(--error-color);margin-top:10px;text-align:center;font-weight:bold}#main-menu{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px}.menu-item{padding:20px;border:1px solid var(--border-color);border-radius:10px;cursor:pointer;transition:all .3s ease;background-color:var(--surface-color)}.menu-item:hover{transform:translateY(-5px);box-shadow:var(--shadow);border-color:var(--primary-color)}.menu-item h3{margin-top:0;color:var(--primary-color);display:flex;align-items:center}.menu-item-icon{font-size:1.5em;margin-right:15px;color:var(--secondary-color)}.menu-item.completed{border-left:5px solid var(--success-color)}.menu-item.completed h3{color:var(--success-color)}.menu-item.completed::after{content:'✓ Завершено';color:var(--success-color);font-size:.8em;font-weight:bold;display:block;margin-top:10px}#product-content h2,#product-content h3{color:var(--primary-color)}#product-content h3{border-bottom:2px solid var(--secondary-color);padding-bottom:5px;margin-top:25px}#product-content ul{list-style-type:'✓ ';padding-left:20px}#product-content li{padding-left:10px;margin-bottom:10px}#test-view .question{margin-bottom:20px;font-size:1.3em;font-weight:bold;color:var(--primary-color)}#test-view .answers{display:flex;flex-direction:column;gap:10px}#test-view .answer{border:2px solid var(--border-color);padding:15px;cursor:pointer;border-radius:8px;transition:all .2s ease-in-out}#test-view .answer:hover{background-color:#e9f7fe;border-color:var(--secondary-color)}#test-results p{font-size:1.2em}#test-results .score{color:var(--primary-color);font-weight:bold;font-size:2em}.window-footer{margin-top:20px;border-top:1px solid var(--border-color);padding-top:20px;display:flex;justify-content:space-between;align-items:center}#back-to-menu-btn{background:var(--text-light-color)}#back-to-menu-btn:hover{background:#555;box-shadow:0 4px 10px rgba(0,0,0,0.2)}.loader{width:50px;height:50px;border:5px solid var(--bg-color);border-top-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite;margin:50px auto}.message{text-align:center;padding:20px;font-size:1.1em;color:var(--text-light-color)}@keyframes spin{to{transform:rotate(360deg)}}#assistant-container{margin-top:30px;padding-top:20px;border-top:1px dashed var(--border-color)}#assistant-container h3{color:var(--primary-color);margin-top:0}#chat-box{height:150px;overflow-y:auto;border:1px solid var(--border-color);border-radius:8px;padding:10px;margin-bottom:10px;background-color:var(--bg-color)}.chat-message{margin-bottom:10px}.user-message{text-align:right}.assistant-message span{background-color:#e9f7fe;padding:5px 10px;border-radius:10px;display:inline-block}.thinking{color:var(--text-light-color);font-style:italic}#chat-form{display:flex;gap:10px}#chat-input{flex-grow:1;margin:0}#chat-form button{margin:0}#admin-controls{text-align:right;margin-bottom:15px}
    </style>
    <style>
        /* Card UI Overrides for .menu-item */
        .menu-item {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .menu-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .tab-btn:not(.active):hover {
            background-color: rgba(0,0,0,0.03);
            border-bottom-color: var(--border-color);
        }
        .course-group-container {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }
        .course-group-container h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
        }
        .skeleton-card { background-color: #e0e0e0; border-radius: 12px; height: 150px; position: relative; overflow: hidden; }
        .skeleton-card::after { content: ''; position: absolute; top: 0; left: -150%; width: 150%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { left: -150%; } 100% { left: 150%; } }
    </style>
    <style>
        .tab-btn{padding:10px 20px;border:none;background-color:transparent;cursor:pointer;font-size:1em;color:var(--text-light-color);border-bottom:3px solid transparent;margin-bottom:-2px}.tab-btn.active{color:var(--primary-color);border-bottom-color:var(--primary-color);font-weight:bold}
        #product-nav { padding: 10px; background-color: var(--bg-color); border-bottom: 1px solid var(--border-color); margin-bottom: 15px; }
        #product-nav a { margin-right: 15px; text-decoration: none; color: var(--text-light-color); font-weight: bold; }
        #product-nav a.active { color: var(--primary-color); }
        #product-nav a .lock-icon { display: inline-block; margin-left: 5px; }
        .presentation-view{height:100%;display:flex;flex-direction:column}
        .presentation-slider{width:100%;background:#e9ecef;border:1px solid #dee2e6;border-radius:12px;margin-top:20px;box-shadow:0 8px 30px rgba(0,0,0,0.05);flex:1 1 auto;overflow-y:auto}.presentation-slide{display:none;padding:40px 60px;animation:fadeIn .6s;word-wrap:break-word}.presentation-slide.active{display:block}.presentation-slide img{max-height:250px;width:100%;object-fit:cover;border-radius:8px;margin-bottom:20px;box-shadow:0 4px 10px rgba(0,0,0,0.1)}.slider-nav-container{display:flex;justify-content:space-between;align-items:center;padding:15px 40px;border-top:1px solid var(--border-color);background-color:#f8f9fa;flex-shrink:0}.slider-nav button{width:auto;padding:10px 22px;font-size:1em;border-radius:50px;background-color:var(--primary-color);color:white;border:none;cursor:pointer;transition:all .3s ease}.slider-nav button:hover{background-color:var(--secondary-color)}.slider-nav button:disabled{background-color:#ccc;cursor:not-allowed;opacity:0.6}.slide-counter{font-size:1em;color:var(--text-color);font-weight:bold}@keyframes fadeIn{from{opacity:0.2}to{opacity:1}}
    </style>
    <style>
        /* Floating Chat Button Styles */
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 174, 239, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 12px rgba(0, 174, 239, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 174, 239, 0); }
        }
        #floating-chat-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background-color: var(--primary-color);
            border-radius: 50%;
            border: none;
            box-shadow: var(--shadow);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: all .3s ease;
            animation: pulse 2.5s infinite;
        }
        #floating-chat-btn:hover {
            transform: scale(1.1);
            background-color: var(--secondary-color);
        }
        #floating-chat-btn svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        /* Override for Assistant Container to be a floating panel with smooth animation */
        #assistant-container {
            position: fixed;
            bottom: 90px;
            left: 20px;
            width: 370px;
            max-width: 90vw;
            background: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            z-index: 999;
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-top: 0;
            border-top: none;

            /* New animation properties */
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
        }

        #assistant-container.hidden {
            display: block !important; /* Override display:none to allow animation */
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px); /* Start position for slide-in effect */
            pointer-events: none;
        }
        #assistant-container h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        #chat-box {
            height: 250px;
        }

        /* Compact Presentation Slide Styles */
        .presentation-slide {
            padding: 25px 50px !important; /* Reduce padding */
        }
        .presentation-slide img {
            max-height: 220px !important; /* Reduce image height */
            margin-bottom: 15px !important; /* Reduce space after image */
        }
        .presentation-slide h2 {
            margin-bottom: 15px !important;
        }
        .presentation-slide p, .presentation-slide li {
            font-size: 0.95rem !important;
            line-height: 1.45 !important;
        }

        /* --- Presentation View Redesign --- */
        /* This class is added to #main-flex-container when a course is active */
        #main-flex-container.presentation-active {
            flex-wrap: nowrap; /* Ensure columns stay side-by-side */
        }

        /* --- Layout Rules: Leaderboard on the left, Main Content on the right --- */

        /* The order is now fixed and will not change. */
        #leaderboard-container {
            order: 1;
            flex: 1 1 30%;
            min-width: 300px;
            align-self: flex-start; /* Fix for consistent vertical alignment */
        }
        #main-content-wrapper {
            order: 2;
            flex: 3 1 70%;
        }

        /* When a presentation is active, we only ensure the flex properties are set for the two-column view */
        #main-flex-container.presentation-active #main-content-wrapper {
            flex: 3 1 70%;
        }
        #main-flex-container.presentation-active #leaderboard-container {
            flex: 1 1 30%;
        }

        /* Make the presentation slider taller when active */
        #main-flex-container.presentation-active .presentation-slider {
            height: 70vh;
        }

        /* On smaller screens, stack them vertically */
        @media (max-width: 950px) {
            #main-flex-container.presentation-active {
                flex-wrap: wrap;
            }
            #main-flex-container.presentation-active #main-content-wrapper,
            #main-flex-container.presentation-active #leaderboard-container {
                order: 0; /* Reset order */
                flex: 1 1 100%; /* Each takes full width */
            }
        }

        /* Floating Chat Button Tooltip Styles */
        #floating-chat-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }
        .chat-tooltip {
            position: absolute;
            bottom: 5px;
            left: 75px;
            padding: 10px 15px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            font-size: 0.9rem;
            max-width: 230px;
            white-space: normal;
            text-align: left;
            pointer-events: none;
        }
        .chat-tooltip::before {
            content: '';
            position: absolute;
            top: 50%;
            right: 100%;
            margin-top: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: transparent var(--border-color) transparent transparent;
        }
        .chat-tooltip::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 100%;
            margin-top: -5px;
            margin-right: -1px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent var(--surface-color) transparent transparent;
        }
        #floating-chat-container:hover .chat-tooltip {
            opacity: 1;
            visibility: visible;
        }
    </style>
    <style id="jules-overrides">
        body.presentation-active-fullscreen {
            overflow: hidden;
        }
        body.presentation-active-fullscreen #app-view.container {
            padding: 0;
            max-width: 100%;
        }
        body.presentation-active-fullscreen #app-view .window {
            padding: 0;
            border: 0;
            border-radius: 0;
            box-shadow: none;
            max-width: 100%;
            height: 100vh;
            background: var(--bg-color);
        }
        body.presentation-active-fullscreen .window-header,
        body.presentation-active-fullscreen .window-footer,
        body.presentation-active-fullscreen #leaderboard-container,
        body.presentation-active-fullscreen .actions-sidebar {
            display: none !important;
        }
        body.presentation-active-fullscreen #back-to-menu-btn {
            display: block !important;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }
        body.presentation-active-fullscreen .content-area.presentation-mode {
            height: 100% !important;
            padding: 0 !important;
            overflow: hidden !important;
        }
        /* New rule to prevent the main content area from scrolling when the presentation is active */
        .content-area.no-scroll {
            overflow-y: hidden;
        }
        body.presentation-active-fullscreen .presentation-wrapper {
            padding: 0;
            gap: 0;
            height: 100%;
            border-radius: 0;
        }
        body.presentation-active-fullscreen .presentation-column {
            height: 100%;
        }
        body.presentation-active-fullscreen .presentation-slider {
            border-radius: 0;
            border: none;
            height: 100% !important;
        }
        body.presentation-active-fullscreen .presentation-slide {
            padding: 40px 80px !important;
        }
        body.presentation-active-fullscreen .slider-nav-container {
            position: absolute;
            bottom: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            border-top: 1px solid var(--border-color);
            z-index: 10;
        }
        .course-actions-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
            justify-content: center;
        }
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 25px;
            border-radius: 12px;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--primary-color);
        }
        .action-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            border-color: var(--primary-color);
        }
        .action-btn .icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        .actions-sidebar {
            padding: 20px;
            background: #f8f9fa;
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .actions-sidebar h3 {
            margin-top: 0;
            font-size: 1.2em;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .actions-sidebar button {
            width: 100%;
        }
    </style>
    <style>
        /* --- Presentation Redesign & Mobile Optimization --- */
        .presentation-slide {
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .presentation-slide h2 {
            font-size: 2.2rem;
            margin-bottom: 25px !important;
            color: var(--primary-color);
        }

        .presentation-slide p, .presentation-slide li, .presentation-slide ul {
            font-size: 1.1rem !important;
            line-height: 1.7 !important;
            color: var(--text-color);
        }

        .presentation-slide ul {
            padding-left: 40px;
        }

        .presentation-slide li {
            margin-bottom: 12px;
        }

        /* Mobile Optimizations for Presentation */
        @media (max-width: 768px) {
            body.presentation-active-fullscreen .presentation-slide {
                padding: 30px 25px !important;
            }

            .presentation-slide h2 {
                font-size: 1.8rem;
            }

            .presentation-slide p, .presentation-slide li, .presentation-slide ul {
                font-size: 1rem !important;
                line-height: 1.6 !important;
            }

            .slider-nav-container {
                padding: 10px 20px;
            }

            .slider-nav button {
                padding: 10px 18px;
                font-size: 0.9em;
            }
        }

        /* --- General Visual Enhancements --- */
        .window {
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.12);
        }

        .menu-item:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: var(--secondary-color);
        }

        .tab-btn {
            transition: all 0.2s ease-in-out;
            border-radius: 6px 6px 0 0;
            padding: 12px 22px;
        }

        .tab-btn:hover:not(.active) {
            background-color: rgba(0, 90, 156, 0.05);
            color: var(--primary-color);
        }

        .action-btn {
            border-radius: 16px;
            font-size: 1em;
            background-color: var(--bg-color);
            border: 2px dashed var(--border-color);
            box-shadow: none;
            color: var(--text-light-color);
        }
        .action-btn:hover {
            background-color: var(--surface-color);
            border-style: solid;
            border-color: var(--secondary-color);
            color: var(--secondary-color);
            transform: translateY(-3px) scale(1.02);
            box-shadow: var(--shadow);
        }

        /* --- Main Page Mobile Optimizations --- */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .window {
                padding: 20px 15px;
            }

            .window-header {
                flex-wrap: wrap;
                gap: 15px;
                justify-content: center;
            }

            .window-header h2 {
                width: 100%;
                text-align: center;
                order: -1;
            }

            #main-flex-container {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .window-header h2 {
                font-size: 1.4em;
            }

            #main-menu {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .menu-item h3 {
                font-size: 1.1em;
            }

            button, .btn {
                padding: 12px 18px;
                font-size: 0.9em;
            }
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2?v=4"></script>
    
    <script>
        const SUPABASE_URL = 'https://wnsdlibhrlmgyszbyxat.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Induc2RsaWJocmxtZ3lzemJ5eGF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyODE0MjgsImV4cCI6MjA2OTg1NzQyOH0.Sgz-50dHj8M599sIjTRYs0kMP7b6kX2BJ-Gc-trMUQ4';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
</head>
<body>
    <div id="auth-view" class="container">
        <div class="window">
            <div class="window-header"><h1>Вход в систему</h1></div>
            <form id="auth-form">
                <p>Пожалуйста, используйте выданные вам логин и пароль.</p>
                <input type="email" id="user-email" placeholder="Рабочий Email" required>
                <input type="password" id="user-password" placeholder="Пароль" required>
                <div id="auth-error" class="hidden"></div>
                <button type="submit" id="auth-button">Войти</button>
            </form>
        </div>
    </div>

    <div id="app-view" class="container hidden">
        <div class="window">
             <div class="window-header">
                <h2 id="window-title">Главное Меню</h2>
                <div class="header-controls">
                    <div id="notifications-bell" style="position: relative; cursor: pointer;">
                        <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M21 19v1H3v-1l2-2v-6c0-3.1 2.03-5.83 5-6.71V4a2 2 0 0 1 2-2a2 2 0 0 1 2 2v.29c2.97.88 5 3.61 5 6.71v6l2 2m-7 2a2 2 0 0 1-2-2h4a2 2 0 0 1-2 2"/></svg>
                        <span id="notifications-badge" class="hidden" style="position: absolute; top: -5px; right: -5px; background: var(--error-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; align-items: center; justify-content: center;"></span>
                    </div>
                    <div id="notifications-panel" class="hidden" style="position: absolute; top: 60px; right: 20px; width: 300px; background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow); z-index: 100;">
                        <div style="padding: 10px; border-bottom: 1px solid var(--border-color); font-weight: bold;">Уведомления</div>
                        <div id="notifications-list" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
                 <img src="https://centras.kz/wp-content/uploads/2023/12/centras-insurance-col.png" alt="Logo" class="logo">
                 <button id="logout-btn" style="background: transparent; border: none; cursor: pointer; font-size: 1.5em; margin-left: 20px;" title="Выйти">🚪</button>
            </div>
            <div id="content-loader" class="hidden" style="display: flex; justify-content: center; align-items: center; height: 60vh;"><div class="loader"></div></div>
            <div class="content-area" id="content-area">
                <div id="main-flex-container" style="display: flex; flex-wrap: wrap; gap: 20px;">
                    <div id="leaderboard-container" style="flex: 1 1 300px; min-width: 280px; padding: 15px; background-color: #e9f7fe; border-radius: 8px; align-self: flex-start;">
                        <h3 style="margin-top: 0; color: var(--primary-color);">🏆 Топ Учеников Недели</h3>
                        <div id="leaderboard-content"></div>
                    </div>
                    <div id="main-content-wrapper" style="flex: 2 1 500px;">
                        <div id="main-menu-tabs" style="display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 15px;">
                            <button class="tab-btn active" data-filter="assigned">📥 Назначенные</button>
                            <button class="tab-btn" data-filter="completed">✅ Пройденные</button>
                            <button class="tab-btn" data-filter="catalog">📚 Каталог</button>
                        </div>
                        <div id="main-menu"></div>
                        <div id="extra-tools" style="padding-top: 20px; border-top: 1px solid #eee;">
                            <button id="launch-simulator-btn">Диалоговый тренажер</button>
                        </div>
                        <div id="admin-controls" class="hidden"></div>
                        <div id="product-content" class="hidden"></div>
                        <div id="audio-player-container-user" style="margin-top: 15px;"></div>
                        <div id="assistant-container" class="hidden">
                            <h3>AI-Ассистент</h3>
                            <div id="chat-box"></div>
                            <form id="chat-form">
                                <input type="text" id="chat-input" placeholder="Задайте вопрос по материалу..." autocomplete="off">
                                <button type="submit">Отправить</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div id="test-view" class="hidden">
                    <p id="question-counter"></p>
                    <div id="question" class="question"></div>
                    <div id="answers" class="answers"></div>
                    <button id="next-question-btn" class="hidden">Следующий вопрос</button>
                </div>
                <div id="test-results" class="hidden">
                     <h2>Результаты тестирования</h2>
                    <p>Продукт: <span id="results-product-name"></span></p>
                    <p>Ваш результат: <span id="results-score" class="score"></span></p>
                    <p id="results-feedback"></p>
                    <button id="back-to-menu-from-results">Вернуться в меню</button>
                </div>
                <div id="simulator-view" class="hidden">
                    <div id="simulator-setup">
                        <h3>Настройка тренажера</h3>
                        <div style="margin-bottom: 20px;">
                            <label for="disposition-slider" style="display: block; margin-bottom: 10px; font-weight: bold;">1. Выберите настроение клиента:</label>
                            <input type="range" id="disposition-slider" min="0" max="2" value="1" style="width: 100%;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: var(--text-light-color);">
                                <span>Холодный</span>
                                <span>Нейтральный</span>
                                <span>Горячий</span>
                            </div>
                        </div>
                        <button id="start-simulation-btn">Начать диалог</button>
                    </div>
                    <div id="simulator-chat-area" class="hidden">
                        <div id="simulator-chat-box" style="height: 45vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; margin-bottom: 10px; background-color: var(--bg-color);"></div>
                        <form id="simulator-chat-form" style="display: flex; gap: 10px;">
                            <input type="text" id="simulator-chat-input" placeholder="Ваш ответ..." autocomplete="off" style="flex-grow: 1; margin: 0;">
                            <button type="submit">Отправить</button>
                        </form>
                        <button id="end-simulation-btn" style="margin-top: 10px; background-color: var(--error-color);">Завершить и получить оценку</button>
                    </div>
                    <div id="simulator-evaluation-area" class="hidden">
                        <h3>Оценка диалога</h3>
                        <div id="evaluation-results" style="white-space: pre-wrap; background-color: var(--bg-color); padding: 15px; border-radius: 8px;"></div>
                        <button id="restart-simulation-btn" style="margin-top: 10px;">Начать заново</button>
                    </div>
                </div>
            </div>
            <div class="window-footer">
                <button id="back-to-menu-btn" class="hidden">Назад в меню</button>
            </div>
        </div>
    </div>

<script>
    const userData = { email: '', token: null };
    let courses = [];
    let currentCourse = null;
    let userProgress = {};
    let simulationHistory = [];
    let backButtonAction = null;
    
    const authView = document.getElementById('auth-view');
    const appView = document.getElementById('app-view');
    const authForm = document.getElementById('auth-form');
    const authError = document.getElementById('auth-error');
    const contentArea = document.getElementById('content-area');
    const mainMenu = document.getElementById('main-menu');
    const productContent = document.getElementById('product-content');
    const testView = document.getElementById('test-view');
    const testResultsView = document.getElementById('test-results');
    const windowTitle = document.getElementById('window-title');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');
    const backToMenuFromResultsBtn = document.getElementById('back-to-menu-from-results');
    const audioPlayerContainerUser = document.getElementById('audio-player-container-user');
    const assistantContainer = document.getElementById('assistant-container');
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const adminControls = document.getElementById('admin-controls');
    const notificationsBell = document.getElementById('notifications-bell');
    const notificationsBadge = document.getElementById('notifications-badge');
    const notificationsPanel = document.getElementById('notifications-panel');
    const notificationsList = document.getElementById('notifications-list');

    // --- Simulator UI Elements ---
    const simulatorView = document.getElementById('simulator-view');
    const launchSimulatorBtn = document.getElementById('launch-simulator-btn');
    const extraToolsDiv = document.getElementById('extra-tools');
    const simulatorSetup = document.getElementById('simulator-setup');
    const simulatorChatArea = document.getElementById('simulator-chat-area');
    const simulatorEvaluationArea = document.getElementById('simulator-evaluation-area');
    const personaSelector = document.getElementById('persona-selector');
    const scenarioSelector = document.getElementById('scenario-selector');
    const startSimulationBtn = document.getElementById('start-simulation-btn');
    const simulatorChatBox = document.getElementById('simulator-chat-box');
    const simulatorChatForm = document.getElementById('simulator-chat-form');
    const simulatorChatInput = document.getElementById('simulator-chat-input');
    const endSimulationBtn = document.getElementById('end-simulation-btn');
    const evaluationResults = document.getElementById('evaluation-results');
    const restartSimulationBtn = document.getElementById('restart-simulation-btn');

    const contentLoader = document.getElementById('content-loader');

    function truncateText(text, maxLength = 120) {
        if (!text || text.length <= maxLength) {
            return text;
        }
        return text.substring(0, maxLength) + '...';
    }

    function showLoader() {
        contentArea.classList.add('hidden');
        contentLoader.classList.remove('hidden');
    }
    function hideLoader() {
        contentArea.classList.remove('hidden');
        contentLoader.classList.add('hidden');
    }
    function showMessage(message, details = '') {
        contentArea.innerHTML = `<div class="message">${message}<br><small style="color: #999;">${details}</small></div>`;
        hideLoader();
    }

    async function handleLogin(email, password) {
        const authButton = document.getElementById('auth-button');
        authButton.disabled = true;
        authButton.textContent = 'Вход...';
        authError.classList.add('hidden');

        try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) throw error;

            if (data && data.session) {
                await onLoginSuccess(data.session);
            } else {
                throw new Error("Ответ от сервера не содержит сессию.");
            }
        } catch (error) {
            console.error("Не удалось войти:", error);
            authError.textContent = 'Ошибка: неверный логин или пароль.';
            authError.classList.remove('hidden');
            authButton.disabled = false;
            authButton.textContent = 'Войти';
        }
    }

    async function onLoginSuccess(session) {
        userData.email = session.user.email;
        userData.token = session.access_token;

        authView.classList.add('hidden');
        appView.classList.remove('hidden');

        showLoader();
        await showMainMenu();
        // await loadNotifications(); // This is now handled by clicking the bell icon.
        hideLoader();
    }

    async function handleLogout() {
        await supabaseClient.auth.signOut();
        userData.token = null;
        userData.email = '';
        sessionStorage.clear();

        appView.classList.add('hidden');
        authView.classList.remove('hidden');
        document.getElementById('user-email').value = '';
        document.getElementById('user-password').value = '';
    }

    async function checkSession() {
        showLoader();
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            await onLoginSuccess(session);
        } else {
            authView.classList.remove('hidden');
            hideLoader();
        }
        // Attach listeners after session check
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('user-email').value.trim();
            const password = document.getElementById('user-password').value.trim();
            handleLogin(email, password);
        });
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
    }

    async function fetchAuthenticated(url, options = {}) {
        if (!userData.token) {
            console.error("Auth token is missing. Request cancelled.");
            throw new Error("Пользователь не авторизован. Токен отсутствует.");
        }
        const defaultHeaders = { 'Authorization': `Bearer ${userData.token}` };
        const finalOptions = { ...options, headers: { ...defaultHeaders, ...options.headers } };
        
        const response = await fetch(url, finalOptions);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: `Ошибка сервера: ${response.statusText} (${response.status})` }));
            console.error(`Authenticated fetch failed for ${url}. Status: ${response.status}.`, errorData);
            throw new Error(errorData.error);
        }
        return response.json();
    }

    notificationsBell.addEventListener('click', async () => {
        const isHidden = notificationsPanel.classList.toggle('hidden');
        if (!isHidden) {
            const notifications = await fetchAuthenticated('/api/getNotifications');
            const unreadNotificationIds = notifications.filter(n => !n.is_read).map(n => n.id);

            if (unreadNotificationIds.length > 0) {
                try {
                    await fetchAuthenticated('/api/markNotificationsAsRead', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notification_ids: unreadNotificationIds })
                    });
                    notificationsBadge.classList.add('hidden');
                    notificationsList.querySelectorAll('div').forEach(div => div.style.fontWeight = 'normal');
                } catch (error) {
                    console.error('Failed to mark notifications as read:', error);
                }
            }
        }
    });

    async function loadLeaderboard() {
        const leaderboardContent = document.getElementById('leaderboard-content');
        leaderboardContent.innerHTML = '<div class="loader" style="height: 20px; width: 20px; margin: 0;"></div>';
        try {
            const leaderboardData = await fetchAuthenticated('/api/get-leaderboard', { method: 'POST' });
            if (!leaderboardData || leaderboardData.length === 0) {
                leaderboardContent.innerHTML = '<p>На этой неделе пока нет лидеров. Станьте первым!</p>';
                return;
            }

            let html = '<ol style="margin: 0; padding-left: 20px;">';
            leaderboardData.forEach(user => {
                html += `<li style="margin-bottom: 5px;"><strong>${user.full_name || 'Аноним'}</strong>: Завершено курсов: ${user.courses_completed || 0}, Время обучения: ${user.total_time_spent_minutes || 0} мин.</li>`;
            });
            html += '</ol>';
            leaderboardContent.innerHTML = html;

        } catch (error) {
            console.error('Failed to load leaderboard:', error);
            leaderboardContent.innerHTML = '<p style="color: var(--error-color);">Не удалось загрузить лидерборд.</p>';
        }
    }

    async function showMainMenu() {
        // Stop any ongoing activities
        document.body.classList.remove('presentation-active-fullscreen');
        stopTimeTracking();

        // --- UI State Reset ---
        windowTitle.textContent = 'Главное Меню';
        backButtonAction = null; // No custom back action needed

        // Hide views that are not the main menu
        productContent.classList.add('hidden');
        testView.classList.add('hidden');
        testResultsView.classList.add('hidden');
        simulatorView.classList.add('hidden');
        assistantContainer.classList.add('hidden');
        document.getElementById('floating-chat-container').classList.add('hidden');
        backToMenuBtn.classList.add('hidden');

        // Show main dashboard elements
        document.getElementById('leaderboard-container').classList.remove('hidden');
        document.getElementById('main-content-wrapper').classList.remove('hidden');
        mainMenu.classList.remove('hidden');
        document.getElementById('main-menu-tabs').classList.remove('hidden');
        extraToolsDiv.classList.remove('hidden');

        // Remove the presentation-active class to restore the default layout
        document.getElementById('main-flex-container').classList.remove('presentation-active');

        // --- Load Dynamic Content ---
        loadLeaderboard();

        // Display skeletons while loading
        mainMenu.innerHTML = '';
        for (let i = 0; i < 3; i++) {
            const skeleton = document.createElement('div');
            skeleton.className = 'skeleton-card';
            mainMenu.appendChild(skeleton);
        }

        try {
            const courseGroups = await fetchAuthenticated(`/api/getCourses`, { method: 'POST' });
            
            if (!Array.isArray(courseGroups)) {
                throw new Error("Ответ сервера не является массивом групп курсов.");
            }

            courses = courseGroups; // This is now an array of groups

            const tabsContainer = document.getElementById('main-menu-tabs');
            tabsContainer.onclick = (e) => {
                if (e.target.matches('.tab-btn')) {
                    tabsContainer.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    const filter = e.target.dataset.filter;
                    if (filter === 'catalog') {
                        renderCatalog();
                    } else {
                        renderCourseGroups(filter);
                    }
                }
            };

            // Initial render with the 'assigned' filter
            renderCourseGroups('assigned');

        } catch (error) {
            console.error('Failed to load courses:', error);
            showMessage('Не удалось загрузить список курсов.', error.message);
        }
    }

    function renderCourseGroups(filter = 'assigned') {
        mainMenu.innerHTML = '';
        mainMenu.style.display = 'block';

        let hasContent = false;

        const filteredGroups = courses.map(group => {
            const filteredCourses = group.courses.filter(course => {
                const progress = course.progress;
                const isCompleted = progress?.completed_at;

                if (filter === 'assigned') return !isCompleted;
                if (filter === 'completed') return isCompleted;
                return false; // Default case, though we only have two tabs now
            });

            // Return a new group object with the filtered courses
            return { ...group, courses: filteredCourses };
        }).filter(group => group.courses.length > 0); // Only keep groups that have courses matching the filter

        if (filteredGroups.length === 0) {
            let message = 'Нет данных для отображения.';
            if (filter === 'assigned') message = 'У вас нет активных назначенных курсов. Так держать!';
            if (filter === 'completed') message = 'Вы еще не завершили ни одного курса.';
            mainMenu.innerHTML = `<p class="message">${message}</p>`;
            return;
        }

        filteredGroups.forEach(group => {
            const groupContainer = document.createElement('div');
            groupContainer.className = 'course-group-container';

            const groupHeader = document.createElement('h3');
            groupHeader.textContent = group.group_name;
            groupContainer.appendChild(groupHeader);

            const coursesGrid = document.createElement('div');
            coursesGrid.className = 'main-menu';
            group.courses.forEach(course => {
                coursesGrid.appendChild(createCourseMenuItem(course));
            });
            groupContainer.appendChild(coursesGrid);
            mainMenu.appendChild(groupContainer);
        });
    }

    function createCourseMenuItem(course) {
        const menuItem = document.createElement('div');
        menuItem.className = 'menu-item';

        if (course.is_locked) {
            menuItem.style.opacity = '0.6';
            menuItem.style.cursor = 'not-allowed';
            menuItem.title = 'Этот курс будет доступен после прохождения предыдущего';
        } else {
            menuItem.style.cursor = 'pointer';
            menuItem.addEventListener('click', () => showProduct(course.id));
        }

        if (course.progress?.completed_at) {
             menuItem.classList.add('completed');
        }

        let deadlineHtml = '';
        if (course.progress?.deadline_date) {
            const deadline = new Date(course.progress.deadline_date);
            const today = new Date();
            const isOverdue = deadline < today;
            deadlineHtml = `<p style="font-size: 0.85em; color: ${isOverdue ? 'var(--error-color)' : 'var(--text-light-color)'}; margin-top: 10px;">
                Срок сдачи: ${deadline.toLocaleDateString('ru-RU')} ${isOverdue ? '(Просрочено)' : ''}
            </p>`;
        }

        let progressBarHtml = '';
        if(course.progress?.percentage > 0 && !course.progress?.completed_at) {
            progressBarHtml = `<div style="width: 100%; background: #eee; border-radius: 5px; margin-top: 10px;"><div style="width: ${course.progress.percentage}%; background: var(--success-color); height: 5px; border-radius: 5px;"></div></div>`;
        }

        menuItem.innerHTML = `
            <div>
                <h3>
                    <span class="menu-item-icon">${course.is_locked ? '🔒' : '📖'}</span>
                    ${course.title}
                </h3>
            </div>
            <div>
                ${progressBarHtml}
                ${deadlineHtml}
            </div>
        `;

        menuItem.style.display = 'flex';
        menuItem.style.flexDirection = 'column';
        menuItem.style.justifyContent = 'space-between';

        return menuItem;
    }

    function createCatalogMenuItem(course) {
        const menuItem = document.createElement('div');
        menuItem.className = 'menu-item';

        let buttonHtml = '';
        switch (course.user_status) {
            case 'not_assigned':
                buttonHtml = `<button class="btn assign-course-btn" data-course-id="${course.id}" style="margin-top: 15px;">Начать изучение</button>`;
                break;
            case 'assigned':
                buttonHtml = `<button class="btn" disabled style="margin-top: 15px; background-color: var(--text-light-color); cursor: not-allowed;">Курс уже назначен</button>`;
                break;
            case 'completed':
                // Visually distinguish completed courses
                menuItem.style.borderLeft = '5px solid var(--success-color)';
                menuItem.style.backgroundColor = '#f8f9fa';
                buttonHtml = `<p style="margin-top: 15px; font-weight: bold; color: var(--success-color);">✓ Курс пройден</p>`;
                break;
        }

        const descriptionText = course.group_name
            ? `Курс из группы: <strong>${course.group_name}</strong>`
            : (truncateText(course.description) || 'Нет описания.');

        menuItem.innerHTML = `
            <div>
                <h3>
                    <span class="menu-item-icon">${course.user_status === 'completed' ? '🏆' : '📚'}</span>
                    ${course.title}
                </h3>
                <p style="font-size: 0.9em; color: var(--text-light-color);">${descriptionText}</p>
            </div>
            <div style="text-align: right;">${buttonHtml}</div>
        `;
        return menuItem;
    }

    async function renderCatalog() {
        mainMenu.innerHTML = '';
        mainMenu.style.display = 'grid'; // Use grid for catalog items
        mainMenu.innerHTML = '<div class="loader"></div>';
        try {
            const catalogCourses = await fetchAuthenticated('/api/getCourseCatalog', { method: 'POST' });
            mainMenu.innerHTML = '';
            if (!catalogCourses || catalogCourses.length === 0) {
                mainMenu.innerHTML = '<p class="message">Нет доступных курсов в каталоге.</p>';
                return;
            }
            catalogCourses.forEach(course => {
                const menuItem = createCatalogMenuItem(course);
                mainMenu.appendChild(menuItem);
            });
        } catch (error) {
            console.error('Failed to load course catalog:', error);
            mainMenu.innerHTML = `<p class="message" style="color: var(--error-color);">Не удалось загрузить каталог курсов.</p>`;
        }
    }
    
    let timeTrackingInterval = null;
    let secondsSinceLastUpdate = 0;

    async function sendTimeUpdate(courseId, seconds) {
        if (!courseId || seconds <= 0) return;
        try {
            await fetchAuthenticated('/api/update-time-spent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ course_id: courseId, seconds_spent: seconds })
            });
            console.log(`Successfully sent ${seconds} seconds for course ${courseId}`);
        } catch (error) {
            console.error('Failed to send time update:', error);
        }
    }

    function stopTimeTracking() {
        if (timeTrackingInterval) {
            clearInterval(timeTrackingInterval);
            timeTrackingInterval = null;
            sendTimeUpdate(currentCourse.id, secondsSinceLastUpdate);
            secondsSinceLastUpdate = 0;
        }
    }

    function renderPresentation(summaryData) {
        const fragment = document.createDocumentFragment();

        if (!Array.isArray(summaryData) || summaryData.length === 0) {
            const p = document.createElement('p');
            p.textContent = 'Материалы курса не найдены или генерируются. Попробуйте обновить позже.';
            fragment.appendChild(p);
            return fragment;
        }

        const slider = document.createElement('div');
        slider.className = 'presentation-slider';

        summaryData.forEach((slideData) => {
            const slideDiv = document.createElement('div');
            slideDiv.className = 'presentation-slide';
            let imageHtml = slideData.image_url ? `<img src="${slideData.image_url}" alt="${slideData.slide_title || 'Slide Image'}">` : '';

            // Added audio button and player container for each slide
            slideDiv.innerHTML = `
                ${imageHtml}
                <h2>${slideData.slide_title || ''}</h2>
                ${slideData.html_content || ''}
                <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px;">
                    <button class="audio-tts-slide-btn" style="width: auto; padding: 8px 15px; font-size: 0.9em; align-self: flex-start;">
                        🎧 Озвучить слайд
                    </button>
                    <div class="audio-player-slide"></div>
                </div>
            `;
            slider.appendChild(slideDiv);
        });

        // Event listener for all slide audio buttons
        slider.addEventListener('click', async (e) => {
            if (e.target.classList.contains('audio-tts-slide-btn')) {
                const button = e.target;
                button.disabled = true;
                button.textContent = '⏳ Загрузка...';

                const slideDiv = button.closest('.presentation-slide');
                const audioPlayerDiv = slideDiv.querySelector('.audio-player-slide');
                audioPlayerDiv.innerHTML = ''; // Clear previous player

                // Clone the slide content to extract text without the audio controls
                const contentClone = slideDiv.cloneNode(true);
                const controlsContainer = contentClone.querySelector('.audio-tts-slide-btn')?.parentElement;
                if (controlsContainer) controlsContainer.remove();

                const textToSpeak = contentClone.textContent.trim();

                if (!textToSpeak) {
                    alert('Нет текста для озвучивания.');
                    button.disabled = false;
                    button.textContent = '🎧 Озвучить слайд';
                    return;
                }

                try {
                    const response = await fetchAuthenticated('/api/text-to-speech-user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ course_id: currentCourse.id, text: textToSpeak })
                    });

                    const audio = new Audio(response.audioUrl);
                    audio.controls = true;
                    audio.autoplay = true;
                    audioPlayerDiv.appendChild(audio);
                    button.textContent = '✅ Готово';

                } catch (error) {
                    console.error('Audio generation for slide failed:', error);
                    alert(`Не удалось создать аудио: ${error.message}`);
                    button.textContent = '❌ Ошибка';
                } finally {
                    setTimeout(() => {
                        button.disabled = false;
                        button.textContent = '🎧 Озвучить слайд';
                    }, 4000);
                }
            }
        });

        const slides = slider.querySelectorAll('.presentation-slide');

        const counter = document.createElement('span');
        counter.className = 'slide-counter';

        const prevBtn = document.createElement('button');
        prevBtn.className = 'slider-prev';
        prevBtn.innerHTML = '‹';

        const nextBtn = document.createElement('button');
        nextBtn.className = 'slider-next';
        nextBtn.innerHTML = '›';

        const navContainer = document.createElement('div');
        navContainer.className = 'slider-nav-container'; // Use the original class name for consistency
        navContainer.appendChild(prevBtn);
        navContainer.appendChild(counter);
        navContainer.appendChild(nextBtn);

        let currentIndex = 0;

        const updateSliderUI = () => {
            slides.forEach((slide, index) => {
                slide.classList.toggle('active', index === currentIndex);
            });
            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === slides.length - 1;
            counter.textContent = `${currentIndex + 1} / ${slides.length}`;
        };

        prevBtn.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; updateSliderUI(); } });
        nextBtn.addEventListener('click', () => { if (currentIndex < slides.length - 1) { currentIndex++; updateSliderUI(); } });

        updateSliderUI(); // Initial setup

        // Return the slider and the nav container separately
        return { slider, navContainer };
    }

    function renderCourseActions() {
        stopTimeTracking();
        backToMenuBtn.textContent = '❮ Назад в меню';
        backButtonAction = showMainMenu;
        productContent.innerHTML = '';
        productContent.classList.remove('presentation-view');

        // Ensure scrolling is re-enabled on the main content area
        contentArea.classList.remove('no-scroll');

        const menu = document.createElement('div');
        menu.className = 'course-actions-menu';

        // 1. Study Material Button
        const studyBtn = document.createElement('div');
        studyBtn.className = 'action-btn';
        studyBtn.innerHTML = `<span class="icon">📖</span> Изучить материал`;
        studyBtn.onclick = () => showPresentationView();
        menu.appendChild(studyBtn);

        // 2. Start Test Button
        const testBtn = document.createElement('div');
        testBtn.className = 'action-btn';
        testBtn.innerHTML = `<span class="icon">🎯</span> Начать тестирование`;
        testBtn.onclick = () => {
            stopTimeTracking();
            startTest(currentCourse.id);
        };
        menu.appendChild(testBtn);

        // 3. Simulator Button
        const simulatorBtn = document.createElement('div');
        simulatorBtn.className = 'action-btn';
        simulatorBtn.innerHTML = `<span class="icon">💬</span> Диалоговый тренажер`;
        simulatorBtn.onclick = () => showSimulatorView();
        menu.appendChild(simulatorBtn);

        // 4. Listen to Material Button
        const listenBtn = document.createElement('div');
        listenBtn.className = 'action-btn';
        listenBtn.innerHTML = `<span class="icon">🎧</span> Прослушать материал`;
        listenBtn.onclick = async () => {
            const icon = listenBtn.querySelector('.icon');
            const originalIcon = icon.innerHTML;
            icon.innerHTML = '⏳';
            listenBtn.style.cursor = 'wait';

            try {
                let summaryText = '';
                if (currentCourse && Array.isArray(currentCourse.summary)) {
                    const tempDiv = document.createElement('div');
                    summaryText = currentCourse.summary.map(slide => {
                        tempDiv.innerHTML = slide.html_content;
                        return tempDiv.textContent || tempDiv.innerText || '';
                    }).join('\n\n');
                }

                if (!summaryText) throw new Error('Текст саммари для озвучивания не найден.');

                const response = await fetchAuthenticated('/api/text-to-speech-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ course_id: currentCourse.id, text: summaryText })
                });

                audioPlayerContainerUser.innerHTML = '';
                const audio = new Audio(response.audioUrl);
                audio.controls = true;
                audio.autoplay = true;
                audioPlayerContainerUser.appendChild(audio);
                icon.innerHTML = '✅';

            } catch (error) {
                console.error('Audio generation failed:', error);
                alert(`Не удалось создать аудио: ${error.message}`);
                icon.innerHTML = '❌';
            } finally {
                 setTimeout(() => {
                    icon.innerHTML = originalIcon;
                    listenBtn.style.cursor = 'pointer';
                }, 3000);
            }
        };
        menu.appendChild(listenBtn);

        productContent.appendChild(menu);
        productContent.appendChild(audioPlayerContainerUser);

        // 5. Downloadable Materials
        if (currentCourse.materials && currentCourse.materials.length > 0) {
            const materialsDiv = document.createElement('div');
            materialsDiv.style.marginTop = '30px';
            materialsDiv.innerHTML = '<h3>Материалы для скачивания</h3>';
            const materialsList = document.createElement('ul');
            currentCourse.materials.forEach(m => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="${m.public_url}" target="_blank" download>${m.file_name}</a>`;
                materialsList.appendChild(li);
            });
            materialsDiv.appendChild(materialsList);
            productContent.appendChild(materialsDiv);
        }
    }

    function showPresentationView() {
        backToMenuBtn.textContent = '❮ Назад к курсу';
        backButtonAction = renderCourseActions;

        // Disable scrolling on the parent container to prevent double scrollbars
        contentArea.classList.add('no-scroll');

        productContent.classList.add('presentation-view');
        assistantContainer.classList.add('hidden');
        document.getElementById('floating-chat-container').classList.remove('hidden');

        // 1. Clear previous content
        productContent.innerHTML = '';

        // 2. Get presentation elements from the refactored function
        const { slider, navContainer } = renderPresentation(currentCourse.summary);

        // 3. Append the slider and the nav container directly to the product content area
        productContent.appendChild(slider);
        productContent.appendChild(navContainer);

        // 5. Start time tracking
        if (timeTrackingInterval) clearInterval(timeTrackingInterval);
        secondsSinceLastUpdate = 0;
        timeTrackingInterval = setInterval(() => {
            secondsSinceLastUpdate += 30;
            sendTimeUpdate(currentCourse.id, 30);
        }, 30000);
    }

    async function showProduct(courseId, forceRegenerate = false) {
        // Find the course from the locally cached list of groups using flatMap for robust search
        currentCourse = courses.flatMap(group => group.courses).find(c => c.id === courseId);

        if (!currentCourse) {
            console.error("Course not found for ID:", courseId);
            showMessage("Не удалось найти выбранный курс.");
            return;
        }

        windowTitle.textContent = currentCourse.title;

        // --- UI State Change for Presentation View ---
        // 1. Add the class to the container to trigger the two-column layout
        document.getElementById('main-flex-container').classList.add('presentation-active');

        // 2. Keep the leaderboard visible, but hide the main menu content
        document.getElementById('main-menu-tabs').classList.add('hidden');
        document.getElementById('main-menu').classList.add('hidden');
        extraToolsDiv.classList.add('hidden');

        // 3. Show the product content area
        productContent.classList.remove('hidden');

        // 4. Configure the back button
        backToMenuBtn.classList.remove('hidden');
        backToMenuBtn.textContent = '❮ Назад в меню';
        backButtonAction = showMainMenu;

        // --- Load Course Content ---
        productContent.innerHTML = '<div class="loader"></div>';
        audioPlayerContainerUser.innerHTML = '';
        const savedChat = sessionStorage.getItem(`chatHistory_${currentCourse.id}`);
        chatBox.innerHTML = savedChat || '';

        try {
            // Check if content is already loaded
            if (!currentCourse.summary || forceRegenerate) {
                const data = await fetchAuthenticated('/api/getCourseContent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ course_id: currentCourse.id, force_regenerate: forceRegenerate })
                });
                currentCourse.summary = data.summary;
                currentCourse.questions = data.questions;
                currentCourse.materials = data.materials;
            }

            renderCourseActions();

        } catch (error) {
            console.error('Не удалось загрузить контент курса:', error);
            showMessage('Ошибка при генерации контента курса.', error.message);
        }
    }

    chatForm.addEventListener('submit', async (e) => { e.preventDefault(); const userQuestion = chatInput.value.trim(); if (!userQuestion || !currentCourse) return; appendMessage(userQuestion, 'user'); chatInput.value = ''; chatInput.disabled = true; appendMessage('...', 'assistant', true); try { const data = await fetchAuthenticated('/api/askAssistant', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ course_id: currentCourse.id, question: userQuestion }) }); updateLastAssistantMessage(data.answer); } catch (error) { console.error('Ошибка ассистента:', error); updateLastAssistantMessage(`Извините, произошла ошибка: ${error.message}`); } finally { chatInput.disabled = false; chatInput.focus(); } });
    function appendMessage(text, sender, isThinking = false) { const messageDiv = document.createElement('div'); messageDiv.className = `chat-message ${sender}-message`; const textSpan = document.createElement('span'); textSpan.textContent = text; if (isThinking) { messageDiv.classList.add('thinking'); messageDiv.id = 'thinking-indicator'; } messageDiv.appendChild(textSpan); chatBox.appendChild(messageDiv); chatBox.scrollTop = chatBox.scrollHeight; if (currentCourse && !isThinking) { sessionStorage.setItem(`chatHistory_${currentCourse.id}`, chatBox.innerHTML); } }

    function updateLastAssistantMessage(text) {
        const thinkingIndicator = document.getElementById('thinking-indicator');
        if (thinkingIndicator) {
            const span = thinkingIndicator.querySelector('span');
            span.textContent = ''; // Clear the "..."
            thinkingIndicator.classList.remove('thinking');
            thinkingIndicator.id = ''; // The message is now final, remove the ID

            let i = 0;
            const speed = 25; // Milliseconds per character

            function typeWriter() {
                if (i < text.length) {
                    span.textContent += text.charAt(i);
                    i++;
                    chatBox.scrollTop = chatBox.scrollHeight; // Keep scrolled to bottom
                    setTimeout(typeWriter, speed);
                } else {
                    // Once typing is done, save the final state to session storage
                    if (currentCourse) {
                        sessionStorage.setItem(`chatHistory_${currentCourse.id}`, chatBox.innerHTML);
                    }
                }
            }
            typeWriter();
        }
    }

    let currentQuestions = [], currentQuestionIndex = 0, score = 0, tabSwitchCount = 0;
    const MAX_ATTEMPTS = 3;
    const MAX_TAB_SWITCHES = 2;

    const handleVisibilityChange = () => {
        if (document.hidden) {
            tabSwitchCount++;
            if (tabSwitchCount === 1) {
                alert('Внимание! Вы переключились на другую вкладку. При повторном переключении тест будет завершен с результатом 0.');
            } else if (tabSwitchCount >= MAX_TAB_SWITCHES) {
                alert('Вы превысили лимит переключений. Тест завершен с нулевым результатом.');
                score = 0;
                showTestResultsView();
            }
        }
    };

    function startTest(courseId) {
        const courseGroup = courses.find(group => group.courses.some(c => c.id === courseId));
        if (courseGroup) {
            currentCourse = courseGroup.courses.find(c => c.id === courseId);
        }
        const progress = userProgress[courseId];
        const attempts = progress ? progress.attempts : 0;

        if (attempts >= MAX_ATTEMPTS) {
            alert(`Вы использовали все ${MAX_ATTEMPTS} попытки для сдачи этого теста.`);
            document.getElementById('start-test-btn').disabled = true;
            return;
        }

        if (!currentCourse || !currentCourse.questions || currentCourse.questions.length === 0) {
            showMessage('Вопросы для этого курса не найдены или отсутствуют.');
            backToMenuBtn.classList.remove('hidden');
            return;
        }

        currentQuestions = currentCourse.questions;
        currentQuestionIndex = 0;
        score = 0;
        tabSwitchCount = 0;
        document.addEventListener('visibilitychange', handleVisibilityChange);

        document.getElementById('main-content-wrapper').classList.add('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden');
        testView.classList.remove('hidden');

        displayQuestion();
    }

    function displayQuestion() { const nextBtn = document.getElementById('next-question-btn'); if (currentQuestionIndex < currentQuestions.length) { const q = currentQuestions[currentQuestionIndex]; document.getElementById('question-counter').textContent = `Вопрос ${currentQuestionIndex + 1} из ${currentQuestions.length}`; document.getElementById('question').textContent = q.question; const answersDiv = document.getElementById('answers'); answersDiv.innerHTML = ''; q.options.forEach((option, index) => { const answerEl = document.createElement('div'); answerEl.className = 'answer'; answerEl.textContent = option; answerEl.dataset.index = index; answerEl.addEventListener('click', selectAnswer); answersDiv.appendChild(answerEl); }); nextBtn.classList.add('hidden'); } else { showTestResultsView(); } }
    function selectAnswer(e) { const selectedIndex = parseInt(e.target.dataset.index, 10); const correctIndex = currentQuestions[currentQuestionIndex].correct_option_index; document.querySelectorAll('.answer').forEach(el => { el.removeEventListener('click', selectAnswer); el.style.cursor = 'default'; }); if (selectedIndex === correctIndex) { score++; e.target.style.borderColor = 'var(--success-color)'; e.target.style.backgroundColor = '#eaf7ec'; } else { e.target.style.borderColor = 'var(--error-color)'; e.target.style.backgroundColor = '#fdeeee'; const correctAnswerEl = document.querySelector(`.answer[data-index='${correctIndex}']`); if(correctAnswerEl) correctAnswerEl.style.borderColor = 'var(--success-color)'; } const nextBtn = document.getElementById('next-question-btn'); nextBtn.classList.remove('hidden'); nextBtn.onclick = () => { currentQuestionIndex++; displayQuestion(); }; }
    async function showTestResultsView() {
        document.removeEventListener('visibilitychange', handleVisibilityChange);

        // Hide other views
        testView.classList.add('hidden');
        document.getElementById('main-content-wrapper').classList.add('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden');

        // Show the results view
        testResultsView.classList.remove('hidden');

        const percentage = Math.round((score / currentQuestions.length) * 100);
        document.getElementById('results-product-name').textContent = currentCourse.title;
        document.getElementById('results-score').textContent = `${percentage}% (${score} из ${currentQuestions.length})`;
        let feedback = '';
        if (percentage >= 80) {
            feedback = 'Отличный результат! Материал усвоен.';
        } else if (percentage >= 60) {
            feedback = 'Хороший результат. Рекомендуется повторить некоторые разделы.';
        } else {
            feedback = 'Результат неудовлетворительный. Требуется повторное изучение модуля.';
        }
        document.getElementById('results-feedback').textContent = feedback;

        userProgress[currentCourse.id] = { completed: true, score, total: currentQuestions.length, percentage };

        try {
            await fetchAuthenticated('/api/saveTestResult', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    course_id: currentCourse.id,
                    score: score,
                    total_questions: currentQuestions.length,
                    percentage: percentage
                })
            });
        } catch(error) {
            console.error('Не удалось сохранить результат:', error);
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        mainMenu.addEventListener('click', async (e) => {
            if (e.target.classList.contains('assign-course-btn')) {
                const courseId = e.target.dataset.courseId;
                if (!courseId) return;

                const button = e.target;
                button.disabled = true;
                button.textContent = 'Запись...';

                try {
                    const response = await fetchAuthenticated('/api/assign-course', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ course_id: courseId })
                    });

                    if (response.message === 'Course already assigned.') {
                         alert('Вы уже записаны на этот курс.');
                         button.textContent = 'Курс уже назначен';
                         // No need to call showMainMenu() here, just update the button state
                    } else {
                        alert('Вы успешно записаны на курс! Он появится на вкладке "Назначенные".');
                        // Switch to the 'assigned' tab to show the user their new course.
                        document.querySelector('.tab-btn[data-filter="assigned"]').click();
                    }
                } catch (error) {
                    console.error('Failed to assign course:', error);
                    // Provide a clearer message for the most common error.
                    if (error.message && error.message.includes('unique constraint')) {
                        alert('Не удалось записаться: Вы уже записаны на этот курс.');
                        button.textContent = 'Курс уже назначен';
                    } else {
                        alert(`Не удалось записаться на курс: ${error.message}`);
                        button.disabled = false;
                        button.textContent = 'Начать изучение';
                    }
                }
            }
        });

        // Hide app view initially
        appView.classList.add('hidden');
        authView.classList.add('hidden');

        // --- Create and set up the floating chat button ---
        const chatContainer = document.createElement('div');
        chatContainer.id = 'floating-chat-container';
        chatContainer.classList.add('hidden');

        const chatBtn = document.createElement('button');
        chatBtn.id = 'floating-chat-btn';
        chatBtn.title = "AI-Ассистент";
        chatBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg" width="30px" height="30px"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9.5 9.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zm3 0c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zm3 0c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5z"/></svg>`;

        const tooltip = document.createElement('div');
        tooltip.className = 'chat-tooltip';
        tooltip.textContent = 'Ваш AI-Ассистент Senti тут! Я могу помочь разобраться в материале.';

        chatContainer.appendChild(chatBtn);
        chatContainer.appendChild(tooltip);
        document.body.appendChild(chatContainer);

        chatBtn.addEventListener('click', () => {
            assistantContainer.classList.toggle('hidden');
        });
        // --- End of chat button setup ---

        checkSession();

        backToMenuBtn.addEventListener('click', () => {
            if (typeof backButtonAction === 'function') {
                backButtonAction();
            }
        });
        backToMenuFromResultsBtn.addEventListener('click', showMainMenu);
    });

    let currentScenario = ''; // To store the scenario for the current session

    function showSimulatorView() {
        windowTitle.textContent = 'Диалоговый тренажер';
        document.getElementById('main-content-wrapper').classList.add('hidden');
        document.getElementById('leaderboard-container').classList.add('hidden');
        simulatorView.classList.remove('hidden');
        backToMenuBtn.classList.remove('hidden');

        // Check if we are inside a course context
        if (currentCourse) {
            backButtonAction = renderCourseActions;
            backToMenuBtn.textContent = '❮ Назад к курсу';
        } else {
            backButtonAction = showMainMenu;
            backToMenuBtn.textContent = '❮ Назад в меню';
        }

        simulatorSetup.classList.remove('hidden');
        simulatorChatArea.classList.add('hidden');
        simulatorEvaluationArea.classList.add('hidden');
        simulatorChatBox.innerHTML = '';
        simulationHistory = [];
        currentScenario = ''; // Reset scenario
    }

    launchSimulatorBtn.addEventListener('click', showSimulatorView);
    restartSimulationBtn.addEventListener('click', showSimulatorView);

    function appendSimulatorMessage(text, role, isThinking = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}-message`;
        const textSpan = document.createElement('span');
        textSpan.textContent = text;
        if (isThinking) {
            messageDiv.classList.add('thinking');
            messageDiv.id = 'simulator-thinking-indicator';
        }
        messageDiv.appendChild(textSpan);
        simulatorChatBox.appendChild(messageDiv);
        simulatorChatBox.scrollTop = simulatorChatBox.scrollHeight;
    }

    function updateLastSimulatorMessage(text) {
        const thinkingIndicator = document.getElementById('simulator-thinking-indicator');
        if (thinkingIndicator) {
            thinkingIndicator.querySelector('span').textContent = text;
            thinkingIndicator.classList.remove('thinking');
            thinkingIndicator.id = '';
        }
    }

    startSimulationBtn.addEventListener('click', async () => {
        simulatorSetup.classList.add('hidden');
        simulatorChatArea.classList.remove('hidden');
        appendSimulatorMessage('...', 'assistant', true);

        try {
            const disposition = document.getElementById('disposition-slider').value;
            const data = await fetchAuthenticated('/api/dialogueSimulator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'start', disposition })
            });

            if (!data.scenario || !data.first_message) {
                throw new Error("Сервер не вернул сценарий или первое сообщение.");
            }

            currentScenario = data.scenario; // This is the critical assignment
            updateLastSimulatorMessage(data.first_message);
            simulationHistory.push({ role: 'assistant', text: data.first_message });

        } catch (error) {
            updateLastSimulatorMessage(`Ошибка при запуске симуляции: ${error.message}`);
        }
    });

    simulatorChatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userInput = simulatorChatInput.value.trim();
        if (!userInput) return;

        appendSimulatorMessage(userInput, 'user');
        simulationHistory.push({ role: 'user', text: userInput });
        simulatorChatInput.value = '';
        simulatorChatInput.disabled = true;
        appendSimulatorMessage('...', 'assistant', true);

        try {
            if (!currentScenario) { // Defensive check
                throw new Error("Сценарий не был начат. Пожалуйста, перезапустите тренажер.");
            }
            const disposition = document.getElementById('disposition-slider').value;
            const data = await fetchAuthenticated('/api/dialogueSimulator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    history: simulationHistory,
                    disposition: disposition,
                    scenario: currentScenario, // Ensure this is passed
                    action: 'chat'
                })
            });
            const aiResponse = data.answer ? data.answer.trim() : '';
            if (aiResponse) {
                updateLastSimulatorMessage(aiResponse);
                simulationHistory.push({ role: 'assistant', text: aiResponse });
            } else {
                updateLastSimulatorMessage("Извините, я не смог получить ответ. Попробуйте перефразировать.");
            }
        } catch (error) {
            updateLastSimulatorMessage(`Ошибка: ${error.message}`);
        } finally {
            simulatorChatInput.disabled = false;
            simulatorChatInput.focus();
        }
    });

    endSimulationBtn.addEventListener('click', async () => {
        if (simulationHistory.length === 0) {
            alert('Сначала начните диалог.');
            return;
        }
        if (!currentScenario) { // Defensive check
            alert("Ошибка: сценарий не определен. Пожалуйста, перезапустите тренажер.");
            return;
        }
        simulatorChatArea.classList.add('hidden');
        simulatorEvaluationArea.classList.remove('hidden');
        evaluationResults.innerHTML = '<div class="loader"></div>';

        try {
             const disposition = document.getElementById('disposition-slider').value;
             const data = await fetchAuthenticated('/api/dialogueSimulator', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    history: simulationHistory,
                    action: 'evaluate',
                    disposition: disposition,
                    scenario: currentScenario // Ensure this is passed
                })
            });

            evaluationResults.innerHTML = '';
            const evaluationData = data.answer;

            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = 'Скачать диалог и оценку';
            downloadBtn.style.marginTop = '10px';
            downloadBtn.style.marginBottom = '15px';

            downloadBtn.onclick = () => {
                const dialogueText = simulationHistory.map(h => `${h.role.toUpperCase()}: ${h.text}`).join('\n');
                const evaluationText = JSON.stringify(evaluationData, null, 2);
                const fullText = `СЦЕНАРИЙ: ${currentScenario}\n\nДИАЛОГ\n--------------------\n${dialogueText}\n\nОЦЕНКА ИИ\n--------------------\n${evaluationText}`;
                const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dialogue-evaluation-${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
            evaluationResults.appendChild(downloadBtn);

            const resultsTable = document.createElement('table');
            resultsTable.style.width = '100%';
            resultsTable.style.borderCollapse = 'collapse';
            resultsTable.innerHTML = `
                <tr style="background-color: var(--bg-color);">
                    <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left;">Критерий</th>
                    <th style="border: 1px solid var(--border-color); padding: 8px; text-align: center;">Оценка</th>
                    <th style="border: 1px solid var(--border-color); padding: 8px; text-align: left;">Комментарий</th>
                </tr>
            `;
            if(evaluationData.evaluation_criteria) {
                evaluationData.evaluation_criteria.forEach(item => {
                    resultsTable.innerHTML += `
                        <tr>
                            <td style="border: 1px solid var(--border-color); padding: 8px;">${item.criterion}</td>
                            <td style="border: 1px solid var(--border-color); padding: 8px; text-align: center; font-weight: bold;">${item.score}/10</td>
                            <td style="border: 1px solid var(--border-color); padding: 8px;">${item.comment}</td>
                        </tr>
                    `;
                });
            }
            evaluationResults.appendChild(resultsTable);

            const summary = document.createElement('div');
            summary.style.marginTop = '15px';
            if(evaluationData.average_score && evaluationData.general_comment) {
                summary.innerHTML = `
                    <h4 style="margin-bottom: 5px;">Общая оценка: <span style="color: var(--primary-color);">${evaluationData.average_score.toFixed(1)}</span></h4>
                    <p><strong>Общий комментарий:</strong> ${evaluationData.general_comment}</p>
                `;
            }
            evaluationResults.appendChild(summary);

        } catch (error) {
            evaluationResults.textContent = `Ошибка при получении оценки: ${error.message}`;
        }
    });

</script>
</body>
</html>
