<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Админ-панель</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; background-color: #f4f7f6; }
        h1, h2, h3 { color: #005A9C; }
        .hidden { display: none; }
        input, textarea, button, select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e0e0e0; font-size: 16px; }
        button { background-color: #005A9C; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background-color: #00AEEF; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        textarea { height: 150px; resize: vertical; }
        .status { padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; }
        .error { color: #dc3545; background-color: #fdeeee; }
        .success { color: #28a745; background-color: #eaf7ec; }
        .info { color: #005A9C; background-color: #e9f7fe; }
        .tabs button { width: auto; padding: 10px 20px; margin-right: 10px; background-color: #e0e0e0; color: #333; }
        .tabs button.active { background-color: #005A9C; color: white; }
        #results-view { margin-top: 20px; }
        #results-filters { display: flex; gap: 10px; margin-bottom: 10px; }
        #results-table { width: 100%; border-collapse: collapse; }
        #results-table th, #results-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #results-table th { background-color: #f2f2f2; }
        #delete-course-btn { background-color: #dc3545; }
        #delete-course-btn:hover { background-color: #c82333; }
        #courses-table, #groups-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #courses-table th, #courses-table td, #groups-table th, #groups-table td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: middle; }
        #courses-table th, #groups-table th { background-color: #f2f2f2; font-weight: bold; }
        .actions-cell button { width: auto; padding: 6px 12px; font-size: 14px; margin-right: 5px; }
        .status-published { color: #28a745; font-weight: bold; }
        .status-processed { color: #ffc107; }
        .inline-error { color: #dc3545; font-size: 0.9em; margin-top: -5px; margin-bottom: 10px; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; }
        .toast { padding: 15px 20px; margin-bottom: 10px; border-radius: 8px; color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); opacity: 0.9; width: 300px; }
        .toast-error { background-color: #dc3545; }
        .toast-success { background-color: #28a745; }
        .toast-info { background-color: #00AEEF; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div id="login-view" class="hidden">
        <h1>Вход для администратора</h1>
        <input type="email" id="admin-email" value="test1@cic.kz">
        <input type="password" id="admin-password" placeholder="Пароль">
        <button id="login-btn">Войти</button>
        <div id="login-error" class="status error hidden"></div>
    </div>

    <div id="panel-view" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Панель управления</h1>
            <button id="logout-btn" style="width: auto; background-color: #6c757d;">Выйти</button>
        </div>
        <div class="tabs">
            <button id="courses-tab-btn" class="active">Управление курсами</button>
            <button id="groups-tab-btn">Управление группами</button>
            <button id="results-tab-btn">Отчеты и Результаты</button>
            <button id="leaderboard-tab-btn">Лидерборд</button>
            <button id="simulator-tab-btn">Результаты Тренажера</button>
        </div>
        <hr>

        <div id="leaderboard-view" class="hidden">
            <h2>Настройки Лидерборда "Топ учеников недели"</h2>
            <p>Выберите метрики, по которым будет строиться рейтинг. Пользователи будут отсортированы по первой выбранной метрике.</p>
            <div id="leaderboard-settings-form">
                <label><input type="checkbox" name="metric" value="courses_completed"> Количество пройденных курсов</label><br>
                <label><input type="checkbox" name="metric" value="time_spent"> Общее время обучения (в минутах)</label><br>
                <label><input type="checkbox" name="metric" value="avg_score"> Средний балл по тестам</label><br>
                <br>
                <button id="save-leaderboard-settings-btn">Сохранить настройки</button>
            </div>
        </div>

        <div id="courses-view">
            <h2>Панель управления курсами</h2>
            <div id="status-box" class="status hidden"></div>

            <h3>Существующие курсы</h3>
            <button id="show-create-form-btn">Создать новый курс</button>
            <table id="courses-table">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>ID Курса</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Course rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <hr>

            <div id="course-form-wrapper"></div>
        </div>

        <div id="groups-view" class="hidden">
            <h2>Управление группами курсов (Блоками)</h2>

            <h3>Существующие группы</h3>
            <button id="show-create-group-form-btn">Создать новую группу</button>
            <table id="groups-table">
                <thead>
                    <tr>
                        <th>Название группы</th>
                        <th>Назначать новым</th>
                        <th>Периодичность</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Group rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <hr>

            <div id="group-form-container" class="hidden">
                <h2 id="group-form-header">Создать новую группу</h2>
                <input type="text" id="group-name" placeholder="Название новой группы">
                <div id="group_name-error" class="inline-error"></div>
                <div style="display: flex; gap: 20px; margin-top: 10px; margin-bottom: 10px; align-items: center;">
                    <div style="flex: 1;">
                        <label for="group-start-date" style="display: block; margin-bottom: 5px;">Дата начала (необязательно)</label>
                        <input type="date" id="group-start-date" style="width: 100%;">
                    </div>
                    <div style="flex: 1;">
                        <label for="group-recurrence" style="display: block; margin-bottom: 5px;">Периодичность</label>
                        <select id="group-recurrence" style="width: 100%;">
                            <option value="">Однократно</option>
                            <option value="1">Раз в 1 месяц</option>
                            <option value="3">Раз в 3 месяца</option>
                            <option value="6">Раз в 6 месяцев</option>
                            <option value="12">Раз в 12 месяцев</option>
                        </select>
                    </div>
                </div>
                <label><input type="checkbox" id="group-for-new-employees"> Назначать новым сотрудникам</label>
                <button id="save-group-btn">Сохранить/Создать группу</button>
                <button id="cancel-group-edit-btn" class="hidden" style="background-color: #6c757d;">Отмена</button>
                <hr>
            </div>
            <h3>Курсы в группе</h3>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <h4>Доступные курсы</h4>
                    <select id="all-courses-list" multiple style="height: 200px;"></select>
                </div>
                <div style="display: flex; flex-direction: column; justify-content: center; gap: 10px;">
                    <button id="add-course-to-group-btn">&gt;&gt;</button>
                    <button id="remove-course-from-group-btn">&lt;&lt;</button>
                </div>
                <div style="flex: 1;">
                    <h4>Курсы в этой группе</h4>
                    <select id="group-courses-list" multiple style="height: 200px;"></select>
                </div>
            </div>
            <button id="save-courses-in-group-btn">Сохранить состав группы</button>
            <hr>
            <h3>Назначить группу подразделению</h3>
            <input type="text" id="assign-department-name" placeholder="Название подразделения">
            <button id="assign-group-btn">Назначить</button>

            <hr style="margin-top: 25px; margin-bottom: 25px;">

            <h3>Управление учениками</h3>
            <p>Здесь вы можете найти любого ученика и назначить ему курс индивидуально.</p>
            <button id="load-students-btn">Загрузить список всех учеников</button>

            <table id="students-table" class="hidden" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Email</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Имя</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Подразделение</th>
                    </tr>
                </thead>
                <tbody id="students-table-body">
                    <!-- Student rows will be inserted here -->
                </tbody>
            </table>

            <div id="student-actions-panel" class="hidden" style="margin-top: 15px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h4>Назначить курс для: <b id="selected-student-email-span"></b></h4>
                <select id="student-course-assignment-list"></select>
                <button id="assign-course-to-student-btn" style="width: auto; padding: 10px 20px; margin-top: 10px;">Назначить выбранный курс</button>
            </div>
        </div>

        <div id="results-view" class="hidden">
            <h2>Отчеты по результатам тестов</h2>
            <div id="results-filters">
                <input type="text" id="filter-user" placeholder="Email пользователя...">
                <input type="text" id="filter-department" placeholder="Подразделение...">
                <select id="filter-course"><option value="">Все курсы</option></select>
                <button id="apply-filters-btn">Применить фильтр</button>
                <button id="export-csv-btn" style="background-color: #218838;">Выгрузить в Excel (CSV)</button>
            </div>
            <table id="results-table">
                <thead>
                    <tr>
                        <th>Пользователь</th>
                        <th>Курс</th>
                        <th>Результат (%)</th>
                        <th>Время (мин)</th>
                        <th>Дата</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Сюда будут добавляться строки с результатами -->
                </tbody>
            </table>
        </div>

        <div id="simulator-results-view" class="hidden">
            <h2>Результаты диалогового тренажера</h2>
            <button id="refresh-sim-results-btn">Обновить</button>
            <table id="simulator-results-table" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Дата</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Пользователь</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Сценарий</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Персонаж</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Средний балл</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Simulator results will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

<script>
    // --- CONSTANTS ---
    const ACTIONS = {
        CREATE_COURSE: 'create_course',
        GET_COURSES_ADMIN: 'get_courses_admin',
        GET_COURSE_DETAILS: 'get_course_details',
        UPLOAD_AND_PROCESS: 'upload_and_process',
        GENERATE_CONTENT: 'generate_content',
        PUBLISH_COURSE: 'publish_course',
        DELETE_COURSE: 'delete_course',
        GET_COURSE_GROUPS: 'get_course_groups',
        CREATE_COURSE_GROUP: 'create_course_group',
        UPDATE_COURSE_GROUP: 'update_course_group',
        DELETE_COURSE_GROUP: 'delete_course_group',
        GET_GROUP_DETAILS: 'get_group_details',
        UPDATE_COURSES_IN_GROUP: 'update_courses_in_group',
        ASSIGN_GROUP_TO_DEPARTMENT: 'assign_group_to_department',
        UPLOAD_COURSE_MATERIAL: 'upload_course_material',
        DELETE_COURSE_MATERIAL: 'delete_course_material',
        GET_LEADERBOARD_SETTINGS: 'get_leaderboard_settings',
        SAVE_LEADERBOARD_SETTINGS: 'save_leaderboard_settings',
        GET_SIMULATION_RESULTS: 'get_simulation_results',
        GET_ALL_USERS: 'get_all_users',
        ASSIGN_COURSE_TO_USER: 'assign_course_to_user',
        TEXT_TO_SPEECH: 'text_to_speech',
    };

    // --- CORE SETUP ---
    const SUPABASE_URL = 'https://wnsdlibhrlmgyszbyxat.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Induc2RsaWJocmxtZ3lzemJ5eGF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyODE0MjgsImV4cCI6MjA2OTg1NzQyOH0.Sgz-50dHj8M599sIjTRYs0kMP7b6kX2BJ-Gc-trMUQ4';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let adminToken = null;
    let allCoursesData = []; // Cache for all courses
    let currentEditingCourseId = null;
    let currentEditingGroupId = null;

    // --- DOM ELEMENTS ---
    const loginView = document.getElementById('login-view');
    const panelView = document.getElementById('panel-view');
    const statusBox = document.getElementById('status-box');
    const allViews = [
        document.getElementById('courses-view'),
        document.getElementById('groups-view'),
        document.getElementById('results-view'),
        document.getElementById('leaderboard-view'),
        document.getElementById('simulator-results-view')
    ];
    const allBtns = [
        document.getElementById('courses-tab-btn'),
        document.getElementById('groups-tab-btn'),
        document.getElementById('results-tab-btn'),
        document.getElementById('leaderboard-tab-btn'),
        document.getElementById('simulator-tab-btn')
    ];
    // Course UI elements
    const courseFormContainer = document.getElementById('course-form-container');
    const courseFormHeader = document.getElementById('course-form-header');
    const coursesTableBody = document.getElementById('courses-table').getElementsByTagName('tbody')[0];
    // Group UI elements
    const groupFormContainer = document.getElementById('group-form-container');
    const groupFormHeader = document.getElementById('group-form-header');
    const groupsTableBody = document.getElementById('groups-table').getElementsByTagName('tbody')[0];
    const cancelGroupEditBtn = document.getElementById('cancel-group-edit-btn');
    const groupNameInput = document.getElementById('group-name');
    const newEmployeesCheckbox = document.getElementById('group-for-new-employees');
    const allCoursesList = document.getElementById('all-courses-list');
    const groupCoursesList = document.getElementById('group-courses-list');

    // --- UTILITY FUNCTIONS ---
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 5000);
    }

    function handleApiError(errorData) {
        // Clear previous inline errors
        document.querySelectorAll('.inline-error').forEach(el => el.textContent = '');

        if (errorData.details && typeof errorData.details === 'object') {
            for (const fieldName in errorData.details) {
                const errorElement = document.getElementById(`${fieldName}-error`);
                if (errorElement) {
                    errorElement.textContent = errorData.details[fieldName];
                } else {
                    showToast(`${fieldName}: ${errorData.details[fieldName]}`, 'error');
                }
            }
            showToast(errorData.error || 'Пожалуйста, проверьте ошибки в форме.', 'error');
        } else if (errorData.error) {
            showToast(errorData.error, 'error');
        } else {
            showToast('Произошла неизвестная ошибка. Попробуйте снова.', 'error');
        }
    }

    // The showStatus function is now an alias for showToast for consistency.
    const showStatus = showToast;

    function escapeHTML(str) {
        if (!str) return '';
        return str.replace(/'/g, '&apos;').replace(/"/g, '&quot;');
    }

    function sanitizeForPath(text) {
        const sanitized = text.replace(/[^a-zA-Z0-9-._]/g, '-');
        const collapsed = sanitized.replace(/-+/g, '-');
        return collapsed.replace(/^-+|-+$/g, '').toLowerCase();
    }

    // --- API & State Management ---
    const apiState = {
        activeCalls: 0,
        jobs: {} // To track background jobs { jobId: { intervalId, status } }
    };

    function showGlobalLoader() {
        let loader = document.getElementById('global-loader');
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'global-loader';
            loader.style.position = 'fixed';
            loader.style.top = '10px';
            loader.style.left = '50%';
            loader.style.transform = 'translateX(-50%)';
            loader.style.backgroundColor = '#005A9C';
            loader.style.color = 'white';
            loader.style.padding = '10px 20px';
            loader.style.borderRadius = '8px';
            loader.style.zIndex = '2000';
            loader.style.fontWeight = 'bold';
            loader.textContent = 'Загрузка...';
            document.body.appendChild(loader);
        }
        loader.classList.remove('hidden');
    }

    function hideGlobalLoader() {
        const loader = document.getElementById('global-loader');
        if (loader) {
            loader.classList.add('hidden');
        }
    }

    function updateApiState(change) {
        const wasActive = apiState.activeCalls > 0;
        apiState.activeCalls += change;
        const isActive = apiState.activeCalls > 0;

        if (!wasActive && isActive) {
            showGlobalLoader();
        } else if (wasActive && !isActive) {
            hideGlobalLoader();
        }
    }

    async function apiCall(action, payload = {}) {
        if (!adminToken) {
            showToast('Ошибка: вы не авторизованы. Пожалуйста, обновите страницу.', 'error');
            throw new Error('Not authorized');
        }

        updateApiState(1);

        try {
            const response = await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, ...payload })
            });

            if (response.status === 202) {
                const data = await response.json();
                startJobPolling(data.jobId);
                showToast(`Задача запущена в фоновом режиме (ID: ${data.jobId}). Вы можете продолжать работу.`, 'info');
                return data;
            }

            if (!response.ok) {
                // Специальная обработка для ошибки "Доступ запрещен"
                if (response.status === 403) {
                    showToast('Доступ запрещен. У вас нет прав для выполнения этого действия.', 'error');
                    // Можно также рассмотреть выход из системы, если это необходимо
                    // await handleLogout();
                    throw new Error('Forbidden');
                }

                let errorData;
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData = { error: `Сервер вернул ошибку ${response.status}, но тело ответа не в формате JSON.` };
                }
                // Log the full error for debugging
                console.error('API Error Response:', errorData);
                // Show a user-friendly message
                showToast(errorData.error || `Ошибка ${response.status}. Попробуйте позже.`, 'error');
                throw new Error(errorData.error || `API Call Failed with status ${response.status}`);
            }

            return await response.json();

        } catch (error) {
            // This catches network errors or errors from the !response.ok block
            console.error('API Call failed:', error);
            // Avoid showing a generic toast if a specific one was already shown
            if (!error.message.includes('API Call Failed')) {
                 showToast('Сетевая ошибка или сервер недоступен. Проверьте ваше подключение и попробуйте снова.', 'error');
            }
            throw error; // Re-throw so calling functions know it failed
        } finally {
            updateApiState(-1);
        }
    }

    function startJobPolling(jobId) {
        if (!jobId) return;

        apiState.jobs[jobId] = { status: 'pending' };

        const intervalId = setInterval(async () => {
            try {
                if (!adminToken) { // Safety check
                    clearInterval(intervalId);
                    return;
                }
                const response = await fetch('/api/get-job-status', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jobId: jobId })
                });

                if (!response.ok) {
                    // Stop polling on 4xx or 5xx errors
                    console.error(`Polling for job ${jobId} failed with status ${response.status}. Stopping.`);
                    showToast(`Не удалось отследить статус задачи ${jobId}.`, 'error');
                    clearInterval(intervalId);
                    delete apiState.jobs[jobId];
                    return;
                }

                const job = await response.json();
                apiState.jobs[jobId].status = job.status;

                if (job.status === 'completed') {
                    showToast(`Задача (ID: ${jobId}) успешно завершена!`, 'success');
                    clearInterval(intervalId);
                    delete apiState.jobs[jobId];
                    // Optionally, refresh data, e.g., loadCourses()
                    if (window.loadCourses) loadCourses();
                } else if (job.status === 'failed') {
                    showToast(`Задача (ID: ${jobId}) не удалась: ${job.error_message}`, 'error');
                    clearInterval(intervalId);
                    delete apiState.jobs[jobId];
                }
                // If 'pending', continue polling silently.
            } catch (error) {
                console.error(`Error during job polling for ${jobId}:`, error);
                showToast(`Ошибка при проверке статуса задачи ${jobId}.`, 'error');
                clearInterval(intervalId);
                delete apiState.jobs[jobId];
            }
        }, 5000); // Poll every 5 seconds

        apiState.jobs[jobId].intervalId = intervalId;
    }

    // --- TAB SWITCHING ---
    function switchTab(activeTab, activeBtn) {
        allViews.forEach(view => view.classList.add('hidden'));
        allBtns.forEach(btn => btn.classList.remove('active'));
        activeTab.classList.remove('hidden');
        activeBtn.classList.add('active');
    }

    allBtns.forEach((btn, index) => {
        btn.addEventListener('click', () => {
            switchTab(allViews[index], btn);
            // Load data for the activated tab
            if (allViews[index].id === 'courses-view') loadCourses();
            if (allViews[index].id === 'groups-view') {
                loadGroups();
                loadAllCoursesForGrouping();
            }
            if (allViews[index].id === 'results-view') loadResults();
            if (allViews[index].id === 'leaderboard-view') loadLeaderboardSettings();
            if (allViews[index].id === 'simulator-results-view') loadSimulatorResults();
        });
    });

    const loginError = document.getElementById('login-error');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');

    // --- AUTHENTICATION & SESSION ---
    async function onLoginSuccess(session) {
        // After getting a session, verify the user has admin rights.
        try {
            // New, simplified check using the 'is_admin' flag from the users table.
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) throw new Error('Не удалось получить данные пользователя.');

            const { data: adminCheck, error: adminCheckError } = await supabaseClient
                .from('users')
                .select('is_admin')
                .eq('id', user.id)
                .single();

            if (adminCheckError) throw adminCheckError;

            if (!adminCheck || !adminCheck.is_admin) {
                throw new Error('У вас нет прав администратора.');
            }

            // Admin rights verified, proceed to show the panel
            adminToken = session.access_token;
            loginView.classList.add('hidden');
            panelView.classList.remove('hidden');
            await loadCourses(); // Load initial data
        } catch (error) {
            showStatus(`Ошибка проверки прав: ${error.message}`, 'error');
            await supabaseClient.auth.signOut(); // Log out user if they are not an admin
            loginView.classList.remove('hidden');
            panelView.classList.add('hidden');
        }
    }

    async function handleLogin() {
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        loginBtn.disabled = true;
        loginBtn.textContent = 'Вход...';
        loginError.classList.add('hidden');

        try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) throw error;
            await onLoginSuccess(data.session);
        } catch (error) {
            loginError.textContent = `Ошибка входа: ${error.message}`;
            loginError.classList.remove('hidden');
        } finally {
            loginBtn.disabled = false;
            loginBtn.textContent = 'Войти';
        }
    }

    async function handleLogout() {
        await supabaseClient.auth.signOut();
        adminToken = null;
        loginView.classList.remove('hidden');
        panelView.classList.add('hidden');
    }

    function showLogin() {
        loginView.classList.remove('hidden');
        panelView.classList.add('hidden');
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session }, error } = await supabaseClient.auth.getSession();

        if (error) {
            // The error is not critical to log to console, as UI handles it.
            showLogin();
            return;
        }

        if (session) {
            await onLoginSuccess(session);
        } else {
            showLogin();
        }

        loginBtn.addEventListener('click', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
    });

    // --- DYNAMIC FORM RENDERING ---
    function renderCourseForm(course = null) {
        const isEditing = course !== null;
        const courseId = isEditing ? course.id : '';
        const title = isEditing ? course.title : '';
        const description = isEditing ? course.description : '';
        const headerText = isEditing ? `Редактирование курса: ${title}` : 'Создать новый курс';

        let content = '';
        if (isEditing && course.content) {
            try {
                // Prettify the JSON string for editing
                const parsedContent = JSON.parse(course.content);
                content = JSON.stringify(parsedContent, null, 2);
            } catch (e) {
                content = course.content; // If it's not valid JSON, show as is
            }
        }

        let materialsHtml = 'Материалы не загружены.';
        if (isEditing && course.course_materials && course.course_materials.length > 0) {
            materialsHtml = course.course_materials.map(mat =>
                `<div>${escapeHTML(mat.file_name)} <button class="delete-material-btn" data-id="${mat.id}" data-path="${mat.storage_path}">Удалить</button></div>`
            ).join('');
        }

        return `
            <div id="course-form-container">
                <h2 id="course-form-header">${headerText}</h2>
                <input type="text" id="course-id" placeholder="ID Курса" value="${escapeHTML(courseId)}" disabled>
                <input type="text" id="course-title" placeholder="Название курса" value="${escapeHTML(title)}">

                <h3>Шаг 1: Загрузите файл для описания</h3>
                <input type="file" id="file-uploader" accept=".pdf,.docx">
                <button id="process-file-btn">Загрузить и извлечь текст</button>

                <h3>Описание (Источник для AI)</h3>
                <div id="audio-player-container" class="hidden" style="margin-top: 10px;"></div>
                <button id="text-to-speech-btn">Озвучить описание</button>
                <textarea id="description" placeholder="После обработки файла здесь появится извлеченный текст...">${escapeHTML(description)}</textarea>

                <h3>Шаг 2: Сгенерируйте контент</h3>
                <textarea id="custom-prompt" placeholder="Напишите свой промпт или оставьте пустым для стандартного..."></textarea>
                <button id="generate-btn">Сгенерировать черновик по описанию</button>

                <h3>Шаг 3: Проверьте и отредактируйте контент</h3>
                <textarea id="content" placeholder="Здесь появится сгенерированный контент в формате JSON...">${escapeHTML(content)}</textarea>

                <h3>Шаг 4: Сохранение и публикация</h3>
                <button id="publish-btn" style="background-color: #28a745;">ОПУБЛИКОВАТЬ</button>
                <button id="cancel-edit-btn" style="background-color: #6c757d;">Отмена</button>

                <hr>
                <h3>Сопутствующие материалы</h3>
                <div id="materials-list">${materialsHtml}</div>
                <input type="file" id="material-uploader">
                <button id="upload-material-btn">Загрузить материал</button>
            </div>
        `;
    }

    function attachCourseFormListeners() {
        document.getElementById('cancel-edit-btn').addEventListener('click', clearCourseForm);
        document.getElementById('process-file-btn').addEventListener('click', processFileHandler);
        document.getElementById('generate-btn').addEventListener('click', generateContentHandler);
        document.getElementById('text-to-speech-btn').addEventListener('click', textToSpeechHandler);
        document.getElementById('publish-btn').addEventListener('click', publishCourseHandler);
        document.getElementById('upload-material-btn').addEventListener('click', uploadMaterialHandler);
        document.getElementById('materials-list').addEventListener('click', deleteMaterialHandler);
    }

    // --- COURSE MANAGEMENT ---
    function clearCourseForm() {
        const wrapper = document.getElementById('course-form-wrapper');
        wrapper.innerHTML = '';
        currentEditingCourseId = null;
    }

    // Event handlers are separated to be attached to dynamically created elements
    async function processFileHandler() {
        const file = document.getElementById('file-uploader').files[0];
        const title = document.getElementById('course-title').value.trim();
        if (!file || !title) return showStatus('Укажите название курса и выберите файл.', 'error');

        let courseId = document.getElementById('course-id').value.trim();

        showStatus(`Обработка файла...`, 'info');

        try {
            // If there is no courseId, it's a new course. Create it first.
            if (!courseId) {
                const newCourse = await apiCall(ACTIONS.CREATE_COURSE, { title });
                courseId = newCourse.id;
                document.getElementById('course-id').value = courseId; // Update UI
                showToast(`Создан новый курс с ID: ${courseId}`, 'success');
            }

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64File = reader.result.split(',')[1];
                await apiCall(ACTIONS.UPLOAD_AND_PROCESS, {
                    course_id: courseId,
                    file_name: sanitizeForPath(file.name),
                    file_data: base64File
                });
                document.getElementById('description').value = 'Обработка файла запущена в фоновом режиме...';
                document.getElementById('course-id').disabled = true;
                await loadCourses();
            };
        } catch(e) { /* Handled in apiCall */ }
    }

    async function generateContentHandler() {
        const courseId = document.getElementById('course-id').value.trim();
        if (!courseId) {
            showToast('Сначала нужно создать или загрузить курс (должен быть ID курса).', 'error');
            return;
        }
        document.getElementById('content').value = 'Генерация контента запущена в фоновом режиме...';
        try {
            await apiCall(ACTIONS.GENERATE_CONTENT, {
                course_id: courseId,
                custom_prompt: document.getElementById('custom-prompt').value
            });
        } catch(e) {
            document.getElementById('content').value = 'Ошибка при запуске генерации. Пожалуйста, проверьте консоль.';
        }
    }

    async function textToSpeechHandler() {
        const description = document.getElementById('description').value;
        if (!description) return showStatus('Нет текста для озвучивания.', 'error');
        showStatus('Идет генерация аудио...', 'info');
        const audioPlayerContainer = document.getElementById('audio-player-container');
        audioPlayerContainer.innerHTML = '';
        try {
            const data = await apiCall(ACTIONS.TEXT_TO_SPEECH, { text: description });
            const audio = new Audio(data.audioUrl);
            audio.controls = true;
            audioPlayerContainer.appendChild(audio);
            audioPlayerContainer.classList.remove('hidden');
            showStatus('Аудио успешно сгенерировано.', 'success');
        } catch (error) { /* Handled in apiCall */ }
    }

    async function publishCourseHandler() {
        const courseId = document.getElementById('course-id').value.trim();
        if (!courseId) return showStatus('Укажите ID курса.', 'error');

        const title = document.getElementById('course-title').value.trim();
        const description = document.getElementById('description').value;
        const content = document.getElementById('content').value;

        if (!title || !description || !content) {
            return showStatus('Название, описание и контент должны быть заполнены.', 'error');
        }

        showStatus('Публикую курс...', 'info');
        try {
            // Ensure content is valid JSON before sending
            const parsedContent = JSON.parse(content);

            await apiCall(ACTIONS.PUBLISH_COURSE, {
                course_id: courseId,
                title: title,
                description: description,
                content: content, // Send the raw string
            });
            showStatus('Курс успешно опубликован.', 'success');
            await loadCourses();
            clearCourseForm();
        } catch (e) {
            showStatus('Ошибка: Контент не является валидным JSON или другая проблема.', 'error');
        }
    }

    async function uploadMaterialHandler() {
        const file = document.getElementById('material-uploader').files[0];
        if (!currentEditingCourseId || !file) return showStatus('Сначала выберите курс для редактирования и файл для загрузки.', 'error');
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            try {
                await apiCall(ACTIONS.UPLOAD_COURSE_MATERIAL, {
                    course_id: currentEditingCourseId,
                    file_name: file.name,
                    file_data: reader.result.split(',')[1]
                });
                showStatus('Материал успешно загружен.', 'success');
                loadCourseForEditing(currentEditingCourseId); // Refresh
            } catch(e) { /* Handled in apiCall */ }
        };
    }

    async function deleteMaterialHandler(e) {
        if (e.target.classList.contains('delete-material-btn')) {
            const materialId = e.target.dataset.id;
            const storagePath = e.target.dataset.path;
            if (confirm(`Удалить материал "${storagePath}"?`)) {
                try {
                    await apiCall(ACTIONS.DELETE_COURSE_MATERIAL, { material_id: materialId, storage_path: storagePath });
                    showStatus('Материал удален.', 'success');
                    loadCourseForEditing(currentEditingCourseId); // Refresh
                } catch(e) { /* Handled in apiCall */ }
            }
        }
    }

    document.getElementById('show-create-form-btn').addEventListener('click', () => {
        const wrapper = document.getElementById('course-form-wrapper');
        wrapper.innerHTML = renderCourseForm();
        attachCourseFormListeners();
        document.getElementById('course-id').focus();
    });

    function renderCoursesTable(courses) {
        if (!courses || courses.length === 0) {
            return '<tr><td colspan="4" style="text-align:center;">Курсы еще не созданы.</td></tr>';
        }
        return courses.sort((a, b) => a.title.localeCompare(b.title)).map(course => `
            <tr>
                <td>${escapeHTML(course.title)}</td>
                <td>${escapeHTML(course.id)}</td>
                <td class="status-published">${course.content ? 'Опубликован' : 'Черновик'}</td>
                <td class="actions-cell">
                    <button onclick="loadCourseForEditing('${escapeHTML(course.id)}')">Редактировать</button>
                    <button style="background-color: #dc3545;" onclick="deleteCourse('${escapeHTML(course.id)}', '${escapeHTML(course.title)}')">Удалить</button>
                </td>
            </tr>
        `).join('');
    }

    async function loadCourses() {
        coursesTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Загрузка...</td></tr>';
        try {
            const courses = await apiCall(ACTIONS.GET_COURSES_ADMIN);
            allCoursesData = courses; // Cache for group management
            coursesTableBody.innerHTML = renderCoursesTable(courses);

            const filterCourseSelector = document.getElementById('filter-course');
            filterCourseSelector.innerHTML = '<option value="">Все курсы</option>';
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = `${course.title} (${course.id})`;
                filterCourseSelector.appendChild(option);
            });
        } catch (e) { /* Handled in apiCall */ }
    }

    async function loadCourseForEditing(courseId) {
        showStatus(`Загружаю данные для курса ${courseId}...`, 'info');
        try {
            const course = await apiCall(ACTIONS.GET_COURSE_DETAILS, { course_id: courseId });
            currentEditingCourseId = courseId;

            const wrapper = document.getElementById('course-form-wrapper');
            wrapper.innerHTML = renderCourseForm(course);
            attachCourseFormListeners();

            showStatus(`Курс ${course.title} успешно загружен.`, 'success');
            window.scrollTo(0, wrapper.offsetTop);
        } catch (e) { /* Handled in apiCall */ }
    }

    async function deleteCourse(courseId, courseTitle) {
        if (!confirm(`Вы уверены, что хотите удалить курс "${courseTitle}" (${courseId})? Это действие необратимо и также удалит все результаты тестов по этому курсу.`)) return;
        try {
            await apiCall(ACTIONS.DELETE_COURSE, { course_id: courseId });
            showStatus('Курс успешно удален.', 'success');
            clearCourseForm();
            await loadCourses();
        } catch (e) { /* Handled in apiCall */ }
    }

    // --- GROUP MANAGEMENT ---
    function clearGroupForm() {
        groupFormContainer.classList.add('hidden');
        groupFormHeader.textContent = 'Создать новую группу';
        groupNameInput.value = '';
        newEmployeesCheckbox.checked = false;
        document.getElementById('group-start-date').value = '';
        document.getElementById('group-recurrence').value = '';
        groupCoursesList.innerHTML = '';
        allCoursesList.innerHTML = '';
        document.getElementById('assign-department-name').value = '';
        cancelGroupEditBtn.classList.add('hidden');
        currentEditingGroupId = null;
    }

    document.getElementById('show-create-group-form-btn').addEventListener('click', () => {
        clearGroupForm();
        groupFormContainer.classList.remove('hidden');
        populateAllCoursesList([]);
        groupNameInput.focus();
    });

    cancelGroupEditBtn.addEventListener('click', clearGroupForm);

    function renderGroupsTable(groups) {
        if (!groups || groups.length === 0) {
            return '<tr><td colspan="4" style="text-align:center;">Группы еще не созданы.</td></tr>';
        }
        const recurrenceMap = {'1': 'Раз в 1 месяц', '3': 'Раз в 3 месяца', '6': 'Раз в 6 месяцев', '12': 'Раз в 12 месяцев'};
        return groups.sort((a, b) => a.group_name.localeCompare(b.group_name)).map(g => `
            <tr>
                <td>${escapeHTML(g.group_name)}</td>
                <td>${g.is_for_new_employees ? 'Да' : 'Нет'}</td>
                <td>${recurrenceMap[g.recurrence_period] || 'Однократно'}</td>
                <td class="actions-cell">
                    <button onclick="loadGroupForEditing('${g.id}')">Редактировать</button>
                    <button style="background-color: #dc3545;" onclick="deleteGroup('${g.id}', '${escapeHTML(g.group_name)}')">Удалить</button>
                </td>
            </tr>
        `).join('');
    }

    async function loadGroups() {
        groupsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Загрузка...</td></tr>';
        try {
            const groups = await apiCall(ACTIONS.GET_COURSE_GROUPS);
            groupsTableBody.innerHTML = renderGroupsTable(groups);
        } catch (e) { /* Handled in apiCall */ }
    }

    async function loadGroupForEditing(groupId) {
        showStatus(`Загрузка группы ${groupId}...`, 'info');
        try {
            const groupDetails = await apiCall(ACTIONS.GET_GROUP_DETAILS, { group_id: groupId });
            clearGroupForm();
            groupFormContainer.classList.remove('hidden');
            groupFormHeader.textContent = `Редактирование группы: ${groupDetails.group_name}`;
            cancelGroupEditBtn.classList.remove('hidden');
            currentEditingGroupId = groupId;

            groupNameInput.value = groupDetails.group_name;
            newEmployeesCheckbox.checked = groupDetails.is_for_new_employees;
            document.getElementById('group-start-date').value = groupDetails.start_date ? groupDetails.start_date.split('T')[0] : '';
            document.getElementById('group-recurrence').value = groupDetails.recurrence_period || '';

            const courseIdsInGroup = groupDetails.course_group_items.map(item => item.course_id);
            groupCoursesList.innerHTML = '';
            allCoursesData.filter(c => courseIdsInGroup.includes(c.course_id)).forEach(c => {
                const option = document.createElement('option');
                option.value = c.course_id;
                option.textContent = `${c.title} (${c.course_id})`;
                groupCoursesList.appendChild(option);
            });
            populateAllCoursesList(courseIdsInGroup);
            showStatus('Группа загружена.', 'success');
            window.scrollTo(0, groupFormContainer.offsetTop);
        } catch (e) { /* Handled in apiCall */ }
    }

    async function deleteGroup(groupId, groupName) {
        if (confirm(`Вы уверены, что хотите удалить группу "${groupName}"?`)) {
            try {
                await apiCall(ACTIONS.DELETE_COURSE_GROUP, { group_id: groupId });
                showStatus('Группа удалена.', 'success');
                clearGroupForm();
                await loadGroups();
            } catch (e) { /* Handled in apiCall */ }
        }
    }

    document.getElementById('save-group-btn').addEventListener('click', async () => {
        const groupName = groupNameInput.value.trim();
        if (!groupName) return showStatus('Название группы не может быть пустым.', 'error');
        const payload = {
            group_name: groupName,
            is_for_new_employees: newEmployeesCheckbox.checked,
            start_date: document.getElementById('group-start-date').value || null,
            recurrence_period: document.getElementById('group-recurrence').value || null
        };
        try {
            if (currentEditingGroupId) {
                await apiCall(ACTIONS.UPDATE_COURSE_GROUP, { ...payload, group_id: currentEditingGroupId });
                showStatus('Группа успешно обновлена.', 'success');
            } else {
                const newGroup = await apiCall(ACTIONS.CREATE_COURSE_GROUP, payload);
                currentEditingGroupId = newGroup.id; // Set current group to allow adding courses right away
                showStatus('Группа успешно создана.', 'success');
            }
            await loadGroups();
        } catch (e) { /* Handled in apiCall */ }
    });

    async function loadAllCoursesForGrouping() {
        if (allCoursesData.length === 0) {
             try {
                allCoursesData = await apiCall(ACTIONS.GET_COURSES_ADMIN);
             } catch(e) { /* Handled in apiCall */ }
        }
    }

    function populateAllCoursesList(usedCourseIds) {
        allCoursesList.innerHTML = '';
        allCoursesData.filter(c => !usedCourseIds.includes(c.course_id)).forEach(c => {
            const option = document.createElement('option');
            option.value = c.course_id;
            option.textContent = `${c.title} (${c.course_id})`;
            allCoursesList.appendChild(option);
        });
    }

    document.getElementById('add-course-to-group-btn').addEventListener('click', () => Array.from(allCoursesList.selectedOptions).forEach(o => groupCoursesList.appendChild(o)));
    document.getElementById('remove-course-from-group-btn').addEventListener('click', () => Array.from(groupCoursesList.selectedOptions).forEach(o => allCoursesList.appendChild(o)));

    document.getElementById('save-courses-in-group-btn').addEventListener('click', async () => {
        if (!currentEditingGroupId) return showStatus('Сначала выберите или создайте группу.', 'error');
        const courseIds = Array.from(groupCoursesList.options).map(opt => opt.value);
        try {
            await apiCall(ACTIONS.UPDATE_COURSES_IN_GROUP, { group_id: currentEditingGroupId, course_ids: courseIds });
            showStatus('Состав группы успешно сохранен.', 'success');
        } catch (e) { /* Handled in apiCall */ }
    });

    document.getElementById('assign-group-btn').addEventListener('click', async () => {
        const department = document.getElementById('assign-department-name').value.trim();
        if (!currentEditingGroupId || !department) return showStatus('Выберите группу и укажите название подразделения.', 'error');
        try {
            await apiCall(ACTIONS.ASSIGN_GROUP_TO_DEPARTMENT, { group_id: currentEditingGroupId, department: department });
            showStatus(`Группа успешно назначена подразделению "${department}".`, 'success');
            document.getElementById('assign-department-name').value = '';
        } catch (e) { /* Handled in apiCall */ }
    });

    // --- STUDENT MANAGEMENT (within Groups tab) ---
    let selectedStudentEmail = null;

    document.getElementById('load-students-btn').addEventListener('click', async () => {
        try {
            showStatus('Загрузка списка учеников...', 'info');
            const students = await apiCall(ACTIONS.GET_ALL_USERS);
            const studentsTable = document.getElementById('students-table');
            const studentsTbody = document.getElementById('students-table-body');
            studentsTbody.innerHTML = '';
            students.forEach(student => {
                const row = studentsTbody.insertRow();
                row.dataset.email = student.email;
                row.insertCell(0).textContent = student.email;
                row.insertCell(1).textContent = student.full_name;
                row.insertCell(2).textContent = student.department;
            });
            studentsTable.classList.remove('hidden');
            showStatus(`Загружено ${students.length} учеников.`, 'success');
        } catch(e) { /* Handled in apiCall */ }
    });

    document.getElementById('students-table-body').addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (!row) return;

        // Toggle selection and update UI
        document.querySelectorAll('#students-table-body tr').forEach(r => r.style.backgroundColor = '');
        row.style.backgroundColor = '#e9f7fe';

        selectedStudentEmail = row.dataset.email;
        const actionsPanel = document.getElementById('student-actions-panel');
        document.getElementById('selected-student-email-span').textContent = selectedStudentEmail;

        const courseList = document.getElementById('student-course-assignment-list');
        courseList.innerHTML = '';
        allCoursesData.forEach(course => {
            const option = document.createElement('option');
            option.value = course.course_id;
            option.textContent = `${course.title} (${course.course_id})`;
            courseList.appendChild(option);
        });

        actionsPanel.classList.remove('hidden');
    });

    document.getElementById('assign-course-to-student-btn').addEventListener('click', async () => {
        const courseId = document.getElementById('student-course-assignment-list').value;
        if (!selectedStudentEmail || !courseId) {
            return showStatus('Выберите ученика и курс для назначения.', 'error');
        }
        try {
            await apiCall(ACTIONS.ASSIGN_COURSE_TO_USER, { user_email: selectedStudentEmail, course_id: courseId });
            showStatus(`Курс "${courseId}" успешно назначен ${selectedStudentEmail}.`, 'success');
        } catch(e) { /* Handled in apiCall */ }
    });


    // --- LEADERBOARD & OTHER ---
    async function loadLeaderboardSettings() {
        try {
            const settings = await apiCall(ACTIONS.GET_LEADERBOARD_SETTINGS);
            const metrics = settings.metrics || { courses_completed: true, time_spent: false, avg_score: false };
            document.querySelectorAll('#leaderboard-settings-form input[type="checkbox"]').forEach(c => { c.checked = metrics[c.value] || false; });
            showStatus('Настройки загружены.', 'success');
        } catch (e) { /* Handled in apiCall */ }
    }

    document.getElementById('save-leaderboard-settings-btn').addEventListener('click', async () => {
        const metrics = {};
        document.querySelectorAll('#leaderboard-settings-form input[type="checkbox"]').forEach(c => { metrics[c.value] = c.checked; });
        try {
            await apiCall(ACTIONS.SAVE_LEADERBOARD_SETTINGS, { metrics });
            showStatus('Настройки успешно сохранены.', 'success');
        } catch (e) { /* Handled in apiCall */ }
    });

    // --- RESULTS ---
    async function loadResults() {
        const tableBody = document.getElementById('results-table').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Загрузка отчета...</td></tr>';
        const userEmail = document.getElementById('filter-user').value;
        const department = document.getElementById('filter-department').value;
        const courseId = document.getElementById('filter-course').value;
        const payload = { user_email: userEmail, department, course_id: courseId };
        try {
            if (!adminToken) throw new Error('Не авторизован');
            const response = await fetch('/api/getDetailedReport', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Ошибка при загрузке отчета.');
            }
            const results = await response.json();
            tableBody.innerHTML = '';
            if (results.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Результаты не найдены.</td></tr>';
                return;
            }
            results.forEach(result => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = result.user_profiles?.full_name || result.user_email;
                row.insertCell(1).textContent = result.courses.title;
                row.insertCell(2).textContent = result.percentage;
                const timeSpentMinutes = result.time_spent_seconds ? Math.round(result.time_spent_seconds / 60) : 0;
                row.insertCell(3).textContent = timeSpentMinutes;
                row.insertCell(4).textContent = result.completed_at ? new Date(result.completed_at).toLocaleString() : 'В процессе';
            });
        } catch (error) {
            showStatus('Ошибка при загрузке результатов.', 'error');
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: red;">${error.message}</td></tr>`;
        }
    }

    document.getElementById('apply-filters-btn').addEventListener('click', loadResults);

    // --- SIMULATOR RESULTS ---
    async function loadSimulatorResults() {
        const tableBody = document.getElementById('simulator-results-table').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Загрузка результатов...</td></tr>';
        showStatus('Загрузка результатов тренажера...', 'info');
        try {
            const results = await apiCall(ACTIONS.GET_SIMULATION_RESULTS);
            tableBody.innerHTML = '';
            if (results.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Результаты тренажера отсутствуют.</td></tr>';
                return;
            }
            results.forEach(res => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = new Date(res.created_at).toLocaleString();
                row.insertCell(1).textContent = res.full_name || res.user_email;
                const scenarioCell = row.insertCell(2);
                scenarioCell.textContent = res.scenario ? (res.scenario.substring(0, 100) + '...') : 'N/A';
                scenarioCell.title = res.scenario;
                row.insertCell(3).textContent = res.persona;
                const scoreCell = row.insertCell(4);
                scoreCell.style.textAlign = 'center';
                scoreCell.style.fontWeight = 'bold';
                scoreCell.textContent = res.evaluation?.average_score ? res.evaluation.average_score.toFixed(1) : 'N/A';
            });
            showStatus('Результаты тренажера загружены.', 'success');
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: red;">${e.message}</td></tr>`;
        }
    }

    document.getElementById('refresh-sim-results-btn').addEventListener('click', loadSimulatorResults);


    document.getElementById('export-csv-btn').addEventListener('click', async () => {
        const userEmail = document.getElementById('filter-user').value;
        const department = document.getElementById('filter-department').value;
        const courseId = document.getElementById('filter-course').value;
        const payload = { format: 'csv', user_email: userEmail, department, course_id: courseId };
        showStatus('Выгрузка отчета...', 'info');
        try {
            // This endpoint requires auth, but for a simple GET request for file download,
            // we can construct the URL and trigger a download without a complex fetch.
            // However, to pass the auth header, we must use fetch.
            const response = await fetch('/api/getDetailedReport', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error((await response.json()).error || 'Не удалось получить данные.');
            const csvData = await response.text();
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', `report-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            showStatus('Отчет успешно выгружен.', 'success');
        } catch (error) {
            showStatus(`Ошибка при выгрузке: ${error.message}`, 'error');
        }
    });
</script>
</body>
</html>
