<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Админ-панель</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; background-color: #f4f7f6; }
        h1, h2, h3 { color: #005A9C; }
        .hidden { display: none; }
        input, textarea, button, select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e0e0e0; font-size: 16px; }
        button { background-color: #005A9C; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background-color: #00AEEF; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        textarea { height: 150px; resize: vertical; }
        .status { padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; }
        .error { color: #dc3545; background-color: #fdeeee; }
        .success { color: #28a745; background-color: #eaf7ec; }
        .info { color: #005A9C; background-color: #e9f7fe; }
        .tabs button { width: auto; padding: 10px 20px; margin-right: 10px; background-color: #e0e0e0; color: #333; }
        .tabs button.active { background-color: #005A9C; color: white; }
        #results-view { margin-top: 20px; }
        #results-filters { display: flex; gap: 10px; margin-bottom: 10px; }
        #results-table { width: 100%; border-collapse: collapse; }
        #results-table th, #results-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #results-table th { background-color: #f2f2f2; }
        #delete-course-btn { background-color: #dc3545; }
        #delete-course-btn:hover { background-color: #c82333; }
        #courses-table, #groups-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #courses-table th, #courses-table td, #groups-table th, #groups-table td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: middle; }
        #courses-table th, #groups-table th { background-color: #f2f2f2; font-weight: bold; }
        .actions-cell button { width: auto; padding: 6px 12px; font-size: 14px; margin-right: 5px; }
        .status-published { color: #28a745; font-weight: bold; }
        .status-processed { color: #ffc107; }
        .inline-error { color: #dc3545; font-size: 0.9em; margin-top: -5px; margin-bottom: 10px; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; }
        .toast { padding: 15px 20px; margin-bottom: 10px; border-radius: 8px; color: white; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); opacity: 0.9; width: 300px; }
        .toast-error { background-color: #dc3545; }
        .toast-success { background-color: #28a745; }
        .toast-info { background-color: #00AEEF; }

        /* WYSIWYG Editor Styles */
        #wysiwyg-editor {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            background-color: #fff;
            min-height: 200px;
        }
        .wysiwyg-slide {
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #fcfcfc;
        }
        .wysiwyg-slide-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 2px solid #005A9C;
            padding-bottom: 10px;
            color: #005A9C;
        }
        .wysiwyg-slide-content, .wysiwyg-question-text, .wysiwyg-option-label {
            min-height: 30px;
            padding: 8px;
            border: 1px dashed #ced4da;
        }
        .wysiwyg-slide-content:focus, .wysiwyg-question-text:focus, .wysiwyg-option-label:focus {
            outline: 1px solid #00AEEF;
            border: 1px solid #00AEEF;
            background-color: #f8f9fa;
        }
        .wysiwyg-questions-container h4 {
            margin-top: 25px;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        .wysiwyg-question {
            background-color: #f1f3f5;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            border-left: 4px solid #00AEEF;
        }
        .wysiwyg-options {
            list-style-type: none;
            padding-left: 0;
            margin-top: 10px;
        }
        .wysiwyg-option-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            background-color: #fff;
            padding: 5px;
            border-radius: 4px;
        }
        .wysiwyg-option-item input[type="radio"] {
            width: auto;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .wysiwyg-option-label {
            flex-grow: 1;
        }
        .course-list {
            list-style-type: none;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            background-color: #fff;
        }
        .course-list li {
            padding: 8px;
            margin-bottom: 5px;
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: grab;
        }
        .course-list li:hover {
            background-color: #e9f7fe;
        }
        .course-list li.dragging {
            opacity: 0.5;
            background-color: #cce5ff;
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div id="login-view" class="hidden">
        <h1>Вход для администратора</h1>
        <input type="email" id="admin-email" value="test1@cic.kz">
        <input type="password" id="admin-password" placeholder="Пароль">
        <button id="login-btn">Войти</button>
        <div id="login-error" class="status error hidden"></div>
    </div>

    <div id="panel-view" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Панель управления</h1>
            <button id="logout-btn" style="width: auto; background-color: #6c757d;">Выйти</button>
        </div>
        <div class="tabs">
            <button id="courses-tab-btn" class="active">Управление курсами</button>
            <button id="groups-tab-btn">Управление группами</button>
            <button id="results-tab-btn">Отчеты и Результаты</button>
            <button id="leaderboard-tab-btn">Лидерборд</button>
            <button id="simulator-tab-btn">Результаты Тренажера</button>
        </div>
        <hr>

        <div id="leaderboard-view" class="hidden">
            <h2>Настройки Лидерборда "Топ учеников недели"</h2>
            <p>Выберите метрики, по которым будет строиться рейтинг. Пользователи будут отсортированы по первой выбранной метрике.</p>
            <div id="leaderboard-settings-form">
                <label><input type="checkbox" name="metric" value="courses_completed"> Количество пройденных курсов</label><br>
                <label><input type="checkbox" name="metric" value="time_spent"> Общее время обучения (в минутах)</label><br>
                <label><input type="checkbox" name="metric" value="avg_score"> Средний балл по тестам</label><br>
                <br>
                <button id="save-leaderboard-settings-btn">Сохранить настройки</button>
            </div>
        </div>

        <div id="courses-view">
            <h2>Панель управления курсами</h2>
            <div id="status-box" class="status hidden"></div>

            <h3>Существующие курсы</h3>
            <button id="show-create-form-btn">Создать новый курс</button>
            <table id="courses-table">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>ID Курса</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Course rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <hr>

            <div id="course-form-wrapper"></div>
        </div>

        <div id="groups-view" class="hidden">
            <h2>Управление группами курсов (Блоками)</h2>

            <h3>Существующие группы</h3>
            <button id="show-create-group-form-btn">Создать новую группу</button>
            <table id="groups-table">
                <thead>
                    <tr>
                        <th>Название группы</th>
                        <th>Назначать новым</th>
                        <th>Видимость</th>
                        <th>Порядок</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Group rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <hr>

            <div id="group-form-container" class="hidden">
                <h2 id="group-form-header">Создать новую группу</h2>
                <input type="text" id="group-name" placeholder="Название новой группы">
                <div id="group_name-error" class="inline-error"></div>

                <div style="display: flex; gap: 20px; margin-top: 10px; margin-bottom: 10px; align-items: center;">
                    <div style="flex: 1;">
                        <label for="group-deadline-days" style="display: block; margin-bottom: 5px;">Срок прохождения (в днях)</label>
                        <input type="number" id="group-deadline-days" placeholder="Например: 30" style="width: 100%;">
                    </div>
                    <div style="flex: 1;">
                        <label for="group-recurrence" style="display: block; margin-bottom: 5px;">Периодичность</label>
                        <select id="group-recurrence" style="width: 100%;">
                            <option value="">Однократно</option>
                            <option value="1">Раз в 1 месяц</option>
                            <option value="3">Раз в 3 месяца</option>
                            <option value="6">Раз в 6 месяцев</option>
                            <option value="12">Раз в 12 месяцев</option>
                        </select>
                    </div>
                </div>

                <label style="display: block; margin-bottom: 5px;"><input type="checkbox" id="group-is-visible"> <b>Видимость:</b> Группа видна пользователям в каталоге</label>
                <label style="display: block; margin-bottom: 5px;"><input type="checkbox" id="group-enforce-order"> <b>Строгий порядок:</b> Требовать последовательного прохождения курсов</label>
                <label style="display: block; margin-bottom: 15px;"><input type="checkbox" id="group-for-new-employees"> <b>Авто-назначение:</b> Назначать новым сотрудникам</label>

                <button id="save-group-btn">Сохранить/Создать группу</button>
                <button id="cancel-group-edit-btn" class="hidden" style="background-color: #6c757d;">Отмена</button>
                <hr>
            </div>

            <h3>Курсы в группе</h3>
            <p>Перетащите курсы между списками и отсортируйте их в правом списке.</p>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <h4>Доступные курсы</h4>
                    <ul id="all-courses-list" class="course-list"></ul>
                </div>
                <div style="flex: 1;">
                    <h4>Курсы в этой группе (сортируемый список)</h4>
                    <ul id="group-courses-list" class="course-list"></ul>
                </div>
            </div>
            <button id="save-courses-in-group-btn">Сохранить состав группы</button>
            <hr>
            <h3>Назначить группу подразделению</h3>
            <select id="assign-department-select" style="width: 100%;"><option value="">Выберите подразделение...</option></select>
            <button id="assign-group-btn">Назначить</button>

            <hr style="margin-top: 25px; margin-bottom: 25px;">

            <h3>Управление учениками</h3>
            <p>Здесь вы можете найти любого ученика и назначить ему курс индивидуально.</p>
            <button id="load-students-btn">Загрузить список всех учеников</button>

            <table id="students-table" class="hidden" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Email</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Имя</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Подразделение</th>
                    </tr>
                </thead>
                <tbody id="students-table-body">
                    <!-- Student rows will be inserted here -->
                </tbody>
            </table>

            <div id="student-actions-panel" class="hidden" style="margin-top: 15px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h4>Назначить курс для: <b id="selected-student-email-span"></b></h4>
                <select id="student-course-assignment-list"></select>
                <button id="assign-course-to-student-btn" style="width: auto; padding: 10px 20px; margin-top: 10px;">Назначить выбранный курс</button>
            </div>
        </div>

        <div id="results-view" class="hidden">
            <h2>Отчеты по результатам тестов</h2>
            <div id="results-filters">
                <input type="text" id="filter-user" placeholder="Email пользователя...">
                <input type="text" id="filter-department" placeholder="Подразделение...">
                <select id="filter-course"><option value="">Все курсы</option></select>
                <button id="apply-filters-btn">Применить фильтр</button>
                <button id="export-csv-btn" style="background-color: #218838;">Выгрузить в Excel (CSV)</button>
            </div>
            <table id="results-table">
                <thead>
                    <tr>
                        <th>Пользователь</th>
                        <th>Курс</th>
                        <th>Результат (%)</th>
                        <th>Время (мин)</th>
                        <th>Дата</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Сюда будут добавляться строки с результатами -->
                </tbody>
            </table>
        </div>

        <div id="simulator-results-view" class="hidden">
            <h2>Результаты диалогового тренажера</h2>
            <button id="refresh-sim-results-btn">Обновить</button>
            <table id="simulator-results-table" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Дата</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Пользователь</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Сценарий</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Персонаж</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Средний балл</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Simulator results will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

<script>
    // --- CONSTANTS ---
    const ACTIONS = {
        CREATE_COURSE: 'create_course',
        GET_COURSES_ADMIN: 'get_courses_admin',
        GET_COURSE_DETAILS: 'get_course_details',
        SAVE_COURSE_DRAFT: 'save_course_draft',
        UPLOAD_AND_PROCESS: 'upload_and_process',
        GENERATE_CONTENT: 'generate_content',
        PUBLISH_COURSE: 'publish_course',
        DELETE_COURSE: 'delete_course',
        GET_COURSE_GROUPS: 'get_course_groups',
        CREATE_COURSE_GROUP: 'create_course_group',
        UPDATE_COURSE_GROUP: 'update_course_group',
        DELETE_COURSE_GROUP: 'delete_course_group',
        GET_GROUP_DETAILS: 'get_group_details',
        UPDATE_COURSES_IN_GROUP: 'update_courses_in_group',
        ASSIGN_GROUP_TO_DEPARTMENT: 'assign_group_to_department',
        UPLOAD_COURSE_MATERIAL: 'upload_course_material',
        DELETE_COURSE_MATERIAL: 'delete_course_material',
        GET_DEPARTMENTS: 'get_departments',
        GET_LEADERBOARD_SETTINGS: 'get_leaderboard_settings',
        SAVE_LEADERBOARD_SETTINGS: 'save_leaderboard_settings',
        GET_SIMULATION_RESULTS: 'get_simulation_results',
        GET_ALL_USERS: 'get_all_users',
        ASSIGN_COURSE_TO_USER: 'assign_course_to_user',
        TEXT_TO_SPEECH: 'text_to_speech',
    };

    // --- CORE SETUP ---
    const SUPABASE_URL = 'https://wnsdlibhrlmgyszbyxat.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Induc2RsaWJocmxtZ3lzemJ5eGF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyODE0MjgsImV4cCI6MjA2OTg1NzQyOH0.Sgz-50dHj8M599sIjTRYs0kMP7b6kX2BJ-Gc-trMUQ4';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let adminToken = null;
    let allCoursesData = []; // Cache for all courses
    let allDepartments = []; // Cache for all departments
    let currentEditingCourseId = null;
    let currentEditingGroupId = null;
    let autosaveTimer = null;

    // --- DOM ELEMENTS ---
    const loginView = document.getElementById('login-view');
    const panelView = document.getElementById('panel-view');
    const statusBox = document.getElementById('status-box');
    const allViews = [
        document.getElementById('courses-view'),
        document.getElementById('groups-view'),
        document.getElementById('results-view'),
        document.getElementById('leaderboard-view'),
        document.getElementById('simulator-results-view')
    ];
    const allBtns = [
        document.getElementById('courses-tab-btn'),
        document.getElementById('groups-tab-btn'),
        document.getElementById('results-tab-btn'),
        document.getElementById('leaderboard-tab-btn'),
        document.getElementById('simulator-tab-btn')
    ];
    // Course UI elements
    const coursesTableBody = document.getElementById('courses-table').getElementsByTagName('tbody')[0];
    // Group UI elements
    const groupFormContainer = document.getElementById('group-form-container');
    const groupFormHeader = document.getElementById('group-form-header');
    const groupsTableBody = document.getElementById('groups-table').getElementsByTagName('tbody')[0];
    const cancelGroupEditBtn = document.getElementById('cancel-group-edit-btn');
    const groupNameInput = document.getElementById('group-name');
    const newEmployeesCheckbox = document.getElementById('group-for-new-employees');
    const allCoursesList = document.getElementById('all-courses-list');
    const groupCoursesList = document.getElementById('group-courses-list');

    // --- UTILITY FUNCTIONS ---
    function updateJsonFromWysiwyg(triggerAutosave = true) {
        const editor = document.getElementById('wysiwyg-editor');
        const contentTextarea = document.getElementById('content');
        if (!editor || !contentTextarea) return;

        const data = { summary: [], questions: [] };

        editor.querySelectorAll('.wysiwyg-slide').forEach(slideEl => {
            data.summary.push({
                slide_title: slideEl.querySelector('.wysiwyg-slide-title').textContent,
                html_content: slideEl.querySelector('.wysiwyg-slide-content').innerHTML,
            });
        });

        editor.querySelectorAll('.wysiwyg-question').forEach(qEl => {
            const questionData = {
                question: qEl.querySelector('.wysiwyg-question-text').textContent,
                options: [],
                correct_option_index: -1
            };
            qEl.querySelectorAll('.wysiwyg-option-item').forEach((optEl, oIndex) => {
                questionData.options.push(optEl.querySelector('.wysiwyg-option-label').textContent);
                if (optEl.querySelector('input[type="radio"]').checked) {
                    questionData.correct_option_index = oIndex;
                }
            });
            data.questions.push(questionData);
        });

        try {
            const originalData = JSON.parse(contentTextarea.value || '{}');
            if (originalData.summary) {
                data.summary.forEach((slide, index) => {
                    if (originalData.summary[index]) {
                        slide.image_search_term = originalData.summary[index].image_search_term;
                        slide.image_url = originalData.summary[index].image_url;
                    }
                });
            }
        } catch (e) { console.warn("Could not merge non-editable fields."); }

        contentTextarea.value = JSON.stringify(data, null, 2);
        if (triggerAutosave) {
            handleAutosave();
        }
    }

    function renderWysiwygEditor() {
        const editor = document.getElementById('wysiwyg-editor');
        const contentTextarea = document.getElementById('content');
        if (!editor || !contentTextarea) return;

        editor.innerHTML = '';
        const jsonString = contentTextarea.value || '{}';

        try {
            const data = JSON.parse(jsonString);
            if (!data || (!data.summary && !data.questions)) {
                 editor.innerHTML = '<p style="color: #888;">Контент пуст или имеет неверный формат. Сгенерируйте его на Шаге 2.</p>';
                 return;
            }

            const slidesHtml = (data.summary || []).map((slide, index) => `
                <div class="wysiwyg-slide" data-index="${index}">
                    <div class="wysiwyg-slide-title" contenteditable="true">${slide.slide_title || 'Новый слайд'}</div>
                    <div class="wysiwyg-slide-content" contenteditable="true">${slide.html_content || '<p>Начните вводить текст...</p>'}</div>
                    ${slide.image_url ? `<img src="${slide.image_url}" alt="Slide Image" style="max-width: 100%; height: auto; margin-top: 10px; border-radius: 4px;">` : ''}
                </div>
            `).join('');
            editor.innerHTML += slidesHtml;

            const questionsHtml = (data.questions || []).map((q, qIndex) => `
                <div class="wysiwyg-question" data-index="${qIndex}">
                    <div class="wysiwyg-question-text" contenteditable="true">${q.question || 'Текст вопроса'}</div>
                    <ul class="wysiwyg-options">
                        ${(q.options || []).map((opt, oIndex) => `
                            <li class="wysiwyg-option-item">
                                <input type="radio" name="correct_q_${qIndex}" ${oIndex === q.correct_option_index ? 'checked' : ''}>
                                <span class="wysiwyg-option-label" contenteditable="true">${escapeHTML(opt)}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `).join('');

            if(questionsHtml) {
                editor.innerHTML += `<div class="wysiwyg-questions-container"><h4>Тестовые вопросы</h4>${questionsHtml}</div>`;
            }

            ['input', 'change'].forEach(evt => editor.addEventListener(evt, () => updateJsonFromWysiwyg()));

        } catch (e) {
            console.error("Error parsing content JSON for WYSIWYG editor:", e);
            editor.innerHTML = `<p class="error">Ошибка: Не удалось разобрать JSON контент. Проверьте его валидность. <br><small>${escapeHTML(e.message)}</small></p>`;
            document.getElementById('content').style.display = 'block';
        }
    }

    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    function handleApiError(errorData) {
        document.querySelectorAll('.inline-error').forEach(el => el.textContent = '');
        if (errorData.details && typeof errorData.details === 'object') {
            for (const fieldName in errorData.details) {
                const errorElement = document.getElementById(`${fieldName}-error`);
                if (errorElement) errorElement.textContent = errorData.details[fieldName];
                else showToast(`${fieldName}: ${errorData.details[fieldName]}`, 'error');
            }
            showToast(errorData.error || 'Пожалуйста, проверьте ошибки в форме.', 'error');
        } else if (errorData.error) {
            showToast(errorData.error, 'error');
        } else {
            showToast('Произошла неизвестная ошибка.', 'error');
        }
    }

    const showStatus = showToast;

    function escapeHTML(str) {
        if (!str) return '';
        return str.replace(/'/g, '&apos;').replace(/"/g, '&quot;');
    }

    function sanitizeForPath(text) {
        const sanitized = text.replace(/[^a-zA-Z0-9-._]/g, '-');
        const collapsed = sanitized.replace(/-+/g, '-');
        return collapsed.replace(/^-+|-+$/g, '').toLowerCase();
    }

    // --- API & State Management ---
    const apiState = { activeCalls: 0, jobs: {} };

    function showGlobalLoader() {
        let loader = document.getElementById('global-loader');
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'global-loader';
            loader.style.cssText = 'position:fixed; top:10px; left:50%; transform:translateX(-50%); background-color:#005A9C; color:white; padding:10px 20px; border-radius:8px; z-index:2000; font-weight:bold;';
            loader.textContent = 'Загрузка...';
            document.body.appendChild(loader);
        }
        loader.classList.remove('hidden');
    }

    function hideGlobalLoader() {
        const loader = document.getElementById('global-loader');
        if (loader) loader.classList.add('hidden');
    }

    function updateApiState(change) {
        const wasActive = apiState.activeCalls > 0;
        apiState.activeCalls += change;
        const isActive = apiState.activeCalls > 0;
        if (!wasActive && isActive) showGlobalLoader();
        else if (wasActive && !isActive) hideGlobalLoader();
    }

    async function apiCall(action, payload = {}) {
        if (!adminToken) {
            showToast('Ошибка: вы не авторизованы.', 'error');
            throw new Error('Not authorized');
        }
        updateApiState(1);
        try {
            const response = await fetch('/api/admin', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, ...payload })
            });
            if (response.status === 202) {
                const data = await response.json();
                startJobPolling(data.jobId);
                showToast(`Задача запущена (ID: ${data.jobId}).`, 'info');
                return data;
            }
            if (!response.ok) {
                if (response.status === 403) {
                    showToast('Доступ запрещен. У вас нет прав.', 'error');
                    throw new Error('Forbidden');
                }
                let errorData;
                try { errorData = await response.json(); } catch (e) { errorData = { error: `Ошибка ${response.status}` }; }
                console.error('API Error Response:', errorData);
                showToast(errorData.error || `Ошибка ${response.status}.`, 'error');
                throw new Error(errorData.error || `API Call Failed`);
            }
            return await response.json();
        } catch (error) {
            console.error('API Call failed:', error);
            if (!error.message.includes('API Call Failed')) {
                 showToast('Сетевая ошибка или сервер недоступен.', 'error');
            }
            throw error;
        } finally {
            updateApiState(-1);
        }
    }

    function startJobPolling(jobId) {
        if (!jobId) return;
        apiState.jobs[jobId] = { status: 'pending' };
        const intervalId = setInterval(async () => {
            try {
                if (!adminToken) return clearInterval(intervalId);
                const response = await fetch('/api/get-job-status', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jobId })
                });
                if (!response.ok) {
                    showToast(`Не удалось отследить статус задачи ${jobId}.`, 'error');
                    return clearInterval(intervalId);
                }
                const job = await response.json();
                apiState.jobs[jobId].status = job.status;
                if (job.status === 'completed' || job.status === 'failed') {
                    showToast(`Задача (ID: ${jobId}) ${job.status === 'completed' ? 'успешно завершена' : 'не удалась'}: ${job.last_error || ''}`, job.status === 'completed' ? 'success' : 'error');
                    clearInterval(intervalId);
                    if (window.loadCourses) loadCourses();
                }
            } catch (error) {
                showToast(`Ошибка при проверке статуса задачи ${jobId}.`, 'error');
                clearInterval(intervalId);
            }
        }, 5000);
        apiState.jobs[jobId].intervalId = intervalId;
    }

    // --- TAB SWITCHING ---
    function switchTab(activeTab, activeBtn) {
        allViews.forEach(view => view.classList.add('hidden'));
        allBtns.forEach(btn => btn.classList.remove('active'));
        activeTab.classList.remove('hidden');
        activeBtn.classList.add('active');
    }

    allBtns.forEach((btn, index) => {
        btn.addEventListener('click', async () => {
            switchTab(allViews[index], btn);
            if (allViews[index].id === 'courses-view') loadCourses();
            if (allViews[index].id === 'groups-view') {
                loadGroups();
                loadAllCoursesForGrouping();
                await loadDepartments();
                populateDepartmentDropdown();
            }
            if (allViews[index].id === 'results-view') loadResults();
            if (allViews[index].id === 'leaderboard-view') loadLeaderboardSettings();
            if (allViews[index].id === 'simulator-results-view') loadSimulatorResults();
        });
    });

    // --- AUTHENTICATION & SESSION ---
    async function onLoginSuccess(session) {
        try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) throw new Error('Не удалось получить данные пользователя.');
            const { data: adminCheck, error } = await supabaseClient.from('users').select('is_admin').eq('id', user.id).single();
            if (error) throw error;
            if (!adminCheck || !adminCheck.is_admin) throw new Error('У вас нет прав администратора.');
            adminToken = session.access_token;
            loginView.classList.add('hidden');
            panelView.classList.remove('hidden');
            await loadCourses();
        } catch (error) {
            showStatus(`Ошибка проверки прав: ${error.message}`, 'error');
            await supabaseClient.auth.signOut();
            loginView.classList.remove('hidden');
            panelView.classList.add('hidden');
        }
    }

    async function handleLogin() {
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        loginBtn.disabled = true; loginBtn.textContent = 'Вход...';
        document.getElementById('login-error').classList.add('hidden');
        try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) throw error;
            await onLoginSuccess(data.session);
        } catch (error) {
            document.getElementById('login-error').textContent = `Ошибка входа: ${error.message}`;
            document.getElementById('login-error').classList.remove('hidden');
        } finally {
            loginBtn.disabled = false; loginBtn.textContent = 'Войти';
        }
    }

    async function handleLogout() {
        await supabaseClient.auth.signOut();
        adminToken = null;
        loginView.classList.remove('hidden');
        panelView.classList.add('hidden');
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) await onLoginSuccess(session);
        else {
            loginView.classList.remove('hidden');
            panelView.classList.add('hidden');
        }
        document.getElementById('login-btn').addEventListener('click', handleLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        initDragAndDrop();
    });

    // --- DYNAMIC FORM RENDERING ---
    function renderCourseForm(course = null) {
        const isEditing = course !== null;
        const courseId = isEditing ? course.id : '';
        const title = isEditing ? course.title || '' : '';
        const description = isEditing ? course.description || '' : '';
        const isVisible = isEditing ? course.is_visible : false;
        const headerText = isEditing ? `Редактирование: ${title}` : 'Создать новый курс';

        let content = isEditing ? course.draft_content || course.content : null;
        // The content can be an object or a string from the DB. Let's ensure it's a string for the textarea.
        if (typeof content === 'object' && content !== null) {
            content = JSON.stringify(content, null, 2);
        } else if (content === null) {
            content = '';
        }

        let materialsHtml = 'Материалы не загружены.';
        if (isEditing && course.course_materials && course.course_materials.length > 0) {
            materialsHtml = course.course_materials.map(mat =>
                `<div>${escapeHTML(mat.file_name)} <button class="delete-material-btn" data-id="${mat.id}" data-path="${mat.storage_path}">Удалить</button></div>`
            ).join('');
        }

        return `
            <div id="course-form-container">
                <h2>${headerText}</h2>
                <input type="hidden" id="course-id" value="${escapeHTML(courseId)}">
                <input type="text" id="course-title" placeholder="Название курса" value="${escapeHTML(title)}">
                <h3>Шаг 1: Загрузите файл для описания</h3>
                <input type="file" id="file-uploader" accept=".pdf,.docx">
                <button id="process-file-btn">Загрузить и извлечь текст</button>
                <h3>Описание (Источник для AI)</h3>
                <div id="audio-player-container" class="hidden" style="margin-top: 10px;"></div>
                <button id="text-to-speech-btn">Озвучить описание</button>
                <textarea id="description" placeholder="Здесь появится текст...">${escapeHTML(description)}</textarea>
                <h3>Шаг 2: Сгенерируйте контент</h3>
                <textarea id="custom-prompt" placeholder="Оставьте пустым для стандартного промпта..."></textarea>
                <button id="generate-btn">Сгенерировать черновик</button>
                <h3>Шаг 3: Проверьте и отредактируйте контент</h3>
                <div id="wysiwyg-editor"></div>
                <textarea id="content" style="display: none;">${content}</textarea>
                <h3>Шаг 4: Сохранение и публикация</h3>
                <p>При нажатии на "Опубликовать", курс станет видимым для пользователей, если установлен флажок ниже.</p>
                <label style="display: block; margin: 15px 0; background-color: #e9f7fe; padding: 10px; border-radius: 8px;">
                    <input type="checkbox" id="course-is-visible" style="width: auto; margin-right: 10px; vertical-align: middle;" ${isVisible ? 'checked' : ''}>
                    <b style="vertical-align: middle;">Видимость в каталоге:</b> Курс доступен для самостоятельного выбора пользователями.
                </label>
                <p id="autosave-status" style="font-style: italic; color: #666;"></p>
                <button id="publish-btn" style="background-color: #28a745;">ОПУБЛИКОВАТЬ</button>
                <button id="cancel-edit-btn" style="background-color: #6c757d;">Отмена</button>
                <hr>
                <h3>Сопутствующие материалы</h3>
                <div id="materials-list">${materialsHtml}</div>
                <input type="file" id="material-uploader">
                <button id="upload-material-btn">Загрузить материал</button>
            </div>
        `;
    }

    function attachCourseFormListeners() {
        document.getElementById('cancel-edit-btn').addEventListener('click', clearCourseForm);
        document.getElementById('process-file-btn').addEventListener('click', processFileHandler);
        document.getElementById('generate-btn').addEventListener('click', generateContentHandler);
        document.getElementById('text-to-speech-btn').addEventListener('click', textToSpeechHandler);
        document.getElementById('publish-btn').addEventListener('click', publishCourseHandler);
        document.getElementById('upload-material-btn').addEventListener('click', uploadMaterialHandler);
        document.getElementById('materials-list').addEventListener('click', deleteMaterialHandler);
        // The autosave listener is now only attached to the WYSIWYG editor in renderWysiwygEditor
        // to prevent saving on title/description changes, which was causing data structure issues.
    }

    // --- COURSE MANAGEMENT ---
    function clearCourseForm() {
        if (autosaveTimer) clearTimeout(autosaveTimer);
        document.getElementById('course-form-wrapper').innerHTML = '';
        currentEditingCourseId = null;
    }

    function handleAutosave() {
        if (autosaveTimer) clearTimeout(autosaveTimer);
        const statusEl = document.getElementById('autosave-status');
        if (statusEl) statusEl.textContent = 'Изменения не сохранены...';
        autosaveTimer = setTimeout(async () => {
            const courseId = document.getElementById('course-id').value;
            if (!courseId) return;
            // Autosave should only save the content part (summary and questions)
            // Title and description changes are saved on "Publish"
            const draftData = JSON.parse(document.getElementById('content').value || '{}');
            try {
                await apiCall(ACTIONS.SAVE_COURSE_DRAFT, { course_id: courseId, draft_data: draftData });
                if (statusEl) statusEl.textContent = `Черновик контента сохранен в ${new Date().toLocaleTimeString()}`;
            } catch (e) {
                if (statusEl) statusEl.textContent = 'Ошибка сохранения черновика.';
            }
        }, 1000); // Autosave 1 second after last input
    }

    async function processFileHandler() {
        const file = document.getElementById('file-uploader').files[0];
        const title = document.getElementById('course-title').value.trim();
        if (!file || !title) return showStatus('Укажите название и выберите файл.', 'error');
        let courseId = document.getElementById('course-id').value.trim();
        try {
            if (!courseId) {
                const newCourse = await apiCall(ACTIONS.CREATE_COURSE, { title });
                courseId = newCourse.id;
                document.getElementById('course-id').value = courseId;
                showToast(`Создан новый курс. ID: ${courseId}`, 'success');
                currentEditingCourseId = courseId;
            }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64File = reader.result.split(',')[1];
                await apiCall(ACTIONS.UPLOAD_AND_PROCESS, { course_id: courseId, file_name: sanitizeForPath(file.name), file_data: base64File });
                document.getElementById('description').value = 'Файл обрабатывается...';
                await loadCourses();
            };
        } catch(e) { /* Handled */ }
    }

    async function generateContentHandler() {
        const courseId = document.getElementById('course-id').value;
        if (!courseId) return showToast('Сначала создайте курс.', 'error');
        document.getElementById('content').value = 'Генерация...';
        try {
            await apiCall(ACTIONS.GENERATE_CONTENT, { course_id: courseId, custom_prompt: document.getElementById('custom-prompt').value });
        } catch(e) { /* Handled */ }
    }

    async function textToSpeechHandler() {
        const description = document.getElementById('description').value;
        if (!description) return showStatus('Нет текста.', 'error');
        const audioContainer = document.getElementById('audio-player-container');
        audioContainer.innerHTML = '';
        try {
            const data = await apiCall(ACTIONS.TEXT_TO_SPEECH, { text: description });
            const audio = new Audio(data.audioUrl);
            audio.controls = true;
            audioContainer.appendChild(audio);
            audioContainer.classList.remove('hidden');
        } catch (error) { /* Handled */ }
    }

    async function publishCourseHandler() {
        const courseId = document.getElementById('course-id').value;
        if (!courseId) {
            showToast('Сначала необходимо создать или загрузить курс.', 'error');
            return;
        }
        if (autosaveTimer) clearTimeout(autosaveTimer);

        // 1. Синхронизировать WYSIWYG с textarea
        updateJsonFromWysiwyg(false); // false - не запускать автосохранение

        // 2. Собрать все данные из формы
        const title = document.getElementById('course-title').value;
        const description = document.getElementById('description').value;
        const contentString = document.getElementById('content').value;
        const isVisible = document.getElementById('course-is-visible').checked;

        if (!title || !contentString) {
            showToast('Название курса и контент не могут быть пустыми.', 'error');
            return;
        }

        let content;
        try {
            content = JSON.parse(contentString);
        } catch (e) {
            showToast('Ошибка в формате JSON контента. Публикация невозможна.', 'error');
            return;
        }

        const payload = {
            course_id: courseId,
            title,
            description,
            content,
            is_visible: isVisible
        };

        try {
            // 3. Отправить полный payload на сервер
            await apiCall(ACTIONS.PUBLISH_COURSE, payload);
            showToast('Курс успешно опубликован!', 'success');
            await loadCourses();
            clearCourseForm();
        } catch (e) {
            // Ошибки уже обрабатываются в apiCall
        }
    }

    async function uploadMaterialHandler() {
        const file = document.getElementById('material-uploader').files[0];
        if (!currentEditingCourseId || !file) return showStatus('Выберите курс и файл.', 'error');
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            try {
                await apiCall(ACTIONS.UPLOAD_COURSE_MATERIAL, { course_id: currentEditingCourseId, file_name: file.name, file_data: reader.result.split(',')[1] });
                loadCourseForEditing(currentEditingCourseId);
            } catch(e) { /* Handled */ }
        };
    }

    async function deleteMaterialHandler(e) {
        if (e.target.classList.contains('delete-material-btn')) {
            const materialId = e.target.dataset.id;
            const storagePath = e.target.dataset.path;
            if (confirm(`Удалить материал "${storagePath}"?`)) {
                try {
                    await apiCall(ACTIONS.DELETE_COURSE_MATERIAL, { material_id: materialId, storage_path: storagePath });
                    loadCourseForEditing(currentEditingCourseId);
                } catch(e) { /* Handled */ }
            }
        }
    }

    document.getElementById('show-create-form-btn').addEventListener('click', () => {
        const wrapper = document.getElementById('course-form-wrapper');
        wrapper.innerHTML = renderCourseForm();
        attachCourseFormListeners();
        renderWysiwygEditor();
    });

    function renderCoursesTable(courses) {
        if (!courses || courses.length === 0) return '<tr><td colspan="4" style="text-align:center;">Курсы не найдены.</td></tr>';
        return courses.sort((a, b) => a.title.localeCompare(b.title)).map(course => `
            <tr>
                <td>${escapeHTML(course.title)}</td>
                <td>${escapeHTML(course.id)}</td>
                <td class="status-${course.status || 'draft'}">${course.status === 'published' ? 'Опубликован' : 'Черновик'} ${course.is_visible ? ' (Виден)' : ''}</td>
                <td class="actions-cell">
                    <button onclick="loadCourseForEditing('${escapeHTML(course.id)}')">Редактировать</button>
                    <button style="background-color: #dc3545;" onclick="deleteCourse('${escapeHTML(course.id)}', '${escapeHTML(course.title)}')">Удалить</button>
                </td>
            </tr>
        `).join('');
    }

    async function loadCourses() {
        coursesTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Загрузка...</td></tr>';
        try {
            const courses = await apiCall(ACTIONS.GET_COURSES_ADMIN);
            allCoursesData = courses;
            coursesTableBody.innerHTML = renderCoursesTable(courses);
            const filterCourseSelector = document.getElementById('filter-course');
            filterCourseSelector.innerHTML = '<option value="">Все курсы</option>';
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = `${course.title}`;
                filterCourseSelector.appendChild(option);
            });
        } catch (e) { /* Handled */ }
    }

    async function loadCourseForEditing(courseId) {
        try {
            let course = await apiCall(ACTIONS.GET_COURSE_DETAILS, { course_id: courseId });
            currentEditingCourseId = courseId;

            // If a published course has content but no draft, create a draft from the published content.
            // This prevents the editor from opening empty and accidentally wiping content.
            if (course.status === 'published' && course.content && !course.draft_content) {
                showToast('Создается черновик из опубликованной версии...', 'info');
                // The draft should only contain the content object itself to be consistent.
                const draftData = course.content;
                await apiCall(ACTIONS.SAVE_COURSE_DRAFT, { course_id: courseId, draft_data: draftData });
                // Re-fetch the course to get the newly created draft
                course = await apiCall(ACTIONS.GET_COURSE_DETAILS, { course_id: courseId });
            }

            const wrapper = document.getElementById('course-form-wrapper');
            wrapper.innerHTML = renderCourseForm(course);
            attachCourseFormListeners();
            // Вызываем редактор WYSIWYG сразу после отрисовки формы, чтобы он корректно инициализировался с данными.
            renderWysiwygEditor();
            window.scrollTo(0, wrapper.offsetTop);
        } catch (e) { /* Handled in apiCall */ }
    }

    async function deleteCourse(courseId, courseTitle) {
        if (!confirm(`Удалить курс "${courseTitle}"? Это действие необратимо.`)) return;
        try {
            await apiCall(ACTIONS.DELETE_COURSE, { course_id: courseId });
            showStatus('Курс удален.', 'success');
            clearCourseForm();
            await loadCourses();
        } catch (e) { /* Handled */ }
    }

    // --- GROUP MANAGEMENT ---
    function clearGroupForm() {
        groupFormContainer.classList.add('hidden');
        groupFormHeader.textContent = 'Создать новую группу';
        groupNameInput.value = '';
        newEmployeesCheckbox.checked = false;
        document.getElementById('group-is-visible').checked = false;
        document.getElementById('group-enforce-order').checked = false;
        document.getElementById('group-deadline-days').value = '';
        document.getElementById('group-recurrence').value = '';
        groupCoursesList.innerHTML = '';
        allCoursesList.innerHTML = '';
        cancelGroupEditBtn.classList.add('hidden');
        currentEditingGroupId = null;
    }

    document.getElementById('show-create-group-form-btn').addEventListener('click', () => {
        clearGroupForm();
        groupFormContainer.classList.remove('hidden');
        populateAllCoursesList([]);
        groupNameInput.focus();
    });

    cancelGroupEditBtn.addEventListener('click', clearGroupForm);

    function renderGroupsTable(groups) {
        if (!groups || groups.length === 0) return '<tr><td colspan="5" style="text-align:center;">Группы не созданы.</td></tr>';
        return groups.sort((a, b) => a.group_name.localeCompare(b.group_name)).map(g => `
            <tr>
                <td>${escapeHTML(g.group_name)}</td>
                <td>${g.is_for_new_employees ? 'Да' : 'Нет'}</td>
                <td>${g.is_visible ? 'Да' : 'Нет'}</td>
                <td>${g.enforce_order ? 'Да' : 'Нет'}</td>
                <td class="actions-cell">
                    <button onclick="loadGroupForEditing('${g.id}')">Редактировать</button>
                    <button style="background-color: #dc3545;" onclick="deleteGroup('${g.id}', '${escapeHTML(g.group_name)}')">Удалить</button>
                </td>
            </tr>
        `).join('');
    }

    async function loadGroups() {
        groupsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Загрузка...</td></tr>';
        try {
            const groups = await apiCall(ACTIONS.GET_COURSE_GROUPS);
            groupsTableBody.innerHTML = renderGroupsTable(groups);
        } catch (e) { /* Handled */ }
    }

    async function loadDepartments() {
        try {
            if (allDepartments.length > 0) return;
            allDepartments = await apiCall(ACTIONS.GET_DEPARTMENTS);
        } catch (e) { /* Handled */ }
    }

    function populateDepartmentDropdown() {
        const select = document.getElementById('assign-department-select');
        if (!select) return;
        while (select.options.length > 1) select.remove(1);
        allDepartments.forEach(dep => {
            const option = document.createElement('option');
            option.value = dep;
            option.textContent = dep;
            select.appendChild(option);
        });
    }

    async function loadGroupForEditing(groupId) {
        try {
            const group = await apiCall(ACTIONS.GET_GROUP_DETAILS, { group_id: groupId });
            clearGroupForm();
            groupFormContainer.classList.remove('hidden');
            groupFormHeader.textContent = `Редактирование: ${group.group_name}`;
            cancelGroupEditBtn.classList.remove('hidden');
            currentEditingGroupId = groupId;
            groupNameInput.value = group.group_name;
            newEmployeesCheckbox.checked = group.is_for_new_employees;
            document.getElementById('group-is-visible').checked = group.is_visible;
            document.getElementById('group-enforce-order').checked = group.enforce_order;
            document.getElementById('group-deadline-days').value = group.deadline_days || '';
            document.getElementById('group-recurrence').value = group.recurrence_period || '';
            const courseIdsInGroup = group.course_group_items.map(item => item.course_id);
            const groupCourses = allCoursesData.filter(c => courseIdsInGroup.includes(c.id));
            const sortedGroupCourses = group.course_group_items.map(item => allCoursesData.find(c => c.id === item.course_id)).filter(Boolean);
            populateGroupCoursesList(sortedGroupCourses);
            populateAllCoursesList(courseIdsInGroup);
            window.scrollTo(0, groupFormContainer.offsetTop);
        } catch (e) { /* Handled */ }
    }

    async function deleteGroup(groupId, groupName) {
        if (confirm(`Удалить группу "${groupName}"?`)) {
            try {
                await apiCall(ACTIONS.DELETE_COURSE_GROUP, { group_id: groupId });
                showStatus('Группа удалена.', 'success');
                clearGroupForm();
                await loadGroups();
            } catch (e) { /* Handled */ }
        }
    }

    document.getElementById('save-group-btn').addEventListener('click', async () => {
        const groupName = groupNameInput.value.trim();
        if (!groupName) return showStatus('Название не может быть пустым.', 'error');
        const payload = {
            group_name: groupName,
            is_for_new_employees: newEmployeesCheckbox.checked,
            is_visible: document.getElementById('group-is-visible').checked,
            enforce_order: document.getElementById('group-enforce-order').checked,
            deadline_days: document.getElementById('group-deadline-days').value || null,
            recurrence_period: document.getElementById('group-recurrence').value || null
        };
        try {
            if (currentEditingGroupId) {
                await apiCall(ACTIONS.UPDATE_COURSE_GROUP, { ...payload, group_id: currentEditingGroupId });
            } else {
                const newGroup = await apiCall(ACTIONS.CREATE_COURSE_GROUP, payload);
                currentEditingGroupId = newGroup.id;
            }
            showStatus('Группа сохранена.', 'success');
            await loadGroups();
        } catch (e) { /* Handled */ }
    });

    async function loadAllCoursesForGrouping() {
        if (allCoursesData.length === 0) {
             try { await apiCall(ACTIONS.GET_COURSES_ADMIN); } catch(e) { /* Handled */ }
        }
    }

    function createCourseListItem(course) {
        const li = document.createElement('li');
        li.dataset.id = course.id;
        li.textContent = course.title;
        li.draggable = true;
        return li;
    }

    function populateAllCoursesList(usedCourseIds) {
        allCoursesList.innerHTML = '';
        allCoursesData.filter(c => !usedCourseIds.includes(c.id)).forEach(course => {
            allCoursesList.appendChild(createCourseListItem(course));
        });
    }

    function populateGroupCoursesList(courses) {
        groupCoursesList.innerHTML = '';
        courses.forEach(course => {
            groupCoursesList.appendChild(createCourseListItem(course));
        });
    }

    function initDragAndDrop() {
        let draggedItem = null;
        const lists = document.querySelectorAll('.course-list');

        lists.forEach(list => {
            list.addEventListener('dragstart', e => {
                draggedItem = e.target;
                setTimeout(() => e.target.classList.add('dragging'), 0);
            });

            list.addEventListener('dragend', e => {
                e.target.classList.remove('dragging');
            });

            list.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(list, e.clientY);
                if (afterElement == null) {
                    list.appendChild(draggedItem);
                } else {
                    list.insertBefore(draggedItem, afterElement);
                }
            });
        });
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('li:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    document.getElementById('save-courses-in-group-btn').addEventListener('click', async () => {
        if (!currentEditingGroupId) return showStatus('Сначала выберите группу.', 'error');
        const courseIds = Array.from(groupCoursesList.getElementsByTagName('li')).map(li => li.dataset.id);
        try {
            await apiCall(ACTIONS.UPDATE_COURSES_IN_GROUP, { group_id: currentEditingGroupId, course_ids: courseIds });
            showStatus('Состав группы сохранен.', 'success');
        } catch (e) { /* Handled */ }
    });

    document.getElementById('assign-group-btn').addEventListener('click', async () => {
        const department = document.getElementById('assign-department-select').value;
        if (!currentEditingGroupId || !department) return showStatus('Выберите группу и подразделение.', 'error');
        try {
            await apiCall(ACTIONS.ASSIGN_GROUP_TO_DEPARTMENT, { group_id: currentEditingGroupId, department: department });
            showStatus(`Группа назначена подразделению "${department}".`, 'success');
            document.getElementById('assign-department-select').value = '';
        } catch (e) { /* Handled */ }
    });

    // --- STUDENT MANAGEMENT (within Groups tab) ---
    let selectedStudentEmail = null;

    document.getElementById('load-students-btn').addEventListener('click', async () => {
        try {
            showStatus('Загрузка списка учеников...', 'info');
            const students = await apiCall(ACTIONS.GET_ALL_USERS);
            const studentsTable = document.getElementById('students-table');
            const studentsTbody = document.getElementById('students-table-body');
            studentsTbody.innerHTML = '';
            students.forEach(student => {
                const row = studentsTbody.insertRow();
                row.dataset.email = student.email;
                row.insertCell(0).textContent = student.email;
                row.insertCell(1).textContent = student.full_name;
                row.insertCell(2).textContent = student.department;
            });
            studentsTable.classList.remove('hidden');
            showStatus(`Загружено ${students.length} учеников.`, 'success');
        } catch(e) { /* Handled in apiCall */ }
    });

    document.getElementById('students-table-body').addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (!row) return;

        // Toggle selection and update UI
        document.querySelectorAll('#students-table-body tr').forEach(r => r.style.backgroundColor = '');
        row.style.backgroundColor = '#e9f7fe';

        selectedStudentEmail = row.dataset.email;
        const actionsPanel = document.getElementById('student-actions-panel');
        document.getElementById('selected-student-email-span').textContent = selectedStudentEmail;

        const courseList = document.getElementById('student-course-assignment-list');
        courseList.innerHTML = '';
        allCoursesData.forEach(course => {
            const option = document.createElement('option');
            option.value = course.course_id;
            option.textContent = `${course.title} (${course.course_id})`;
            courseList.appendChild(option);
        });

        actionsPanel.classList.remove('hidden');
    });

    document.getElementById('assign-course-to-student-btn').addEventListener('click', async () => {
        const courseId = document.getElementById('student-course-assignment-list').value;
        if (!selectedStudentEmail || !courseId) {
            return showStatus('Выберите ученика и курс для назначения.', 'error');
        }
        try {
            await apiCall(ACTIONS.ASSIGN_COURSE_TO_USER, { user_email: selectedStudentEmail, course_id: courseId });
            showStatus(`Курс "${courseId}" успешно назначен ${selectedStudentEmail}.`, 'success');
        } catch(e) { /* Handled in apiCall */ }
    });


    // --- LEADERBOARD & OTHER ---
    async function loadLeaderboardSettings() {
        try {
            const settings = await apiCall(ACTIONS.GET_LEADERBOARD_SETTINGS);
            const metrics = settings.metrics || { courses_completed: true, time_spent: false, avg_score: false };
            document.querySelectorAll('#leaderboard-settings-form input[type="checkbox"]').forEach(c => { c.checked = metrics[c.value] || false; });
            showStatus('Настройки загружены.', 'success');
        } catch (e) { /* Handled in apiCall */ }
    }

    document.getElementById('save-leaderboard-settings-btn').addEventListener('click', async () => {
        const metrics = {};
        document.querySelectorAll('#leaderboard-settings-form input[type="checkbox"]').forEach(c => { metrics[c.value] = c.checked; });
        try {
            await apiCall(ACTIONS.SAVE_LEADERBOARD_SETTINGS, { metrics });
            showStatus('Настройки успешно сохранены.', 'success');
        } catch (e) { /* Handled in apiCall */ }
    });

    // --- RESULTS ---
    async function loadResults() {
        const tableBody = document.getElementById('results-table').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Загрузка отчета...</td></tr>';
        const userEmail = document.getElementById('filter-user').value;
        const department = document.getElementById('filter-department').value;
        const courseId = document.getElementById('filter-course').value;
        const payload = { user_email: userEmail, department, course_id: courseId };
        try {
            if (!adminToken) throw new Error('Не авторизован');
            const response = await fetch('/api/getDetailedReport', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Ошибка при загрузке отчета.');
            }
            const results = await response.json();
            tableBody.innerHTML = '';
            if (results.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Результаты не найдены.</td></tr>';
                return;
            }
            results.forEach(result => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = result.user_profiles?.full_name || result.user_email;
                row.insertCell(1).textContent = result.courses.title;
                row.insertCell(2).textContent = result.percentage;
                const timeSpentMinutes = result.time_spent_seconds ? Math.round(result.time_spent_seconds / 60) : 0;
                row.insertCell(3).textContent = timeSpentMinutes;
                row.insertCell(4).textContent = result.completed_at ? new Date(result.completed_at).toLocaleString() : 'В процессе';
            });
        } catch (error) {
            showStatus('Ошибка при загрузке результатов.', 'error');
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: red;">${error.message}</td></tr>`;
        }
    }

    document.getElementById('apply-filters-btn').addEventListener('click', loadResults);

    // --- SIMULATOR RESULTS ---
    async function loadSimulatorResults() {
        const tableBody = document.getElementById('simulator-results-table').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Загрузка результатов...</td></tr>';
        showStatus('Загрузка результатов тренажера...', 'info');
        try {
            const results = await apiCall(ACTIONS.GET_SIMULATION_RESULTS);
            tableBody.innerHTML = '';
            if (results.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Результаты тренажера отсутствуют.</td></tr>';
                return;
            }
            results.forEach(res => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = new Date(res.created_at).toLocaleString();
                row.insertCell(1).textContent = res.full_name || res.user_email;
                const scenarioCell = row.insertCell(2);
                scenarioCell.textContent = res.scenario ? (res.scenario.substring(0, 100) + '...') : 'N/A';
                scenarioCell.title = res.scenario;
                row.insertCell(3).textContent = res.persona;
                const scoreCell = row.insertCell(4);
                scoreCell.style.textAlign = 'center';
                scoreCell.style.fontWeight = 'bold';
                scoreCell.textContent = res.evaluation?.average_score ? res.evaluation.average_score.toFixed(1) : 'N/A';
            });
            showStatus('Результаты тренажера загружены.', 'success');
        } catch (e) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: red;">${e.message}</td></tr>`;
        }
    }

    document.getElementById('refresh-sim-results-btn').addEventListener('click', loadSimulatorResults);


    document.getElementById('export-csv-btn').addEventListener('click', async () => {
        const userEmail = document.getElementById('filter-user').value;
        const department = document.getElementById('filter-department').value;
        const courseId = document.getElementById('filter-course').value;
        const payload = { format: 'csv', user_email: userEmail, department, course_id: courseId };
        showStatus('Выгрузка отчета...', 'info');
        try {
            // This endpoint requires auth, but for a simple GET request for file download,
            // we can construct the URL and trigger a download without a complex fetch.
            // However, to pass the auth header, we must use fetch.
            const response = await fetch('/api/getDetailedReport', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error((await response.json()).error || 'Не удалось получить данные.');
            const csvData = await response.text();
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', `report-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            showStatus('Отчет успешно выгружен.', 'success');
        } catch (error) {
            showStatus(`Ошибка при выгрузке: ${error.message}`, 'error');
        }
    });
</script>
</body>
</html>
