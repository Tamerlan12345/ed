<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Админ-панель</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 20px; max-width: 900px; margin: auto; background-color: #f4f7f6; }
        h1, h2, h3 { color: #005A9C; }
        .hidden { display: none; }
        input, textarea, button, select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e0e0e0; font-size: 16px; }
        button { background-color: #005A9C; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background-color: #00AEEF; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        textarea { height: 150px; resize: vertical; }
        .status { padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; }
        .error { color: #dc3545; background-color: #fdeeee; }
        .success { color: #28a745; background-color: #eaf7ec; }
        .info { color: #005A9C; background-color: #e9f7fe; }
        .tabs button { width: auto; padding: 10px 20px; margin-right: 10px; background-color: #e0e0e0; color: #333; }
        .tabs button.active { background-color: #005A9C; color: white; }
        #results-view { margin-top: 20px; }
        #results-filters { display: flex; gap: 10px; margin-bottom: 10px; }
        #results-table { width: 100%; border-collapse: collapse; }
        #results-table th, #results-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #results-table th { background-color: #f2f2f2; }
        #delete-course-btn { background-color: #dc3545; }
        #delete-course-btn:hover { background-color: #c82333; }
        #courses-table, #groups-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #courses-table th, #courses-table td, #groups-table th, #groups-table td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: middle; }
        #courses-table th, #groups-table th { background-color: #f2f2f2; font-weight: bold; }
        .actions-cell button { width: auto; padding: 6px 12px; font-size: 14px; margin-right: 5px; }
        .status-published { color: #28a745; font-weight: bold; }
        .status-processed { color: #ffc107; }
    </style>
</head>
<body>
    <div id="login-view">
        <h1>Вход для администратора</h1>
        <input type="email" id="admin-email" value="admin@cic.kz">
        <input type="password" id="admin-password" placeholder="Пароль">
        <button id="login-btn">Войти</button>
    </div>

    <div id="panel-view" class="hidden">
        <h1>Панель управления</h1>
        <div class="tabs">
            <button id="courses-tab-btn" class="active">Управление курсами</button>
            <button id="groups-tab-btn">Управление группами</button>
            <button id="results-tab-btn">Отчеты и Результаты</button>
            <button id="leaderboard-tab-btn">Лидерборд</button>
            <button id="simulator-tab-btn">Результаты Тренажера</button>
        </div>
        <hr>

        <div id="leaderboard-view" class="hidden">
            <h2>Настройки Лидерборда "Топ учеников недели"</h2>
            <p>Выберите метрики, по которым будет строиться рейтинг. Пользователи будут отсортированы по первой выбранной метрике.</p>
            <div id="leaderboard-settings-form">
                <label><input type="checkbox" name="metric" value="courses_completed"> Количество пройденных курсов</label><br>
                <label><input type="checkbox" name="metric" value="time_spent"> Общее время обучения (в минутах)</label><br>
                <label><input type="checkbox" name="metric" value="avg_score"> Средний балл по тестам</label><br>
                <br>
                <button id="save-leaderboard-settings-btn">Сохранить настройки</button>
            </div>
        </div>

        <div id="courses-view">
            <h2>Панель управления курсами</h2>
            <div id="status-box" class="status hidden"></div>

            <h3>Существующие курсы</h3>
            <button id="show-create-form-btn">Создать новый курс</button>
            <table id="courses-table">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>ID Курса</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Course rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <hr>

            <div id="course-form-container" class="hidden">
                <h2 id="course-form-header">Создать новый курс</h2>
                <input type="text" id="course-id" placeholder="ID курса (например, kasko-2025)">
                <input type="text" id="course-title" placeholder="Название курса">

                <h3>Шаг 1: Загрузите файл и извлеките текст</h3>
                <input type="file" id="file-uploader" accept=".pdf,.docx">
                <button id="process-file-btn">Загрузить и обработать файл</button>

                <h3>Извлеченный текст (Источник для AI)</h3>
                <div id="audio-player-container" class="hidden" style="margin-top: 10px;"></div>
                <button id="text-to-speech-btn">Озвучить текст</button>
                <textarea id="source-text" placeholder="После обработки файла здесь появится извлеченный текст..."></textarea>

                <h3>Шаг 2: Сгенерируйте контент</h3>
                <textarea id="custom-prompt" placeholder="Напишите свой промпт или оставьте пустым для стандартного..."></textarea>
                <button id="generate-btn">Сгенерировать черновик по тексту</button>

                <h3>Шаг 3: Проверьте и отредактируйте</h3>
                <textarea id="generated-html" placeholder="Здесь появится сгенерированный HTML..."></textarea>
                <textarea id="generated-questions" placeholder="Здесь появятся сгенерированные вопросы в формате JSON..."></textarea>

                <h3>Шаг 4: Сохранение и публикация</h3>
                <button id="publish-btn" style="background-color: #28a745;">ОПУБЛИКОВАТЬ</button>
                <button id="cancel-edit-btn" class="hidden" style="background-color: #6c757d;">Отмена</button>

                <hr>
                <h3>Сопутствующие материалы</h3>
                <div id="materials-list"></div>
                <input type="file" id="material-uploader">
                <button id="upload-material-btn">Загрузить материал</button>
            </div>
        </div>

        <div id="groups-view" class="hidden">
            <h2>Управление группами курсов (Блоками)</h2>

            <h3>Существующие группы</h3>
            <button id="show-create-group-form-btn">Создать новую группу</button>
            <table id="groups-table">
                <thead>
                    <tr>
                        <th>Название группы</th>
                        <th>Назначать новым</th>
                        <th>Периодичность</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Group rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <hr>

            <div id="group-form-container" class="hidden">
                <h2 id="group-form-header">Создать новую группу</h2>
                <input type="text" id="group-name" placeholder="Название новой группы">
                <div style="display: flex; gap: 20px; margin-top: 10px; margin-bottom: 10px; align-items: center;">
                    <div style="flex: 1;">
                        <label for="group-start-date" style="display: block; margin-bottom: 5px;">Дата начала (необязательно)</label>
                        <input type="date" id="group-start-date" style="width: 100%;">
                    </div>
                    <div style="flex: 1;">
                        <label for="group-recurrence" style="display: block; margin-bottom: 5px;">Периодичность</label>
                        <select id="group-recurrence" style="width: 100%;">
                            <option value="">Однократно</option>
                            <option value="1">Раз в 1 месяц</option>
                            <option value="3">Раз в 3 месяца</option>
                            <option value="6">Раз в 6 месяцев</option>
                            <option value="12">Раз в 12 месяцев</option>
                        </select>
                    </div>
                </div>
                <label><input type="checkbox" id="group-for-new-employees"> Назначать новым сотрудникам</label>
                <button id="save-group-btn">Сохранить/Создать группу</button>
                <button id="cancel-group-edit-btn" class="hidden" style="background-color: #6c757d;">Отмена</button>
                <hr>
            </div>
            <h3>Курсы в группе</h3>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <h4>Доступные курсы</h4>
                    <select id="all-courses-list" multiple style="height: 200px;"></select>
                </div>
                <div style="display: flex; flex-direction: column; justify-content: center; gap: 10px;">
                    <button id="add-course-to-group-btn">&gt;&gt;</button>
                    <button id="remove-course-from-group-btn">&lt;&lt;</button>
                </div>
                <div style="flex: 1;">
                    <h4>Курсы в этой группе</h4>
                    <select id="group-courses-list" multiple style="height: 200px;"></select>
                </div>
            </div>
            <button id="save-courses-in-group-btn">Сохранить состав группы</button>
            <hr>
            <h3>Назначить группу подразделению</h3>
            <input type="text" id="assign-department-name" placeholder="Название подразделения">
            <button id="assign-group-btn">Назначить</button>

            <hr style="margin-top: 25px; margin-bottom: 25px;">

            <h3>Управление учениками</h3>
            <p>Здесь вы можете найти любого ученика и назначить ему курс индивидуально.</p>
            <button id="load-students-btn">Загрузить список всех учеников</button>

            <table id="students-table" class="hidden" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Email</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Имя</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Подразделение</th>
                    </tr>
                </thead>
                <tbody id="students-table-body">
                    <!-- Student rows will be inserted here -->
                </tbody>
            </table>

            <div id="student-actions-panel" class="hidden" style="margin-top: 15px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h4>Назначить курс для: <b id="selected-student-email-span"></b></h4>
                <select id="student-course-assignment-list"></select>
                <button id="assign-course-to-student-btn" style="width: auto; padding: 10px 20px; margin-top: 10px;">Назначить выбранный курс</button>
            </div>
        </div>

        <div id="results-view" class="hidden">
            <h2>Отчеты по результатам тестов</h2>
            <div id="results-filters">
                <input type="text" id="filter-user" placeholder="Email пользователя...">
                <input type="text" id="filter-department" placeholder="Подразделение...">
                <select id="filter-course"><option value="">Все курсы</option></select>
                <button id="apply-filters-btn">Применить фильтр</button>
                <button id="export-csv-btn" style="background-color: #218838;">Выгрузить в Excel (CSV)</button>
            </div>
            <table id="results-table">
                <thead>
                    <tr>
                        <th>Пользователь</th>
                        <th>Курс</th>
                        <th>Результат (%)</th>
                        <th>Время (мин)</th>
                        <th>Дата</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Сюда будут добавляться строки с результатами -->
                </tbody>
            </table>
        </div>

        <div id="simulator-results-view" class="hidden">
            <h2>Результаты диалогового тренажера</h2>
            <button id="refresh-sim-results-btn">Обновить</button>
            <table id="simulator-results-table" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Дата</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Пользователь</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Сценарий</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Персонаж</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Средний балл</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Simulator results will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

<script>
    // --- CORE SETUP ---
    const SUPABASE_URL = 'https://wnsdlibhrlmgyszbyxat.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Induc2RsaWJocmxtZ3lzemJ5eGF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyODE0MjgsImV4cCI6MjA2OTg1NzQyOH0.Sgz-50dHj8M599sIjTRYs0kMP7b6kX2BJ-Gc-trMUQ4';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let adminToken = null;
    let allCoursesData = []; // Cache for all courses
    let currentEditingCourseId = null;
    let currentEditingGroupId = null;

    // --- DOM ELEMENTS ---
    const loginView = document.getElementById('login-view');
    const panelView = document.getElementById('panel-view');
    const statusBox = document.getElementById('status-box');
    const allViews = [
        document.getElementById('courses-view'),
        document.getElementById('groups-view'),
        document.getElementById('results-view'),
        document.getElementById('leaderboard-view'),
        document.getElementById('simulator-results-view')
    ];
    const allBtns = [
        document.getElementById('courses-tab-btn'),
        document.getElementById('groups-tab-btn'),
        document.getElementById('results-tab-btn'),
        document.getElementById('leaderboard-tab-btn'),
        document.getElementById('simulator-tab-btn')
    ];
    // Course UI elements
    const courseFormContainer = document.getElementById('course-form-container');
    const courseFormHeader = document.getElementById('course-form-header');
    const coursesTableBody = document.getElementById('courses-table').getElementsByTagName('tbody')[0];
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    // Group UI elements
    const groupFormContainer = document.getElementById('group-form-container');
    const groupFormHeader = document.getElementById('group-form-header');
    const groupsTableBody = document.getElementById('groups-table').getElementsByTagName('tbody')[0];
    const cancelGroupEditBtn = document.getElementById('cancel-group-edit-btn');
    const groupNameInput = document.getElementById('group-name');
    const newEmployeesCheckbox = document.getElementById('group-for-new-employees');
    const allCoursesList = document.getElementById('all-courses-list');
    const groupCoursesList = document.getElementById('group-courses-list');

    // --- UTILITY FUNCTIONS ---
    function showStatus(message, type = 'info') {
        statusBox.textContent = message;
        statusBox.className = `status ${type}`;
        setTimeout(() => {
            if (statusBox.textContent === message) {
                statusBox.textContent = '';
                statusBox.className = 'status hidden';
            }
        }, 5000);
    }

    function sanitizeForPath(text) {
        const sanitized = text.replace(/[^a-zA-Z0-9-._]/g, '-');
        const collapsed = sanitized.replace(/-+/g, '-');
        return collapsed.replace(/^-+|-+$/g, '').toLowerCase();
    }

    async function apiCall(action, payload = {}) {
        if (!adminToken) {
            showStatus('Ошибка: вы не авторизованы.', 'error');
            throw new Error('Not authorized');
        }
        const response = await fetch('/.netlify/functions/admin-handler', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${adminToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ action, ...payload })
        });
        const data = await response.json();
        if (!response.ok) {
            const errorMsg = data.error?.message || JSON.stringify(data.error);
            showStatus(`Ошибка: ${errorMsg}`, 'error');
            throw new Error(errorMsg);
        }
        return data;
    }

    // --- TAB SWITCHING ---
    function switchTab(activeTab, activeBtn) {
        allViews.forEach(view => view.classList.add('hidden'));
        allBtns.forEach(btn => btn.classList.remove('active'));
        activeTab.classList.remove('hidden');
        activeBtn.classList.add('active');
    }

    allBtns.forEach((btn, index) => {
        btn.addEventListener('click', () => {
            switchTab(allViews[index], btn);
            // Load data for the activated tab
            if (allViews[index].id === 'courses-view') loadCourses();
            if (allViews[index].id === 'groups-view') {
                loadGroups();
                loadAllCoursesForGrouping();
            }
            if (allViews[index].id === 'results-view') loadResults();
            if (allViews[index].id === 'leaderboard-view') loadLeaderboardSettings();
            if (allViews[index].id === 'simulator-results-view') loadSimulatorResults();
        });
    });

    // --- LOGIN ---
    document.getElementById('login-btn').addEventListener('click', async () => {
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) throw error;
            if (data.user.email.toLowerCase() !== 'admin@cic.kz') {
                 throw new Error('Доступ только для администратора.');
            }
            adminToken = data.session.access_token;
            loginView.classList.add('hidden');
            panelView.classList.remove('hidden');
            // Load initial data for the default tab
            await loadCourses();
        } catch(error) {
            showStatus(`Ошибка входа: ${error.message}`, 'error');
        }
    });

    // --- COURSE MANAGEMENT ---
    function clearCourseForm() {
        courseFormContainer.classList.add('hidden');
        courseFormHeader.textContent = 'Создать новый курс';
        document.getElementById('course-id').value = '';
        document.getElementById('course-id').disabled = false;
        document.getElementById('course-title').value = '';
        document.getElementById('file-uploader').value = '';
        document.getElementById('source-text').value = '';
        document.getElementById('custom-prompt').value = '';
        document.getElementById('generated-html').value = '';
        document.getElementById('generated-questions').value = '';
        document.getElementById('materials-list').innerHTML = '';
        document.getElementById('material-uploader').value = '';
        cancelEditBtn.classList.add('hidden');
        currentEditingCourseId = null;
    }

    document.getElementById('show-create-form-btn').addEventListener('click', () => {
        clearCourseForm();
        courseFormContainer.classList.remove('hidden');
        document.getElementById('course-id').focus();
    });

    cancelEditBtn.addEventListener('click', clearCourseForm);

    async function loadCourses() {
        try {
            const courses = await apiCall('get_courses_admin');
            allCoursesData = courses; // Cache for group management
            coursesTableBody.innerHTML = '';
            const filterCourseSelector = document.getElementById('filter-course');
            filterCourseSelector.innerHTML = '<option value="">Все курсы</option>';

            courses.sort((a, b) => a.title.localeCompare(b.title)).forEach(course => {
                const row = coursesTableBody.insertRow();
                row.insertCell(0).textContent = course.title;
                row.insertCell(1).textContent = course.course_id;
                const statusCell = row.insertCell(2);
                statusCell.textContent = course.status || 'N/A';
                statusCell.className = `status-${course.status}`;
                const actionsCell = row.insertCell(3);
                actionsCell.className = 'actions-cell';
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Редактировать';
                editBtn.onclick = () => loadCourseForEditing(course.course_id);
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Удалить';
                deleteBtn.style.backgroundColor = '#dc3545';
                deleteBtn.onclick = () => deleteCourse(course.course_id, course.title);
                actionsCell.appendChild(editBtn);
                actionsCell.appendChild(deleteBtn);

                const option = document.createElement('option');
                option.value = course.course_id;
                option.textContent = `${course.title} (${course.course_id})`;
                filterCourseSelector.appendChild(option);
            });
        } catch (e) { /* Handled in apiCall */ }
    }

    async function loadCourseForEditing(courseId) {
        showStatus(`Загружаю данные для курса ${courseId}...`, 'info');
        try {
            const course = await apiCall('get_course_details', { course_id: courseId });
            clearCourseForm();
            currentEditingCourseId = courseId;
            courseFormContainer.classList.remove('hidden');
            courseFormHeader.textContent = `Редактирование курса: ${course.title}`;
            cancelEditBtn.classList.remove('hidden');
            window.scrollTo(0, courseFormContainer.offsetTop);

            document.getElementById('course-id').value = course.course_id;
            document.getElementById('course-id').disabled = true;
            document.getElementById('course-title').value = course.title;
            document.getElementById('source-text').value = course.source_text || '';

            let summary = '', questions = '', adminPrompt = '';
            if (course.content_html) {
                if (typeof course.content_html === 'object' && course.content_html.summary) {
                    summary = JSON.stringify(course.content_html.summary, null, 2);
                    questions = JSON.stringify(course.content_html.questions || [], null, 2);
                    adminPrompt = course.content_html.admin_prompt || '';
                } else {
                    summary = JSON.stringify(course.content_html, null, 2);
                }
            }
            document.getElementById('generated-html').value = summary;
            document.getElementById('generated-questions').value = questions;
            document.getElementById('custom-prompt').value = adminPrompt;

            const materialsList = document.getElementById('materials-list');
            materialsList.innerHTML = '';
            if (course.course_materials && course.course_materials.length > 0) {
                course.course_materials.forEach(mat => {
                    const matDiv = document.createElement('div');
                    matDiv.innerHTML = `${mat.file_name} <button class="delete-material-btn" data-id="${mat.id}" data-path="${mat.storage_path}">Удалить</button>`;
                    materialsList.appendChild(matDiv);
                });
            }
            showStatus(`Курс ${course.title} успешно загружен.`, 'success');
        } catch (e) { /* Handled in apiCall */ }
    }

    async function deleteCourse(courseId, courseTitle) {
        if (!confirm(`Вы уверены, что хотите удалить курс "${courseTitle}" (${courseId})? Это действие необратимо и также удалит все результаты тестов по этому курсу.`)) return;
        try {
            await apiCall('delete_course', { course_id: courseId });
            showStatus('Курс успешно удален.', 'success');
            clearCourseForm();
            await loadCourses();
        } catch (e) { /* Handled in apiCall */ }
    }

    // --- GROUP MANAGEMENT ---
    function clearGroupForm() {
        groupFormContainer.classList.add('hidden');
        groupFormHeader.textContent = 'Создать новую группу';
        groupNameInput.value = '';
        newEmployeesCheckbox.checked = false;
        document.getElementById('group-start-date').value = '';
        document.getElementById('group-recurrence').value = '';
        groupCoursesList.innerHTML = '';
        allCoursesList.innerHTML = '';
        document.getElementById('assign-department-name').value = '';
        cancelGroupEditBtn.classList.add('hidden');
        currentEditingGroupId = null;
    }

    document.getElementById('show-create-group-form-btn').addEventListener('click', () => {
        clearGroupForm();
        groupFormContainer.classList.remove('hidden');
        populateAllCoursesList([]);
        groupNameInput.focus();
    });

    cancelGroupEditBtn.addEventListener('click', clearGroupForm);

    async function loadGroups() {
        try {
            const groups = await apiCall('get_course_groups');
            groupsTableBody.innerHTML = '';
            groups.sort((a, b) => a.group_name.localeCompare(b.group_name)).forEach(g => {
                const row = groupsTableBody.insertRow();
                row.insertCell(0).textContent = g.group_name;
                row.insertCell(1).textContent = g.is_for_new_employees ? 'Да' : 'Нет';
                const recurrenceMap = {'1': 'Раз в 1 месяц', '3': 'Раз в 3 месяца', '6': 'Раз в 6 месяцев', '12': 'Раз в 12 месяцев'};
                row.insertCell(2).textContent = recurrenceMap[g.recurrence_period] || 'Однократно';
                const actionsCell = row.insertCell(3);
                actionsCell.className = 'actions-cell';
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Редактировать';
                editBtn.onclick = () => loadGroupForEditing(g.id);
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Удалить';
                deleteBtn.style.backgroundColor = '#dc3545';
                deleteBtn.onclick = () => deleteGroup(g.id, g.group_name);
                actionsCell.appendChild(editBtn);
                actionsCell.appendChild(deleteBtn);
            });
        } catch (e) { /* Handled in apiCall */ }
    }

    async function loadGroupForEditing(groupId) {
        showStatus(`Загрузка группы ${groupId}...`, 'info');
        try {
            const groupDetails = await apiCall('get_group_details', { group_id: groupId });
            clearGroupForm();
            groupFormContainer.classList.remove('hidden');
            groupFormHeader.textContent = `Редактирование группы: ${groupDetails.group_name}`;
            cancelGroupEditBtn.classList.remove('hidden');
            currentEditingGroupId = groupId;

            groupNameInput.value = groupDetails.group_name;
            newEmployeesCheckbox.checked = groupDetails.is_for_new_employees;
            document.getElementById('group-start-date').value = groupDetails.start_date ? groupDetails.start_date.split('T')[0] : '';
            document.getElementById('group-recurrence').value = groupDetails.recurrence_period || '';

            const courseIdsInGroup = groupDetails.course_group_items.map(item => item.course_id);
            groupCoursesList.innerHTML = '';
            allCoursesData.filter(c => courseIdsInGroup.includes(c.course_id)).forEach(c => {
                const option = document.createElement('option');
                option.value = c.course_id;
                option.textContent = `${c.title} (${c.course_id})`;
                groupCoursesList.appendChild(option);
            });
            populateAllCoursesList(courseIdsInGroup);
            showStatus('Группа загружена.', 'success');
            window.scrollTo(0, groupFormContainer.offsetTop);
        } catch (e) { /* Handled in apiCall */ }
    }

    async function deleteGroup(groupId, groupName) {
        if (confirm(`Вы уверены, что хотите удалить группу "${groupName}"?`)) {
            try {
                await apiCall('delete_course_group', { group_id: groupId });
                showStatus('Группа удалена.', 'success');
                clearGroupForm();
                await loadGroups();
            } catch (e) { /* Handled in apiCall */ }
        }
    }

    document.getElementById('save-group-btn').addEventListener('click', async () => {
        const groupName = groupNameInput.value.trim();
        if (!groupName) return showStatus('Название группы не может быть пустым.', 'error');
        const payload = {
            group_name: groupName,
            is_for_new_employees: newEmployeesCheckbox.checked,
            start_date: document.getElementById('group-start-date').value || null,
            recurrence_period: document.getElementById('group-recurrence').value || null
        };
        try {
            if (currentEditingGroupId) {
                await apiCall('update_course_group', { ...payload, group_id: currentEditingGroupId });
                showStatus('Группа успешно обновлена.', 'success');
            } else {
                const newGroup = await apiCall('create_course_group', payload);
                currentEditingGroupId = newGroup.id; // Set current group to allow adding courses right away
                showStatus('Группа успешно создана.', 'success');
            }
            await loadGroups();
        } catch (e) { /* Handled in apiCall */ }
    });

    async function loadAllCoursesForGrouping() {
        if (allCoursesData.length === 0) {
             try {
                allCoursesData = await apiCall('get_courses_admin');
             } catch(e) { /* Handled in apiCall */ }
        }
    }

    function populateAllCoursesList(usedCourseIds) {
        allCoursesList.innerHTML = '';
        allCoursesData.filter(c => !usedCourseIds.includes(c.course_id)).forEach(c => {
            const option = document.createElement('option');
            option.value = c.course_id;
            option.textContent = `${c.title} (${c.course_id})`;
            allCoursesList.appendChild(option);
        });
    }

    document.getElementById('add-course-to-group-btn').addEventListener('click', () => Array.from(allCoursesList.selectedOptions).forEach(o => groupCoursesList.appendChild(o)));
    document.getElementById('remove-course-from-group-btn').addEventListener('click', () => Array.from(groupCoursesList.selectedOptions).forEach(o => allCoursesList.appendChild(o)));

    document.getElementById('save-courses-in-group-btn').addEventListener('click', async () => {
        if (!currentEditingGroupId) return showStatus('Сначала выберите или создайте группу.', 'error');
        const courseIds = Array.from(groupCoursesList.options).map(opt => opt.value);
        try {
            await apiCall('update_courses_in_group', { group_id: currentEditingGroupId, course_ids: courseIds });
            showStatus('Состав группы успешно сохранен.', 'success');
        } catch (e) { /* Handled in apiCall */ }
    });

    document.getElementById('assign-group-btn').addEventListener('click', async () => {
        const department = document.getElementById('assign-department-name').value.trim();
        if (!currentEditingGroupId || !department) return showStatus('Выберите группу и укажите название подразделения.', 'error');
        try {
            await apiCall('assign_group_to_department', { group_id: currentEditingGroupId, department: department });
            showStatus(`Группа успешно назначена подразделению "${department}".`, 'success');
            document.getElementById('assign-department-name').value = '';
        } catch (e) { /* Handled in apiCall */ }
    });

    // --- STUDENT MANAGEMENT (within Groups tab) ---
    let selectedStudentEmail = null;

    document.getElementById('load-students-btn').addEventListener('click', async () => {
        try {
            showStatus('Загрузка списка учеников...', 'info');
            const students = await apiCall('get_all_users');
            const studentsTable = document.getElementById('students-table');
            const studentsTbody = document.getElementById('students-table-body');
            studentsTbody.innerHTML = '';
            students.forEach(student => {
                const row = studentsTbody.insertRow();
                row.dataset.email = student.email;
                row.insertCell(0).textContent = student.email;
                row.insertCell(1).textContent = student.full_name;
                row.insertCell(2).textContent = student.department;
            });
            studentsTable.classList.remove('hidden');
            showStatus(`Загружено ${students.length} учеников.`, 'success');
        } catch(e) { /* Handled in apiCall */ }
    });

    document.getElementById('students-table-body').addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (!row) return;

        // Toggle selection and update UI
        document.querySelectorAll('#students-table-body tr').forEach(r => r.style.backgroundColor = '');
        row.style.backgroundColor = '#e9f7fe';

        selectedStudentEmail = row.dataset.email;
        const actionsPanel = document.getElementById('student-actions-panel');
        document.getElementById('selected-student-email-span').textContent = selectedStudentEmail;

        const courseList = document.getElementById('student-course-assignment-list');
        courseList.innerHTML = '';
        allCoursesData.forEach(course => {
            const option = document.createElement('option');
            option.value = course.course_id;
            option.textContent = `${course.title} (${course.course_id})`;
            courseList.appendChild(option);
        });

        actionsPanel.classList.remove('hidden');
    });

    document.getElementById('assign-course-to-student-btn').addEventListener('click', async () => {
        const courseId = document.getElementById('student-course-assignment-list').value;
        if (!selectedStudentEmail || !courseId) {
            return showStatus('Выберите ученика и курс для назначения.', 'error');
        }
        try {
            await apiCall('assign_course_to_user', { user_email: selectedStudentEmail, course_id: courseId });
            showStatus(`Курс "${courseId}" успешно назначен ${selectedStudentEmail}.`, 'success');
        } catch(e) { /* Handled in apiCall */ }
    });


    // --- LEADERBOARD & OTHER ---
    async function loadLeaderboardSettings() {
        try {
            const settings = await apiCall('get_leaderboard_settings');
            const metrics = settings.metrics || { courses_completed: true, time_spent: false, avg_score: false };
            document.querySelectorAll('#leaderboard-settings-form input[type="checkbox"]').forEach(c => { c.checked = metrics[c.value] || false; });
            showStatus('Настройки загружены.', 'success');
        } catch (e) { /* Handled in apiCall */ }
    }

    document.getElementById('save-leaderboard-settings-btn').addEventListener('click', async () => {
        const metrics = {};
        document.querySelectorAll('#leaderboard-settings-form input[type="checkbox"]').forEach(c => { metrics[c.value] = c.checked; });
        try {
            await apiCall('save_leaderboard_settings', { metrics });
            showStatus('Настройки успешно сохранены.', 'success');
        } catch (e) { /* Handled in apiCall */ }
    });

    // --- RESULTS ---
    async function loadResults() {
        const userEmail = document.getElementById('filter-user').value;
        const department = document.getElementById('filter-department').value;
        const courseId = document.getElementById('filter-course').value;
        const params = new URLSearchParams({ user_email: userEmail, department, course_id: courseId });
        try {
            if (!adminToken) throw new Error('Не авторизован');
            const response = await fetch(`/.netlify/functions/getDetailedReport?${params.toString()}`, {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || 'Ошибка при загрузке отчета.');
            }
            const results = await response.json();
            const tableBody = document.getElementById('results-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            results.forEach(result => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = result.user_profiles?.full_name || result.user_email;
                row.insertCell(1).textContent = result.courses.title;
                row.insertCell(2).textContent = result.percentage;
                const timeSpentMinutes = result.time_spent_seconds ? Math.round(result.time_spent_seconds / 60) : 0;
                row.insertCell(3).textContent = timeSpentMinutes;
                row.insertCell(4).textContent = result.completed_at ? new Date(result.completed_at).toLocaleString() : 'В процессе';
            });
        } catch (error) {
            showStatus('Ошибка при загрузке результатов.', 'error');
        }
    }

    document.getElementById('apply-filters-btn').addEventListener('click', loadResults);

    // --- SIMULATOR RESULTS ---
    async function loadSimulatorResults() {
        showStatus('Загрузка результатов тренажера...', 'info');
        try {
            const results = await apiCall('get_simulation_results');
            const tableBody = document.getElementById('simulator-results-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            results.forEach(res => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = new Date(res.created_at).toLocaleString();
                row.insertCell(1).textContent = res.full_name || res.user_email;
                const scenarioCell = row.insertCell(2);
                scenarioCell.textContent = res.scenario ? (res.scenario.substring(0, 100) + '...') : 'N/A';
                scenarioCell.title = res.scenario;
                row.insertCell(3).textContent = res.persona;
                const scoreCell = row.insertCell(4);
                scoreCell.style.textAlign = 'center';
                scoreCell.style.fontWeight = 'bold';
                scoreCell.textContent = res.evaluation?.average_score ? res.evaluation.average_score.toFixed(1) : 'N/A';
            });
            showStatus('Результаты тренажера загружены.', 'success');
        } catch (e) { /* Handled in apiCall */ }
    }

    document.getElementById('refresh-sim-results-btn').addEventListener('click', loadSimulatorResults);


    document.getElementById('export-csv-btn').addEventListener('click', async () => {
        const userEmail = document.getElementById('filter-user').value;
        const department = document.getElementById('filter-department').value;
        const courseId = document.getElementById('filter-course').value;
        const params = new URLSearchParams({ format: 'csv', user_email: userEmail, department, course_id: courseId });
        showStatus('Выгрузка отчета...', 'info');
        try {
            const response = await fetch(`/.netlify/functions/getDetailedReport?${params.toString()}`);
            if (!response.ok) throw new Error((await response.json()).error || 'Не удалось получить данные.');
            const csvData = await response.text();
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', `report-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            showStatus('Отчет успешно выгружен.', 'success');
        } catch (error) {
            showStatus(`Ошибка при выгрузке: ${error.message}`, 'error');
        }
    });

    // --- LEGACY FORM BUTTONS (inside course/group forms) ---
    document.getElementById('process-file-btn').addEventListener('click', async () => {
        const file = document.getElementById('file-uploader').files[0];
        const title = document.getElementById('course-title').value.trim();
        let courseId = document.getElementById('course-id').value.trim();
        if (!file || !courseId || !title) return showStatus('Укажите ID, название курса и выберите файл.', 'error');
        courseId = sanitizeForPath(courseId);
        showStatus(`Обработка файла...`, 'info');
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            try {
                const base64File = reader.result.split(',')[1];
                const data = await apiCall('upload_and_process', {
                    course_id: courseId, title,
                    file_name: sanitizeForPath(file.name), file_data: base64File
                });
                showStatus('Файл успешно обработан.', 'success');
                document.getElementById('source-text').value = data.extractedText;
                document.getElementById('course-id').disabled = true;
                await loadCourses();
            } catch(e) { /* Handled in apiCall */ }
        };
    });

    document.getElementById('generate-btn').addEventListener('click', async () => {
        let courseId = document.getElementById('course-id').value.trim();
        if (!courseId) return showStatus('Укажите ID курса.', 'error');
        showStatus('Идет генерация контента AI...', 'info');
        try {
            const data = await apiCall('generate_content', {
                course_id: courseId,
                custom_prompt: document.getElementById('custom-prompt').value
            });
            showStatus('Черновик успешно сгенерирован.', 'success');
            document.getElementById('generated-html').value = JSON.stringify(data.summary, null, 2);
            document.getElementById('generated-questions').value = JSON.stringify(data.questions, null, 2);
        } catch(e) { /* Handled in apiCall */ }
    });

    document.getElementById('text-to-speech-btn').addEventListener('click', async () => {
        const sourceText = document.getElementById('source-text').value;
        if (!sourceText) return showStatus('Нет текста для озвучивания.', 'error');
        showStatus('Идет генерация аудио...', 'info');
        const audioPlayerContainer = document.getElementById('audio-player-container');
        audioPlayerContainer.innerHTML = '';
        try {
            const data = await apiCall('text_to_speech', { text: sourceText });
            const audio = new Audio(data.audioUrl);
            audio.controls = true;
            audioPlayerContainer.appendChild(audio);
            audioPlayerContainer.classList.remove('hidden');
            showStatus('Аудио успешно сгенерировано.', 'success');
        } catch (error) { /* Handled in apiCall */ }
    });

    document.getElementById('publish-btn').addEventListener('click', async () => {
        let courseId = document.getElementById('course-id').value.trim();
        if (!courseId) return showStatus('Укажите ID курса.', 'error');
        showStatus('Публикую курс...', 'info');
        try {
            const content_html = JSON.parse(document.getElementById('generated-html').value);
            const questions = JSON.parse(document.getElementById('generated-questions').value);
            await apiCall('publish_course', {
                course_id: courseId, content_html, questions,
                admin_prompt: document.getElementById('custom-prompt').value
            });
            showStatus('Курс успешно опубликован.', 'success');
            await loadCourses();
            clearCourseForm();
        } catch (e) {
            showStatus('Ошибка: Неверный формат JSON или другая проблема.', 'error');
        }
    });

    document.getElementById('upload-material-btn').addEventListener('click', async () => {
        const file = document.getElementById('material-uploader').files[0];
        if (!currentEditingCourseId || !file) return showStatus('Сначала выберите курс для редактирования и файл для загрузки.', 'error');
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            try {
                await apiCall('upload_course_material', {
                    course_id: currentEditingCourseId,
                    file_name: file.name,
                    file_data: reader.result.split(',')[1]
                });
                showStatus('Материал успешно загружен.', 'success');
                loadCourseForEditing(currentEditingCourseId); // Refresh
            } catch(e) { /* Handled in apiCall */ }
        };
    });

    document.getElementById('materials-list').addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-material-btn')) {
            const materialId = e.target.dataset.id;
            const storagePath = e.target.dataset.path;
            if (confirm(`Удалить материал "${storagePath}"?`)) {
                try {
                    await apiCall('delete_course_material', { material_id: materialId, storage_path: storagePath });
                    showStatus('Материал удален.', 'success');
                    loadCourseForEditing(currentEditingCourseId); // Refresh
                } catch(e) { /* Handled in apiCall */ }
            }
        }
    });
</script>
</body>
</html>
