<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Админ-панель</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/shared/constants.js"></script>
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #00AEEF;
            --bg-color: #f4f7f6;
            --surface-color: #ffffff;
            --text-color: #333333;
            --text-light-color: #777777;
            --border-color: #e0e0e0;
            --success-color: #28a745;
            --error-color: #dc3545;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        body { font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif; padding: 20px; max-width: 1200px; margin: auto; background-color: var(--bg-color); color: var(--text-color); }
        h1, h2, h3 { color: var(--primary-color); }
        .hidden { display: none; }
        input, textarea, button, select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; }
        button { background-color: var(--primary-color); color: white; cursor: pointer; border: none; font-weight: bold; transition: background-color 0.2s; }
        button:hover { background-color: var(--secondary-color); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        textarea { height: 150px; resize: vertical; }
        .status { padding: 15px; border-radius: 8px; margin: 10px 0; text-align: center; }
        .error { color: var(--error-color); background-color: #fdeeee; }
        .success { color: var(--success-color); background-color: #eaf7ec; }
        .info { color: var(--primary-color); background-color: #e9f7fe; }
        .tabs button { width: auto; padding: 10px 20px; margin-right: 10px; background-color: var(--border-color); color: var(--text-color); }
        .tabs button.active { background-color: var(--primary-color); color: white; }
        #results-view { margin-top: 20px; }
        #results-filters { display: flex; gap: 10px; margin-bottom: 10px; }
        #results-table { width: 100%; border-collapse: collapse; }
        #results-table th, #results-table td { border: 1px solid var(--border-color); padding: 8px; text-align: left; }
        #results-table th { background-color: var(--bg-color); }
        #delete-course-btn { background-color: var(--error-color); }
        #delete-course-btn:hover { background-color: #c82333; }
        #courses-table, #groups-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #courses-table th, #courses-table td, #groups-table th, #groups-table td { border: 1px solid var(--border-color); padding: 10px; text-align: left; vertical-align: middle; }
        #courses-table th, #groups-table th { background-color: var(--bg-color); font-weight: bold; }
        #courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .course-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background-color: var(--surface-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .course-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .course-card h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: var(--primary-color);
        }
        .course-card p {
            margin: 4px 0;
            font-size: 0.9em;
            color: var(--text-color);
        }
        .course-card .actions-cell {
            margin-top: 15px;
            display: flex;
            gap: 5px;
        }
        .actions-cell button { width: auto; padding: 6px 12px; font-size: 14px; margin-right: 5px; }
        .status-published { color: var(--success-color); font-weight: bold; }
        .status-processed { color: #ffc107; }
        .inline-error { color: var(--error-color); font-size: 0.9em; margin-top: -5px; margin-bottom: 10px; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; }
        .toast { padding: 15px 20px; margin-bottom: 10px; border-radius: 8px; color: white; font-weight: bold; box-shadow: var(--shadow); opacity: 0.9; width: 300px; }
        .toast-error { background-color: var(--error-color); }
        .toast-success { background-color: var(--success-color); }
        .toast-info { background-color: var(--secondary-color); }

        /* WYSIWYG Editor Styles */
        #wysiwyg-editor {
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
            background-color: var(--surface-color);
            min-height: 200px;
        }
        .wysiwyg-slide {
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            background-color: #fcfcfc;
        }
        .wysiwyg-slide-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            color: var(--primary-color);
        }
        .wysiwyg-slide-content, .wysiwyg-question-text, .wysiwyg-option-label {
            min-height: 30px;
            padding: 8px;
            border: 1px dashed var(--border-color);
        }
        .wysiwyg-slide-content:focus, .wysiwyg-question-text:focus, .wysiwyg-option-label:focus {
            outline: 1px solid var(--secondary-color);
            border: 1px solid var(--secondary-color);
            background-color: #f8f9fa;
        }
        .wysiwyg-questions-container h4 {
            margin-top: 25px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }
        .wysiwyg-question {
            background-color: #f1f3f5;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            border-left: 4px solid var(--secondary-color);
        }
        .wysiwyg-options {
            list-style-type: none;
            padding-left: 0;
            margin-top: 10px;
        }
        .wysiwyg-option-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            background-color: #fff;
            padding: 5px;
            border-radius: 4px;
        }
        .wysiwyg-option-item input[type="radio"] {
            width: auto;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .wysiwyg-option-label {
            flex-grow: 1;
        }
        .course-list {
            list-style-type: none;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            background-color: #fff;
        }
        .course-list li {
            padding: 8px;
            margin-bottom: 5px;
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: grab;
        }
        .course-list li:hover {
            background-color: #e9f7fe;
        }
        .course-list li.dragging {
            opacity: 0.5;
            background-color: #cce5ff;
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div id="login-view" class="hidden">
        <h1>Вход для администратора</h1>
        <input type="email" id="admin-email" value="test1@cic.kz">
        <input type="password" id="admin-password" placeholder="Пароль">
        <button id="login-btn">Войти</button>
        <div id="login-error" class="status error hidden"></div>
    </div>

    <div id="panel-view" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 20px;">
                <img src="https://centras.kz/wp-content/uploads/2023/12/centras-insurance-col.png" alt="Logo" style="height: 40px;">
                <h1>Панель управления</h1>
            </div>
            <button id="logout-btn" style="width: auto; background-color: var(--text-light-color);">Выйти</button>
        </div>
        <div class="tabs">
            <button id="courses-tab-btn" class="active">Управление курсами</button>
            <button id="groups-tab-btn">Управление группами</button>
            <button id="results-tab-btn">Отчеты и Результаты</button>
            <button id="leaderboard-tab-btn">Лидерборд</button>
            <button id="simulator-tab-btn">Результаты Тренажера</button>
        </div>
        <hr>

        <div id="leaderboard-view" class="hidden">
            <h2>Настройки Лидерборда "Топ учеников недели"</h2>
            <p>Выберите метрики, по которым будет строиться рейтинг. Пользователи будут отсортированы по первой выбранной метрике.</p>
            <div id="leaderboard-settings-form">
                <label><input type="checkbox" name="metric" value="courses_completed"> Количество пройденных курсов</label><br>
                <label><input type="checkbox" name="metric" value="time_spent"> Общее время обучения (в минутах)</label><br>
                <label><input type="checkbox" name="metric" value="avg_score"> Средний балл по тестам</label><br>
                <br>
                <button id="save-leaderboard-settings-btn">Сохранить настройки</button>
            </div>
        </div>

        <div id="courses-view">
            <h2>Панель управления курсами</h2>
            <div id="status-box" class="status hidden"></div>

            <h3>Существующие курсы</h3>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                <input type="text" id="course-search-input" placeholder="Поиск по названию или группе..." style="flex-grow: 1; min-width: 250px;">
                <div id="pagination-controls" style="display: flex; align-items: center;">
                    <button id="prev-page-btn" style="width: auto; padding: 8px 12px;">&lt; Назад</button>
                    <span id="page-info" style="padding: 0 15px; font-weight: bold;"></span>
                    <button id="next-page-btn" style="width: auto; padding: 8px 12px;">Вперед &gt;</button>
                </div>
            </div>
            <button id="show-create-form-btn" style="margin-top: 10px;">Создать новый курс</button>
            <div id="courses-grid">
                <!-- Course cards will be inserted here by JavaScript -->
            </div>
            <hr>

            <div id="course-form-wrapper"></div>
        </div>

        <div id="groups-view" class="hidden">
            <h2>Управление группами курсов (Блоками)</h2>

            <h3>Существующие группы</h3>
            <button id="show-create-group-form-btn">Создать новую группу</button>
            <table id="groups-table">
                <thead>
                    <tr>
                        <th>Название группы</th>
                        <th>Назначать новым</th>
                        <th>Видимость</th>
                        <th>Порядок</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Group rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <hr>

            <div id="group-form-container" class="hidden">
                <h2 id="group-form-header">Создать новую группу</h2>
                <input type="text" id="group-name" placeholder="Название новой группы">
                <div id="group_name-error" class="inline-error"></div>

                <div style="display: flex; gap: 20px; margin-top: 10px; margin-bottom: 10px; align-items: center;">
                    <div style="flex: 1;">
                        <label for="group-deadline-days" style="display: block; margin-bottom: 5px;">Срок прохождения (в днях)</label>
                        <input type="number" id="group-deadline-days" placeholder="Например: 30" style="width: 100%;">
                    </div>
                    <div style="flex: 1;">
                        <label for="group-recurrence" style="display: block; margin-bottom: 5px;">Периодичность</label>
                        <select id="group-recurrence" style="width: 100%;">
                            <option value="">Однократно</option>
                            <option value="1">Раз в 1 месяц</option>
                            <option value="3">Раз в 3 месяца</option>
                            <option value="6">Раз в 6 месяцев</option>
                            <option value="12">Раз в 12 месяцев</option>
                        </select>
                    </div>
                </div>

                <label style="display: block; margin-bottom: 5px;"><input type="checkbox" id="group-is-visible"> <b>Видимость:</b> Группа видна пользователям в каталоге</label>
                <label style="display: block; margin-bottom: 5px;"><input type="checkbox" id="group-enforce-order"> <b>Строгий порядок:</b> Требовать последовательного прохождения курсов</label>
                <label style="display: block; margin-bottom: 15px;"><input type="checkbox" id="group-for-new-employees"> <b>Авто-назначение:</b> Назначать новым сотрудникам</label>

                <button id="save-group-btn">Сохранить/Создать группу</button>
                <button id="cancel-group-edit-btn" class="hidden" style="background-color: #6c757d;">Отмена</button>
                <hr>
            </div>

            <h3>Курсы в группе</h3>
            <p>Перетащите курсы между списками и отсортируйте их в правом списке.</p>
            <div style="display: flex; gap: 20px;">
                <div style="flex: 1;">
                    <h4>Доступные курсы</h4>
                    <ul id="all-courses-list" class="course-list"></ul>
                </div>
                <div style="flex: 1;">
                    <h4>Курсы в этой группе (сортируемый список)</h4>
                    <ul id="group-courses-list" class="course-list"></ul>
                </div>
            </div>
            <button id="save-courses-in-group-btn">Сохранить состав группы</button>
            <hr>
            <h3>Назначить группу подразделению</h3>
            <select id="assign-department-select" style="width: 100%;"><option value="">Выберите подразделение...</option></select>
            <button id="assign-group-btn">Назначить</button>

            <hr style="margin-top: 25px; margin-bottom: 25px;">

            <h3>Управление учениками</h3>
            <p>Здесь вы можете найти любого ученика и назначить ему курс индивидуально.</p>
            <button id="load-students-btn">Загрузить список всех учеников</button>

            <input type="text" id="student-search-input" placeholder="Поиск по имени или email..." class="hidden" style="margin-top: 15px;">

            <table id="students-table" class="hidden" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Email</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Имя</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Подразделение</th>
                    </tr>
                </thead>
                <tbody id="students-table-body">
                    <!-- Student rows will be inserted here -->
                </tbody>
            </table>

            <div id="student-pagination-controls" class="hidden" style="display: flex; align-items: center; justify-content: center; margin-top: 10px;">
                <button id="student-prev-page-btn" style="width: auto; padding: 8px 12px;">&lt; Назад</button>
                <span id="student-page-info" style="padding: 0 15px; font-weight: bold;"></span>
                <button id="student-next-page-btn" style="width: auto; padding: 8px 12px;">Вперед &gt;</button>
            </div>

            <div id="student-actions-panel" class="hidden" style="margin-top: 15px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h4>Назначить курс для: <b id="selected-student-email-span"></b></h4>
                <select id="student-course-assignment-list"></select>
                <button id="assign-course-to-student-btn" style="width: auto; padding: 10px 20px; margin-top: 10px;">Назначить выбранный курс</button>
            </div>
        </div>

        <div id="results-view" class="hidden">
            <h2>Отчеты по результатам тестов</h2>
            <div id="results-filters">
                <input type="text" id="filter-user" placeholder="Email пользователя...">
                <input type="text" id="filter-department" placeholder="Подразделение...">
                <select id="filter-course"><option value="">Все курсы</option></select>
                <button id="apply-filters-btn">Применить фильтр</button>
                <button id="export-csv-btn" style="background-color: #218838;">Выгрузить в Excel (CSV)</button>
            </div>
            <table id="results-table">
                <thead>
                    <tr>
                        <th>Пользователь</th>
                        <th>Курс</th>
                        <th>Результат (%)</th>
                        <th>Время (мин)</th>
                        <th>Дата</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Сюда будут добавляться строки с результатами -->
                </tbody>
            </table>
        </div>

        <div id="simulator-results-view" class="hidden">
            <h2>Результаты диалогового тренажера</h2>
            <button id="refresh-sim-results-btn">Обновить</button>
            <table id="simulator-results-table" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Дата</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Пользователь</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Сценарий</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Персонаж</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Средний балл</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Simulator results will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

<script type="module" src="/client/admin.js"></script>

<template id="course-form-template">
    <div id="course-form-container">
        <h2 id="course-form-header"></h2>
        <input type="hidden" id="course-id">
        <input type="text" id="course-title" placeholder="Название курса">
        <h3>Шаг 1А: Генерация из файла (текущий функционал)</h3>
        <input type="file" id="file-uploader" accept=".pdf,.docx">
        <button id="process-file-btn">Загрузить и извлечь текст</button>
        <hr style="margin: 20px 0;">
        <h3>ИЛИ Шаг 1А.2: Загрузка файла с вопросами (новый функционал)</h3>
        <p style="font-size: 0.9em; color: #666; margin-top: -5px;">Загрузите .docx или .rtf файл с тестами. Система автоматически распознает вопросы, варианты ответов и правильный ответ (отмеченный знаком "+").</p>
        <input type="file" id="questions-file-uploader" accept=".docx,.rtf">
        <button id="process-questions-file-btn">Загрузить и распознать вопросы</button>
        <hr style="margin: 20px 0;">
        <h3>ИЛИ Шаг 1Б: Генерация по ссылке на Google Slides</h3>
        <p style="font-size: 0.9em; color: #666; margin-top: -5px;">Для корректной работы опубликуйте презентацию в интернете (Файл -> Поделиться -> Опубликовать в интернете) и вставьте ссылку сюда.</p>
        <input type="url" id="presentation-url" placeholder="Вставьте ссылку на опубликованную Google Slides презентацию">
        <div id="presentation-preview-container" style="margin-top: 15px; min-height: 400px; border: 1px solid #e0e0e0; display: none; background-color: #f9f9f9; padding: 5px; border-radius: 8px;"></div>
        <button id="process-presentation-btn">Создать/Обновить курс по презентации</button>
        <hr style="margin: 20px 0;">
        <h3>Описание (Источник для AI)</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button id="text-to-speech-btn" style="flex: 1;">Озвучить описание</button>
        </div>
        <div id="audio-player-container" class="hidden" style="margin-top: 10px;"></div>
        <textarea id="description" placeholder="Здесь появится текст..."></textarea>
        <h3>Шаг 2: Сгенерируйте контент</h3>
        <textarea id="custom-prompt" placeholder="Оставьте пустым для стандартного промпта..."></textarea>
        <button id="generate-btn">Сгенерировать черновик</button>
        <h3>Шаг 3: Проверьте и отредактируйте контент</h3>
        <div id="wysiwyg-editor"></div>
        <textarea id="content" style="display: none;"></textarea>
        <h3>Шаг 4: Сохранение и публикация</h3>
        <p>При нажатии на "Опубликовать", курс станет видимым для пользователей, если установлен флажок ниже.</p>
        <label style="display: block; margin: 15px 0; background-color: #e9f7fe; padding: 10px; border-radius: 8px;">
            <input type="checkbox" id="course-is-visible" style="width: auto; margin-right: 10px; vertical-align: middle;">
            <b style="vertical-align: middle;">Видимость в каталоге:</b> Курс доступен для самостоятельного выбора пользователями.
        </label>
        <div style="margin: 15px 0;">
            <label for="course-deadline-days"><b>Срок выполнения в днях (для индивидуальных курсов):</b></label>
            <input type="number" id="course-deadline-days" placeholder="Оставьте пустым, если срока нет" style="margin-top: 5px;">
        </div>
        <p id="autosave-status" style="font-style: italic; color: #666;"></p>
        <div style="display: flex; gap: 10px;">
            <button id="save-draft-btn" style="background-color: #00AEEF; flex: 1;">Сохранить черновик</button>
            <button id="publish-btn" style="background-color: #28a745; flex: 2;">ОПУБЛИКОВАТЬ</button>
            <button id="download-pdf-btn" style="background-color: #17a2b8; flex: 1;">Скачать PDF</button>
        </div>
        <button id="cancel-edit-btn" style="background-color: #6c757d; margin-top: 10px;">Отмена</button>
        <hr>
        <h3>Сопутствующие материалы</h3>
        <div id="materials-list" style="margin-bottom: 15px;"></div>
        <div id="add-material-form" style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="material-name" placeholder="Название файла" style="flex: 1; margin-bottom: 0;">
            <input type="url" id="material-url" placeholder="https://example.com/file.pdf" style="flex: 2; margin-bottom: 0;">
            <button id="add-material-btn" style="width: auto; padding: 10px 15px; margin-bottom: 0;">+</button>
        </div>
    </div>
</template>

<template id="course-card-template">
    <div class="course-card">
        <div>
            <h4 class="course-title"></h4>
            <p><strong>ID:</strong> <span class="course-id"></span></p>
            <p><strong>Статус:</strong> <span class="course-status"></span></p>
            <div class="job-status-indicator" style="font-style: italic; color: #005A9C; margin-top: 5px;"></div>
        </div>
        <div class="actions-cell">
            <button class="edit-btn">Редактировать</button>
            <button class="delete-btn" style="background-color: #dc3545;">Удалить</button>
        </div>
    </div>
</template>

<template id="group-row-template">
    <tr>
        <td class="group-name"></td>
        <td class="group-new-employees"></td>
        <td class="group-visibility"></td>
        <td class="group-order"></td>
        <td class="actions-cell">
            <button class="edit-btn">Редактировать</button>
            <button class="delete-btn" style="background-color: #dc3545;">Удалить</button>
        </td>
    </tr>
</template>

</body>
</html>
